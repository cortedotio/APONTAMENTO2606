<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestão de Frotas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      padding: 24px;
      background-color: #e0e7ff;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .card {
      padding: 32px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      width: 100%;
      max-width: 768px;
      background-color: #ffffff;
      border: 1px solid #e2e8f0;
    }
    h2 {
      font-size: 2.25rem;
      font-weight: 800;
      color: #1a202c;
      margin-bottom: 20px;
    }
    h3 {
      font-size: 1.75rem;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid #edf2f7;
    }
    h4 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 12px;
    }
    .btn {
      padding: 12px 28px;
      border: none;
      color: white;
      border-radius: 10px;
      cursor: pointer;
      margin: 6px 4px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      background-image: linear-gradient(145deg, var(--color-light), var(--color-dark));
    }
    .btn.yellow { --color-light: #ffeb3b; --color-dark: #fbc02d; color: #333; }
    .btn.green { --color-light: #4CAF50; --color-dark: #388E3C; }
    .btn.red { --color-light: #f44336; --color-dark: #d32f2f; }
    .btn.blue { --color-light: #2196F3; --color-dark: #1976D2; }
    .btn.purple { --color-light: #9C27B0; --color-dark: #7B1FA2; }
    .btn.darkblue { --color-light: #3F51B5; --color-dark: #303F9F; }
    .btn.teal { --color-light: #009688; --color-dark: #00796B; }
    .btn.orange { --color-light: #FF9800; --color-dark: #F57C00; }
    /* Adicionado para botões escuros */
    .btn.dark-primary { --color-light: #374151; --color-dark: #1F2937; } /* Cor mais escura para botões principais */
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      opacity: 1;
    }
    .field {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
    @media (min-width: 640px) {
      .field {
        flex-direction: row;
        align-items: center;
        gap: 16px;
      }
    }
    .field label {
      flex: 0 0 140px;
      color: #4a5568;
      font-weight: 600;
      font-size: 0.95rem;
    }
    .field input[type="text"],
    .field input[type="date"],
    .field input[type="time"],
    .field input[type="password"],
    .field select,
    .field textarea {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #cbd5e0;
      border-radius: 8px;
      box-sizing: border-box;
      width: 100%;
      font-size: 1rem;
      color: #2d3748;
      background-color: #f7fafc;
      transition: all 0.2s ease-in-out;
    }
    .field input:focus, .field select:focus, .field textarea:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
      background-color: #ffffff;
    }
    .field img {
      margin-left: 0;
      margin-top: 12px;
      width: 90px;
      height: 90px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #6366f1;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    @media (min-width: 640px) {
      .field img {
        margin-left: 20px;
        margin-top: 0;
      }
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    .checklist {
      padding: 20px;
      border: 1px solid #d1d8e0;
      border-radius: 12px;
      background-color: #f0f4f8;
      margin-top: 24px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }
    .checklist h4 {
      color: #333;
      margin-top: 0;
      margin-bottom: 16px;
      text-align: center;
      font-size: 1.35rem;
    }
    .checklist label {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      font-size: 0.9rem;
      color: #4a5568;
    }
    .checklist input[type="radio"] {
        transform: scale(1.2);
        cursor: pointer;
    }
    .admin-panel {
      display: none;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid #e2e8f0;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.6);
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(4px);
    }
    .modal-content {
        background-color: #ffffff;
        padding: 30px;
        border: 1px solid #b2c1d3;
        border-radius: 16px;
        width: 90%;
        max-width: 650px; /* Increased width for lists */
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .modal-warning-background {
        background-color: #ffebee;
        border-color: #ef9a9a;
    }
    .modal-warning-background h3,
    .modal-warning-background p {
        color: #c62828;
    }
    .modal-content h3 {
        font-size: 1.6rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 12px;
        border-bottom: none;
    }
    .modal-content p {
        font-size: 1.05rem;
        color: #555;
        margin-bottom: 24px;
        line-height: 1.5;
        white-space: pre-wrap; /* Allows line breaks in the message */
    }
    .modal-buttons button {
        margin: 0 10px;
        min-width: 100px;
    }
    .modal-list-content {
        max-height: 400px;
        overflow-y: auto;
        margin-top: 1rem;
    }
    .availability-table, .consult-table, .data-table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 8px;
        overflow: hidden;
        margin-top: 16px;
    }
    .availability-table th, .availability-table td,
    .consult-table th, .consult-table td,
    .data-table th, .data-table td {
        padding: 12px 8px;
        font-size: 0.9rem;
        text-align: left;
        border: 1px solid #e2e8f0;
    }
    .availability-table thead, .consult-table thead, .data-table thead {
        background-color: #e2e8f0;
        color: #4a5568;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.8rem;
    }
    .availability-table tbody tr:nth-child(even),
    .consult-table tbody tr:nth-child(even),
    .data-table tbody tr:nth-child(even) {
        background-color: #f7fafc;
    }
    .availability-table tbody tr:hover,
    .consult-table tbody tr:hover,
    .data-table tbody tr:hover {
        background-color: #ebf4ff;
    }
    @media (max-width: 640px) {
        .availability-table, .consult-table, .data-table { border: none; }
        .availability-table thead, .consult-table thead, .data-table thead { display: none; }
        .availability-table tr, .consult-table tr, .data-table tr {
            margin-bottom: 16px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            background-color: #ffffff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            display: block;
            width: 100%;
        }
        .availability-table td, .consult-table td, .data-table td {
            border-bottom: 1px dotted #e2e8f0;
            text-align: right;
            padding-left: 50%;
            position: relative;
            display: block;
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
        }
        .availability-table td:last-child, .consult-table td:last-child, .data-table td:last-child { border-bottom: 0; }
    }
    .status-maintenance-strong { background-color: #D32F2F; color: #FFFFFF; font-weight: 600; }
    .status-revision-strong { background-color: #3F51B5; color: #FFFFFF; font-weight: 600; }
    .status-active { background-color: #BBDEFB; color: #1A237E; font-weight: 600; }
    .status-cell {
        padding: 6px 12px;
        border-radius: 6px;
        display: inline-block;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .status-ok { background-color: #c8e6c9; color: #2e7d32; }
    .status-inconsistente { background-color: #ffebee; color: #d32f2f; }
  </style>
</head>
<body>

<!-- Painel Principal de Gestão de Frotas -->
<div class="card" id="gestaoDeFrotasPanel">
    <div class="flex items-center gap-4 mb-4">
        <img id="logoGestao" alt="Logotipo da Empresa" class="h-14">
        <h2 class="flex-grow" style="margin-bottom: 0;">Gestão de Frotas</h2>
    </div>
    <p class="text-gray-600 mb-8">Selecione uma das opções abaixo para gerenciar a frota de empilhadeiras.</p>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
        <button class="btn dark-primary" onclick="window.showApp('statusDeAtividadePanel')">Status de Atividade</button>
        <button class="btn dark-primary" onclick="window.showApp('manutencaoPanel')">Gestão de Manutenção</button>
        <button class="btn dark-primary" onclick="window.showApp('abastecimentoPanel')">Gestão de Abastecimento</button>
        <button class="btn dark-primary" onclick="window.alert('Função em desenvolvimento.')">Gestão de Pneus</button>
        <button class="btn dark-primary" onclick="window.showApp('statusDeAtividadePanel', 'cadastro')">Cadastro</button>
        <button class="btn dark-primary" onclick="window.showApp('statusDeAtividadePanel', 'relatorio')">Relatório</button>
    </div>
    <div class="flex justify-center mt-4">
        <button class="btn dark-primary" onclick="window.showApp('statusDeAtividadePanel', 'administrador')">Gerenciamento</button>
    </div>
</div>

<!-- Painel da Aplicação de Atividade de Empilhadeiras (oculto por padrão) -->
<div class="card" id="statusDeAtividadePanel" style="display:none;">
  <div class="flex justify-between items-center mb-6">
    <div class="flex items-center gap-4">
        <img id="logoStatus" alt="Logotipo da Empresa" class="h-14">
        <h2 id="panelTitle" style="margin-bottom: 0;">Status de Atividade</h2>
    </div>
    <div>
        <!-- Botão Administrador removido daqui, agora acessível via "Gerenciamento" na tela principal -->
        <button class="btn red" onclick="window.showApp('gestaoDeFrotasPanel')">Voltar</button>
    </div>
  </div>
  
  <div class="flex flex-wrap justify-center mb-8 gap-3">
    <button class="btn yellow" id="btnDisponibilidade" onclick="window.mostrar('disponibilidade')">Disponibilidade</button>
    <button class="btn green" id="btnInicioAtividade" onclick="window.mostrar('inicio')">Início de Atividade</button>
    <button class="btn red" id="btnEncerramentoAtividade" onclick="window.mostrar('fim')">Encerramento de Atividade</button>
    <button class="btn blue" id="btnCadastro" style="display:none;" onclick="window.mostrar('cadastro')">Cadastro</button>
    <button class="btn blue" id="btnRelatorio" style="display:none;" onclick="window.mostrar('relatorio')">Relatório</button>
    <button class="btn darkblue" id="btnDados" style="display:none;" onclick="window.mostrar('dados')">Dados</button>
  </div>
  
  <div id="inicio" style="display:none; margin-top:20px;">
    <h3>Início de Atividade</h3>
    <form id="formInicio">
      <div class="flex justify-end mb-4">
        <button class="btn red" type="button" onclick="window.limparFormulario('formInicio')">Limpar Formulário</button>
      </div>
      <div class="field">
        <label for="crachaInicio">Crachá</label>
        <input type="text" name="crachaInicio" id="crachaInicio" oninput="this.value = this.value.toUpperCase(); window.buscarOperador(this.value,'nomeInicio','fotoInicio');" required>
        <label for="nomeInicio">Operador</label>
        <input type="text" id="nomeInicio" readonly>
        <img id="fotoInicio" src="https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR" alt="Foto Operador">
      </div>
      <div class="field">
        <label for="dataInicial">Data Inicial</label>
        <input type="date" name="dataInicial" id="dataInicial" required onclick="confirmarDataHora('dataInicial','horaInicial')">
      </div>
      <div class="field">
        <label for="horaInicial">Hora Inicial</label>
        <input type="time" id="horaInicial" name="horaInicial" required>
      </div>
      <div class="field">
        <label for="frotaInicio">Frota</label>
        <input type="text" name="frotaInicio" id="frotaInicio" oninput="this.value = this.value.toUpperCase(); window.mostrarModeloFrota(this.value,'equipamentoInicio','fotoEquipInicio');" required>
        <img id="fotoEquipInicio" src="https://placehold.co/100x100/A0AEC0/000000?text=FROTA" alt="Foto Frota">
      </div>
      <div class="field">
        <label for="equipamentoInicio">Equipamento</label>
        <input type="text" id="equipamentoInicio" readonly>
      </div>
      <div class="field">
        <label for="horimetroInicial">Horímetro Inicial</label>
        <input type="text" name="horimetroInicial" id="horimetroInicial" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" required>
      </div>
      <div class="field">
        <label for="setorInicio">Setor</label>
        <select id="setorInicio" required></select>
      </div>
      <div class="field">
        <label for="atividadeInicio">Atividade</label>
        <select id="atividadeInicio" onchange="window.toggleRelatoProblema()" required></select>
      </div>
      <div class="field" id="relatoProblemaField" style="display:none;">
        <label for="relatoProblema">Relato do Problema</label>
        <textarea name="relatoProblema" id="relatoProblema" rows="3" placeholder="Descreva o problema da manutenção"></textarea>
      </div>
      <div class="field">
        <label for="implementoInicio">Implemento</label>
        <select id="implementoInicio" required></select>
      </div>
      <div class="checklist" id="safetyChecklist">
        <h4 class="font-bold uppercase text-center mb-4">Checklist de Segurança</h4>
        <div class="grid grid-cols-12 gap-2 items-center text-center font-bold text-gray-700 text-sm mb-2">
            <div class="col-span-1">OK</div>
            <div class="col-span-6 text-left cursor-pointer" onclick="window.hideAllChecklistReports()">ITENS A CONFERIR</div>
            <div class="col-span-2">NÃO CONFORME</div>
            <div class="col-span-3 text-left">RELATAR</div>
        </div>
        <div class="grid grid-cols-12 gap-2 items-center mb-3">
            <div class="col-span-1 flex justify-center"><input type="radio" name="status_OleoMotor" value="OK" checked required></div>
            <div class="col-span-6 text-left text-sm">Óleo do Motor</div>
            <div class="col-span-2 flex justify-center"><input type="radio" name="status_OleoMotor" value="NÃO CONFORME" data-target-textarea="relato_OleoMotor" onchange="window.toggleNonConformityReport(this)"></div>
            <div class="col-span-3"><textarea name="relato_OleoMotor" id="relato_OleoMotor" rows="1" placeholder="Relatar não conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea></div>
        </div>
        <div class="grid grid-cols-12 gap-2 items-center mb-3">
            <div class="col-span-1 flex justify-center"><input type="radio" name="status_OleoHidraulico" value="OK" checked required></div>
            <div class="col-span-6 text-left text-sm">Óleo Hidráulico</div>
            <div class="col-span-2 flex justify-center"><input type="radio" name="status_OleoHidraulico" value="NÃO CONFORME" data-target-textarea="relato_OleoHidraulico" onchange="window.toggleNonConformityReport(this)"></div>
            <div class="col-span-3"><textarea name="relato_OleoHidraulico" id="relato_OleoHidraulico" rows="1" placeholder="Relatar não conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea></div>
        </div>
        <div class="grid grid-cols-12 gap-2 items-center mb-3">
            <div class="col-span-1 flex justify-center"><input type="radio" name="status_OleoTransmissao" value="OK" checked required></div>
            <div class="col-span-6 text-left text-sm">Óleo da Transmissão</div>
            <div class="col-span-2 flex justify-center"><input type="radio" name="status_OleoTransmissao" value="NÃO CONFORME" data-target-textarea="relato_OleoTransmissao" onchange="window.toggleNonConformityReport(this)"></div>
            <div class="col-span-3"><textarea name="relato_OleoTransmissao" id="relato_OleoTransmissao" rows="1" placeholder="Relatar não conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea></div>
        </div>
        <div class="grid grid-cols-12 gap-2 items-center mb-3">
            <div class="col-span-1 flex justify-center"><input type="radio" name="status_Extintor" value="OK" checked required></div>
            <div class="col-span-6 text-left text-sm">Extintor</div>
            <div class="col-span-2 flex justify-center"><input type="radio" name="status_Extintor" value="NÃO CONFORME" data-target-textarea="relato_Extintor" onchange="window.toggleNonConformityReport(this)"></div>
            <div class="col-span-3"><textarea name="relato_Extintor" id="relato_Extintor" rows="1" placeholder="Relatar não conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea></div>
        </div>
        <div class="grid grid-cols-12 gap-2 items-center mb-3">
            <div class="col-span-1 flex justify-center"><input type="radio" name="status_Pneus" value="OK" checked required></div>
            <div class="col-span-6 text-left text-sm">Pneus</div>
            <div class="col-span-2 flex justify-center"><input type="radio" name="status_Pneus" value="NÃO CONFORME" data-target-textarea="relato_Pneus" onchange="window.toggleNonConformityReport(this)"></div>
            <div class="col-span-3"><textarea name="relato_Pneus" id="relato_Pneus" rows="1" placeholder="Relatar não conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea></div>
        </div>
        <div class="grid grid-cols-12 gap-2 items-center mb-3">
            <div class="col-span-1 flex justify-center"><input type="radio" name="status_ParteEletrica" value="OK" checked required></div>
            <div class="col-span-6 text-left text-sm">Parte Elétrica</div>
            <div class="col-span-2 flex justify-center"><input type="radio" name="status_ParteEletrica" value="NÃO CONFORME" data-target-textarea="relato_ParteEletrica" onchange="window.toggleNonConformityReport(this)"></div>
            <div class="col-span-3"><textarea name="relato_ParteEletrica" id="relato_ParteEletrica" rows="1" placeholder="Relatar não conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea></div>
        </div>
      </div>
      <button class="btn blue mt-6" type="button" onclick="window.enviarInicio(event)">Salvar Início</button>
    </form>
  </div>
  
  <div id="disponibilidade" style="display:none; margin-top:20px;">
    <h3>Disponibilidade</h3>
    <div id="disponibilidadeContent"><p class="text-gray-600">Nenhuma frota cadastrada ou atividade em andamento para exibir.</p></div>
    <div id="frotasEmManutencaoList" class="mt-8 p-6 border border-red-300 rounded-lg bg-red-50 shadow-md" style="display: none;">
      <h4 class="text-xl font-bold mb-4 text-red-700">Frotas em Manutenção</h4>
      <ul id="manutencaoItems" class="list-disc pl-5 text-red-600 text-base leading-relaxed"></ul>
    </div>
  </div>
  
  <div id="fim" style="display:none; margin-top:20px;">
    <h3>Fim de Atividade</h3>
    <form id="formFim">
      <div class="flex justify-end mb-4"><button class="btn red" type="button" onclick="window.limparFormulario('formFim')">Limpar Formulário</button></div>
      <div class="field">
        <label for="crachaFim">Crachá</label>
        <input type="text" name="crachaFim" id="crachaFim" oninput="this.value = this.value.toUpperCase(); window.handleCrachaFimChange();" required>
        <label for="nomeFim">Operador</label>
        <input type="text" id="nomeFim" readonly>
        <img id="fotoFim" src="https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR" alt="Foto Operador">
      </div>
      <div class="field">
        <label for="dataFinal">Data Final</label>
        <input type="date" name="dataFinal" id="dataFinal" required onclick="window.confirmarDataHora('dataFinal', 'horaFinal')">
      </div>
      <div class="field">
        <label for="horaFinal">Hora Final</label>
        <input type="time" id="horaFinal" name="horaFinal" required>
      </div>
      <div class="field">
        <label for="frotaFim">Frota</label>
        <input type="text" name="frotaFim" id="frotaFim" oninput="this.value = this.value.toUpperCase(); window.mostrarModeloFrota(this.value,'equipamentoFim','fotoEquipFim')" required>
        <img id="fotoEquipFim" src="https://placehold.co/100x100/A0AEC0/000000?text=FROTA" alt="Foto Frota">
      </div>
      <div class="field" id="frotaSelectionContainer" style="display:none;">
          <label for="selectFrotaAtiva">Selecione a Frota:</label>
          <div id="multipleFrotaWarning" class="text-red-700 font-semibold mb-2" style="display:none;"></div>
          <select id="selectFrotaAtiva" onchange="window.selecionarFrotaAtiva(this.value)"></select>
      </div>
      <div class="field">
        <label for="equipamentoFim">Equipamento</label>
        <input type="text" id="equipamentoFim" readonly>
      </div>
      <div class="field">
        <label for="horimetroFim">Horímetro Final</label>
        <input type="text" name="horimetroFim" id="horimetroFim" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" required>
      </div>
      <div class="field">
        <label for="observacoesFim">Observações</label>
        <textarea name="observacoesFim" id="observacoesFim" rows="3"></textarea>
      </div>
      <button class="btn green mt-6" type="button" onclick="window.enviarFim(event)">Finalizar</button>
    </form>
  </div>
  
  <div id="cadastro" class="admin-panel">
    <h3>Cadastro</h3> 
    <div class="flex flex-wrap justify-center mb-6 gap-3">
      <button class="btn blue" onclick="window.mostrarCadastro('cadastroOperador')">Operador</button>
      <button class="btn blue" onclick="window.mostrarCadastro('cadastroFrota')">Frota</button>
      <button class="btn blue" onclick="window.mostrarCadastro('cadastroSetor')">Setor</button>
      <button class="btn blue" onclick="window.mostrarCadastro('cadastroAtividade')">Atividade</button>
      <button class="btn blue" onclick="window.mostrarCadastro('cadastroImplemento')">Implemento</button>
    </div>
    <div id="cadastroOperador" style="display:none; margin-top:10px;">
      <h4>Cadastro de Operador</h4>
      <form><div class="field"><label for="crachaOperador">Crachá</label><input type="text" id="crachaOperador" oninput="this.value = this.value.toUpperCase()"></div>
      <div class="field"><label for="nomeOperador">Operador</label><input type="text" id="nomeOperador" oninput="this.value = this.value.toUpperCase()"></div>
      <div class="field"><label for="fotoOperador">Foto</label><input type="file" id="fotoOperador" accept="image/*" capture></div>
      <div class="flex justify-start gap-4 mt-6"><button class="btn blue" type="button" onclick="window.salvarOperador()">Salvar</button><button class="btn blue" type="button" onclick="window.consultarOperador()">Consultar</button></div></form>
    </div>
    <div id="cadastroFrota" style="display:none; margin-top:10px;">
      <h4>Cadastro de Frota</h4>
      <form><div class="field"><label for="codigoFrota">Frota</label><input type="text" id="codigoFrota" oninput="this.value = this.value.toUpperCase()"></div>
      <div class="field"><label for="modeloFrota">Modelo</label><input type="text" id="modeloFrota" oninput="this.value = this.value.toUpperCase()"></div>
      <div class="field"><label for="fotoFrota">Foto</label><input type="file" id="fotoFrota" accept="image/*" capture></div>
      <div class="flex justify-start gap-4 mt-6"><button class="btn blue" type="button" onclick="window.salvarFrota()">Salvar</button><button class="btn blue" type="button" onclick="window.consultarFrota()">Consultar</button></div></form>
    </div>
    <div id="cadastroSetor" style="display:none; margin-top:10px;">
      <h4>Cadastro de Setor</h4>
      <div class="field"><label for="nomeSetor">Setor</label><input type="text" id="nomeSetor" oninput="this.value = this.value.toUpperCase()"></div>
      <div class="flex justify-start gap-4 mt-6"><button class="btn blue" onclick="window.salvarSetor()">Salvar</button><button class="btn blue" onclick="window.consultarSetor()">Consultar</button></div>
    </div>
    <div id="cadastroAtividade" style="display:none; margin-top:10px;">
      <h4>Cadastro de Atividade</h4>
      <div class="field"><label for="nomeAtividade">Atividade</label><input type="text" id="nomeAtividade" oninput="this.value = this.value.toUpperCase()"></div>
      <div class="flex justify-start gap-4 mt-6"><button class="btn blue" type="button" onclick="window.salvarAtividade()">Salvar</button><button class="btn blue" type="button" onclick="window.consultarAtividade()">Consultar</button></div></form>
    </div>
    <div id="cadastroImplemento" style="display:none; margin-top:10px;">
      <h4>Cadastro de Implemento</h4>
      <div class="field"><label for="nomeImplemento">Implemento</label><input type="text" id="nomeImplemento" oninput="this.value = this.value.toUpperCase()"></div>
      <div class="field"><label for="siglaImplemento">Sigla</label><input type="text" id="siglaImplemento" required oninput="this.value = this.value.toUpperCase()"></div>
      <div class="flex justify-start gap-4 mt-6"><button class="btn blue" onclick="window.salvarImplemento()">Salvar</button><button class="btn blue" type="button" onclick="window.consultarImplemento()">Consultar</button></div>
    </div>
  </div>

  <div id="administrador" class="admin-panel">
    <h3>Painel Administrativo</h3>
    <div id="adminLogin" style="display:block;">
      <h4>Login de Administrador</h4>
      <div class="field"><label for="adminUsername">Usuário</label><input type="text" id="adminUsername" required></div>
      <div class="field"><label for="adminPassword">Senha</label><input type="password" id="adminPassword" required></div>
      <button class="btn purple mt-6" onclick="window.handleLogin()">Entrar</button>
      <p class="text-sm text-gray-600 mt-4">Axyn: Menos custos, mais controle. Simples assim.</p>
    </div>
    <div id="adminDashboard" style="display:none; margin-top:20px;">
      <h4>Bem-vindo, <span id="loggedInUserRoleDisplay"></span>!</h4>
      <p class="mb-4 text-gray-700">Você está logado com acesso <span id="loggedInUserLevelDisplay" class="font-bold"></span>.</p>
      <div id="userManagement" class="mt-8 p-6 border border-blue-300 rounded-lg bg-blue-50 shadow-md" style="display: none;">
        <h4 class="text-xl font-bold mb-4 text-blue-800">Gerenciamento de Usuários</h4>
        <div class="field"><label for="newUsername">Usuário</label><input type="text" id="newUsername" placeholder="Novo usuário" required></div>
        <div class="field"><label for="newPassword">Senha</label><input type="password" id="newPassword" placeholder="Nova senha" required></div>
        <div class="field">
          <label for="newUserLevel">Nível</label>
          <select id="newUserLevel" required>
            <option value="">Selecione o Nível</option>
            <option value="operacao">Operação</option>
            <option value="analista">Analista</option>
            <option value="administrador">Administrador</option>
          </select>
        </div>
        <button class="btn blue mt-6" onclick="window.salvarUsuario()">Salvar Usuário</button>
        <h5 class="font-bold mt-8 mb-4 text-gray-700">Usuários Cadastrados:</h5>
        <div id="userListContainer" class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg bg-white shadow-inner">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuário</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nível</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
              </tr>
            </thead>
            <tbody id="userList" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
      <button class="btn red mt-6" onclick="window.logout()">Sair</button>
    </div>
  </div>

  <div id="relatorio" style="display:none; margin-top:20px;">
    <h3>Relatórios</h3>
    <div class="field">
        <label for="tipoRelatorio">Tipo de Relatório</label>
        <select id="tipoRelatorio">
            <option value="horasFrota">Horas por Frota</option>
            <option value="atividadesOperador">Atividades por Operador</option>
            <option value="manutencoes">Manutenções</option>
            <option value="disponibilidade">Tempo de Disponibilidade de Frotas</option>
            <option value="comparativoHoras">Horímetro vs. Apontamento</option>
            <option value="atividades">Relatório de Atividades</option>
            <option value="setor">Relatório por Setor</option>
            <option value="edicoes">Relatório de Apontamentos Inconsistentes</option>
            <option value="consumoFrota">Consumo por Frota</option>
            <option value="custosCombustivel">Custos de Combustível</option>
        </select>
    </div>
    <div class="field">
      <label for="relatorioDataInicio">Data de Início</label>
      <input type="date" id="relatorioDataInicio">
    </div>
    <div class="field">
      <label for="relatorioDataFim">Data de Fim</label>
      <input type="date" id="relatorioDataFim">
    </div>
    <button class="btn blue mt-4" onclick="window.gerarRelatorio()">Gerar Relatório</button>
    <!-- Botão Dados movido para cá -->
    <button class="btn darkblue mt-4" onclick="window.mostrar('dados')">Dados</button>
    <div id="relatorioResultado" class="mt-6"></div>
  </div>

  <div id="dados" style="display:none; margin-top:20px;">
    <h3>Banco de Dados de Lançamentos</h3>
    <p class="text-gray-600 mb-4">Visualize e gerencie todos os lançamentos históricos. Alterações requerem senha de administrador.</p>
    <div id="dadosContent" class="mt-4"></div>
  </div>
</div>

<!-- Maintenance Panel -->
<div class="card" id="manutencaoPanel" style="display:none;">
    <div class="flex justify-between items-center mb-6">
        <h3>Gestão de Manutenção</h3>
        <button class="btn red" onclick="window.showApp('gestaoDeFrotasPanel')">Voltar</button>
    </div>
    <div class="flex flex-wrap justify-center mb-6 gap-3">
        <button class="btn blue" onclick="window.mostrarManutencaoSubpanel('formAbrirOS')">Abrir Ordem de Serviço</button>
        <button class="btn green" onclick="window.mostrarManutencaoSubpanel('formPlanosManutencao')">Planos de Manutenção</button>
        <button class="btn orange" onclick="window.mostrarManutencaoSubpanel('consultarOS')">Consultar Ordens de Serviço</button>
        <button class="btn teal" onclick="window.mostrarManutencaoSubpanel('gestaoPecas')">Gestão de Peças</button>
        <button class="btn purple" onclick="window.mostrarManutencaoSubpanel('orcamentosAprovacoes')">Orçamentos e Aprovações</button>
        <button class="btn darkblue" onclick="window.mostrarManutencaoSubpanel('historicoManutencao')">Histórico de Manutenção</button>
    </div>

    <div id="formAbrirOS" style="display:none;">
        <h4>Abrir Ordem de Serviço</h4>
        <form id="osForm">
            <div class="field"><label for="osFrota">Frota</label><input type="text" id="osFrota" oninput="this.value = this.value.toUpperCase(); window.mostrarModeloFrota(this.value, 'osModelo')" required><input type="text" id="osModelo" readonly placeholder="Modelo"></div>
            <div class="field"><label for="osDataAbertura">Data Abertura</label><input type="text" id="osDataAbertura" readonly></div>
            <div class="field"><label for="osSolicitante">Solicitante</label><input type="text" id="osSolicitante" required></div>
            <div class="field"><label for="osDescricao">Descrição do Problema</label><textarea id="osDescricao" rows="3" required></textarea></div>
            <div class="field"><label for="osTipo">Tipo</label><select id="osTipo"><option value="Corretiva">Corretiva</option><option value="Preventiva">Preventiva</option></select></div>
            <button class="btn blue mt-4" type="button" onclick="window.salvarOS()">Abrir OS</button>
        </form>
    </div>
    <div id="formPlanosManutencao" style="display:none;">
        <h4>Planos de Manutenção</h4>
        <form id="planosManutencaoForm">
            <div class="field"><label for="planoFrota">Frota</label><input type="text" id="planoFrota" oninput="this.value = this.value.toUpperCase(); window.mostrarModeloFrota(this.value, 'planoModelo')" required><input type="text" id="planoModelo" readonly placeholder="Modelo"></div>
            <div class="field"><label for="planoDescricao">Descrição</label><textarea id="planoDescricao" rows="2" required></textarea></div>
            <div class="field"><label for="tipoManutencao">Tipo</label><select id="tipoManutencao" required><option value="Horímetro">Baseado em Horímetro</option><option value="Tempo">Baseado em Tempo</option></select></div>
            <div class="field" id="horimetroIntervalField"><label for="horimetroInterval">Intervalo (Horímetro)</label><input type="text" id="horimetroInterval" oninput="this.value = this.value.replace(/[^0-9.]/g, '')"></div>
            <div class="field" id="tempoIntervalField" style="display:none;"><label for="tempoInterval">Intervalo (dias)</label><input type="text" id="tempoInterval" oninput="this.value = this.value.replace(/[^0-9]/g, '')"></div>
            <div class="field"><label for="ultimaManutencao">Última Manutenção</label><input type="date" id="ultimaManutencao"></div>
            <button class="btn blue mt-4" type="button" onclick="window.salvarPlanoManutencao()">Salvar Plano</button>
        </form>
        <div id="planosManutencaoListContainer" class="mt-6">
            <h4>Planos Cadastrados</h4>
            <div id="planosManutencaoTable"></div>
        </div>
    </div>
    <div id="consultarOS" style="display:none;">
        <h4>Consultar Ordens de Serviço</h4>
        <div id="osListContainer">
            <p class="text-gray-600">Nenhuma Ordem de Serviço para exibir.</p>
        </div>
    </div>
    <div id="gestaoPecas" style="display:none;">
        <h4>Gestão de Peças</h4>
        <form id="pecaForm">
            <div class="field"><label for="nomePeca">Nome da Peça</label><input type="text" id="nomePeca" required></div>
            <div class="field"><label for="codPeca">Cód. Peça</label><input type="text" id="codPeca"></div>
            <div class="field"><label for="stockPeca">Stock</label><input type="number" id="stockPeca" required min="0"></div>
            <div class="field"><label for="minStockPeca">Stock Mínimo</label><input type="number" id="minStockPeca" min="0"></div>
            <div class="field"><label for="custoPeca">Custo Unitário (R$)</label><input type="text" id="custoPeca" oninput="this.value = this.value.replace(/[^0-9.]/g, '')"></div>
            <button class="btn blue mt-4" type="button" onclick="window.salvarPeca()">Salvar Peça</button>
        </form>
        <div id="pecasListContainer" class="mt-6">
            <h4>Inventário de Peças</h4>
            <div id="pecasTable"></div>
        </div>
    </div>
    <div id="orcamentosAprovacoes" style="display:none;">
        <h4>Orçamentos e Aprovações</h4>
        <form id="orcamentoForm">
            <div class="field"><label for="orcamentoOsId">OS ID</label><input type="text" id="orcamentoOsId" oninput="this.value = this.value.replace(/[^0-9]/g, '')" required></div>
            <div class="field"><label for="orcamentoDescricao">Descrição Orçamento</label><textarea id="orcamentoDescricao" rows="2"></textarea></div>
            <div class="field"><label for="orcamentoValor">Valor Estimado (R$)</label><input type="text" id="orcamentoValor" oninput="this.value = this.value.replace(/[^0-9.]/g, '')" required></div>
            <button class="btn blue mt-4" type="button" onclick="window.salvarOrcamento()">Submeter Orçamento</button>
        </form>
        <div id="orcamentosListContainer" class="mt-6">
            <h4>Orçamentos Pendentes</h4>
            <div id="orcamentosTable"></div>
        </div>
    </div>
    <div id="historicoManutencao" style="display:none;">
        <h4>Histórico de Manutenção</h4>
        <div class="field"><label for="historicoFrotaFilter">Filtrar por Frota</label><input type="text" id="historicoFrotaFilter" oninput="this.value = this.value.toUpperCase(); window.consultarHistoricoManutencao()"></div>
        <div id="historicoManutencaoListContainer" class="mt-4">
            <p class="text-gray-600">Nenhum histórico de manutenção para exibir.</p>
        </div>
    </div>
</div>


<!-- Fueling Panel -->
<div class="card" id="abastecimentoPanel" style="display:none;">
    <div class="flex justify-between items-center mb-6">
        <h3>Gestão de Abastecimento</h3>
        <button class="btn red" onclick="window.showApp('gestaoDeFrotasPanel')">Voltar</button>
    </div>
    <div class="flex flex-wrap justify-center mb-6 gap-3">
      <button class="btn blue" onclick="window.mostrarAbastecimentoSubpanel('formAbastecimento')">Registrar Abastecimento</button>
      <button class="btn green" onclick="window.mostrarAbastecimentoSubpanel('formCompraCombustivel')">Registrar Compra de Combustível</button>
    </div>
    <div id="formAbastecimento" style="display:none;">
        <h4>Registrar Abastecimento</h4>
        <form id="abastecimentoForm">
            <div class="field"><label for="abastecimentoFrota">Frota</label><input type="text" id="abastecimentoFrota" oninput="this.value = this.value.toUpperCase(); window.mostrarModeloFrota(this.value, 'abastecimentoModelo')" required><input type="text" id="abastecimentoModelo" readonly placeholder="Modelo"></div>
            <div class="field"><label for="abastecimentoDoc">Documento/NF</label><input type="text" id="abastecimentoDoc" required></div>
            <div class="field"><label for="abastecimentoEmpresa">Empresa</label><input type="text" id="abastecimentoEmpresa" required></div>
            <div class="field"><label for="abastecimentoHorimetro">Horímetro</label><input type="text" id="abastecimentoHorimetro" oninput="this.value = this.value.replace(/[^0-9.]/g, '')" required></div>
            <div class="field"><label for="abastecimentoData">Data</label><input type="date" id="abastecimentoData" required></div>
            <div class="field"><label for="abastecimentoHora">Hora</label><input type="time" id="abastecimentoHora" required></div>
            <div class="field"><label for="abastecimentoMotorista">Crachá Motorista</label><input type="text" id="abastecimentoMotorista" oninput="this.value = this.value.toUpperCase(); window.buscarOperador(this.value, 'nomeMotorista')" required><input type="text" id="nomeMotorista" readonly placeholder="Nome do Motorista"></div>
            <div class="field"><label for="abastecimentoFrentista">Crachá Frentista</label><input type="text" id="abastecimentoFrentista" oninput="this.value = this.value.toUpperCase(); window.buscarOperador(this.value, 'nomeFrentista')" required><input type="text" id="nomeFrentista" readonly placeholder="Nome do Frentista"></div>
            <div class="field"><label for="abastecimentoCodProduto">Cód. Produto</label><input type="text" id="abastecimentoCodProduto" oninput="this.value = this.value.toUpperCase(); window.buscarProduto(this.value, 'nomeProduto')" required><input type="text" id="nomeProduto" readonly placeholder="Nome do Produto"></div>
            <div class="field"><label for="abastecimentoLocal">Local</label><select id="abastecimentoLocal" onchange="window.toggleVolumeRestante(this.value)"><option value="interno">Dentro da Empresa</option><option value="externo">Fora da Empresa</option></select></div>
            <div class="field" id="volumeRestanteField"><label for="volumeRestante">Volume Restante</label><input type="text" id="volumeRestante" readonly></div>
            <button class="btn blue mt-4" type="button" onclick="window.salvarAbastecimento()">Salvar</button>
        </form>
    </div>
    <div id="formCompraCombustivel" style="display:none;">
        <h4>Registrar Compra de Combustível</h4>
        <form id="compraCombustivelForm">
            <div class="field"><label for="compraCodProduto">Cód. Produto</label><input type="text" id="compraCodProduto" oninput="this.value = this.value.toUpperCase();" required></div>
            <div class="field"><label for="compraEmpresa">Empresa Comprado</label><input type="text" id="compraEmpresa" required></div>
            <div class="field"><label for="compraVolume">Volume (L)</label><input type="text" id="compraVolume" oninput="this.value = this.value.replace(/[^0-9.]/g, '')" required></div>
            <div class="field"><label for="compraValor">Valor (R$)</label><input type="text" id="compraValor" oninput="this.value = this.value.replace(/[^0-9.]/g, '')" required></div>
            <button class="btn green mt-4" type="button" onclick="window.salvarCompraCombustivel()">Salvar Compra</button>
        </form>
    </div>
</div>

<!-- Tires Panel -->
<div class="card" id="pneusPanel" style="display:none;">
    <div class="flex justify-between items-center mb-6">
        <h3>Gestão de Pneus</h3>
        <button class="btn red" onclick="window.showApp('gestaoDeFrotasPanel')">Voltar</button>
    </div>
    <p class="text-gray-600 mb-8">Esta seção está em desenvolvimento.</p>
</div>

<!-- Confirmation Modal -->
<div id="confirmationModal" class="modal">
    <div class="modal-content" id="modalContent">
        <h3 id="modalTitle">Confirmação</h3>
        <p id="modalMessage">Você tem certeza?</p>
        <div class="modal-buttons">
            <button id="modalConfirmBtn" class="btn green">Confirmar</button>
            <button id="modalCancelBtn" class="btn red">Cancelar</button>
        </div>
    </div>
</div>

<!-- List Display Modal -->
<div id="listModal" class="modal">
    <div class="modal-content">
        <h3 id="listModalTitle">Itens Cadastrados</h3>
        <div id="listModalContent" class="modal-list-content"></div>
        <div class="modal-buttons mt-4">
            <button id="listModalCloseBtn" class="btn red">Fechar</button>
        </div>
    </div>
</div>

<!-- Generic Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <h3 id="editModalTitle">Editar Item</h3>
        <form id="editForm" class="text-left"></form>
        <div class="modal-buttons mt-6">
            <button id="editModalSaveBtn" class="btn green">Salvar</button>
            <button id="editModalCancelBtn" class="btn red">Cancelar</button>
        </div>
    </div>
</div>


<script>
// --- DATABASE SETUP (IndexedDB) ---
let db;
const DB_NAME = 'ForkliftAppDB';
const DB_VERSION = 1;
const request = indexedDB.open(DB_NAME, DB_VERSION);

// Logotipo da Empresa
const logoUrl = "https://firebasestorage.googleapis.com/v0/b/generative-ai-sandbox-b9894.appspot.com/o/ChatGPT%20Image%203%20de%20jul.%20de%202025%2C%2017_55_58.jpg?alt=media&token=25087595-5028-444f-83a3-6119f448c903";

// Define os src das imagens do logotipo
document.addEventListener('DOMContentLoaded', () => {
    const logoGestao = document.getElementById('logoGestao');
    if (logoGestao) {
        logoGestao.src = logoUrl;
    }
    const logoStatus = document.getElementById('logoStatus');
    if (logoStatus) {
        logoStatus.src = logoUrl;
    }
});


// Manipuladores de eventos IndexedDB
request.onerror = (event) => {
    console.error("Erro ao abrir o IndexedDB:", event.target.errorCode);
    window.alert("Erro ao abrir o banco de dados. A aplicação pode não funcionar corretamente.");
};

request.onsuccess = (event) => {
    db = event.target.result;
    console.log("IndexedDB aberto com sucesso.");
    // Inicia o aplicativo após o IndexedDB estar pronto
    window.showApp('gestaoDeFrotasPanel');
    window.populateSelects();
    window.checkLoginState();
};

request.onupgradeneeded = (event) => {
    db = event.target.result;
    console.log("Atualização de esquema do IndexedDB.");

    // Cria object stores se não existirem
    if (!db.objectStoreNames.contains('operadores')) {
        db.createObjectStore('operadores', { keyPath: 'cracha' });
    }
    if (!db.objectStoreNames.contains('frotas')) {
        db.createObjectStore('frotas', { keyPath: 'codigo' });
    }
    if (!db.objectStoreNames.contains('setores')) {
        db.createObjectStore('setores', { keyPath: 'nome' }); // Changed to 'nome' as keyPath
    }
    if (!db.objectStoreNames.contains('atividades')) {
        db.createObjectStore('atividades', { keyPath: 'nome' }); // Changed to 'nome' as keyPath
    }
    if (!db.objectStoreNames.contains('implementos')) {
        db.createObjectStore('implementos', { keyPath: 'nome' }); // Changed to 'nome' as keyPath
    }
    if (!db.objectStoreNames.contains('atividadesEmAndamento')) {
        db.createObjectStore('atividadesEmAndamento', { keyPath: 'id', autoIncrement: true });
    }
    if (!db.objectStoreNames.contains('historicoAtividades')) {
        const historicoStore = db.createObjectStore('historicoAtividades', { keyPath: 'id', autoIncrement: true });
        historicoStore.createIndex('frota', 'frota', { unique: false });
        historicoStore.createIndex('cracha', 'cracha', { unique: false });
        historicoStore.createIndex('setor', 'setor', { unique: false });
    }
    if (!db.objectStoreNames.contains('usuarios')) {
        db.createObjectStore('usuarios', { keyPath: 'username' });
    }
    if (!db.objectStoreNames.contains('ordensServico')) {
        db.createObjectStore('ordensServico', { keyPath: 'id', autoIncrement: true });
    }
    if (!db.objectStoreNames.contains('abastecimentos')) {
        db.createObjectStore('abastecimentos', { keyPath: 'id', autoIncrement: true });
    }
    if (!db.objectStoreNames.contains('comprasCombustivel')) {
        db.createObjectStore('comprasCombustivel', { keyPath: 'id', autoIncrement: true });
    }
    // New object stores for Maintenance Management improvements
    if (!db.objectStoreNames.contains('maintenancePlans')) {
        db.createObjectStore('maintenancePlans', { keyPath: 'id', autoIncrement: true });
    }
    if (!db.objectStoreNames.contains('partsInventory')) {
        db.createObjectStore('partsInventory', { keyPath: 'id', autoIncrement: true });
    }
    if (!db.objectStoreNames.contains('repairBudgets')) {
        db.createObjectStore('repairBudgets', { keyPath: 'id', autoIncrement: true });
    }
};

// --- NAVIGATION ---
window.showApp = function(panelId, subPanelId = '') {
    document.getElementById('gestaoDeFrotasPanel').style.display = 'none';
    document.getElementById('statusDeAtividadePanel').style.display = 'none';
    document.getElementById('manutencaoPanel').style.display = 'none'; // Ensure maintenance panel is hidden
    document.getElementById('abastecimentoPanel').style.display = 'none'; // Ensure abastecimento panel is hidden
    document.getElementById('pneusPanel').style.display = 'none'; // Ensure pneus panel is hidden

    document.getElementById(panelId).style.display = 'block';
    
    if (panelId === 'statusDeAtividadePanel') {
        window.mostrar(subPanelId || 'disponibilidade'); // Default to 'disponibilidade' if no subPanelId is provided
    } else if (panelId === 'manutencaoPanel') {
        window.mostrarManutencaoSubpanel('formAbrirOS'); // Default to 'Abrir OS'
    } else if (panelId === 'abastecimentoPanel') {
        window.mostrarAbastecimentoSubpanel('formAbastecimento'); // Default to 'Registrar Abastecimento'
    }
}

window.mostrar = function(idToShow) {
  const sections = ['inicio', 'disponibilidade', 'fim', 'cadastro', 'administrador', 'relatorio', 'dados'];
  const panelTitle = document.getElementById('panelTitle');
  
  // Get all navigation buttons within statusDeAtividadePanel
  const btnDisponibilidade = document.getElementById('btnDisponibilidade');
  const btnInicioAtividade = document.getElementById('btnInicioAtividade');
  const btnEncerramentoAtividade = document.getElementById('btnEncerramentoAtividade');
  const btnCadastro = document.getElementById('btnCadastro');
  const btnRelatorio = document.getElementById('btnRelatorio');
  const btnDados = document.getElementById('btnDados');

  // Hide all navigation buttons first
  [btnDisponibilidade, btnInicioAtividade, btnEncerramentoAtividade, btnCadastro, btnRelatorio, btnDados].forEach(btn => {
    if (btn) btn.style.display = 'none';
  });

  sections.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = (id === idToShow) ? 'block' : 'none';
  });

  // Now, selectively show buttons based on the active section
  if (idToShow === 'disponibilidade' || idToShow === 'inicio' || idToShow === 'fim') {
    btnDisponibilidade.style.display = 'inline-block';
    btnInicioAtividade.style.display = 'inline-block';
    btnEncerramentoAtividade.style.display = 'inline-block';
  } else if (idToShow === 'relatorio') {
    // When 'relatorio' is active, hide 'btnRelatorio' and show 'btnDados'
    btnDados.style.display = 'inline-block';
  }
  // For 'cadastro' and 'dados' (when 'dados' is the active panel), no buttons from this nav bar should be shown.
  // For 'administrador', no buttons from this nav bar should be shown.

  switch(idToShow) {
    case 'disponibilidade': panelTitle.textContent = 'Status de Atividade'; window.updateDisponibilidade(); break;
    case 'inicio': panelTitle.textContent = 'Iniciar Atividade'; window.populateSelects(); window.populateCurrentDateTime('dataInicial', 'horaInicial'); break;
    case 'fim': panelTitle.textContent = 'Encerrar Atividade'; window.populateCurrentDateTime('dataFinal', 'horaFinal'); break;
    case 'cadastro': panelTitle.textContent = 'Gerenciar Cadastros'; window.mostrarCadastro('cadastroOperador'); break;
    case 'administrador': panelTitle.textContent = 'Painel Administrativo'; window.checkLoginState(); break;
    case 'relatorio': panelTitle.textContent = 'Relatórios'; document.getElementById('relatorioResultado').innerHTML = ''; break;
    case 'dados': panelTitle.textContent = 'Gerenciar Dados'; window.mostrarBancoDeDados(); break;
  }
}

window.mostrarManutencaoSubpanel = function(subPanelId) {
    const subPanelsManutencao = ['formAbrirOS', 'formPlanosManutencao', 'consultarOS', 'gestaoPecas', 'orcamentosAprovacoes', 'historicoManutencao'];
    subPanelsManutencao.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });

    const targetPanel = document.getElementById(subPanelId);
    if (targetPanel) {
        targetPanel.style.display = 'block';
    }

    if (subPanelId === 'formAbrirOS') {
        window.populateCurrentDateTime('osDataAbertura');
    } else if (subPanelId === 'consultarOS') {
        window.consultarOrdensServico();
    } else if (subPanelId === 'formPlanosManutencao') {
        window.consultarPlanosManutencao();
        // Set initial state for interval fields
        const tipoManutencao = document.getElementById('tipoManutencao').value;
        document.getElementById('horimetroIntervalField').style.display = tipoManutencao === 'Horímetro' ? 'flex' : 'none';
        document.getElementById('tempoIntervalField').style.display = tipoManutencao === 'Tempo' ? 'flex' : 'none';
    } else if (subPanelId === 'gestaoPecas') {
        window.consultarPecas();
    } else if (subPanelId === 'orcamentosAprovacoes') {
        window.consultarOrcamentos();
    } else if (subPanelId === 'historicoManutencao') {
        window.consultarHistoricoManutencao();
    }
}

window.mostrarAbastecimentoSubpanel = function(subPanelId) {
    const subPanelsAbastecimento = ['formAbastecimento', 'formCompraCombustivel'];
    subPanelsAbastecimento.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });

    const targetPanel = document.getElementById(subPanelId);
    if (targetPanel) {
        targetPanel.style.display = 'block';
    }

    if (subPanelId === 'formAbastecimento') {
        window.populateCurrentDateTime('abastecimentoData', 'abastecimentoHora');
        window.toggleVolumeRestante(document.getElementById('abastecimentoLocal').value);
    }
}


// --- AUTHENTICATION & USER STATE ---
let currentUser = null;

window.checkLoginState = function() {
    const loggedInUser = sessionStorage.getItem('loggedInUser');
    if (loggedInUser) {
        currentUser = JSON.parse(loggedInUser);
        window.showAdminDashboard();
    } else {
        document.getElementById('adminLogin').style.display = 'block';
        document.getElementById('adminDashboard').style.display = 'none';
    }
}

// --- GENERIC HELPER FUNCTIONS ---
window.saveData = function(storeName, data, successMessage) {
    if (!db) { window.alert("Banco de dados não está pronto."); return; }
    const transaction = db.transaction([storeName], 'readwrite');
    const store = transaction.objectStore(storeName);
    const request = store.put(data);
    request.onsuccess = () => { window.alert(successMessage); };
    request.onerror = (event) => { console.error(`Error saving to ${storeName}:`, event.target.error); window.alert(`Erro ao salvar em ${storeName}.`); };
}

window.getAllData = function(storeName) {
    return new Promise((resolve, reject) => {
        if (!db) return reject("Banco de dados não está pronto.");
        const request = db.transaction([storeName], 'readonly').objectStore(storeName).getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = (event) => reject(`Error fetching from ${storeName}: ${event.target.error}`);
    });
}

window.fileToBase64 = function(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

window.populateSelects = async function() {
    try {
        const [setores, atividades, implementos] = await Promise.all([
            window.getAllData('setores'),
            window.getAllData('atividades'),
            window.getAllData('implementos')
        ]);

        const setorSelect = document.getElementById('setorInicio');
        const atividadeSelect = document.getElementById('atividadeInicio');
        const implementoSelect = document.getElementById('implementoInicio');

        [setorSelect, atividadeSelect, implementoSelect].forEach(s => s.innerHTML = '<option value="">Selecione...</option>');

        setores.forEach(item => setorSelect.innerHTML += `<option value="${item.nome}">${item.nome}</option>`);
        atividades.forEach(item => atividadeSelect.innerHTML += `<option value="${item.nome}">${item.nome}</option>`);
        implementos.forEach(item => implementoSelect.innerHTML += `<option value="${item.nome}">${item.nome} (${item.sigla})</option>`);
    } catch (error) {
        console.error("Failed to populate selects:", error);
    }
}

window.limparFormulario = function(formId) {
    const form = document.getElementById(formId);
    if (!form) return;
    form.reset();
    if (formId === 'formInicio') {
        document.getElementById('nomeInicio').value = '';
        document.getElementById('equipamentoInicio').value = '';
        document.getElementById('fotoInicio').src = 'https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR';
        document.getElementById('fotoEquipInicio').src = 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
        document.getElementById('relatoProblemaField').style.display = 'none';
        window.hideAllChecklistReports();
    } else if (formId === 'formFim') {
        document.getElementById('nomeFim').value = '';
        document.getElementById('equipamentoFim').value = '';
        document.getElementById('fotoFim').src = 'https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR';
        document.getElementById('fotoEquipFim').src = 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
        document.getElementById('frotaSelectionContainer').style.display = 'none';
    } else if (formId === 'osForm') {
        document.getElementById('osModelo').value = '';
    } else if (formId === 'abastecimentoForm') {
        document.getElementById('abastecimentoModelo').value = '';
        document.getElementById('nomeMotorista').value = '';
        document.getElementById('nomeFrentista').value = '';
        document.getElementById('nomeProduto').value = '';
    } else if (formId === 'planosManutencaoForm') {
        document.getElementById('planoModelo').value = '';
        document.getElementById('horimetroIntervalField').style.display = 'flex';
        document.getElementById('tempoIntervalField').style.display = 'none';
    } else if (formId === 'pecaForm') {
        // No specific readonly fields to clear
    } else if (formId === 'orcamentoForm') {
        // No specific readonly fields to clear
    }
}

window.populateCurrentDateTime = function(dateInputId, timeInputId) {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');

    const dateInput = document.getElementById(dateInputId);
    if (dateInput) {
        dateInput.value = `${year}-${month}-${day}`;
    }
    const timeInput = document.getElementById(timeInputId);
    if (timeInput) {
        timeInput.value = `${hours}:${minutes}`;
    }
}

// NEW/REFACTORED: Prompts the user to fill the date/time fields if they are empty.
window.promptAndFillDateTime = function(dateInputId, timeInputId) {
    const dateInput = document.getElementById(dateInputId);
    const timeInput = document.getElementById(timeInputId);

    // Only prompt to fill if both are empty
    if (!dateInput.value && !timeInput.value) {
        window.showModal(
            'Data e Hora Atuais',
            'Deseja preencher a data e a hora com o momento atual?',
            () => { // onConfirm callback
                window.populateCurrentDateTime(dateInputId, timeInputId);
            }
        );
    }
}

// NEW/REFACTORED: Validates that the selected date and time are not in the future.
window.validateDateTime = function(dateInputId, timeInputId) {
    const dateInput = document.getElementById(dateInputId);
    const timeInput = document.getElementById(timeInputId);
    const selectedDate = dateInput.value;
    const selectedTime = timeInput.value;

    if (!selectedDate || !selectedTime) {
        // This will be caught by the form's main validation check later.
        return true; 
    }

    const selectedDateTime = new Date(`${selectedDate}T${selectedTime}`);
    const now = new Date();

    // Allow a small buffer (e.g., 2 minutes) to prevent errors from submission delay
    if (selectedDateTime.getTime() > now.getTime() + 120000) {
        window.showModal("Data/Hora Inválida", "A data e hora não podem ser futuras. Por favor, corrija.", null, true);
        return false;
    }
    return true;
}

// --- MODAL FUNCTIONS ---
let modalConfirmCallback = null;
window.showModal = function(title, message, onConfirm, isWarning = false) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalMessage').textContent = message;
    document.getElementById('modalContent').classList.toggle('modal-warning-background', isWarning);
    modalConfirmCallback = onConfirm;
    document.getElementById('modalConfirmBtn').style.display = onConfirm ? 'inline-block' : 'none'; // Show confirm only if callback exists
    document.getElementById('modalCancelBtn').textContent = onConfirm ? 'Cancelar' : 'Fechar'; // Change text
    document.getElementById('confirmationModal').style.display = 'flex';
}
document.getElementById('modalConfirmBtn').onclick = () => { if (typeof modalConfirmCallback === 'function') modalConfirmCallback(); window.closeModal(); };
document.getElementById('modalCancelBtn').onclick = () => window.closeModal();
window.closeModal = function() { document.getElementById('confirmationModal').style.display = 'none'; modalConfirmCallback = null; }

document.getElementById('listModalCloseBtn').onclick = () => {
    document.getElementById('listModal').style.display = 'none';
};

document.getElementById('editModalCancelBtn').onclick = () => {
    document.getElementById('editModal').style.display = 'none';
};


window.showListModal = async function(title, data, headers, storeName) {
    const modal = document.getElementById('listModal');
    const titleEl = document.getElementById('listModalTitle');
    const contentEl = document.getElementById('listModalContent');

    titleEl.textContent = title;
    contentEl.innerHTML = '';

    if (!data || data.length === 0) {
        contentEl.innerHTML = '<p class="text-gray-600">Nenhum item cadastrado.</p>';
        modal.style.display = 'flex';
        return;
    }

    const table = document.createElement('table');
    table.className = 'consult-table w-full';
    
    const thead = table.createTHead();
    const headerRow = thead.insertRow();
    for (const key in headers) {
        const th = document.createElement('th');
        th.textContent = headers[key];
        headerRow.appendChild(th);
    }
    const thActions = document.createElement('th');
    thActions.textContent = 'Ações';
    headerRow.appendChild(thActions);

    const tbody = table.createTBody();
    data.forEach(item => {
        const row = tbody.insertRow();
        for (const key in headers) {
            const cell = row.insertCell();
            if (key === 'foto' && item[key]) {
                const img = document.createElement('img');
                img.src = item[key];
                img.alt = 'Foto';
                img.className = 'w-12 h-12 object-cover rounded';
                cell.appendChild(img);
            } else {
                cell.textContent = item[key] || '-';
            }
        }
        const actionsCell = row.insertCell();
        actionsCell.className = 'flex gap-2';
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Alterar';
        editBtn.className = 'btn blue text-xs p-1';
        editBtn.onclick = () => window.handleEdit(storeName, item);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Excluir';
        deleteBtn.className = 'btn red text-xs p-1';
        deleteBtn.onclick = () => window.handleDelete(storeName, item[db.transaction(storeName).objectStore(storeName).keyPath]);
        
        actionsCell.appendChild(editBtn);
        actionsCell.appendChild(deleteBtn);
    });

    contentEl.appendChild(table);
    modal.style.display = 'flex';
}

// --- CADASTRO (REGISTRATION) FUNCTIONS ---
window.mostrarCadastro = function(subpanel) {
    ['cadastroOperador', 'cadastroFrota', 'cadastroSetor', 'cadastroAtividade', 'cadastroImplemento'].forEach(p => {
        document.getElementById(p).style.display = p === subpanel ? 'block' : 'none';
    });
}
window.salvarOperador = async function() {
    const cracha = document.getElementById('crachaOperador').value.trim();
    const nome = document.getElementById('nomeOperador').value.trim();
    const fotoFile = document.getElementById('fotoOperador').files[0];
    if (!cracha || !nome) { window.alert("Crachá e Nome são obrigatórios."); return; }
    const foto = fotoFile ? await window.fileToBase64(fotoFile) : null;
    window.saveData('operadores', { cracha, nome, foto }, "Operador salvo com sucesso!");
    document.getElementById('cadastroOperador').querySelector('form').reset();
}
window.salvarFrota = async function() {
    const codigo = document.getElementById('codigoFrota').value.trim();
    const modelo = document.getElementById('modeloFrota').value.trim();
    const fotoFile = document.getElementById('fotoFrota').files[0];
    if (!codigo || !modelo) { window.alert("Código e Modelo são obrigatórios."); return; }
    const foto = fotoFile ? await window.fileToBase64(fotoFile) : null;
    window.saveData('frotas', { codigo, modelo, foto }, "Frota salva com sucesso!");
    document.getElementById('cadastroFrota').querySelector('form').reset();
}
window.salvarSetor = function() {
    const nome = document.getElementById('nomeSetor').value.trim();
    if (!nome) { window.alert("Nome do setor é obrigatório."); return; }
    window.saveData('setores', { nome }, "Setor salvo com sucesso!");
    document.getElementById('nomeSetor').value = '';
    window.populateSelects();
}
window.salvarAtividade = function() {
    const nome = document.getElementById('nomeAtividade').value.trim();
    if (!nome) { window.alert("Nome da atividade é obrigatório."); return; }
    window.saveData('atividades', { nome }, "Atividade salva com sucesso!");
    document.getElementById('nomeAtividade').value = '';
    window.populateSelects();
}
window.salvarImplemento = function() {
    const nome = document.getElementById('nomeImplemento').value.trim();
    const sigla = document.getElementById('siglaImplemento').value.trim();
    if (!nome || !sigla) { window.alert("Nome e Sigla são obrigatórios."); return; }
    window.saveData('implementos', { nome, sigla }, "Implemento salvo com sucesso!");
    document.getElementById('nomeImplemento').value = '';
    document.getElementById('siglaImplemento').value = '';
    window.populateSelects();
}

// --- INÍCIO/FIM DE ATIVIDADE FUNCTIONS ---
window.buscarOperador = function(cracha, nomeFieldId, fotoFieldId) {
    return new Promise((resolve, reject) => {
        if (!db || !cracha) {
            document.getElementById(nomeFieldId).value = '';
            document.getElementById(fotoFieldId).src = 'https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR';
            return resolve(null);
        }
        const request = db.transaction(['operadores']).objectStore('operadores').get(cracha);
        request.onsuccess = () => {
            const op = request.result;
            document.getElementById(nomeFieldId).value = op ? op.nome : 'Operador não encontrado';
            document.getElementById(fotoFieldId).src = op?.foto || 'https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR';
            resolve(op);
        };
        request.onerror = (e) => {
            console.error("Erro ao buscar operador:", e);
            document.getElementById(nomeFieldId).value = 'Erro na busca';
            document.getElementById(fotoFieldId).src = 'https://placehold.co/100x100/A0AEC0/000000?text=ERRO';
            reject(e);
        };
    });
}
window.mostrarModeloFrota = function(codigo, modeloFieldId, fotoFieldId) {
    return new Promise((resolve, reject) => {
        if (!db || !codigo) {
            document.getElementById(modeloFieldId).value = '';
            if (document.getElementById(fotoFieldId)) {
               document.getElementById(fotoFieldId).src = 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
            }
            return resolve(null);
        }
        const request = db.transaction(['frotas']).objectStore('frotas').get(codigo);
        request.onsuccess = () => {
            const frota = request.result;
            document.getElementById(modeloFieldId).value = frota ? frota.modelo : 'Frota não encontrada';
             if (document.getElementById(fotoFieldId)) {
                document.getElementById(fotoFieldId).src = frota?.foto || 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
             }
            resolve(frota);
        };
        request.onerror = (e) => {
            console.error("Erro ao buscar frota:", e);
            document.getElementById(modeloFieldId).value = 'Erro na busca';
            if (document.getElementById(fotoFieldId)) {
                document.getElementById(fotoFieldId).src = 'https://placehold.co/100x100/A0AEC0/000000?text=ERRO';
            }
            reject(e);
        };
    });
}
window.toggleRelatoProblema = function() {
    const atividade = document.getElementById('atividadeInicio').value;
    const relatoField = document.getElementById('relatoProblemaField');
    const relatoTextarea = document.getElementById('relatoProblema');
    const isMaintenance = atividade.toLowerCase().includes('manutenção');
    relatoField.style.display = isMaintenance ? 'flex' : 'none';
    relatoTextarea.required = isMaintenance;
}
window.toggleNonConformityReport = function(radio) {
    const textarea = document.getElementById(radio.dataset.targetTextarea);
    textarea.classList.toggle('hidden', radio.value !== 'NÃO CONFORME');
    textarea.required = radio.value === 'NÃO CONFORME';
    if(radio.value !== 'NÃO CONFORME') textarea.value = '';
}
window.hideAllChecklistReports = function() {
    document.querySelectorAll('#safetyChecklist textarea').forEach(textarea => {
        textarea.classList.add('hidden');
        textarea.required = false;
        textarea.value = '';
    });
    document.querySelectorAll('#safetyChecklist input[type="radio"][value="OK"]').forEach(radio => {
        radio.checked = true;
    });
}

window.enviarInicio = async function(event) {
    event.preventDefault();
    
    // UPDATED: Simplified date/time validation
    if (!window.validateDateTime('dataInicial', 'horaInicial')) {
        return;
    }

    const frotaCadastrada = await window.mostrarModeloFrota(document.getElementById('frotaInicio').value, 'equipamentoInicio', 'fotoEquipInicio');
    if (!frotaCadastrada) {
        window.showModal('Erro', 'Frota não cadastrada. Verifique o código da frota e tente novamente.', () => {}, true);
        return;
    }

    const requiredFields = [
        { id: 'crachaInicio', label: 'Crachá' }, { id: 'nomeInicio', label: 'Operador (inválido ou não encontrado)' },
        { id: 'dataInicial', label: 'Data Inicial' }, { id: 'horaInicial', label: 'Hora Inicial' },
        { id: 'frotaInicio', label: 'Frota' }, { id: 'equipamentoInicio', label: 'Equipamento (inválido ou não encontrado)' },
        { id: 'horimetroInicial', label: 'Horímetro Inicial' }, { id: 'setorInicio', label: 'Setor' },
        { id: 'atividadeInicio', label: 'Atividade' }, { id: 'implementoInicio', label: 'Implemento' }
    ];
    const missingFields = requiredFields.filter(field => {
        const input = document.getElementById(field.id);
        return !input.value || input.value.includes('não encontrado');
    }).map(field => field.label);

    const atividade = document.getElementById('atividadeInicio').value;
    if (atividade.toLowerCase().includes('manutenção') && !document.getElementById('relatoProblema').value.trim()) {
        missingFields.push('Relato do Problema');
    }

    if (missingFields.length > 0) {
        window.showModal('Campos Obrigatórios', 'Por favor, preencha os seguintes campos:\n\n- ' + missingFields.join('\n- '), () => {}, true);
        return;
    }

    const cracha = document.getElementById('crachaInicio').value;
    const frota = document.getElementById('frotaInicio').value;
    const atividadesEmAndamento = await window.getAllData('atividadesEmAndamento');

    if (atividadesEmAndamento.some(item => item.frota === frota)) {
        window.showModal('Erro', `A frota ${frota} já está em atividade.`, () => {}, true);
        return;
    }

    const saveActivity = () => {
        const dados = {
            cracha, operador: document.getElementById('nomeInicio').value,
            dataInicial: document.getElementById('dataInicial').value, horaInicial: document.getElementById('horaInicial').value,
            frota, equipamento: document.getElementById('equipamentoInicio').value,
            horimetroInicial: parseFloat(document.getElementById('horimetroInicial').value), setor: document.getElementById('setorInicio').value,
            atividade: document.getElementById('atividadeInicio').value, implemento: document.getElementById('implementoInicio').value,
            relatoProblema: document.getElementById('relatoProblema').value, checklist: {}
        };
        let nonConformityFound = false;
        document.querySelectorAll('#safetyChecklist input[type="radio"][value="NÃO CONFORME"]:checked').forEach(radio => {
            nonConformityFound = true;
        });

        if (nonConformityFound) {
            window.showModal('Atenção: Não Conformidade', `Foram encontradas não conformidades no checklist.\nA frota será marcada para manutenção. Continuar?`, () => {
                dados.atividade = 'MANUTENÇÃO';
                window.saveData('atividadesEmAndamento', dados, 'Atividade de manutenção iniciada!');
                window.limparFormulario('formInicio');
                window.mostrar('disponibilidade');
            }, true);
        } else {
             window.saveData('atividadesEmAndamento', dados, 'Atividade iniciada com sucesso!');
             window.limparFormulario('formInicio');
             window.mostrar('disponibilidade');
        }
    };

    if (atividadesEmAndamento.some(item => item.cracha === cracha)) {
        window.showModal('Operador em Atividade', `O operador ${cracha} já possui uma atividade em andamento. Deseja iniciar uma nova atividade mesmo assim?`, saveActivity, true);
    } else {
        saveActivity();
    }
}

window.handleCrachaFimChange = async function() {
    const cracha = document.getElementById('crachaFim').value;
    const operador = await window.buscarOperador(cracha, 'nomeFim', 'fotoFim');

    const frotaFimInput = document.getElementById('frotaFim');
    const container = document.getElementById('frotaSelectionContainer');
    const select = document.getElementById('selectFrotaAtiva');
    
    frotaFimInput.value = '';
    document.getElementById('equipamentoFim').value = '';
    document.getElementById('fotoEquipFim').src = 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
    container.style.display = 'none';
    select.innerHTML = '<option value="">Selecione a frota...</option>';

    if (!operador) return;

    const request = db.transaction(['atividadesEmAndamento']).objectStore('atividadesEmAndamento').getAll();
    request.onsuccess = () => {
        const atividadesOperador = request.result.filter(item => item.cracha === cracha);
        if (atividadesOperador.length === 1) {
            window.selecionarFrotaAtiva(atividadesOperador[0].id);
            container.style.display = 'none';
        } else if (atividadesOperador.length > 1) {
            atividadesOperador.forEach(ativ => select.innerHTML += `<option value="${ativ.id}">${ativ.frota} - ${ativ.atividade}</option>`);
            container.style.display = 'flex';
        }
    };
}
window.selecionarFrotaAtiva = function(id) {
    const request = db.transaction(['atividadesEmAndamento']).objectStore('atividadesEmAndamento').get(Number(id));
    request.onsuccess = () => {
        const ativ = request.result;
        if (ativ) {
            document.getElementById('frotaFim').value = ativ.frota;
            window.mostrarModeloFrota(ativ.frota, 'equipamentoFim', 'fotoEquipFim');
            const horimetroInput = document.getElementById('horimetroFim');
            horimetroInput.dataset.atividadeId = ativ.id;
            horimetroInput.dataset.horimetroInicial = ativ.horimetroInicial;
        }
    };
}
window.enviarFim = function(event) {
    event.preventDefault();
    const form = document.getElementById('formFim');
    if (!form.checkValidity()) { form.reportValidity(); return; }
    
    // UPDATED: Simplified date/time validation
    if (!window.validateDateTime('dataFinal', 'horaFinal')) {
        return;
    }

    const atividadeId = Number(document.getElementById('horimetroFim').dataset.atividadeId);
    if (!atividadeId) { window.alert("Nenhuma atividade selecionada para finalizar. Verifique o crachá e a frota."); return; }

    const transaction = db.transaction(['atividadesEmAndamento'], 'readonly');
    const requestGet = transaction.objectStore('atividadesEmAndamento').get(atividadeId);

    requestGet.onsuccess = () => {
        const atividadeAberta = requestGet.result;
        if (!atividadeAberta) { window.alert("Erro: Atividade não encontrada."); return; }
        window.finalizarAtividade(atividadeId, atividadeAberta);
    };
}

window.finalizarAtividade = function(atividadeId, atividadeEncerrada) {
    let isInconsistente = false;
    const horimetroFinal = parseFloat(document.getElementById('horimetroFim').value);
    const horimetroInicial = parseFloat(atividadeEncerrada.horimetroInicial);
    
    const dataFinalVal = document.getElementById('dataFinal').value;
    const horaFinalVal = document.getElementById('horaFinal').value;
    const inicioTimestamp = new Date(`${atividadeEncerrada.dataInicial}T${atividadeEncerrada.horaInicial}`).getTime();
    const fimTimestamp = new Date(`${dataFinalVal}T${horaFinalVal}`).getTime();

    const doSave = () => {
        const transaction = db.transaction(['atividadesEmAndamento', 'historicoAtividades'], 'readwrite');
        const storeAtividades = transaction.objectStore('atividadesEmAndamento');
        const storeHistorico = transaction.objectStore('historicoAtividades');

        Object.assign(atividadeEncerrada, {
            dataFinal: dataFinalVal, horaFinal: horaFinalVal,
            horimetroFinal: horimetroFinal, observacoes: document.getElementById('observacoesFim').value,
            horasHorimetro: (horimetroFinal - horimetroInicial).toFixed(2),
            inconsistente: isInconsistente
        });
        
        storeHistorico.add(atividadeEncerrada);
        storeAtividades.delete(atividadeId);

        transaction.oncomplete = () => {
            window.alert("Atividade finalizada com sucesso!");
            window.limparFormulario('formFim');
            window.mostrar('disponibilidade');
        };
        transaction.onerror = (e) => { console.error("Erro ao finalizar atividade:", e.target.error); window.alert("Ocorreu um erro ao finalizar a atividade."); };
    };

    const checkDate = () => {
        if (fimTimestamp < inicioTimestamp) {
            isInconsistente = true;
            window.showModal('Data Incorreta', 'A data/hora final é anterior à inicial. Deseja continuar mesmo assim?', doSave, true);
        } else {
            doSave();
        }
    };

    if (horimetroFinal < horimetroInicial) {
        isInconsistente = true;
        window.showModal('Erro de Horímetro', `O horímetro final (${horimetroFinal}) é menor que o inicial (${horimetroInicial}). Deseja continuar mesmo assim?`, checkDate, true);
    } else {
        checkDate();
    }
}


// --- DISPONIBILIDADE (AVAILABILITY) VIEW ---
window.updateDisponibilidade = async function() {
    try {
        const [todasFrotas, atividadesEmAndamento, ordensServico] = await Promise.all([
            window.getAllData('frotas'),
            window.getAllData('atividadesEmAndamento'),
            window.getAllData('ordensServico')
        ]);
        const contentDiv = document.getElementById('disponibilidadeContent');
        const manutencaoListDiv = document.getElementById('frotasEmManutencaoList');
        const manutencaoItemsUl = document.getElementById('manutencaoItems');
        
        contentDiv.innerHTML = '';
        manutencaoItemsUl.innerHTML = '';
        manutencaoListDiv.style.display = 'none';

        if (todasFrotas.length === 0) {
            contentDiv.innerHTML = '<p class="text-gray-600">Nenhuma frota cadastrada.</p>';
            return;
        }

        const frotasAgrupadas = todasFrotas.reduce((acc, frota) => {
            const modelo = frota.modelo || 'Sem Modelo';
            if (!acc[modelo]) acc[modelo] = [];
            acc[modelo].push(frota);
            return acc;
        }, {});

        const frotasEmManutencao = [];

        for (const modelo in frotasAgrupadas) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'mb-8';
            const groupTitle = document.createElement('h4');
            groupTitle.className = 'text-lg font-bold text-gray-700 border-b pb-2 mb-4';
            groupTitle.textContent = `Modelo: ${modelo}`;
            groupDiv.appendChild(groupTitle);

            const table = document.createElement('table');
            table.className = 'availability-table';
            table.innerHTML = `<thead><tr><th>Frota</th><th>Status</th><th>Operador</th><th>Atividade</th><th>Início</th></tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');

            frotasAgrupadas[modelo].forEach(frota => {
                const atividade = atividadesEmAndamento.find(a => a.frota === frota.codigo);
                const osAberta = ordensServico.find(os => os.frota === frota.codigo && (os.status === 'Aberta' || os.status === 'Em Andamento'));
                
                let statusClass = 'status-ok';
                let statusText = 'Disponível';
                let operadorText = '-';
                let inicioText = '-';
                let atividadeText = '-';

                if (atividade) {
                    statusText = atividade.atividade;
                    statusClass = atividade.atividade.toUpperCase() === 'MANUTENÇÃO' ? 'status-maintenance-strong' : 'status-active';
                    operadorText = `${atividade.operador} (${atividade.cracha})`;
                    inicioText = `${new Date(atividade.dataInicial + 'T' + atividade.horaInicial).toLocaleDateString('pt-BR')} ${atividade.horaInicial}`;
                    atividadeText = atividade.atividade;

                    if (atividade.atividade.toUpperCase() === 'MANUTENÇÃO') {
                        frotasEmManutencao.push({codigo: frota.codigo, relato: atividade.relatoProblema || 'Sem relato.'});
                    }
                } else if (osAberta) {
                    statusText = 'Em Manutenção (OS)';
                    statusClass = 'status-maintenance-strong';
                    operadorText = `Manutenção (OS ${osAberta.id})`;
                    inicioText = `${new Date(osAberta.dataAbertura).toLocaleDateString('pt-BR')}`;
                    atividadeText = osAberta.descricao;
                    frotasEmManutencao.push({codigo: frota.codigo, relato: osAberta.descricao});
                }

                const row = tbody.insertRow();
                row.innerHTML = `<td data-label="Frota">${frota.codigo}</td><td data-label="Status"><span class="status-cell ${statusClass}">${statusText}</span></td><td data-label="Operador">${operadorText}</td><td data-label="Atividade">${atividadeText}</td><td data-label="Início">${inicioText}</td>`;
            });
            groupDiv.appendChild(table);
            contentDiv.appendChild(groupDiv);
        }

        if (frotasEmManutencao.length > 0) {
            manutencaoListDiv.style.display = 'block';
            frotasEmManutencao.forEach(item => manutencaoItemsUl.innerHTML += `<li><b>Frota ${item.codigo}:</b> ${item.relato}</li>`);
        }

    } catch (error) {
        console.error("Failed to update availability:", error);
        document.getElementById('disponibilidadeContent').innerHTML = '<p class="text-red-500">Erro ao carregar dados.</p>';
    }
}


// --- ADMIN PANEL FUNCTIONS ---
window.handleLogin = async function() {
    const username = document.getElementById('adminUsername').value;
    const password = document.getElementById('adminPassword').value;
    if (!db) { window.alert("Banco de dados não está pronto."); return; }
    const transaction = db.transaction(['usuarios'], 'readwrite'); // readwrite to create defaults
    const store = transaction.objectStore('usuarios');
    const adminCheck = store.get('admin');
    adminCheck.onsuccess = () => {
        if (!adminCheck.result) {
            store.put({ username: 'admin', password: 'admin123', level: 'administrador' });
            store.put({ username: 'analista', password: 'analista123', level: 'analista' });
        }
        const loginRequest = store.get(username);
        loginRequest.onsuccess = () => {
            const user = loginRequest.result;
            if (user && user.password === password) {
                currentUser = user;
                sessionStorage.setItem('loggedInUser', JSON.stringify(user));
                window.showAdminDashboard();
            } else {
                window.alert('Usuário ou senha inválidos.');
            }
        };
    };
}
window.showAdminDashboard = function() {
    if (!currentUser) return;
    document.getElementById('adminLogin').style.display = 'none';
    document.getElementById('adminDashboard').style.display = 'block';
    document.getElementById('loggedInUserRoleDisplay').textContent = currentUser.username;
    document.getElementById('loggedInUserLevelDisplay').textContent = currentUser.level;
    const isAdmin = currentUser.level === 'administrador';
    const isAnalyst = currentUser.level === 'analista';
    
    // Hide all navigation buttons when in admin panel
    document.getElementById('btnDisponibilidade').style.display = 'none';
    document.getElementById('btnInicioAtividade').style.display = 'none';
    document.getElementById('btnEncerramentoAtividade').style.display = 'none';
    document.getElementById('btnCadastro').style.display = 'none';
    document.getElementById('btnRelatorio').style.display = 'none';
    document.getElementById('btnDados').style.display = 'none';

    document.getElementById('userManagement').style.display = isAdmin ? 'block' : 'none';
    if (isAdmin) window.loadUserList();
}
window.logout = function() {
    currentUser = null;
    sessionStorage.removeItem('loggedInUser');
    // Hide management buttons when logged out
    document.getElementById('btnCadastro').style.display = 'none';
    document.getElementById('btnRelatorio').style.display = 'none';
    document.getElementById('btnDados').style.display = 'none';

    document.getElementById('adminDashboard').style.display = 'none';
    document.getElementById('adminLogin').style.display = 'block';
    document.getElementById('adminUsername').value = '';
    document.getElementById('adminPassword').value = '';
    window.mostrar('disponibilidade'); // Return to default view
}
window.salvarUsuario = async function() {
    const username = document.getElementById('newUsername').value.trim();
    const password = document.getElementById('newPassword').value.trim();
    const level = document.getElementById('newUserLevel').value;
    if (!username || !password || !level) { window.alert("Todos os campos são obrigatórios."); return; }
    window.saveData('usuarios', { username, password, level }, "Usuário salvo com sucesso!");
    window.loadUserList();
    document.getElementById('newUsername').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('newUserLevel').value = '';
}
window.loadUserList = async function() {
    const users = await window.getAllData('usuarios');
    const userListBody = document.getElementById('userList');
    userListBody.innerHTML = '';
    users.forEach(user => {
        const row = userListBody.insertRow();
        row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.username}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.level}</td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><a href="#" class="text-red-600 hover:text-red-900" onclick="window.deleteUser('${user.username}')">Excluir</a></td>`;
    });
}
window.deleteUser = function(username) {
    if (username === 'admin') { window.alert("Não é possível excluir o administrador padrão."); return; }
    window.showModal('Excluir Usuário', `Tem certeza que deseja excluir '${username}'?`, () => {
        const transaction = db.transaction(['usuarios'], 'readwrite');
        transaction.objectStore('usuarios').delete(username);
        transaction.oncomplete = () => { window.alert(`Usuário ${username} excluído.`); window.loadUserList(); };
    }, true);
}

// --- DATA MANAGEMENT & REPORT FUNCTIONS ---
window.gerarRelatorio = function() {
    const tipo = document.getElementById('tipoRelatorio').value;
    switch (tipo) {
        case 'horasFrota':
            window.gerarRelatorioHorasFrota();
            break;
        case 'atividadesOperador':
            window.generateAtividadesOperadorReport();
            break;
        case 'manutencoes':
            window.generateManutencoesReport();
            break;
        case 'disponibilidade':
            window.generateDisponibilidadeReport();
            break;
        case 'comparativoHoras':
            window.generateComparativoHorasReport();
            break;
        case 'atividades':
            window.generateAtividadesReport();
            break;
        case 'setor':
            window.generateSetorReport();
            break;
        case 'edicoes':
            window.generateEdicoesReport();
            break;
        case 'consumoFrota':
            window.generateConsumoFrotaReport(); // New report
            break;
        case 'custosCombustivel':
            window.generateCustosCombustivelReport(); // New report
            break;
        default:
            window.alert(`Relatório do tipo '${tipo}' ainda não implementado.`);
            document.getElementById('relatorioResultado').innerHTML = '';
    }
}

window.gerarRelatorioHorasFrota = async function() {
    const dataInicio = document.getElementById('relatorioDataInicio').value;
    const dataFim = document.getElementById('relatorioDataFim').value;
    const resultadoDiv = document.getElementById('relatorioResultado');
    resultadoDiv.innerHTML = '';

    if (!dataInicio || !dataFim) {
        window.alert('Por favor, selecione as datas de início e fim.');
        return;
    }

    const historico = await window.getAllData('historicoAtividades');
    const relatorio = {};

    const inicioTimestamp = new Date(dataInicio + 'T00:00:00').getTime();
    const fimTimestamp = new Date(dataFim + 'T23:59:59').getTime();

    historico.forEach(item => {
        const itemTimestamp = new Date(item.dataFinal).getTime();
        if (itemTimestamp >= inicioTimestamp && itemTimestamp <= fimTimestamp) {
            if (!relatorio[item.frota]) {
                relatorio[item.frota] = { horasHorimetro: 0, modelo: item.equipamento };
            }
            relatorio[item.frota].horasHorimetro += parseFloat(item.horasHorimetro || 0);
        }
    });

    if (Object.keys(relatorio).length === 0) {
        resultadoDiv.innerHTML = '<p class="text-gray-600 mt-4">Nenhum dado encontrado para o período selecionado.</p>';
        return;
    }

    const table = document.createElement('table');
    table.className = 'data-table';
    table.innerHTML = `
        <thead>
            <tr>
                <th>Frota</th>
                <th>Modelo</th>
                <th>Total de Horas (Horímetro)</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');
    for (const frota in relatorio) {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td data-label="Frota">${frota}</td>
            <td data-label="Modelo">${relatorio[frota].modelo}</td>
            <td data-label="Horas">${relatorio[frota].horasHorimetro.toFixed(2)}</td>
        `;
    }
    resultadoDiv.appendChild(table);
}

window.generateAtividadesOperadorReport = async function() {
    const dataInicio = document.getElementById('relatorioDataInicio').value;
    const dataFim = document.getElementById('relatorioDataFim').value;
    const resultadoDiv = document.getElementById('relatorioResultado');
    resultadoDiv.innerHTML = '';

    if (!dataInicio || !dataFim) {
        window.alert('Por favor, selecione as datas de início e fim.');
        return;
    }

    const historico = await window.getAllData('historicoAtividades');
    const operadores = await window.getAllData('operadores');
    const relatorio = {};

    operadores.forEach(op => relatorio[op.cracha] = { nome: op.nome, totalAtividades: 0, totalHoras: 0 });

    const inicioTimestamp = new Date(dataInicio + 'T00:00:00').getTime();
    const fimTimestamp = new Date(dataFim + 'T23:59:59').getTime();

    historico.forEach(item => {
        const itemTimestamp = new Date(item.dataFinal).getTime();
        if (itemTimestamp >= inicioTimestamp && itemTimestamp <= fimTimestamp && relatorio[item.cracha]) {
            relatorio[item.cracha].totalAtividades++;
            relatorio[item.cracha].totalHoras += parseFloat(item.horasHorimetro || 0);
        }
    });

    if (Object.keys(relatorio).length === 0) {
        resultadoDiv.innerHTML = '<p class="text-gray-600 mt-4">Nenhum dado encontrado para o período selecionado.</p>';
        return;
    }

    const table = document.createElement('table');
    table.className = 'data-table';
    table.innerHTML = `
        <thead>
            <tr>
                <th>Crachá</th>
                <th>Nome do Operador</th>
                <th>Total de Atividades</th>
                <th>Total de Horas</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');
    for (const cracha in relatorio) {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td data-label="Crachá">${cracha}</td>
            <td data-label="Nome">${relatorio[cracha].nome}</td>
            <td data-label="Atividades">${relatorio[cracha].totalAtividades}</td>
            <td data-label="Horas">${relatorio[cracha].totalHoras.toFixed(2)}</td>
        `;
    }
    resultadoDiv.appendChild(table);
}

window.generateManutencoesReport = async function() {
    const dataInicio = document.getElementById('relatorioDataInicio').value;
    const dataFim = document.getElementById('relatorioDataFim').value;
    const resultadoDiv = document.getElementById('relatorioResultado');
    resultadoDiv.innerHTML = '';

    if (!dataInicio || !dataFim) {
        window.alert('Por favor, selecione as datas de início e fim.');
        return;
    }

    const ordensServico = await window.getAllData('ordensServico');
    const filteredOS = ordensServico.filter(os => {
        const osDate = new Date(os.dataAbertura);
        const start = new Date(dataInicio);
        const end = new Date(dataFim + 'T23:59:59');
        return osDate >= start && osDate <= end;
    });

    if (filteredOS.length === 0) {
        resultadoDiv.innerHTML = '<p class="text-gray-600 mt-4">Nenhuma Ordem de Serviço encontrada para o período selecionado.</p>';
        return;
    }

    const table = document.createElement('table');
    table.className = 'data-table';
    table.innerHTML = `
        <thead>
            <tr>
                <th>OS ID</th>
                <th>Frota</th>
                <th>Modelo</th>
                <th>Data Abertura</th>
                <th>Solicitante</th>
                <th>Descrição</th>
                <th>Tipo</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');
    filteredOS.forEach(os => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td data-label="OS ID">${os.id}</td>
            <td data-label="Frota">${os.frota}</td>
            <td data-label="Modelo">${os.modeloFrota}</td>
            <td data-label="Data Abertura">${os.dataAbertura}</td>
            <td data-label="Solicitante">${os.solicitante}</td>
            <td data-label="Descrição">${os.descricao}</td>
            <td data-label="Tipo">${os.tipo}</td>
            <td data-label="Status">${os.status}</td>
        `;
    });
    resultadoDiv.appendChild(table);
}

window.generateDisponibilidadeReport = async function() {
    const dataInicio = document.getElementById('relatorioDataInicio').value;
    const dataFim = document.getElementById('relatorioDataFim').value;
    const resultadoDiv = document.getElementById('relatorioResultado');
    resultadoDiv.innerHTML = '';

    if (!dataInicio || !dataFim) {
        window.alert('Por favor, selecione as datas de início e fim.');
        return;
    }

    const frotas = await window.getAllData('frotas');
    const historico = await window.getAllData('historicoAtividades');
    const ordensServico = await window.getAllData('ordensServico');

    const inicioTimestamp = new Date(dataInicio + 'T00:00:00').getTime();
    const fimTimestamp = new Date(dataFim + 'T23:59:59').getTime();

    const reportData = frotas.map(frota => {
        let totalHorasOperacao = 0;
        let totalHorasManutencao = 0;

        historico.filter(item => item.frota === frota.codigo && new Date(item.dataFinal).getTime() >= inicioTimestamp && new Date(item.dataFinal).getTime() <= fimTimestamp)
                 .forEach(item => {
                     const horas = parseFloat(item.horasHorimetro || 0);
                     if (item.atividade.toUpperCase() === 'MANUTENÇÃO') {
                         totalHorasManutencao += horas;
                     } else {
                         totalHorasOperacao += horas;
                     }
                 });
        
        // Simplesmente para mostrar o status atual no período
        const currentStatus = ordensServico.some(os => os.frota === frota.codigo && (os.status === 'Aberta' || os.status === 'Em Andamento')) ? 'Em Manutenção' : 
                              historico.some(item => item.frota === frota.codigo && !item.dataFinal) ? 'Em Operação' : 'Disponível';

        return {
            frota: frota.codigo,
            modelo: frota.modelo,
            horasOperacao: totalHorasOperacao.toFixed(2),
            horasManutencao: totalHorasManutencao.toFixed(2),
            statusAtual: currentStatus
        };
    });

    if (reportData.length === 0) {
        resultadoDiv.innerHTML = '<p class="text-gray-600 mt-4">Nenhum dado encontrado para o período selecionado.</p>';
        return;
    }

    const table = document.createElement('table');
    table.className = 'data-table';
    table.innerHTML = `
        <thead>
            <tr>
                <th>Frota</th>
                <th>Modelo</th>
                <th>Horas de Operação</th>
                <th>Horas de Manutenção</th>
                <th>Status Atual</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');
    reportData.forEach(item => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td data-label="Frota">${item.frota}</td>
            <td data-label="Modelo">${item.modelo}</td>
            <td data-label="Horas Op.">${item.horasOperacao}</td>
            <td data-label="Horas Manut.">${item.horasManutencao}</td>
            <td data-label="Status">${item.statusAtual}</td>
        `;
    });
    resultadoDiv.appendChild(table);
}

window.generateComparativoHorasReport = async function() {
    const dataInicio = document.getElementById('relatorioDataInicio').value;
    const dataFim = document.getElementById('relatorioDataFim').value;
    const resultadoDiv = document.getElementById('relatorioResultado');
    resultadoDiv.innerHTML = '';

    if (!dataInicio || !dataFim) {
        window.alert('Por favor, selecione as datas de início e fim.');
        return;
    }

    const historico = await window.getAllData('historicoAtividades');
    const filteredHistorico = historico.filter(item => {
        const itemDate = new Date(item.dataFinal);
        const start = new Date(dataInicio);
        const end = new Date(dataFim + 'T23:59:59');
        return itemDate >= start && itemDate <= end;
    });

    if (filteredHistorico.length === 0) {
        resultadoDiv.innerHTML = '<p class="text-gray-600 mt-4">Nenhum dado encontrado para o período selecionado.</p>';
        return;
    }

    const table = document.createElement('table');
    table.className = 'data-table';
    table.innerHTML = `
        <thead>
            <tr>
                <th>ID Atividade</th>
                <th>Frota</th>
                <th>Operador</th>
                <th>Horímetro Inicial</th>
                <th>Horímetro Final</th>
                <th>Horas Apontadas</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');
    filteredHistorico.forEach(item => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td data-label="ID">${item.id}</td>
            <td data-label="Frota">${item.frota}</td>
            <td data-label="Operador">${item.operador}</td>
            <td data-label="Horímetro Inicial">${parseFloat(item.horimetroInicial).toFixed(2)}</td>
            <td data-label="Horímetro Final">${parseFloat(item.horimetroFinal).toFixed(2)}</td>
            <td data-label="Horas Apontadas">${parseFloat(item.horasHorimetro).toFixed(2)}</td>
        `;
    });
    resultadoDiv.appendChild(table);
}

window.generateAtividadesReport = async function() {
    const dataInicio = document.getElementById('relatorioDataInicio').value;
    const dataFim = document.getElementById('relatorioDataFim').value;
    const resultadoDiv = document.getElementById('relatorioResultado');
    resultadoDiv.innerHTML = '';

    if (!dataInicio || !dataFim) {
        window.alert('Por favor, selecione as datas de início e fim.');
        return;
    }

    const historico = await window.getAllData('historicoAtividades');
    const filteredHistorico = historico.filter(item => {
        const itemDate = new Date(item.dataFinal);
        const start = new Date(dataInicio);
        const end = new Date(dataFim + 'T23:59:59');
        return itemDate >= start && itemDate <= end;
    });

    if (filteredHistorico.length === 0) {
        resultadoDiv.innerHTML = '<p class="text-gray-600 mt-4">Nenhum dado encontrado para o período selecionado.</p>';
        return;
    }

    const table = document.createElement('table');
    table.className = 'data-table';
    table.innerHTML = `
        <thead>
            <tr>
                <th>ID</th>
                <th>Frota</th>
                <th>Operador</th>
                <th>Atividade</th>
                <th>Setor</th>
                <th>Início</th>
                <th>Fim</th>
                <th>Horas</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');
    filteredHistorico.forEach(item => {
        const row = tbody.insertRow();
        const statusClass = item.inconsistente ? 'status-inconsistente' : 'status-ok';
        const statusText = item.inconsistente ? 'Inconsistente' : 'OK';
        row.innerHTML = `
            <td data-label="ID">${item.id}</td>
            <td data-label="Frota">${item.frota}</td>
            <td data-label="Operador">${item.operador}</td>
            <td data-label="Atividade">${item.atividade}</td>
            <td data-label="Setor">${item.setor}</td>
            <td data-label="Início">${item.dataInicial} ${item.horaInicial}</td>
            <td data-label="Fim">${item.dataFinal} ${item.horaFinal}</td>
            <td data-label="Horas">${parseFloat(item.horasHorimetro).toFixed(2)}</td>
            <td data-label="Status"><span class="status-cell ${statusClass}">${statusText}</span></td>
        `;
    });
    resultadoDiv.appendChild(table);
}

window.generateSetorReport = async function() {
    const dataInicio = document.getElementById('relatorioDataInicio').value;
    const dataFim = document.getElementById('relatorioDataFim').value;
    const resultadoDiv = document.getElementById('relatorioResultado');
    resultadoDiv.innerHTML = '';

    if (!dataInicio || !dataFim) {
        window.alert('Por favor, selecione as datas de início e fim.');
        return;
    }

    const historico = await window.getAllData('historicoAtividades');
    const relatorio = {};

    const inicioTimestamp = new Date(dataInicio + 'T00:00:00').getTime();
    const fimTimestamp = new Date(dataFim + 'T23:59:59').getTime();

    historico.forEach(item => {
        const itemTimestamp = new Date(item.dataFinal).getTime();
        if (itemTimestamp >= inicioTimestamp && itemTimestamp <= fimTimestamp) {
            if (!relatorio[item.setor]) {
                relatorio[item.setor] = { totalHoras: 0, totalAtividades: 0 };
            }
            relatorio[item.setor].totalAtividades++;
            relatorio[item.setor].totalHoras += parseFloat(item.horasHorimetro || 0);
        }
    });

    if (Object.keys(relatorio).length === 0) {
        resultadoDiv.innerHTML = '<p class="text-gray-600 mt-4">Nenhum dado encontrado para o período selecionado.</p>';
        return;
    }

    const table = document.createElement('table');
    table.className = 'data-table';
    table.innerHTML = `
        <thead>
            <tr>
                <th>Setor</th>
                <th>Total de Atividades</th>
                <th>Total de Horas</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');
    for (const setor in relatorio) {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td data-label="Setor">${setor}</td>
            <td data-label="Atividades">${relatorio[setor].totalAtividades}</td>
            <td data-label="Horas">${relatorio[setor].totalHoras.toFixed(2)}</td>
        `;
    }
    resultadoDiv.appendChild(table);
}

window.generateEdicoesReport = async function() {
    const dataInicio = document.getElementById('relatorioDataInicio').value;
    const dataFim = document.getElementById('relatorioDataFim').value;
    const resultadoDiv = document.getElementById('relatorioResultado');
    resultadoDiv.innerHTML = '';

    if (!dataInicio || !dataFim) {
        window.alert('Por favor, selecione as datas de início e fim.');
        return;
    }

    const historico = await window.getAllData('historicoAtividades');
    const filteredHistorico = historico.filter(item => {
        const itemDate = new Date(item.dataFinal);
        const start = new Date(dataInicio);
        const end = new Date(dataFim + 'T23:59:59');
        return itemDate >= start && itemDate <= end && item.inconsistente;
    });

    if (filteredHistorico.length === 0) {
        resultadoDiv.innerHTML = '<p class="text-gray-600 mt-4">Nenhum apontamento inconsistente encontrado para o período selecionado.</p>';
        return;
    }

    const table = document.createElement('table');
    table.className = 'data-table';
    table.innerHTML = `
        <thead>
            <tr>
                <th>ID</th>
                <th>Frota</th>
                <th>Operador</th>
                <th>Horímetro Inicial</th>
                <th>Horímetro Final</th>
                <th>Inconsistência</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');
    filteredHistorico.forEach(item => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td data-label="ID">${item.id}</td>
            <td data-label="Frota">${item.frota}</td>
            <td data-label="Operador">${item.operador}</td>
            <td data-label="Horímetro Inicial">${parseFloat(item.horimetroInicial).toFixed(2)}</td>
            <td data-label="Horímetro Final">${parseFloat(item.horimetroFinal).toFixed(2)}</td>
            <td data-label="Inconsistência">Horímetro final menor que inicial ou data incorreta</td>
        `;
    });
    resultadoDiv.appendChild(table);
}

window.generateConsumoFrotaReport = async function() {
    const dataInicio = document.getElementById('relatorioDataInicio').value;
    const dataFim = document.getElementById('relatorioDataFim').value;
    const resultadoDiv = document.getElementById('relatorioResultado');
    resultadoDiv.innerHTML = '';

    if (!dataInicio || !dataFim) {
        window.alert('Por favor, selecione as datas de início e fim.');
        return;
    }

    const abastecimentos = await window.getAllData('abastecimentos');
    const consumoPorFrota = {};

    const inicioTimestamp = new Date(dataInicio + 'T00:00:00').getTime();
    const fimTimestamp = new Date(dataFim + 'T23:59:59').getTime();

    abastecimentos.forEach(abast => {
        const abastDate = new Date(abast.data);
        if (abastDate.getTime() >= inicioTimestamp && abastDate.getTime() <= fimTimestamp) {
            if (!consumoPorFrota[abast.frota]) {
                consumoPorFrota[abast.frota] = {
                    modelo: abast.modelo,
                    totalVolume: 0
                };
            }
            // Assuming volume is implicitly derived from horimeter difference or directly captured
            // For now, let's assume a fixed volume per abastecimento for simplicity if not explicitly stored
            // In a real app, you'd calculate volume based on tank levels or direct input.
            // For this demo, let's use a placeholder or assume a default volume if not present.
            // If 'volumeRestante' is the tank level, we need to calculate volume dispensed.
            // Let's assume a fixed volume per fueling event for now, or add a 'volumeDispensed' field to abastecimentos.
            // For simplicity, let's assume each abastecimento represents a full tank fill or a standard volume.
            // If 'abastecimentoHorimetro' is the only numeric field, we can't calculate volume directly.
            // Let's assume a new field `volumeLitros` is added to `abastecimentos` for this report.
            // For now, I'll use a placeholder value if volume isn't explicitly recorded.
            const volumeDispensed = abast.volumeLitros || 50; // Use volumeLitros if available, else 50
            consumoPorFrota[abast.frota].totalVolume += volumeDispensed;
        }
    });

    if (Object.keys(consumoPorFrota).length === 0) {
        resultadoDiv.innerHTML = '<p class="text-gray-600 mt-4">Nenhum consumo de combustível encontrado para o período selecionado.</p>';
        return;
    }

    let tableHtml = `
        <h4>Relatório de Consumo por Frota</h4>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Frota</th>
                    <th>Modelo</th>
                    <th>Total Consumido (Litros)</th>
                </tr>
            </thead>
            <tbody>
    `;
    for (const frotaCode in consumoPorFrota) {
        tableHtml += `
            <tr>
                <td>${frotaCode}</td>
                <td>${consumoPorFrota[frotaCode].modelo}</td>
                <td>${consumoPorFrota[frotaCode].totalVolume.toFixed(2)} L</td>
            </tr>
        `;
    }
    tableHtml += `</tbody></table>`;
    resultadoDiv.innerHTML = tableHtml;
}

window.generateCustosCombustivelReport = async function() {
    const dataInicio = document.getElementById('relatorioDataInicio').value;
    const dataFim = document.getElementById('relatorioDataFim').value;
    const resultadoDiv = document.getElementById('relatorioResultado');
    resultadoDiv.innerHTML = '';

    if (!dataInicio || !dataFim) {
        window.alert('Por favor, selecione as datas de início e fim.');
        return;
    }

    const comprasCombustivel = await window.getAllData('comprasCombustivel');
    const abastecimentos = await window.getAllData('abastecimentos'); // To link consumption to costs

    const inicioTimestamp = new Date(dataInicio + 'T00:00:00').getTime();
    const fimTimestamp = new Date(dataFim + 'T23:59:59').getTime();

    let totalCustoCompras = 0;
    const custoPorProduto = {};
    const custoPorFrota = {};

    comprasCombustivel.forEach(compra => {
        const compraDate = new Date(compra.dataRegistro);
        if (compraDate.getTime() >= inicioTimestamp && compraDate.getTime() <= fimTimestamp) {
            totalCustoCompras += compra.valor;
            if (!custoPorProduto[compra.codProduto]) {
                custoPorProduto[compra.codProduto] = {
                    nome: compra.codProduto, // Assuming product name is same as code for simplicity
                    totalVolume: 0,
                    totalValor: 0
                };
            }
            custoPorProduto[compra.codProduto].totalVolume += compra.volume;
            custoPorProduto[compra.codProduto].totalValor += compra.valor;
        }
    });

    // Link abastecimentos to costs (simplified: average cost per liter)
    let totalVolumeAbastecido = 0;
    abastecimentos.forEach(abast => {
        const abastDate = new Date(abast.data);
        if (abastDate.getTime() >= inicioTimestamp && abastDate.getTime() <= fimTimestamp) {
            const volumeDispensed = abast.volumeLitros || 50; // Use volumeLitros if available, else 50
            totalVolumeAbastecido += volumeDispensed;
            if (!custoPorFrota[abast.frota]) {
                custoPorFrota[abast.frota] = {
                    modelo: abast.modelo,
                    volumeConsumido: 0,
                    custoEstimado: 0
                };
            }
            custoPorFrota[abast.frota].volumeConsumido += volumeDispensed;
        }
    });

    const averageCostPerLiter = totalVolumeAbastecido > 0 ? totalCustoCompras / totalVolumeAbastecido : 0;

    for (const frotaCode in custoPorFrota) {
        custoPorFrota[frotaCode].custoEstimado = custoPorFrota[frotaCode].volumeConsumido * averageCostPerLiter;
    }

    let html = `
        <h4>Relatório de Custos de Combustível</h4>
        <p class="text-gray-700 mb-4">Custo Total de Compras no Período: R$ ${totalCustoCompras.toFixed(2)}</p>
        <p class="text-gray-700 mb-4">Custo Médio por Litro (Estimado): R$ ${averageCostPerLiter.toFixed(2)}/L</p>
        
        <h5 class="font-bold mt-6 mb-2">Custos por Produto:</h5>
        <table class="data-table mb-6">
            <thead>
                <tr>
                    <th>Produto</th>
                    <th>Volume Comprado (L)</th>
                    <th>Valor Total (R$)</th>
                </tr>
            </thead>
            <tbody>
    `;
    for (const prodCode in custoPorProduto) {
        html += `
            <tr>
                <td>${prodCode}</td>
                <td>${custoPorProduto[prodCode].totalVolume.toFixed(2)}</td>
                <td>${custoPorProduto[prodCode].totalValor.toFixed(2)}</td>
            </tr>
        `;
    }
    html += `</tbody></table>`;

    html += `
        <h5 class="font-bold mt-6 mb-2">Custos Estimados por Frota:</h5>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Frota</th>
                    <th>Modelo</th>
                    <th>Volume Consumido (L)</th>
                    <th>Custo Estimado (R$)</th>
                </tr>
            </thead>
            <tbody>
    `;
    for (const frotaCode in custoPorFrota) {
        html += `
            <tr>
                <td>${frotaCode}</td>
                <td>${custoPorFrota[frotaCode].modelo}</td>
                <td>${custoPorFrota[frotaCode].volumeConsumido.toFixed(2)}</td>
                <td>${custoPorFrota[frotaCode].custoEstimado.toFixed(2)}</td>
            </tr>
        `;
    }
    html += `</tbody></table>`;

    resultadoDiv.innerHTML = html;
}


window.mostrarBancoDeDados = async function() {
    const contentDiv = document.getElementById('dadosContent');
    contentDiv.innerHTML = '';
    const historico = await window.getAllData('historicoAtividades');

    if (historico.length === 0) {
        contentDiv.innerHTML = '<p class="text-gray-600">Nenhum lançamento no histórico.</p>';
        return;
    }

    const table = document.createElement('table');
    table.className = 'data-table';
    table.innerHTML = `<thead><tr><th>ID</th><th>Frota</th><th>Operador</th><th>Atividade</th><th>Data Final</th><th>Status</th><th>Ações</th></tr></thead><tbody></tbody>`;
    const tbody = table.querySelector('tbody');

    historico.forEach(item => {
        const row = tbody.insertRow();
        const statusClass = item.inconsistente ? 'status-inconsistente' : 'status-ok';
        const statusText = item.inconsistente ? 'Inconsistente' : 'OK';
        
        row.innerHTML = `
            <td data-label="ID">${item.id}</td>
            <td data-label="Frota">${item.frota}</td>
            <td data-label="Operador">${item.operador}</td>
            <td data-label="Atividade">${item.atividade}</td>
            <td data-label="Data Final">${new Date(item.dataFinal + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
            <td data-label="Status"><span class="status-cell ${statusClass}">${statusText}</span></td>
            <td data-label="Ações"><button class="btn blue text-xs p-1" onclick="window.handleEdit('historicoAtividades', ${item.id})">Alterar</button></td>
        `;
    });
    contentDiv.appendChild(table);
}

// --- CONSULTA & EDIT FUNCTIONS ---
window.consultarOperador = async function() {
    const data = await window.getAllData('operadores');
    window.showListModal('Operadores Cadastrados', data, { cracha: 'Crachá', nome: 'Nome', foto: 'Foto' }, 'operadores');
}
window.consultarFrota = async function() {
    const data = await window.getAllData('frotas');
    window.showListModal('Frotas Cadastradas', data, { codigo: 'Código', modelo: 'Modelo', foto: 'Foto' }, 'frotas');
}
window.consultarSetor = async function() {
    const data = await window.getAllData('setores');
    window.showListModal('Setores Cadastrados', data, { nome: 'Nome' }, 'setores');
}
window.consultarAtividade = async function() {
    const data = await window.getAllData('atividades');
    window.showListModal('Atividades Cadastradas', data, { nome: 'Nome' }, 'atividades');
}
window.consultarImplemento = async function() {
    const data = await window.getAllData('implementos');
    window.showListModal('Implementos Cadastrados', data, { nome: 'Nome', sigla: 'Sigla' }, 'implementos');
}

window.handleDelete = async function(storeName, key) {
    const password = window.prompt("Para excluir, digite a senha de administrador:");
    if (password !== 'admin123') { // Simple password check for demo
        window.alert('Senha incorreta.');
        return;
    }
    const transaction = db.transaction([storeName], 'readwrite');
    const request = transaction.objectStore(storeName).delete(key);
    request.onsuccess = () => {
        window.alert('Item excluído com sucesso!');
        document.getElementById('listModal').style.display = 'none';
        // Re-render relevant lists after deletion
        if (storeName === 'operadores') window.consultarOperador();
        else if (storeName === 'frotas') window.consultarFrota();
        else if (storeName === 'setores') window.consultarSetor();
        else if (storeName === 'atividades') window.consultarAtividade();
        else if (storeName === 'implementos') window.consultarImplemento();
        else if (storeName === 'historicoAtividades') window.mostrarBancoDeDados();
        else if (storeName === 'usuarios') window.loadUserList();
        else if (storeName === 'ordensServico') window.consultarOrdensServico(); // Added for OS
        else if (storeName === 'maintenancePlans') window.consultarPlanosManutencao(); // Added for Maintenance Plans
        else if (storeName === 'partsInventory') window.consultarPecas(); // Added for Parts
        else if (storeName === 'repairBudgets') window.consultarOrcamentos(); // Added for Budgets
        window.updateDisponibilidade(); // Update availability if frotas or activities change
    };
    request.onerror = (event) => {
        console.error(`Error deleting from ${storeName}:`, event.target.error);
        window.alert(`Erro ao excluir item de ${storeName}.`);
    };
}

window.handleEdit = async function(storeName, keyOrItem) {
    const password = window.prompt("Para editar, digite a senha de administrador:");
    if (password !== 'admin123') { // Simple password check for demo
        window.alert('Senha incorreta.');
        return;
    }

    const key = typeof keyOrItem === 'object' ? keyOrItem[db.transaction(storeName).objectStore(storeName).keyPath] : keyOrItem;

    const transaction = db.transaction([storeName], 'readonly');
    const request = transaction.objectStore(storeName).get(key);
    
    request.onsuccess = () => {
        const item = request.result;
        if (!item) { window.alert('Item não encontrado.'); return; }

        const modal = document.getElementById('editModal');
        const titleEl = document.getElementById('editModalTitle');
        const formEl = document.getElementById('editForm');
        
        titleEl.textContent = `Editar Item (ID: ${key})`;
        formEl.innerHTML = '';

        // Define fields based on storeName for specific edit forms
        let fieldsToEdit = [];
        if (storeName === 'ordensServico') {
            fieldsToEdit = [
                { key: 'frota', label: 'Frota', type: 'text', readonly: true },
                { key: 'modeloFrota', label: 'Modelo', type: 'text', readonly: true },
                { key: 'dataAbertura', label: 'Data Abertura', type: 'date', readonly: true },
                { key: 'solicitante', label: 'Solicitante', type: 'text' },
                { key: 'descricao', label: 'Descrição', type: 'textarea' },
                { key: 'tipo', label: 'Tipo', type: 'select', options: ['Corretiva', 'Preventiva'] },
                { key: 'status', label: 'Status', type: 'select', options: ['Aberta', 'Em Andamento', 'Concluída', 'Cancelada'] }
            ];
        } else if (storeName === 'maintenancePlans') {
            fieldsToEdit = [
                { key: 'frota', label: 'Frota', type: 'text', readonly: true },
                { key: 'modeloFrota', label: 'Modelo', type: 'text', readonly: true },
                { key: 'descricao', label: 'Descrição', type: 'textarea' },
                { key: 'tipoManutencao', label: 'Tipo', type: 'select', options: ['Horímetro', 'Tempo'] },
                { key: 'horimetroInterval', label: 'Intervalo (Horímetro)', type: 'number' },
                { key: 'tempoInterval', label: 'Intervalo (dias)', type: 'number' },
                { key: 'ultimaManutencao', label: 'Última Manutencao', type: 'date' },
                { key: 'proximaManutencao', label: 'Próxima Manutencao', type: 'date', readonly: true }
            ];
        } else if (storeName === 'partsInventory') {
            fieldsToEdit = [
                { key: 'nomePeca', label: 'Nome da Peça', type: 'text' },
                { key: 'codPeca', label: 'Cód. Peça', type: 'text' },
                { key: 'stockPeca', label: 'Stock', type: 'number' },
                { key: 'minStockPeca', label: 'Stock Mínimo', type: 'number' },
                { key: 'custoPeca', label: 'Custo Unitário (R$)', type: 'text' }
            ];
        } else if (storeName === 'repairBudgets') {
            fieldsToEdit = [
                { key: 'orcamentoOsId', label: 'OS ID', type: 'text', readonly: true },
                { key: 'orcamentoDescricao', label: 'Descrição', type: 'textarea' },
                { key: 'orcamentoValor', label: 'Valor (R$)', type: 'text' },
                { key: 'status', label: 'Status', type: 'select', options: ['Pendente', 'Aprovado', 'Rejeitado'] },
                { key: 'dataSubmissao', label: 'Data Submissão', type: 'date', readonly: true }
            ];
        } else if (storeName === 'usuarios') {
             fieldsToEdit = [
                { key: 'username', label: 'Usuário', type: 'text', readonly: true },
                { key: 'password', label: 'Senha', type: 'password' },
                { key: 'level', label: 'Nível', type: 'select', options: ['operacao', 'analista', 'administrador'] }
            ];
        } else if (storeName === 'abastecimentos') {
            fieldsToEdit = [
                { key: 'frota', label: 'Frota', type: 'text', readonly: true },
                { key: 'modelo', label: 'Modelo', type: 'text', readonly: true },
                { key: 'doc', label: 'Documento/NF', type: 'text' },
                { key: 'empresa', label: 'Empresa', type: 'text' },
                { key: 'horimetro', label: 'Horímetro', type: 'number' },
                { key: 'data', label: 'Data', type: 'date' },
                { key: 'hora', label: 'Hora', type: 'time' },
                { key: 'crachaMotorista', label: 'Crachá Motorista', type: 'text' },
                { key: 'nomeMotorista', label: 'Nome Motorista', type: 'text' },
                { key: 'crachaFrentista', label: 'Crachá Frentista', type: 'text' },
                { key: 'nomeFrentista', label: 'Nome Frentista', type: 'text' },
                { key: 'codProduto', label: 'Cód. Produto', type: 'text' },
                { key: 'nomeProduto', label: 'Nome Produto', type: 'text' },
                { key: 'local', label: 'Local', type: 'select', options: ['interno', 'externo'] },
                { key: 'volumeRestante', label: 'Volume Restante', type: 'number' },
                { key: 'volumeLitros', label: 'Volume (L)', type: 'number' }
            ];
        } else if (storeName === 'comprasCombustivel') {
            fieldsToEdit = [
                { key: 'codProduto', label: 'Cód. Produto', type: 'text' },
                { key: 'empresa', label: 'Empresa', type: 'text' },
                { key: 'volume', label: 'Volume (L)', type: 'number' },
                { key: 'valor', label: 'Valor (R$)', type: 'number' },
                { key: 'dataRegistro', label: 'Data Registo', type: 'date', readonly: true }
            ];
        } else { // Generic handling for other stores
            for (const prop in item) {
                if (prop === 'foto') continue;
                let type = 'text';
                if (typeof item[prop] === 'number') type = 'number';
                if (prop.toLowerCase().includes('data')) type = 'date';
                if (prop.toLowerCase().includes('hora')) type = 'time';
                if (prop.toLowerCase().includes('password')) type = 'password';
                fieldsToEdit.push({ key: prop, label: prop.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()), type: type, readonly: (prop === db.transaction(storeName).objectStore(storeName).keyPath) });
            }
        }


        for (const field of fieldsToEdit) {
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'field';
            const label = document.createElement('label');
            label.textContent = field.label;
            label.className = 'capitalize';
            
            let inputElement;
            if (field.type === 'select') {
                inputElement = document.createElement('select');
                inputElement.id = `edit_${field.key}`;
                inputElement.className = 'w-full p-2 border rounded';
                field.options.forEach(option => {
                    const optionEl = document.createElement('option');
                    optionEl.value = option;
                    optionEl.textContent = option;
                    if (option === item[field.key]) {
                        optionEl.selected = true;
                    }
                    inputElement.appendChild(optionEl);
                });
            } else if (field.type === 'textarea') {
                inputElement = document.createElement('textarea');
                inputElement.id = `edit_${field.key}`;
                inputElement.rows = 3;
                inputElement.className = 'w-full p-2 border rounded';
                inputElement.value = item[field.key] || '';
            } else {
                inputElement = document.createElement('input');
                inputElement.type = field.type;
                inputElement.id = `edit_${field.key}`;
                inputElement.className = 'w-full p-2 border rounded';
                inputElement.value = item[field.key] || '';
                if (field.readonly) {
                    inputElement.readOnly = true;
                    inputElement.classList.add('bg-gray-200');
                }
            }
            fieldDiv.appendChild(label);
            fieldDiv.appendChild(inputElement);
            formEl.appendChild(fieldDiv);
        }

        document.getElementById('editModalSaveBtn').onclick = () => {
            const updatedItem = { ...item };
            for (const field of fieldsToEdit) {
                const inputElement = document.getElementById(`edit_${field.key}`);
                if (inputElement) {
                    updatedItem[field.key] = inputElement.value;
                    // Convert to number if type is number
                    if (field.type === 'number') {
                        updatedItem[field.key] = parseFloat(inputElement.value);
                    }
                }
            }
            const saveTransaction = db.transaction([storeName], 'readwrite');
            saveTransaction.objectStore(storeName).put(updatedItem);
            saveTransaction.oncomplete = () => {
                window.alert('Item atualizado com sucesso!');
                modal.style.display = 'none';
                document.getElementById('listModal').style.display = 'none';
                // Re-render relevant lists after update
                if(storeName === 'historicoAtividades') window.mostrarBancoDeDados();
                else if (storeName === 'operadores') window.consultarOperador();
                else if (storeName === 'frotas') window.consultarFrota();
                else if (storeName === 'setores') window.consultarSetor();
                else if (storeName === 'atividades') window.consultarAtividade();
                else if (storeName === 'implementos') window.consultarImplemento();
                else if (storeName === 'usuarios') window.loadUserList();
                else if (storeName === 'ordensServico') window.consultarOrdensServico();
                else if (storeName === 'maintenancePlans') window.consultarPlanosManutencao();
                else if (storeName === 'partsInventory') window.consultarPecas();
                else if (storeName === 'repairBudgets') window.consultarOrcamentos();
                else if (storeName === 'abastecimentos') window.mostrarAbastecimentoSubpanel('formAbastecimento'); // Refresh abastecimento view
                else if (storeName === 'comprasCombustivel') window.mostrarAbastecimentoSubpanel('formCompraCombustivel'); // Refresh compras view
                window.updateDisponibilidade(); // Update availability if frotas or activities change
            };
            saveTransaction.onerror = (event) => {
                console.error(`Error updating item in ${storeName}:`, event.target.error);
                window.alert(`Erro ao atualizar item em ${storeName}.`);
            };
        };

        modal.style.display = 'flex';
    };
    request.onerror = (event) => {
        console.error(`Error fetching item for edit from ${storeName}:`, event.target.error);
        window.alert(`Erro ao buscar item para edição de ${storeName}.`);
    };
}

// --- Maintenance Specific Functions ---
window.salvarOS = async function() {
    const form = document.getElementById('osForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        window.showModal("Campos Faltando", "Por favor, preencha todos os campos obrigatórios.", () => {}, true);
        return;
    }

    const frota = document.getElementById('osFrota').value.toUpperCase();
    const modeloFrota = document.getElementById('osModelo').value.toUpperCase();
    const dataAbertura = document.getElementById('osDataAbertura').value;
    const solicitante = document.getElementById('osSolicitante').value;
    const descricao = document.getElementById('osDescricao').value;
    const tipo = document.getElementById('osTipo').value;

    const osData = {
        frota,
        modeloFrota,
        dataAbertura,
        solicitante,
        descricao,
        tipo,
        status: 'Aberta' // Initial status
    };

    try {
        await window.saveData('ordensServico', osData, "Ordem de Serviço aberta com sucesso!");
        window.limparFormulario('osForm');
        window.consultarOrdensServico(); // Update OS list
        window.updateDisponibilidade(); // Update fleet status
    } catch (error) {
        console.error("Erro ao salvar OS:", error);
        window.showModal("Erro", `Não foi possível abrir a Ordem de Serviço: ${error.message}`, () => {}, true);
    }
}

window.consultarOrdensServico = async function() {
    const osListContainer = document.getElementById('osListContainer');
    try {
        const ordensServico = await window.getAllData('ordensServico');

        if (ordensServico.length === 0) {
            osListContainer.innerHTML = '<p class="text-gray-600">Nenhuma Ordem de Serviço cadastrada.</p>';
            return;
        }

        let tableHtml = `
            <table class="consult-table">
                <thead>
                    <tr>
                        <th>OS ID</th>
                        <th>Frota</th>
                        <th>Modelo</th>
                        <th>Data Abertura</th>
                        <th>Solicitante</th>
                        <th>Descrição</th>
                        <th>Tipo</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
        `;
        ordensServico.forEach(osData => {
            const osId = osData.id;
            const statusClass = osData.status === 'Aberta' ? 'status-inconsistente' :
                                osData.status === 'Em Andamento' ? 'status-revision-strong' : 'status-ok';

            tableHtml += `
                <tr>
                    <td>${osId}</td>
                    <td>${osData.frota}</td>
                    <td>${osData.modeloFrota}</td>
                    <td>${osData.dataAbertura}</td>
                    <td>${osData.solicitante}</td>
                    <td>${osData.descricao}</td>
                    <td>${osData.tipo}</td>
                    <td><span class="status-cell ${statusClass}">${osData.status}</span></td>
                    <td>
                        <button class="btn blue px-3 py-1 text-xs" onclick="window.handleEdit('ordensServico', ${osId})">Editar</button>
                        <button class="btn red px-3 py-1 text-xs ml-2" onclick="window.handleDelete('ordensServico', ${osId})">Excluir</button>
                    </td>
                </tr>
            `;
        });
        tableHtml += `</tbody></table>`;
        osListContainer.innerHTML = tableHtml;
    } catch (error) {
        console.error("Erro ao consultar Ordens de Serviço:", error);
        osListContainer.innerHTML = '<p class="text-red-600">Erro ao carregar Ordens de Serviço.</p>';
    }
}

// --- New Maintenance Management Functions ---

// Function to toggle maintenance interval fields based on type
document.getElementById('tipoManutencao').addEventListener('change', function() {
    const tipo = this.value;
    document.getElementById('horimetroIntervalField').style.display = tipo === 'Horímetro' ? 'flex' : 'none';
    document.getElementById('tempoIntervalField').style.display = tipo === 'Tempo' ? 'flex' : 'none';
    // Clear values when switching type
    document.getElementById('horimetroInterval').value = '';
    document.getElementById('tempoInterval').value = '';
});

window.salvarPlanoManutencao = async function() {
    const form = document.getElementById('planosManutencaoForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        window.showModal("Campos Faltando", "Por favor, preencha todos os campos obrigatórios.", () => {}, true);
        return;
    }

    const frota = document.getElementById('planoFrota').value.toUpperCase();
    const modeloFrota = document.getElementById('planoModelo').value.toUpperCase();
    const descricao = document.getElementById('planoDescricao').value;
    const tipoManutencao = document.getElementById('tipoManutencao').value;
    const horimetroInterval = tipoManutencao === 'Horímetro' ? parseFloat(document.getElementById('horimetroInterval').value) : null;
    const tempoInterval = tipoManutencao === 'Tempo' ? parseInt(document.getElementById('tempoInterval').value) : null;
    const ultimaManutencao = document.getElementById('ultimaManutencao').value;

    const planoData = {
        frota,
        modeloFrota,
        descricao,
        tipoManutencao,
        horimetroInterval,
        tempoInterval,
        ultimaManutencao,
        proximaManutencao: null // To be calculated
    };

    try {
        // Simple calculation for next maintenance date (can be more complex)
        if (tipoManutencao === 'Tempo' && ultimaManutencao && tempoInterval) {
            const lastMaintenanceDate = new Date(ultimaManutencao);
            lastMaintenanceDate.setDate(lastMaintenanceDate.getDate() + tempoInterval);
            planoData.proximaManutencao = lastMaintenanceDate.toISOString().split('T')[0];
        }
        // For horimeter, next maintenance would depend on current horimeter reading, which is dynamic.
        // This would require a background check or trigger based on activity logging.

        await window.saveData('maintenancePlans', planoData, "Plano de manutenção salvo com sucesso!");
        window.limparFormulario('planosManutencaoForm');
        window.consultarPlanosManutencao();
    } catch (error) {
        console.error("Erro ao salvar plano de manutenção:", error);
        window.showModal("Erro", `Não foi possível salvar o plano de manutenção: ${error.message}`, () => {}, true);
    }
}

window.consultarPlanosManutencao = async function() {
    const planosManutencaoListContainer = document.getElementById('planosManutencaoTable');
    try {
        const planos = await window.getAllData('maintenancePlans');

        if (planos.length === 0) {
            planosManutencaoListContainer.innerHTML = '<p class="text-gray-600">Nenhum plano de manutenção cadastrado.</p>';
            return;
        }

        let tableHtml = `
            <table class="consult-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Frota</th>
                        <th>Descrição</th>
                        <th>Tipo</th>
                        <th>Intervalo</th>
                        <th>Última Manut.</th>
                        <th>Próxima Manut.</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
        `;
        planos.forEach(plano => {
            const intervaloText = plano.tipoManutencao === 'Horímetro' ? `${plano.horimetroInterval} Horas` : `${plano.tempoInterval} dias`;
            tableHtml += `
                <tr>
                    <td>${plano.id}</td>
                    <td>${plano.frota}</td>
                    <td>${plano.descricao}</td>
                    <td>${plano.tipoManutencao}</td>
                    <td>${intervaloText}</td>
                    <td>${plano.ultimaManutencao || '-'}</td>
                    <td>${plano.proximaManutencao || '-'}</td>
                    <td>
                        <button class="btn blue px-3 py-1 text-xs" onclick="window.handleEdit('maintenancePlans', ${plano.id})">Editar</button>
                        <button class="btn red px-3 py-1 text-xs ml-2" onclick="window.handleDelete('maintenancePlans', ${plano.id})">Excluir</button>
                    </td>
                </tr>
            `;
        });
        tableHtml += `</tbody></table>`;
        planosManutencaoListContainer.innerHTML = tableHtml;
    } catch (error) {
        console.error("Erro ao consultar planos de manutenção:", error);
        planosManutencaoListContainer.innerHTML = '<p class="text-red-600">Erro ao carregar planos de manutenção.</p>';
    }
}

window.salvarPeca = async function() {
    const form = document.getElementById('pecaForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        window.showModal("Campos Faltando", "Por favor, preencha todos os campos obrigatórios.", () => {}, true);
        return;
    }

    const nomePeca = document.getElementById('nomePeca').value.trim();
    const codPeca = document.getElementById('codPeca').value.trim();
    const stockPeca = parseInt(document.getElementById('stockPeca').value);
    const minStockPeca = parseInt(document.getElementById('minStockPeca').value) || 0;
    const custoPeca = parseFloat(document.getElementById('custoPeca').value) || 0;

    const pecaData = {
        nomePeca,
        codPeca,
        stockPeca,
        minStockPeca,
        custoPeca
    };

    try {
        await window.saveData('partsInventory', pecaData, "Peça salva com sucesso!");
        window.limparFormulario('pecaForm');
        window.consultarPecas();
    } catch (error) {
        console.error("Erro ao salvar peça:", error);
        window.showModal("Erro", `Não foi possível salvar a peça: ${error.message}`, () => {}, true);
    }
}

window.consultarPecas = async function() {
    const pecasListContainer = document.getElementById('pecasTable');
    try {
        const pecas = await window.getAllData('partsInventory');

        if (pecas.length === 0) {
            pecasListContainer.innerHTML = '<p class="text-gray-600">Nenhuma peça cadastrada.</p>';
            return;
        }

        let tableHtml = `
            <table class="consult-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome da Peça</th>
                        <th>Cód. Peça</th>
                        <th>Stock</th>
                        <th>Stock Mínimo</th>
                        <th>Custo Unit. (R$)</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
        `;
        pecas.forEach(peca => {
            const statusClass = peca.stockPeca <= peca.minStockPeca ? 'status-inconsistente' : 'status-ok';
            const statusText = peca.stockPeca <= peca.minStockPeca ? 'Baixo Stock' : 'OK';
            tableHtml += `
                <tr>
                    <td>${peca.id}</td>
                    <td>${peca.nomePeca}</td>
                    <td>${peca.codPeca || '-'}</td>
                    <td>${peca.stockPeca}</td>
                    <td>${peca.minStockPeca}</td>
                    <td>${peca.custoPeca.toFixed(2)}</td>
                    <td><span class="status-cell ${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="btn blue px-3 py-1 text-xs" onclick="window.handleEdit('partsInventory', ${peca.id})">Editar</button>
                        <button class="btn red px-3 py-1 text-xs ml-2" onclick="window.handleDelete('partsInventory', ${peca.id})">Excluir</button>
                    </td>
                </tr>
            `;
        });
        tableHtml += `</tbody></table>`;
        pecasListContainer.innerHTML = tableHtml;
    } catch (error) {
        console.error("Erro ao consultar peças:", error);
        pecasListContainer.innerHTML = '<p class="text-red-600">Erro ao carregar inventário de peças.</p>';
    }
}

window.salvarOrcamento = async function() {
    const form = document.getElementById('orcamentoForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        window.showModal("Campos Faltando", "Por favor, preencha todos os campos obrigatórios.", () => {}, true);
        return;
    }

    const orcamentoOsId = parseInt(document.getElementById('orcamentoOsId').value);
    const orcamentoDescricao = document.getElementById('orcamentoDescricao').value;
    const orcamentoValor = parseFloat(document.getElementById('orcamentoValor').value);

    const orcamentoData = {
        orcamentoOsId,
        orcamentoDescricao,
        orcamentoValor,
        status: 'Pendente',
        dataSubmissao: new Date().toISOString().split('T')[0]
    };

    try {
        await window.saveData('repairBudgets', orcamentoData, "Orçamento submetido com sucesso!");
        window.limparFormulario('orcamentoForm');
        window.consultarOrcamentos();
    } catch (error) {
        console.error("Erro ao salvar orçamento:", error);
        window.showModal("Erro", `Não foi possível submeter o orçamento: ${error.message}`, () => {}, true);
    }
}

window.consultarOrcamentos = async function() {
    const orcamentosListContainer = document.getElementById('orcamentosTable');
    try {
        const orcamentos = await window.getAllData('repairBudgets');

        if (orcamentos.length === 0) {
            orcamentosListContainer.innerHTML = '<p class="text-gray-600">Nenhum orçamento para exibir.</p>';
            return;
        }

        let tableHtml = `
            <table class="consult-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>OS ID</th>
                        <th>Descrição</th>
                        <th>Valor (R$)</th>
                        <th>Status</th>
                        <th>Data Submissão</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
        `;
        orcamentos.forEach(orcamento => {
            const statusClass = orcamento.status === 'Pendente' ? 'status-inconsistente' :
                                orcamento.status === 'Aprovado' ? 'status-ok' : 'status-red';
            tableHtml += `
                <tr>
                    <td>${orcamento.id}</td>
                    <td>${orcamento.orcamentoOsId}</td>
                    <td>${orcamento.orcamentoDescricao}</td>
                    <td>${orcamento.orcamentoValor.toFixed(2)}</td>
                    <td><span class="status-cell ${statusClass}">${orcamento.status}</span></td>
                    <td>${orcamento.dataSubmissao}</td>
                    <td>
                        ${orcamento.status === 'Pendente' ? `
                        <button class="btn green px-3 py-1 text-xs" onclick="window.aprovarOrcamento(${orcamento.id})">Aprovar</button>
                        <button class="btn red px-3 py-1 text-xs ml-2" onclick="window.rejeitarOrcamento(${orcamento.id})">Rejeitar</button>
                        ` : '-'}
                        <button class="btn blue px-3 py-1 text-xs ml-2" onclick="window.handleEdit('repairBudgets', ${orcamento.id})">Editar</button>
                        <button class="btn red px-3 py-1 text-xs ml-2" onclick="window.handleDelete('repairBudgets', ${orcamento.id})">Excluir</button>
                    </td>
                </tr>
            `;
        });
        tableHtml += `</tbody></table>`;
        orcamentosListContainer.innerHTML = tableHtml;
    } catch (error) {
        console.error("Erro ao consultar orçamentos:", error);
        orcamentosListContainer.innerHTML = '<p class="text-red-600">Erro ao carregar orçamentos.</p>';
    }
}

window.aprovarOrcamento = function(orcamentoId) {
    window.showModal('Aprovar Orçamento', 'Tem certeza que deseja aprovar este orçamento?', () => {
        const password = window.prompt("Digite a senha de administrador para aprovar:");
        if (password === 'admin123') {
            const transaction = db.transaction(['repairBudgets'], 'readwrite');
            const store = transaction.objectStore('repairBudgets');
            const request = store.get(orcamentoId);
            request.onsuccess = () => {
                const orcamento = request.result;
                if (orcamento) {
                    orcamento.status = 'Aprovado';
                    store.put(orcamento);
                    transaction.oncomplete = () => {
                        window.alert('Orçamento aprovado!');
                        window.consultarOrcamentos();
                    };
                }
            };
        } else {
            window.alert('Senha incorreta.');
        }
    }, false); // Not a warning, but needs confirmation
}

window.rejeitarOrcamento = function(orcamentoId) {
    window.showModal('Rejeitar Orçamento', 'Tem certeza que deseja rejeitar este orçamento?', () => {
        const password = window.prompt("Digite a senha de administrador para rejeitar:");
        if (password === 'admin123') {
            const transaction = db.transaction(['repairBudgets'], 'readwrite');
            const store = transaction.objectStore('repairBudgets');
            const request = store.get(orcamentoId);
            request.onsuccess = () => {
                const orcamento = request.result;
                if (orcamento) {
                    orcamento.status = 'Rejeitado';
                    store.put(orcamento);
                    transaction.oncomplete = () => {
                        window.alert('Orçamento rejeitado!');
                        window.consultarOrcamentos();
                    };
                }
            };
        } else {
            window.alert('Senha incorreta.');
        }
    }, true); // Is a warning, needs confirmation
}

window.consultarHistoricoManutencao = async function() {
    const historicoManutencaoListContainer = document.getElementById('historicoManutencaoListContainer');
    const frotaFilter = document.getElementById('historicoFrotaFilter').value.toUpperCase();
    try {
        const todasOS = await window.getAllData('ordensServico');
        const todasAtividadesHistorico = await window.getAllData('historicoAtividades');

        let historicoCombinado = [];

        // Adicionar Ordens de Serviço (concluídas ou canceladas)
        todasOS.forEach(os => {
            if (os.status === 'Concluída' || os.status === 'Cancelada') {
                historicoCombinado.push({
                    tipo: 'OS',
                    id: os.id,
                    frota: os.frota,
                    modeloFrota: os.modeloFrota,
                    data: os.dataAbertura,
                    descricao: os.descricao,
                    status: os.status,
                    horas: 'N/A' // OS might not have direct hours
                });
            }
        });

        // Adicionar atividades de Manutenção do histórico de atividades
        todasAtividadesHistorico.forEach(ativ => {
            if (ativ.atividade.toUpperCase() === 'MANUTENÇÃO') {
                historicoCombinado.push({
                    tipo: 'Atividade',
                    id: ativ.id,
                    frota: ativ.frota,
                    modeloFrota: ativ.equipamento,
                    data: ativ.dataFinal,
                    descricao: ativ.relatoProblema || 'Manutenção geral',
                    status: ativ.status,
                    horas: ativ.horasHorimetro // Hours from activity
                });
            }
        });

        // Filtrar se um código de frota for fornecido
        if (frotaFilter) {
            historicoCombinado = historicoCombinado.filter(item => item.frota === frotaFilter);
        }

        // Ordenar por data (mais recente primeiro)
        historicoCombinado.sort((a, b) => new Date(b.data).getTime() - new Date(a.data).getTime());

        if (historicoCombinado.length === 0) {
            historicoManutencaoListContainer.innerHTML = '<p class="text-gray-600">Nenhum histórico de manutenção encontrado.</p>';
            return;
        }

        let tableHtml = `
            <table class="consult-table">
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>ID</th>
                        <th>Frota</th>
                        <th>Modelo</th>
                        <th>Data</th>
                        <th>Descrição</th>
                        <th>Status</th>
                        <th>Horas</th>
                    </tr>
                </thead>
                <tbody>
        `;
        historicoCombinado.forEach(item => {
            let statusClass = 'status-ok';
            if (item.status === 'Cancelada' || item.status === 'Inconsistente') {
                statusClass = 'status-inconsistente';
            } else if (item.status === 'Em Andamento') {
                statusClass = 'status-revision-strong';
            }
            tableHtml += `
                <tr>
                    <td>${item.tipo}</td>
                    <td>${item.id}</td>
                    <td>${item.frota}</td>
                    <td>${item.modeloFrota}</td>
                    <td>${item.data}</td>
                    <td>${item.descricao}</td>
                    <td><span class="status-cell ${statusClass}">${item.status}</span></td>
                    <td>${item.horas}</td>
                </tr>
            `;
        });
        tableHtml += `</tbody></table>`;
        historicoManutencaoListContainer.innerHTML = tableHtml;

    } catch (error) {
        console.error("Erro ao consultar histórico de manutenção:", error);
        historicoManutencaoListContainer.innerHTML = '<p class="text-red-600">Erro ao carregar histórico de manutenção.</p>';
    }
}

// --- Fueling Specific Functions ---
window.toggleVolumeRestante = function(local) {
    const volumeRestanteField = document.getElementById('volumeRestanteField');
    const volumeRestanteInput = document.getElementById('volumeRestante');
    if (local === 'interno') {
        volumeRestanteField.style.display = 'flex';
        volumeRestanteInput.setAttribute('required', 'true');
        volumeRestanteInput.value = '1000.00 L'; // Example value for internal tank
    } else {
        volumeRestanteField.style.display = 'none';
        volumeRestanteInput.removeAttribute('required');
        volumeRestanteInput.value = '';
    }
}

window.buscarProduto = async function(codProduto, nomeProdutoFieldId) {
    // This is a placeholder. In a real app, you would fetch this from an 'produtos' object store.
    const produtos = {
        'DIESELS10': 'DIESEL S10',
        'GASOLINA': 'GASOLINA COMUM',
    };
    const nomeProdutoInput = document.getElementById(nomeProdutoFieldId);
    if (produtos[codProduto]) {
        nomeProdutoInput.value = produtos[codProduto];
    } else {
        nomeProdutoInput.value = 'Produto não encontrado';
    }
}

window.salvarAbastecimento = async function() {
    const form = document.getElementById('abastecimentoForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        window.showModal("Campos Faltando", "Por favor, preencha todos os campos obrigatórios.", () => {}, true);
        return;
    }

    const frota = document.getElementById('abastecimentoFrota').value.toUpperCase();
    const modelo = document.getElementById('abastecimentoModelo').value.toUpperCase();
    const doc = document.getElementById('abastecimentoDoc').value;
    const empresa = document.getElementById('abastecimentoEmpresa').value;
    const horimetro = parseFloat(document.getElementById('abastecimentoHorimetro').value);
    const data = document.getElementById('abastecimentoData').value;
    const hora = document.getElementById('abastecimentoHora').value;
    const crachaMotorista = document.getElementById('abastecimentoMotorista').value.toUpperCase();
    const nomeMotorista = document.getElementById('nomeMotorista').value.toUpperCase();
    const crachaFrentista = document.getElementById('abastecimentoFrentista').value.toUpperCase();
    const nomeFrentista = document.getElementById('nomeFrentista').value.toUpperCase();
    const codProduto = document.getElementById('abastecimentoCodProduto').value.toUpperCase();
    const nomeProduto = document.getElementById('nomeProduto').value.toUpperCase();
    const local = document.getElementById('abastecimentoLocal').value;
    const volumeRestante = local === 'interno' ? parseFloat(document.getElementById('volumeRestante').value) : null;

    const abastecimentoData = {
        frota,
        modelo,
        doc,
        empresa,
        horimetro,
        data,
        hora,
        crachaMotorista,
        nomeMotorista,
        crachaFrentista,
        nomeFrentista,
        codProduto,
        nomeProduto,
        local,
        volumeRestante,
        volumeLitros: 50 // Placeholder for volume dispensed
    };

    try {
        await window.saveData('abastecimentos', abastecimentoData, "Abastecimento registrado com sucesso!");
        window.limparFormulario('abastecimentoForm');
    }
    catch (error) {
        console.error("Erro ao salvar abastecimento:", error);
        window.showModal("Erro", `Não foi possível registrar o abastecimento: ${error.message}`, () => {}, true);
    }
}

window.salvarCompraCombustivel = async function() {
    const form = document.getElementById('compraCombustivelForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        window.showModal("Campos Faltando", "Por favor, preencha todos os campos obrigatórios.", () => {}, true);
        return;
    }

    const codProduto = document.getElementById('compraCodProduto').value.toUpperCase();
    const empresa = document.getElementById('compraEmpresa').value;
    const volume = parseFloat(document.getElementById('compraVolume').value);
    const valor = parseFloat(document.getElementById('compraValor').value);

    const compraData = {
        codProduto,
        empresa,
        volume,
        valor,
        dataRegistro: new Date().toISOString().split('T')[0] // Current date
    };

    try {
        await window.saveData('comprasCombustivel', compraData, "Compra de combustível registrada com sucesso!");
        window.limparFormulario('compraCombustivelForm');
    } catch (error) {
        console.error("Erro ao salvar compra de combustível:", error);
        window.showModal("Erro", `Não foi possível registrar a compra: ${error.message}`, () => {}, true);
    }
}

</script>
</body>
</html>
