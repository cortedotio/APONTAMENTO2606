<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestão de Frotas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      padding: 24px;
      background-color: #e0e7ff;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .card {
      padding: 32px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      width: 100%;
      max-width: 768px;
      background-color: #ffffff;
      border: 1px solid #e2e8f0;
    }
    h2 {
      font-size: 2.25rem;
      font-weight: 800;
      color: #1a202c;
      margin-bottom: 20px;
    }
    h3 {
      font-size: 1.75rem;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid #edf2f7;
    }
    h4 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 12px;
    }
    .btn {
      padding: 12px 28px;
      border: none;
      color: white;
      border-radius: 10px;
      cursor: pointer;
      margin: 6px 4px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      background-image: linear-gradient(145deg, var(--color-light), var(--color-dark));
    }
    .btn.yellow { --color-light: #ffeb3b; --color-dark: #fbc02d; color: #333; }
    .btn.green { --color-light: #4CAF50; --color-dark: #388E3C; }
    .btn.red { --color-light: #f44336; --color-dark: #d32f2f; }
    .btn.blue { --color-light: #2196F3; --color-dark: #1976D2; }
    .btn.purple { --color-light: #9C27B0; --color-dark: #7B1FA2; }
    .btn.darkblue { --color-light: #3F51B5; --color-dark: #303F9F; }
    .btn.teal { --color-light: #009688; --color-dark: #00796B; }
    .btn.orange { --color-light: #FF9800; --color-dark: #F57C00; }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      opacity: 1;
    }
    .field {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
    @media (min-width: 640px) {
      .field {
        flex-direction: row;
        align-items: center;
        gap: 16px;
      }
    }
    .field label {
      flex: 0 0 140px;
      color: #4a5568;
      font-weight: 600;
      font-size: 0.95rem;
    }
    .field input[type="text"],
    .field input[type="date"],
    .field input[type="time"],
    .field input[type="password"],
    .field select,
    .field textarea {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #cbd5e0;
      border-radius: 8px;
      box-sizing: border-box;
      width: 100%;
      font-size: 1rem;
      color: #2d3748;
      background-color: #f7fafc;
      transition: all 0.2s ease-in-out;
    }
    .field input:focus, .field select:focus, .field textarea:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
      background-color: #ffffff;
    }
    .field img {
      margin-left: 0;
      margin-top: 12px;
      width: 90px;
      height: 90px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #6366f1;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    @media (min-width: 640px) {
      .field img {
        margin-left: 20px;
        margin-top: 0;
      }
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    .checklist {
      padding: 20px;
      border: 1px solid #d1d8e0;
      border-radius: 12px;
      background-color: #f0f4f8;
      margin-top: 24px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }
    .checklist h4 {
      color: #333;
      margin-top: 0;
      margin-bottom: 16px;
      text-align: center;
      font-size: 1.35rem;
    }
    .checklist label {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      font-size: 0.9rem;
      color: #4a5568;
    }
    .checklist input[type="radio"] {
        transform: scale(1.2);
        cursor: pointer;
    }
    .admin-panel {
      display: none;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid #e2e8f0;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.6);
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(4px);
    }
    .modal-content {
        background-color: #ffffff;
        padding: 30px;
        border: 1px solid #b2c1d3;
        border-radius: 16px;
        width: 90%;
        max-width: 650px; /* Increased width for lists */
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .modal-warning-background {
        background-color: #ffebee;
        border-color: #ef9a9a;
    }
    .modal-warning-background h3,
    .modal-warning-background p {
        color: #c62828;
    }
    .modal-content h3 {
        font-size: 1.6rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 12px;
        border-bottom: none;
    }
    .modal-content p {
        font-size: 1.05rem;
        color: #555;
        margin-bottom: 24px;
        line-height: 1.5;
        white-space: pre-wrap; /* Allows line breaks in the message */
    }
    .modal-buttons button {
        margin: 0 10px;
        min-width: 100px;
    }
    .modal-list-content {
        max-height: 400px;
        overflow-y: auto;
        margin-top: 1rem;
    }
    .availability-table, .consult-table, .data-table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 8px;
        overflow: hidden;
        margin-top: 16px;
    }
    .availability-table th, .availability-table td,
    .consult-table th, .consult-table td,
    .data-table th, .data-table td {
        padding: 12px 8px;
        font-size: 0.9rem;
        text-align: left;
        border: 1px solid #e2e8f0;
    }
    .availability-table thead, .consult-table thead, .data-table thead {
        background-color: #e2e8f0;
        color: #4a5568;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.8rem;
    }
    .availability-table tbody tr:nth-child(even),
    .consult-table tbody tr:nth-child(even),
    .data-table tbody tr:nth-child(even) {
        background-color: #f7fafc;
    }
    .availability-table tbody tr:hover,
    .consult-table tbody tr:hover,
    .data-table tbody tr:hover {
        background-color: #ebf4ff;
    }
    @media (max-width: 640px) {
        .availability-table, .consult-table, .data-table { border: none; }
        .availability-table thead, .consult-table thead, .data-table thead { display: none; }
        .availability-table tr, .consult-table tr, .data-table tr {
            margin-bottom: 16px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            background-color: #ffffff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            display: block;
            width: 100%;
        }
        .availability-table td, .consult-table td, .data-table td {
            border-bottom: 1px dotted #e2e8f0;
            text-align: right;
            padding-left: 50%;
            position: relative;
            display: block;
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
        }
        .availability-table td:last-child, .consult-table td:last-child, .data-table td:last-child { border-bottom: 0; }
    }
    .status-maintenance-strong { background-color: #D32F2F; color: #FFFFFF; font-weight: 600; }
    .status-revision-strong { background-color: #3F51B5; color: #FFFFFF; font-weight: 600; }
    .status-active { background-color: #BBDEFB; color: #1A237E; font-weight: 600; }
    .status-cell {
        padding: 6px 12px;
        border-radius: 6px;
        display: inline-block;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .status-ok { background-color: #c8e6c9; color: #2e7d32; }
    .status-inconsistente { background-color: #ffebee; color: #d32f2f; }
  </style>
</head>
<body>

<!-- Main Fleet Management Panel -->
<div class="card" id="gestaoDeFrotasPanel">
    <div class="flex items-center gap-4 mb-4">
        <img id="logoGestao" alt="Logotipo da Empresa" class="h-14">
        <h2 class="flex-grow" style="margin-bottom: 0;">Gestão de Frotas</h2>
    </div>
    <p class="text-gray-600 mb-8">Selecione uma das opções abaixo para gerenciar a frota de empilhadeiras.</p>
    <div class="flex flex-wrap justify-center items-center gap-4">
        <button class="btn blue" onclick="showApp('statusDeAtividadePanel')">Status de Atividade</button>
        <button class="btn teal" onclick="alert('Função em desenvolvimento.')">Gestao de Manutenção</button>
        <button class="btn orange" onclick="alert('Função em desenvolvimento.')">Gestao de Abastecimento</button>
        <button class="btn purple" onclick="alert('Função em desenvolvimento.')">Gestão de Pneus</button>
    </div>
</div>

<!-- Forklift Activity Application Panel (hidden by default) -->
<div class="card" id="statusDeAtividadePanel" style="display:none;">
  <div class="flex justify-between items-center mb-6">
    <div class="flex items-center gap-4">
        <img id="logoStatus" alt="Logotipo da Empresa" class="h-14">
        <h2 id="panelTitle" style="margin-bottom: 0;">Status de Atividade</h2>
    </div>
    <div>
        <button class="btn purple" id="btnAdministrador" onclick="mostrar('administrador')">Administrador</button>
        <button class="btn red" onclick="showApp('gestaoDeFrotasPanel')">Voltar</button>
    </div>
  </div>
  
  <div class="flex flex-wrap justify-center mb-8 gap-3">
    <button class="btn yellow" id="btnDisponibilidade" onclick="mostrar('disponibilidade')">Disponibilidade</button>
    <button class="btn green" id="btnInicioAtividade" onclick="mostrar('inicio')">Início de Atividade</button>
    <button class="btn red" id="btnEncerramentoAtividade" onclick="mostrar('fim')">Encerramento de Atividade</button>
    <button class="btn blue" id="btnCadastro" style="display:none;" onclick="mostrar('cadastro')">Cadastro</button>
    <button class="btn blue" id="btnRelatorio" style="display:none;" onclick="mostrar('relatorio')">Relatório</button>
    <button class="btn darkblue" id="btnDados" style="display:none;" onclick="mostrar('dados')">Dados</button>
  </div>
  
  <div id="inicio" style="display:none; margin-top:20px;">
    <h3>Início de Atividade</h3>
    <form id="formInicio">
      <div class="flex justify-end mb-4">
        <button class="btn red" type="button" onclick="limparFormulario('formInicio')">Limpar Formulário</button>
      </div>
      <div class="field">
        <label for="crachaInicio">Crachá</label>
        <input type="text" name="crachaInicio" id="crachaInicio" oninput="this.value = this.value.toUpperCase(); buscarOperador(this.value,'nomeInicio','fotoInicio');" required>
        <label for="nomeInicio">Operador</label>
        <input type="text" id="nomeInicio" readonly>
        <img id="fotoInicio" src="https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR" alt="Foto Operador">
      </div>
      <div class="field">
        <label for="dataInicial">Data Inicial</label>
        <input type="date" name="dataInicial" id="dataInicial" required onclick="confirmarDataHora('dataInicial','horaInicial')">
      </div>
      <div class="field">
        <label for="horaInicial">Hora Inicial</label>
        <input type="time" id="horaInicial" name="horaInicial" required>
      </div>
      <div class="field">
        <label for="frotaInicio">Frota</label>
        <input type="text" name="frotaInicio" id="frotaInicio" oninput="this.value = this.value.toUpperCase(); mostrarModeloFrota(this.value,'equipamentoInicio','fotoEquipInicio');" required>
        <img id="fotoEquipInicio" src="https://placehold.co/100x100/A0AEC0/000000?text=FROTA" alt="Foto Frota">
      </div>
      <div class="field">
        <label for="equipamentoInicio">Equipamento</label>
        <input type="text" id="equipamentoInicio" readonly>
      </div>
      <div class="field">
        <label for="horimetroInicial">Horímetro Inicial</label>
        <input type="text" name="horimetroInicial" id="horimetroInicial" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" required>
      </div>
      <div class="field">
        <label for="setorInicio">Setor</label>
        <select id="setorInicio" required></select>
      </div>
      <div class="field">
        <label for="atividadeInicio">Atividade</label>
        <select id="atividadeInicio" onchange="toggleRelatoProblema()" required></select>
      </div>
      <div class="field" id="relatoProblemaField" style="display:none;">
        <label for="relatoProblema">Relato do Problema</label>
        <textarea name="relatoProblema" id="relatoProblema" rows="3" placeholder="Descreva o problema da manutenção"></textarea>
      </div>
      <div class="field">
        <label for="implementoInicio">Implemento</label>
        <select id="implementoInicio" required></select>
      </div>
      <div class="checklist" id="safetyChecklist">
        <h4 class="font-bold uppercase text-center mb-4">Checklist de Segurança</h4>
        <div class="grid grid-cols-12 gap-2 items-center text-center font-bold text-gray-700 text-sm mb-2">
            <div class="col-span-1">OK</div>
            <div class="col-span-6 text-left cursor-pointer" onclick="hideAllChecklistReports()">ITENS A CONFERIR</div>
            <div class="col-span-2">NÃO CONFORME</div>
            <div class="col-span-3 text-left">RELATAR</div>
        </div>
        <div class="grid grid-cols-12 gap-2 items-center mb-3">
            <div class="col-span-1 flex justify-center"><input type="radio" name="status_OleoMotor" value="OK" checked required></div>
            <div class="col-span-6 text-left text-sm">Óleo do Motor</div>
            <div class="col-span-2 flex justify-center"><input type="radio" name="status_OleoMotor" value="NÃO CONFORME" data-target-textarea="relato_OleoMotor" onchange="toggleNonConformityReport(this)"></div>
            <div class="col-span-3"><textarea name="relato_OleoMotor" id="relato_OleoMotor" rows="1" placeholder="Relatar não conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea></div>
        </div>
        <div class="grid grid-cols-12 gap-2 items-center mb-3">
            <div class="col-span-1 flex justify-center"><input type="radio" name="status_OleoHidraulico" value="OK" checked required></div>
            <div class="col-span-6 text-left text-sm">Óleo Hidráulico</div>
            <div class="col-span-2 flex justify-center"><input type="radio" name="status_OleoHidraulico" value="NÃO CONFORME" data-target-textarea="relato_OleoHidraulico" onchange="toggleNonConformityReport(this)"></div>
            <div class="col-span-3"><textarea name="relato_OleoHidraulico" id="relato_OleoHidraulico" rows="1" placeholder="Relatar não conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea></div>
        </div>
        <div class="grid grid-cols-12 gap-2 items-center mb-3">
            <div class="col-span-1 flex justify-center"><input type="radio" name="status_OleoTransmissao" value="OK" checked required></div>
            <div class="col-span-6 text-left text-sm">Óleo da Transmissão</div>
            <div class="col-span-2 flex justify-center"><input type="radio" name="status_OleoTransmissao" value="NÃO CONFORME" data-target-textarea="relato_OleoTransmissao" onchange="toggleNonConformityReport(this)"></div>
            <div class="col-span-3"><textarea name="relato_OleoTransmissao" id="relato_OleoTransmissao" rows="1" placeholder="Relatar não conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea></div>
        </div>
        <div class="grid grid-cols-12 gap-2 items-center mb-3">
            <div class="col-span-1 flex justify-center"><input type="radio" name="status_Extintor" value="OK" checked required></div>
            <div class="col-span-6 text-left text-sm">Extintor</div>
            <div class="col-span-2 flex justify-center"><input type="radio" name="status_Extintor" value="NÃO CONFORME" data-target-textarea="relato_Extintor" onchange="toggleNonConformityReport(this)"></div>
            <div class="col-span-3"><textarea name="relato_Extintor" id="relato_Extintor" rows="1" placeholder="Relatar não conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea></div>
        </div>
        <div class="grid grid-cols-12 gap-2 items-center mb-3">
            <div class="col-span-1 flex justify-center"><input type="radio" name="status_Pneus" value="OK" checked required></div>
            <div class="col-span-6 text-left text-sm">Pneus</div>
            <div class="col-span-2 flex justify-center"><input type="radio" name="status_Pneus" value="NÃO CONFORME" data-target-textarea="relato_Pneus" onchange="toggleNonConformityReport(this)"></div>
            <div class="col-span-3"><textarea name="relato_Pneus" id="relato_Pneus" rows="1" placeholder="Relatar não conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea></div>
        </div>
        <div class="grid grid-cols-12 gap-2 items-center mb-3">
            <div class="col-span-1 flex justify-center"><input type="radio" name="status_ParteEletrica" value="OK" checked required></div>
            <div class="col-span-6 text-left text-sm">Parte Elétrica</div>
            <div class="col-span-2 flex justify-center"><input type="radio" name="status_ParteEletrica" value="NÃO CONFORME" data-target-textarea="relato_ParteEletrica" onchange="toggleNonConformityReport(this)"></div>
            <div class="col-span-3"><textarea name="relato_ParteEletrica" id="relato_ParteEletrica" rows="1" placeholder="Relatar não conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea></div>
        </div>
      </div>
      <button class="btn blue mt-6" type="button" onclick="enviarInicio(event)">Salvar Início</button>
    </form>
  </div>
  
  <div id="disponibilidade" style="display:none; margin-top:20px;">
    <h3>Disponibilidade</h3>
    <div id="disponibilidadeContent"><p class="text-gray-600">Nenhuma frota cadastrada ou atividade em andamento para exibir.</p></div>
    <div id="frotasEmManutencaoList" class="mt-8 p-6 border border-red-300 rounded-lg bg-red-50 shadow-md" style="display: none;">
      <h4 class="text-xl font-bold mb-4 text-red-700">Frotas em Manutenção</h4>
      <ul id="manutencaoItems" class="list-disc pl-5 text-red-600 text-base leading-relaxed"></ul>
    </div>
  </div>
  
  <div id="fim" style="display:none; margin-top:20px;">
    <h3>Fim de Atividade</h3>
    <form id="formFim">
      <div class="flex justify-end mb-4"><button class="btn red" type="button" onclick="limparFormulario('formFim')">Limpar Formulário</button></div>
      <div class="field">
        <label for="crachaFim">Crachá</label>
        <input type="text" name="crachaFim" id="crachaFim" oninput="this.value = this.value.toUpperCase(); handleCrachaFimChange();" required>
        <label for="nomeFim">Operador</label>
        <input type="text" id="nomeFim" readonly>
        <img id="fotoFim" src="https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR" alt="Foto Operador">
      </div>
      <div class="field">
        <label for="dataFinal">Data Final</label>
        <input type="date" name="dataFinal" id="dataFinal" required onclick="confirmarDataHora('dataFinal', 'horaFinal')">
      </div>
      <div class="field">
        <label for="horaFinal">Hora Final</label>
        <input type="time" id="horaFinal" name="horaFinal" required>
      </div>
      <div class="field">
        <label for="frotaFim">Frota</label>
        <input type="text" name="frotaFim" id="frotaFim" oninput="this.value = this.value.toUpperCase(); mostrarModeloFrota(this.value,'equipamentoFim','fotoEquipFim')" required>
        <img id="fotoEquipFim" src="https://placehold.co/100x100/A0AEC0/000000?text=FROTA" alt="Foto Frota">
      </div>
      <div class="field" id="frotaSelectionContainer" style="display:none;">
          <label for="selectFrotaAtiva">Selecione a Frota:</label>
          <div id="multipleFrotaWarning" class="text-red-700 font-semibold mb-2" style="display:none;"></div>
          <select id="selectFrotaAtiva" onchange="selecionarFrotaAtiva(this.value)"></select>
      </div>
      <div class="field">
        <label for="equipamentoFim">Equipamento</label>
        <input type="text" id="equipamentoFim" readonly>
      </div>
      <div class="field">
        <label for="horimetroFim">Horímetro Final</label>
        <input type="text" name="horimetroFim" id="horimetroFim" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" required>
      </div>
      <div class="field">
        <label for="observacoesFim">Observações</label>
        <textarea name="observacoesFim" id="observacoesFim" rows="3"></textarea>
      </div>
      <button class="btn green mt-6" type="button" onclick="enviarFim(event)">Finalizar</button>
    </form>
  </div>
  
  <div id="cadastro" class="admin-panel">
    <h3>Cadastro</h3> 
    <div class="flex flex-wrap justify-center mb-6 gap-3">
      <button class="btn blue" onclick="mostrarCadastro('cadastroOperador')">Operador</button>
      <button class="btn blue" onclick="mostrarCadastro('cadastroFrota')">Frota</button>
      <button class="btn blue" onclick="mostrarCadastro('cadastroSetor')">Setor</button>
      <button class="btn blue" onclick="mostrarCadastro('cadastroAtividade')">Atividade</button>
      <button class="btn blue" onclick="mostrarCadastro('cadastroImplemento')">Implemento</button>
    </div>
    <div id="cadastroOperador" style="display:none; margin-top:10px;">
      <h4>Cadastro de Operador</h4>
      <form><div class="field"><label for="crachaOperador">Crachá</label><input type="text" id="crachaOperador" oninput="this.value = this.value.toUpperCase()"></div>
      <div class="field"><label for="nomeOperador">Operador</label><input type="text" id="nomeOperador" oninput="this.value = this.value.toUpperCase()"></div>
      <div class="field"><label for="fotoOperador">Foto</label><input type="file" id="fotoOperador" accept="image/*" capture></div>
      <div class="flex justify-start gap-4 mt-6"><button class="btn blue" type="button" onclick="salvarOperador()">Salvar</button><button class="btn blue" type="button" onclick="consultarOperador()">Consultar</button></div></form>
    </div>
    <div id="cadastroFrota" style="display:none; margin-top:10px;">
      <h4>Cadastro de Frota</h4>
      <form><div class="field"><label for="codigoFrota">Frota</label><input type="text" id="codigoFrota" oninput="this.value = this.value.toUpperCase()"></div>
      <div class="field"><label for="modeloFrota">Modelo</label><input type="text" id="modeloFrota" oninput="this.value = this.value.toUpperCase()"></div>
      <div class="field"><label for="fotoFrota">Foto</label><input type="file" id="fotoFrota" accept="image/*" capture></div>
      <div class="flex justify-start gap-4 mt-6"><button class="btn blue" type="button" onclick="salvarFrota()">Salvar</button><button class="btn blue" type="button" onclick="consultarFrota()">Consultar</button></div></form>
    </div>
    <div id="cadastroSetor" style="display:none; margin-top:10px;">
      <h4>Cadastro de Setor</h4>
      <div class="field"><label for="nomeSetor">Setor</label><input type="text" id="nomeSetor" oninput="this.value = this.value.toUpperCase()"></div>
      <div class="flex justify-start gap-4 mt-6"><button class="btn blue" onclick="salvarSetor()">Salvar</button><button class="btn blue" onclick="consultarSetor()">Consultar</button></div>
    </div>
    <div id="cadastroAtividade" style="display:none; margin-top:10px;">
      <h4>Cadastro de Atividade</h4>
      <div class="field"><label for="nomeAtividade">Atividade</label><input type="text" id="nomeAtividade" oninput="this.value = this.value.toUpperCase()"></div>
      <div class="flex justify-start gap-4 mt-6"><button class="btn blue" onclick="salvarAtividade()">Salvar</button><button class="btn blue" onclick="consultarAtividade()">Consultar</button></div>
    </div>
    <div id="cadastroImplemento" style="display:none; margin-top:10px;">
      <h4>Cadastro de Implemento</h4>
      <div class="field"><label for="nomeImplemento">Implemento</label><input type="text" id="nomeImplemento" oninput="this.value = this.value.toUpperCase()"></div>
      <div class="field"><label for="siglaImplemento">Sigla</label><input type="text" id="siglaImplemento" required oninput="this.value = this.value.toUpperCase()"></div>
      <div class="flex justify-start gap-4 mt-6"><button class="btn blue" onclick="salvarImplemento()">Salvar</button><button class="btn blue" onclick="consultarImplemento()">Consultar</button></div>
    </div>
  </div>

  <div id="administrador" class="admin-panel">
    <h3>Painel Administrativo</h3>
    <div id="adminLogin" style="display:block;">
      <h4>Login de Administrador</h4>
      <div class="field"><label for="adminUsername">Usuário</label><input type="text" id="adminUsername" required></div>
      <div class="field"><label for="adminPassword">Senha</label><input type="password" id="adminPassword" required></div>
      <button class="btn purple mt-6" onclick="handleLogin()">Entrar</button>
      <p class="text-sm text-gray-600 mt-4">Axyn: Menos custos, mais controle. Simples assim.</p>
    </div>
    <div id="adminDashboard" style="display:none; margin-top:20px;">
      <h4>Bem-vindo, <span id="loggedInUserRoleDisplay"></span>!</h4>
      <p class="mb-4 text-gray-700">Você está logado com acesso <span id="loggedInUserLevelDisplay" class="font-bold"></span>.</p>
      <div id="userManagement" class="mt-8 p-6 border border-blue-300 rounded-lg bg-blue-50 shadow-md" style="display: none;">
        <h4 class="text-xl font-bold mb-4 text-blue-800">Gerenciamento de Usuários</h4>
        <div class="field"><label for="newUsername">Usuário</label><input type="text" id="newUsername" placeholder="Novo usuário" required></div>
        <div class="field"><label for="newPassword">Senha</label><input type="password" id="newPassword" placeholder="Nova senha" required></div>
        <div class="field">
          <label for="newUserLevel">Nível</label>
          <select id="newUserLevel" required>
            <option value="">Selecione o Nível</option>
            <option value="operacao">Operação</option>
            <option value="analista">Analista</option>
            <option value="administrador">Administrador</option>
          </select>
        </div>
        <button class="btn blue mt-6" onclick="salvarUsuario()">Salvar Usuário</button>
        <h5 class="font-bold mt-8 mb-4 text-gray-700">Usuários Cadastrados:</h5>
        <div id="userListContainer" class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg bg-white shadow-inner">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuário</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nível</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
              </tr>
            </thead>
            <tbody id="userList" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
      <button class="btn red mt-6" onclick="logout()">Sair</button>
    </div>
  </div>

  <div id="relatorio" style="display:none; margin-top:20px;">
    <h3>Relatórios</h3>
    <div class="field">
        <label for="tipoRelatorio">Tipo de Relatório</label>
        <select id="tipoRelatorio">
            <option value="horasFrota">Horas por Frota</option>
            <option value="atividadesOperador">Atividades por Operador</option>
            <option value="manutencoes">Manutenções</option>
            <option value="disponibilidade">Tempo de Disponibilidade de Frotas</option>
            <option value="comparativoHoras">Horímetro vs. Apontamento</option>
            <option value="atividades">Relatório de Atividades</option>
            <option value="setor">Relatório por Setor</option>
            <option value="edicoes">Relatório de Apontamentos Inconsistentes</option>
        </select>
    </div>
    <div class="field">
      <label for="relatorioDataInicio">Data de Início</label>
      <input type="date" id="relatorioDataInicio">
    </div>
    <div class="field">
      <label for="relatorioDataFim">Data de Fim</label>
      <input type="date" id="relatorioDataFim">
    </div>
    <button class="btn blue mt-4" onclick="gerarRelatorio()">Gerar Relatório</button>
    <div id="relatorioResultado" class="mt-6"></div>
  </div>

  <div id="dados" style="display:none; margin-top:20px;">
    <h3>Banco de Dados de Lançamentos</h3>
    <p class="text-gray-600 mb-4">Visualize e gerencie todos os lançamentos históricos. Alterações requerem senha de administrador.</p>
    <div id="dadosContent" class="mt-4"></div>
  </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmationModal" class="modal">
    <div class="modal-content" id="modalContent">
        <h3 id="modalTitle">Confirmação</h3>
        <p id="modalMessage">Você tem certeza?</p>
        <div class="modal-buttons">
            <button id="modalConfirmBtn" class="btn green">Confirmar</button>
            <button id="modalCancelBtn" class="btn red">Cancelar</button>
        </div>
    </div>
</div>

<!-- List Display Modal -->
<div id="listModal" class="modal">
    <div class="modal-content">
        <h3 id="listModalTitle">Itens Cadastrados</h3>
        <div id="listModalContent" class="modal-list-content"></div>
        <div class="modal-buttons mt-4">
            <button id="listModalCloseBtn" class="btn red">Fechar</button>
        </div>
    </div>
</div>

<!-- Generic Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <h3 id="editModalTitle">Editar Item</h3>
        <form id="editForm" class="text-left"></form>
        <div class="modal-buttons mt-6">
            <button id="editModalSaveBtn" class="btn green">Salvar</button>
            <button id="editModalCancelBtn" class="btn red">Cancelar</button>
        </div>
    </div>
</div>


<script>
// --- DATABASE SETUP (IndexedDB) ---
let db;
const DB_NAME = 'ForkliftAppDB';
const DB_VERSION = 1;
const request = indexedDB.open(DB_NAME, DB_VERSION);

const logoBase64 = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAoHBwgHBgoICAgLCgoLDhgQDg0NDh0VFhEYIx8lJCIfIiEmKzcvJik0KSEiMEExNDk7Pj4+JS5ESUM8SDc9Pjv/2wBDAQoLCw4NDhwQEBw7KCIoOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozv/wAARCAFUAlgDASIAAhEBAxEB/8QAGwABAAMBAQEBAAAAAAAAAAAAAAECBAMFBgf/xAA5EAABAwIFAgQFAwQCAgMBAAAAAQIDBBEFEiExQVEGEyJhcYEHkaGxMkLB0RQjUmJy4fAVM4KS8f/EABgBAQEBAQEAAAAAAAAAAAAAAAABAgME/8QAHxEBAQEBAAMBAQEBAQAAAAAAAAABEQIhMRJBUQNB/9oADAMBAAIRAxEAPwD5y5rXNa5rXOa1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1zWua1-";

request.onerror = (event) => {
  console.error("Database error:", event.target.errorCode);
  alert("Erro ao abrir o banco de dados. A aplicação pode não funcionar corretamente.");
};

request.onupgradeneeded = (event) => {
  db = event.target.result;
  db.createObjectStore('operadores', { keyPath: 'cracha' });
  db.createObjectStore('frotas', { keyPath: 'codigo' });
  db.createObjectStore('setores', { keyPath: 'id', autoIncrement: true });
  db.createObjectStore('atividades', { keyPath: 'id', autoIncrement: true });
  db.createObjectStore('implementos', { keyPath: 'id', autoIncrement: true });
  db.createObjectStore('atividadesEmAndamento', { keyPath: 'id', autoIncrement: true });
  const historicoStore = db.createObjectStore('historicoAtividades', { keyPath: 'id', autoIncrement: true });
  historicoStore.createIndex('frota', 'frota', { unique: false });
  historicoStore.createIndex('cracha', 'cracha', { unique: false });
  historicoStore.createIndex('setor', 'setor', { unique: false });
  db.createObjectStore('usuarios', { keyPath: 'username' });
};

request.onsuccess = (event) => {
  db = event.target.result;
  console.log("Banco de dados aberto com sucesso.");
  document.getElementById('logoGestao').src = logoBase64;
  document.getElementById('logoStatus').src = logoBase64;
  showApp('gestaoDeFrotasPanel'); // Show main menu on start
  populateSelects();
  checkLoginState();
};

// --- NAVIGATION ---
function showApp(panelId) {
    document.getElementById('gestaoDeFrotasPanel').style.display = 'none';
    document.getElementById('statusDeAtividadePanel').style.display = 'none';

    document.getElementById(panelId).style.display = 'block';
    
    if (panelId === 'statusDeAtividadePanel') {
        mostrar('disponibilidade');
    }
}

function mostrar(idToShow) {
  const sections = ['inicio', 'disponibilidade', 'fim', 'cadastro', 'administrador', 'relatorio', 'dados'];
  const panelTitle = document.getElementById('panelTitle');
  
  sections.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = (id === idToShow) ? 'block' : 'none';
  });

  switch(idToShow) {
    case 'disponibilidade': panelTitle.textContent = 'Status de Atividade'; updateDisponibilidade(); break;
    case 'inicio': panelTitle.textContent = 'Iniciar Atividade'; break;
    case 'fim': panelTitle.textContent = 'Encerrar Atividade'; break;
    case 'cadastro': panelTitle.textContent = 'Gerenciar Cadastros'; mostrarCadastro('cadastroOperador'); break;
    case 'administrador': panelTitle.textContent = 'Painel Administrativo'; break;
    case 'relatorio': panelTitle.textContent = 'Relatórios'; break;
    case 'dados': panelTitle.textContent = 'Gerenciar Dados'; mostrarBancoDeDados(); break;
  }
}

// --- AUTHENTICATION & USER STATE ---
let currentUser = null;

function checkLoginState() {
    const loggedInUser = sessionStorage.getItem('loggedInUser');
    if (loggedInUser) {
        currentUser = JSON.parse(loggedInUser);
        showAdminDashboard();
    }
}

// --- GENERIC HELPER FUNCTIONS ---
function saveData(storeName, data, successMessage) {
    if (!db) { alert("Banco de dados não está pronto."); return; }
    const transaction = db.transaction([storeName], 'readwrite');
    const store = transaction.objectStore(storeName);
    const request = store.put(data);
    request.onsuccess = () => { alert(successMessage); };
    request.onerror = (event) => { console.error(`Error saving to ${storeName}:`, event.target.error); alert(`Erro ao salvar em ${storeName}.`); };
}

function getAllData(storeName) {
    return new Promise((resolve, reject) => {
        if (!db) return reject("Banco de dados não está pronto.");
        const request = db.transaction([storeName], 'readonly').objectStore(storeName).getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = (event) => reject(`Error fetching from ${storeName}: ${event.target.error}`);
    });
}

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

async function populateSelects() {
    try {
        const [setores, atividades, implementos] = await Promise.all([
            getAllData('setores'),
            getAllData('atividades'),
            getAllData('implementos')
        ]);

        const setorSelect = document.getElementById('setorInicio');
        const atividadeSelect = document.getElementById('atividadeInicio');
        const implementoSelect = document.getElementById('implementoInicio');

        [setorSelect, atividadeSelect, implementoSelect].forEach(s => s.innerHTML = '<option value="">Selecione...</option>');

        setores.forEach(item => setorSelect.innerHTML += `<option value="${item.nome}">${item.nome}</option>`);
        atividades.forEach(item => atividadeSelect.innerHTML += `<option value="${item.nome}">${item.nome}</option>`);
        implementos.forEach(item => implementoSelect.innerHTML += `<option value="${item.nome}">${item.nome} (${item.sigla})</option>`);
    } catch (error) {
        console.error("Failed to populate selects:", error);
    }
}

function limparFormulario(formId) {
    const form = document.getElementById(formId);
    if (!form) return;
    form.reset();
    if (formId === 'formInicio') {
        document.getElementById('nomeInicio').value = '';
        document.getElementById('equipamentoInicio').value = '';
        document.getElementById('fotoInicio').src = 'https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR';
        document.getElementById('fotoEquipInicio').src = 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
        document.getElementById('relatoProblemaField').style.display = 'none';
        hideAllChecklistReports();
    } else if (formId === 'formFim') {
        document.getElementById('nomeFim').value = '';
        document.getElementById('equipamentoFim').value = '';
        document.getElementById('fotoFim').src = 'https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR';
        document.getElementById('fotoEquipFim').src = 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
        document.getElementById('frotaSelectionContainer').style.display = 'none';
    }
}

function confirmarDataHora(dateInputId, timeInputId) {
    const dateInput = document.getElementById(dateInputId);
    if (dateInput.value && dateInputId === 'dataInicial') return; 

    showModal(
        'Data e Hora Atuais',
        'Deseja preencher a data e a hora com o momento atual?',
        () => { // onConfirm callback
            const now = new Date();
            const timeInput = document.getElementById(timeInputId);
            
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;

            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            timeInput.value = `${hours}:${minutes}`;
        }
    );
}

// --- MODAL FUNCTIONS ---
let modalConfirmCallback = null;
function showModal(title, message, onConfirm, isWarning = false) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalMessage').textContent = message;
    document.getElementById('modalContent').classList.toggle('modal-warning-background', isWarning);
    modalConfirmCallback = onConfirm;
    document.getElementById('confirmationModal').style.display = 'flex';
}
document.getElementById('modalConfirmBtn').onclick = () => { if (typeof modalConfirmCallback === 'function') modalConfirmCallback(); closeModal(); };
document.getElementById('modalCancelBtn').onclick = () => closeModal();
function closeModal() { document.getElementById('confirmationModal').style.display = 'none'; modalConfirmCallback = null; }

document.getElementById('listModalCloseBtn').onclick = () => {
    document.getElementById('listModal').style.display = 'none';
};

document.getElementById('editModalCancelBtn').onclick = () => {
    document.getElementById('editModal').style.display = 'none';
};


async function showListModal(title, data, headers, storeName) {
    const modal = document.getElementById('listModal');
    const titleEl = document.getElementById('listModalTitle');
    const contentEl = document.getElementById('listModalContent');

    titleEl.textContent = title;
    contentEl.innerHTML = '';

    if (!data || data.length === 0) {
        contentEl.innerHTML = '<p class="text-gray-600">Nenhum item cadastrado.</p>';
        modal.style.display = 'flex';
        return;
    }

    const table = document.createElement('table');
    table.className = 'consult-table w-full';
    
    const thead = table.createTHead();
    const headerRow = thead.insertRow();
    for (const key in headers) {
        const th = document.createElement('th');
        th.textContent = headers[key];
        headerRow.appendChild(th);
    }
    const thActions = document.createElement('th');
    thActions.textContent = 'Ações';
    headerRow.appendChild(thActions);

    const tbody = table.createTBody();
    data.forEach(item => {
        const row = tbody.insertRow();
        for (const key in headers) {
            const cell = row.insertCell();
            if (key === 'foto' && item[key]) {
                const img = document.createElement('img');
                img.src = item[key];
                img.alt = 'Foto';
                img.className = 'w-12 h-12 object-cover rounded';
                cell.appendChild(img);
            } else {
                cell.textContent = item[key] || '-';
            }
        }
        const actionsCell = row.insertCell();
        actionsCell.className = 'flex gap-2';
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Alterar';
        editBtn.className = 'btn blue text-xs p-1';
        editBtn.onclick = () => handleEdit(storeName, item);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Excluir';
        deleteBtn.className = 'btn red text-xs p-1';
        deleteBtn.onclick = () => handleDelete(storeName, item[db.transaction(storeName).objectStore(storeName).keyPath]);
        
        actionsCell.appendChild(editBtn);
        actionsCell.appendChild(deleteBtn);
    });

    contentEl.appendChild(table);
    modal.style.display = 'flex';
}

// --- CADASTRO (REGISTRATION) FUNCTIONS ---
function mostrarCadastro(subpanel) {
    ['cadastroOperador', 'cadastroFrota', 'cadastroSetor', 'cadastroAtividade', 'cadastroImplemento'].forEach(p => {
        document.getElementById(p).style.display = p === subpanel ? 'block' : 'none';
    });
}
async function salvarOperador() {
    const cracha = document.getElementById('crachaOperador').value.trim();
    const nome = document.getElementById('nomeOperador').value.trim();
    const fotoFile = document.getElementById('fotoOperador').files[0];
    if (!cracha || !nome) { alert("Crachá e Nome são obrigatórios."); return; }
    const foto = fotoFile ? await fileToBase64(fotoFile) : null;
    saveData('operadores', { cracha, nome, foto }, "Operador salvo com sucesso!");
    document.getElementById('cadastroOperador').querySelector('form').reset();
}
async function salvarFrota() {
    const codigo = document.getElementById('codigoFrota').value.trim();
    const modelo = document.getElementById('modeloFrota').value.trim();
    const fotoFile = document.getElementById('fotoFrota').files[0];
    if (!codigo || !modelo) { alert("Código e Modelo são obrigatórios."); return; }
    const foto = fotoFile ? await fileToBase64(fotoFile) : null;
    saveData('frotas', { codigo, modelo, foto }, "Frota salva com sucesso!");
    document.getElementById('cadastroFrota').querySelector('form').reset();
}
function salvarSetor() {
    const nome = document.getElementById('nomeSetor').value.trim();
    if (!nome) { alert("Nome do setor é obrigatório."); return; }
    saveData('setores', { nome }, "Setor salvo com sucesso!");
    document.getElementById('nomeSetor').value = '';
    populateSelects();
}
function salvarAtividade() {
    const nome = document.getElementById('nomeAtividade').value.trim();
    if (!nome) { alert("Nome da atividade é obrigatório."); return; }
    saveData('atividades', { nome }, "Atividade salva com sucesso!");
    document.getElementById('nomeAtividade').value = '';
    populateSelects();
}
function salvarImplemento() {
    const nome = document.getElementById('nomeImplemento').value.trim();
    const sigla = document.getElementById('siglaImplemento').value.trim();
    if (!nome || !sigla) { alert("Nome e Sigla são obrigatórios."); return; }
    saveData('implementos', { nome, sigla }, "Implemento salvo com sucesso!");
    document.getElementById('nomeImplemento').value = '';
    document.getElementById('siglaImplemento').value = '';
    populateSelects();
}

// --- INÍCIO/FIM DE ATIVIDADE FUNCTIONS ---
function buscarOperador(cracha, nomeFieldId, fotoFieldId) {
    return new Promise((resolve, reject) => {
        if (!db || !cracha) return resolve(null);
        const request = db.transaction(['operadores']).objectStore('operadores').get(cracha);
        request.onsuccess = () => {
            const op = request.result;
            document.getElementById(nomeFieldId).value = op ? op.nome : 'Operador não encontrado';
            document.getElementById(fotoFieldId).src = op?.foto || 'https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR';
            resolve(op);
        };
        request.onerror = (e) => reject(e);
    });
}
function mostrarModeloFrota(codigo, modeloFieldId, fotoFieldId) {
    return new Promise((resolve, reject) => {
        if (!db || !codigo) return resolve(null);
        const request = db.transaction(['frotas']).objectStore('frotas').get(codigo);
        request.onsuccess = () => {
            const frota = request.result;
            document.getElementById(modeloFieldId).value = frota ? frota.modelo : 'Frota não encontrada';
            document.getElementById(fotoFieldId).src = frota?.foto || 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
            resolve(frota);
        };
        request.onerror = (e) => reject(e);
    });
}
function toggleRelatoProblema() {
    const atividade = document.getElementById('atividadeInicio').value;
    const relatoField = document.getElementById('relatoProblemaField');
    const relatoTextarea = document.getElementById('relatoProblema');
    const isMaintenance = atividade.toLowerCase().includes('manutenção');
    relatoField.style.display = isMaintenance ? 'flex' : 'none';
    relatoTextarea.required = isMaintenance;
}
function toggleNonConformityReport(radio) {
    const textarea = document.getElementById(radio.dataset.targetTextarea);
    textarea.classList.toggle('hidden', radio.value !== 'NÃO CONFORME');
    textarea.required = radio.value === 'NÃO CONFORME';
    if(radio.value !== 'NÃO CONFORME') textarea.value = '';
}
function hideAllChecklistReports() {
    document.querySelectorAll('#safetyChecklist textarea').forEach(textarea => {
        textarea.classList.add('hidden');
        textarea.required = false;
        textarea.value = '';
    });
    document.querySelectorAll('#safetyChecklist input[type="radio"][value="OK"]').forEach(radio => {
        radio.checked = true;
    });
}

async function enviarInicio(event) {
    event.preventDefault();
    
    const frotaCadastrada = await mostrarModeloFrota(document.getElementById('frotaInicio').value, 'equipamentoInicio', 'fotoEquipInicio');
    if (!frotaCadastrada) {
        showModal('Erro', 'Frota não cadastrada. Verifique o código da frota e tente novamente.', () => {}, true);
        return;
    }

    const requiredFields = [
        { id: 'crachaInicio', label: 'Crachá' }, { id: 'nomeInicio', label: 'Operador (inválido ou não encontrado)' },
        { id: 'dataInicial', label: 'Data Inicial' }, { id: 'horaInicial', label: 'Hora Inicial' },
        { id: 'frotaInicio', label: 'Frota' }, { id: 'equipamentoInicio', label: 'Equipamento (inválido ou não encontrado)' },
        { id: 'horimetroInicial', label: 'Horímetro Inicial' }, { id: 'setorInicio', label: 'Setor' },
        { id: 'atividadeInicio', label: 'Atividade' }, { id: 'implementoInicio', label: 'Implemento' }
    ];
    const missingFields = requiredFields.filter(field => {
        const input = document.getElementById(field.id);
        return !input.value || input.value.includes('não encontrado');
    }).map(field => field.label);

    const atividade = document.getElementById('atividadeInicio').value;
    if (atividade.toLowerCase().includes('manutenção') && !document.getElementById('relatoProblema').value.trim()) {
        missingFields.push('Relato do Problema');
    }

    if (missingFields.length > 0) {
        showModal('Campos Obrigatórios', 'Por favor, preencha os seguintes campos:\n\n- ' + missingFields.join('\n- '), () => {}, true);
        return;
    }

    const cracha = document.getElementById('crachaInicio').value;
    const frota = document.getElementById('frotaInicio').value;
    const atividadesEmAndamento = await getAllData('atividadesEmAndamento');

    if (atividadesEmAndamento.some(item => item.frota === frota)) {
        showModal('Erro', `A frota ${frota} já está em atividade.`, () => {}, true);
        return;
    }

    const saveActivity = () => {
        const dados = {
            cracha, operador: document.getElementById('nomeInicio').value,
            dataInicial: document.getElementById('dataInicial').value, horaInicial: document.getElementById('horaInicial').value,
            frota, equipamento: document.getElementById('equipamentoInicio').value,
            horimetroInicial: document.getElementById('horimetroInicial').value, setor: document.getElementById('setorInicio').value,
            atividade: document.getElementById('atividadeInicio').value, implemento: document.getElementById('implementoInicio').value,
            relatoProblema: document.getElementById('relatoProblema').value, checklist: {}
        };
        let nonConformityFound = false;
        document.querySelectorAll('#safetyChecklist input[type="radio"][value="NÃO CONFORME"]:checked').forEach(radio => {
            nonConformityFound = true;
        });

        if (nonConformityFound) {
            showModal('Atenção: Não Conformidade', `Foram encontradas não conformidades no checklist.\nA frota será marcada para manutenção. Continuar?`, () => {
                dados.atividade = 'MANUTENÇÃO';
                saveData('atividadesEmAndamento', dados, 'Atividade de manutenção iniciada!');
                limparFormulario('formInicio');
                mostrar('disponibilidade');
            }, true);
        } else {
             saveData('atividadesEmAndamento', dados, 'Atividade iniciada com sucesso!');
             limparFormulario('formInicio');
             mostrar('disponibilidade');
        }
    };

    if (atividadesEmAndamento.some(item => item.cracha === cracha)) {
        showModal('Operador em Atividade', `O operador ${cracha} já possui uma atividade em andamento. Deseja iniciar uma nova atividade mesmo assim?`, saveActivity, true);
    } else {
        saveActivity();
    }
}

async function handleCrachaFimChange() {
    const cracha = document.getElementById('crachaFim').value;
    const operador = await buscarOperador(cracha, 'nomeFim', 'fotoFim');

    const frotaFimInput = document.getElementById('frotaFim');
    const container = document.getElementById('frotaSelectionContainer');
    const select = document.getElementById('selectFrotaAtiva');
    
    frotaFimInput.value = '';
    document.getElementById('equipamentoFim').value = '';
    document.getElementById('fotoEquipFim').src = 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
    container.style.display = 'none';
    select.innerHTML = '<option value="">Selecione a frota...</option>';

    if (!operador) return;

    const request = db.transaction(['atividadesEmAndamento']).objectStore('atividadesEmAndamento').getAll();
    request.onsuccess = () => {
        const atividadesOperador = request.result.filter(item => item.cracha === cracha);
        if (atividadesOperador.length === 1) {
            selecionarFrotaAtiva(atividadesOperador[0].id);
            container.style.display = 'none';
        } else if (atividadesOperador.length > 1) {
            atividadesOperador.forEach(ativ => select.innerHTML += `<option value="${ativ.id}">${ativ.frota} - ${ativ.atividade}</option>`);
            container.style.display = 'flex';
        }
    };
}
function selecionarFrotaAtiva(id) {
    const request = db.transaction(['atividadesEmAndamento']).objectStore('atividadesEmAndamento').get(Number(id));
    request.onsuccess = () => {
        const ativ = request.result;
        if (ativ) {
            document.getElementById('frotaFim').value = ativ.frota;
            mostrarModeloFrota(ativ.frota, 'equipamentoFim', 'fotoEquipFim');
            const horimetroInput = document.getElementById('horimetroFim');
            horimetroInput.dataset.atividadeId = ativ.id;
            horimetroInput.dataset.horimetroInicial = ativ.horimetroInicial;
        }
    };
}
function enviarFim(event) {
    event.preventDefault();
    const form = document.getElementById('formFim');
    if (!form.checkValidity()) { form.reportValidity(); return; }
    
    const atividadeId = Number(document.getElementById('horimetroFim').dataset.atividadeId);
    if (!atividadeId) { alert("Nenhuma atividade selecionada para finalizar. Verifique o crachá e a frota."); return; }

    const transaction = db.transaction(['atividadesEmAndamento'], 'readonly');
    const requestGet = transaction.objectStore('atividadesEmAndamento').get(atividadeId);

    requestGet.onsuccess = () => {
        const atividadeAberta = requestGet.result;
        if (!atividadeAberta) { alert("Erro: Atividade não encontrada."); return; }
        finalizarAtividade(atividadeId, atividadeAberta);
    };
}

function finalizarAtividade(atividadeId, atividadeEncerrada) {
    let isInconsistente = false;
    const horimetroFinal = parseFloat(document.getElementById('horimetroFim').value);
    const horimetroInicial = parseFloat(atividadeEncerrada.horimetroInicial);
    
    const dataFinalVal = document.getElementById('dataFinal').value;
    const horaFinalVal = document.getElementById('horaFinal').value;
    const inicioTimestamp = new Date(`${atividadeEncerrada.dataInicial}T${atividadeEncerrada.horaInicial}`).getTime();
    const fimTimestamp = new Date(`${dataFinalVal}T${horaFinalVal}`).getTime();

    const doSave = () => {
        const transaction = db.transaction(['atividadesEmAndamento', 'historicoAtividades'], 'readwrite');
        const storeAtividades = transaction.objectStore('atividadesEmAndamento');
        const storeHistorico = transaction.objectStore('historicoAtividades');

        Object.assign(atividadeEncerrada, {
            dataFinal: dataFinalVal, horaFinal: horaFinalVal,
            horimetroFinal: horimetroFinal, observacoes: document.getElementById('observacoesFim').value,
            horasHorimetro: (horimetroFinal - horimetroInicial).toFixed(2),
            inconsistente: isInconsistente
        });
        
        storeHistorico.add(atividadeEncerrada);
        storeAtividades.delete(atividadeId);

        transaction.oncomplete = () => {
            alert("Atividade finalizada com sucesso!");
            limparFormulario('formFim');
            mostrar('disponibilidade');
        };
        transaction.onerror = (e) => { console.error("Erro ao finalizar atividade:", e.target.error); alert("Ocorreu um erro ao finalizar a atividade."); };
    };

    const checkDate = () => {
        if (fimTimestamp < inicioTimestamp) {
            isInconsistente = true;
            showModal('Data Incorreta', 'A data/hora final é anterior à inicial. Deseja continuar mesmo assim?', doSave, true);
        } else {
            doSave();
        }
    };

    if (horimetroFinal < horimetroInicial) {
        isInconsistente = true;
        showModal('Erro de Horímetro', `O horímetro final (${horimetroFinal}) é menor que o inicial (${horimetroInicial}). Deseja continuar mesmo assim?`, checkDate, true);
    } else {
        checkDate();
    }
}


// --- DISPONIBILIDADE (AVAILABILITY) VIEW ---
async function updateDisponibilidade() {
    try {
        const [todasFrotas, atividadesEmAndamento] = await Promise.all([getAllData('frotas'), getAllData('atividadesEmAndamento')]);
        const contentDiv = document.getElementById('disponibilidadeContent');
        const manutencaoListDiv = document.getElementById('frotasEmManutencaoList');
        const manutencaoItemsUl = document.getElementById('manutencaoItems');
        
        contentDiv.innerHTML = '';
        manutencaoItemsUl.innerHTML = '';
        manutencaoListDiv.style.display = 'none';

        if (todasFrotas.length === 0) {
            contentDiv.innerHTML = '<p class="text-gray-600">Nenhuma frota cadastrada.</p>';
            return;
        }

        const frotasAgrupadas = todasFrotas.reduce((acc, frota) => {
            const modelo = frota.modelo || 'Sem Modelo';
            if (!acc[modelo]) acc[modelo] = [];
            acc[modelo].push(frota);
            return acc;
        }, {});

        const frotasEmManutencao = [];

        for (const modelo in frotasAgrupadas) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'mb-8';
            const groupTitle = document.createElement('h4');
            groupTitle.className = 'text-lg font-bold text-gray-700 border-b pb-2 mb-4';
            groupTitle.textContent = `Modelo: ${modelo}`;
            groupDiv.appendChild(groupTitle);

            const table = document.createElement('table');
            table.className = 'availability-table';
            table.innerHTML = `<thead><tr><th>Frota</th><th>Status</th><th>Operador</th><th>Atividade</th><th>Início</th></tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');

            frotasAgrupadas[modelo].forEach(frota => {
                const atividade = atividadesEmAndamento.find(a => a.frota === frota.codigo);
                const isManutencao = atividade?.atividade.toUpperCase() === 'MANUTENÇÃO';
                
                if (isManutencao) {
                    frotasEmManutencao.push({codigo: frota.codigo, relato: atividade.relatoProblema || 'Sem relato.'});
                }
                
                let statusClass = 'status-ok';
                let statusText = 'Disponível';
                if (atividade) {
                    statusText = atividade.atividade;
                    statusClass = isManutencao ? 'status-maintenance-strong' : 'status-active';
                }

                const operadorText = atividade ? `${atividade.operador} (${atividade.cracha})` : '-';
                const inicioText = atividade ? `${new Date(atividade.dataInicial + 'T00:00:00').toLocaleDateString('pt-BR')} ${atividade.horaInicial}` : '-';
                const row = tbody.insertRow();
                row.innerHTML = `<td data-label="Frota">${frota.codigo}</td><td data-label="Status"><span class="status-cell ${statusClass}">${statusText}</span></td><td data-label="Operador">${operadorText}</td><td data-label="Atividade">${atividade?.atividade || '-'}</td><td data-label="Início">${inicioText}</td>`;
            });
            groupDiv.appendChild(table);
            contentDiv.appendChild(groupDiv);
        }

        if (frotasEmManutencao.length > 0) {
            manutencaoListDiv.style.display = 'block';
            frotasEmManutencao.forEach(item => manutencaoItemsUl.innerHTML += `<li><b>Frota ${item.codigo}:</b> ${item.relato}</li>`);
        }

    } catch (error) {
        console.error("Failed to update availability:", error);
        document.getElementById('disponibilidadeContent').innerHTML = '<p class="text-red-500">Erro ao carregar dados.</p>';
    }
}


// --- ADMIN PANEL FUNCTIONS ---
async function handleLogin() {
    const username = document.getElementById('adminUsername').value;
    const password = document.getElementById('adminPassword').value;
    if (!db) { alert("Banco de dados não está pronto."); return; }
    const transaction = db.transaction(['usuarios'], 'readwrite'); // readwrite to create defaults
    const store = transaction.objectStore('usuarios');
    const adminCheck = store.get('admin');
    adminCheck.onsuccess = () => {
        if (!adminCheck.result) {
            store.put({ username: 'admin', password: 'admin123', level: 'administrador' });
            store.put({ username: 'analista', password: 'analista123', level: 'analista' });
        }
        const loginRequest = store.get(username);
        loginRequest.onsuccess = () => {
            const user = loginRequest.result;
            if (user && user.password === password) {
                currentUser = user;
                sessionStorage.setItem('loggedInUser', JSON.stringify(user));
                showAdminDashboard();
            } else {
                alert('Usuário ou senha inválidos.');
            }
        };
    };
}
function showAdminDashboard() {
    if (!currentUser) return;
    document.getElementById('adminLogin').style.display = 'none';
    document.getElementById('adminDashboard').style.display = 'block';
    document.getElementById('loggedInUserRoleDisplay').textContent = currentUser.username;
    document.getElementById('loggedInUserLevelDisplay').textContent = currentUser.level;
    const isAdmin = currentUser.level === 'administrador';
    const isAnalyst = currentUser.level === 'analista';
    document.getElementById('btnCadastro').style.display = isAdmin ? 'inline-block' : 'none';
    document.getElementById('btnRelatorio').style.display = (isAdmin || isAnalyst) ? 'inline-block' : 'none';
    document.getElementById('btnDados').style.display = isAdmin ? 'inline-block' : 'none';
    document.getElementById('userManagement').style.display = isAdmin ? 'block' : 'none';
    if (isAdmin) loadUserList();
}
function logout() {
    currentUser = null;
    sessionStorage.removeItem('loggedInUser');
    ['btnCadastro', 'btnRelatorio', 'btnDados'].forEach(id => document.getElementById(id).style.display = 'none');
    document.getElementById('adminDashboard').style.display = 'none';
    document.getElementById('adminLogin').style.display = 'block';
    document.getElementById('adminUsername').value = '';
    document.getElementById('adminPassword').value = '';
    mostrar('disponibilidade');
}
async function salvarUsuario() {
    const username = document.getElementById('newUsername').value.trim();
    const password = document.getElementById('newPassword').value.trim();
    const level = document.getElementById('newUserLevel').value;
    if (!username || !password || !level) { alert("Todos os campos são obrigatórios."); return; }
    saveData('usuarios', { username, password, level }, "Usuário salvo com sucesso!");
    loadUserList();
    document.getElementById('newUsername').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('newUserLevel').value = '';
}
async function loadUserList() {
    const users = await getAllData('usuarios');
    const userListBody = document.getElementById('userList');
    userListBody.innerHTML = '';
    users.forEach(user => {
        const row = userListBody.insertRow();
        row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.username}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.level}</td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><a href="#" class="text-red-600 hover:text-red-900" onclick="deleteUser('${user.username}')">Excluir</a></td>`;
    });
}
function deleteUser(username) {
    if (username === 'admin') { alert("Não é possível excluir o administrador padrão."); return; }
    showModal('Excluir Usuário', `Tem certeza que deseja excluir '${username}'?`, () => {
        const transaction = db.transaction(['usuarios'], 'readwrite');
        transaction.objectStore('usuarios').delete(username);
        transaction.oncomplete = () => { alert(`Usuário ${username} excluído.`); loadUserList(); };
    }, true);
}

// --- DATA MANAGEMENT & REPORT FUNCTIONS ---
function gerarRelatorio() {
    const tipo = document.getElementById('tipoRelatorio').value;
    switch (tipo) {
        case 'horasFrota':
            gerarRelatorioHorasFrota();
            break;
        default:
            alert(`Relatório do tipo '${tipo}' ainda não implementado.`);
            document.getElementById('relatorioResultado').innerHTML = '';
    }
}

async function gerarRelatorioHorasFrota() {
    const dataInicio = document.getElementById('relatorioDataInicio').value;
    const dataFim = document.getElementById('relatorioDataFim').value;
    const resultadoDiv = document.getElementById('relatorioResultado');
    resultadoDiv.innerHTML = '';

    if (!dataInicio || !dataFim) {
        alert('Por favor, selecione as datas de início e fim.');
        return;
    }

    const historico = await getAllData('historicoAtividades');
    const relatorio = {};

    const inicioTimestamp = new Date(dataInicio + 'T00:00:00').getTime();
    const fimTimestamp = new Date(dataFim + 'T23:59:59').getTime();

    historico.forEach(item => {
        const itemTimestamp = new Date(item.dataFinal).getTime();
        if (itemTimestamp >= inicioTimestamp && itemTimestamp <= fimTimestamp) {
            if (!relatorio[item.frota]) {
                relatorio[item.frota] = { horasHorimetro: 0, modelo: item.equipamento };
            }
            relatorio[item.frota].horasHorimetro += parseFloat(item.horasHorimetro || 0);
        }
    });

    if (Object.keys(relatorio).length === 0) {
        resultadoDiv.innerHTML = '<p class="text-gray-600 mt-4">Nenhum dado encontrado para o período selecionado.</p>';
        return;
    }

    const table = document.createElement('table');
    table.className = 'data-table';
    table.innerHTML = `
        <thead>
            <tr>
                <th>Frota</th>
                <th>Modelo</th>
                <th>Total de Horas (Horímetro)</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');
    for (const frota in relatorio) {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td data-label="Frota">${frota}</td>
            <td data-label="Modelo">${relatorio[frota].modelo}</td>
            <td data-label="Horas">${relatorio[frota].horasHorimetro.toFixed(2)}</td>
        `;
    }
    resultadoDiv.appendChild(table);
}

async function mostrarBancoDeDados() {
    const contentDiv = document.getElementById('dadosContent');
    contentDiv.innerHTML = '';
    const historico = await getAllData('historicoAtividades');

    if (historico.length === 0) {
        contentDiv.innerHTML = '<p class="text-gray-600">Nenhum lançamento no histórico.</p>';
        return;
    }

    const table = document.createElement('table');
    table.className = 'data-table';
    table.innerHTML = `<thead><tr><th>ID</th><th>Frota</th><th>Operador</th><th>Atividade</th><th>Data Final</th><th>Status</th><th>Ações</th></tr></thead><tbody></tbody>`;
    const tbody = table.querySelector('tbody');

    historico.forEach(item => {
        const row = tbody.insertRow();
        const statusClass = item.inconsistente ? 'status-inconsistente' : 'status-ok';
        const statusText = item.inconsistente ? 'Inconsistente' : 'OK';
        
        row.innerHTML = `
            <td data-label="ID">${item.id}</td>
            <td data-label="Frota">${item.frota}</td>
            <td data-label="Operador">${item.operador}</td>
            <td data-label="Atividade">${item.atividade}</td>
            <td data-label="Data Final">${new Date(item.dataFinal + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
            <td data-label="Status"><span class="status-cell ${statusClass}">${statusText}</span></td>
            <td data-label="Ações"><button class="btn blue text-xs p-1" onclick="handleEdit('historicoAtividades', ${item.id})">Alterar</button></td>
        `;
    });
    contentDiv.appendChild(table);
}

// --- CONSULTA & EDIT FUNCTIONS ---
async function consultarOperador() {
    const data = await getAllData('operadores');
    showListModal('Operadores Cadastrados', data, { cracha: 'Crachá', nome: 'Nome', foto: 'Foto' }, 'operadores');
}
async function consultarFrota() {
    const data = await getAllData('frotas');
    showListModal('Frotas Cadastradas', data, { codigo: 'Código', modelo: 'Modelo', foto: 'Foto' }, 'frotas');
}
async function consultarSetor() {
    const data = await getAllData('setores');
    showListModal('Setores Cadastrados', data, { nome: 'Nome' }, 'setores');
}
async function consultarAtividade() {
    const data = await getAllData('atividades');
    showListModal('Atividades Cadastradas', data, { nome: 'Nome' }, 'atividades');
}
async function consultarImplemento() {
    const data = await getAllData('implementos');
    showListModal('Implementos Cadastrados', data, { nome: 'Nome', sigla: 'Sigla' }, 'implementos');
}

async function handleDelete(storeName, key) {
    const password = prompt("Para excluir, digite a senha de administrador:");
    if (password !== 'admin123') { // Simple password check for demo
        alert('Senha incorreta.');
        return;
    }
    const transaction = db.transaction([storeName], 'readwrite');
    const request = transaction.objectStore(storeName).delete(key);
    request.onsuccess = () => {
        alert('Item excluído com sucesso!');
        document.getElementById('listModal').style.display = 'none';
    };
}

async function handleEdit(storeName, keyOrItem) {
    const password = prompt("Para editar, digite a senha de administrador:");
    if (password !== 'admin123') { // Simple password check for demo
        alert('Senha incorreta.');
        return;
    }

    const key = typeof keyOrItem === 'object' ? keyOrItem[db.transaction(storeName).objectStore(storeName).keyPath] : keyOrItem;

    const transaction = db.transaction([storeName], 'readonly');
    const request = transaction.objectStore(storeName).get(key);
    
    request.onsuccess = () => {
        const item = request.result;
        if (!item) { alert('Item não encontrado.'); return; }

        const modal = document.getElementById('editModal');
        const titleEl = document.getElementById('editModalTitle');
        const formEl = document.getElementById('editForm');
        
        titleEl.textContent = `Editar Item (ID: ${key})`;
        formEl.innerHTML = '';

        for (const prop in item) {
            if (prop === 'foto') continue; // Skip photo for simplicity
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'field';
            const label = document.createElement('label');
            label.textContent = prop;
            label.className = 'capitalize';
            const input = document.createElement(prop.length > 50 ? 'textarea' : 'input');
            input.type = 'text';
            input.name = prop;
            input.value = item[prop];
            input.className = 'border p-2 rounded w-full';
            if (prop === db.transaction(storeName).objectStore(storeName).keyPath) {
                input.readOnly = true;
                input.classList.add('bg-gray-200');
            }
            fieldDiv.appendChild(label);
            fieldDiv.appendChild(input);
            formEl.appendChild(fieldDiv);
        }

        document.getElementById('editModalSaveBtn').onclick = () => {
            const updatedItem = { ...item };
            new FormData(formEl).forEach((value, key) => {
                updatedItem[key] = value;
            });
            const saveTransaction = db.transaction([storeName], 'readwrite');
            saveTransaction.objectStore(storeName).put(updatedItem);
            saveTransaction.oncomplete = () => {
                alert('Item atualizado com sucesso!');
                modal.style.display = 'none';
                document.getElementById('listModal').style.display = 'none';
                if(storeName === 'historicoAtividades') mostrarBancoDeDados();
            };
        };

        modal.style.display = 'flex';
    };
}

</script>
</body>
</html>
