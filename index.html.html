g<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apontamento de Empilhadeira</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      padding: 24px; /* Increased padding */
      background-color: #e0e7ff; /* Lighter, more professional background */
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .card {
      padding: 32px; /* Increased padding */
      border-radius: 16px; /* More rounded corners */
      box-shadow: 0 10px 30px rgba(0,0,0,0.15); /* Stronger, diffused shadow */
      width: 100%;
      max-width: 768px; /* Slightly wider max-width for content */
      transition: background-color 0.4s ease-in-out;
      background-color: #ffffff;
      border: 1px solid #e2e8f0; /* Subtle border */
    }
    h2 {
      font-size: 2.25rem; /* Larger title */
      font-weight: 800; /* Extra bold */
      color: #1a202c; /* Darker text */
      margin-bottom: 20px;
    }
    h3 {
      font-size: 1.75rem; /* Subtitle size */
      font-weight: 700; /* Bold */
      color: #2d3748; /* Darker text */
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid #edf2f7; /* Underline for sections */
    }
    h4 {
      font-size: 1.25rem; /* Smaller heading for sub-sections */
      font-weight: 600; /* Semi-bold */
      color: #4a5568;
      margin-bottom: 12px;
    }
    .btn {
      padding: 12px 28px; /* Larger padding for buttons */
      border: none;
      color: white;
      border-radius: 10px; /* More rounded buttons */
      cursor: pointer;
      margin: 6px 4px; /* Slightly increased margin */
      font-weight: 600; /* Semi-bold */
      transition: all 0.3s ease; /* Smooth transition for all properties */
      box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Subtle shadow for buttons */
      background-image: linear-gradient(145deg, var(--color-light), var(--color-dark)); /* Gradient effect */
    }
    .btn.yellow {
      --color-light: #ffeb3b;
      --color-dark: #fbc02d;
      color: #333; /* Darker text for yellow buttons */
    }
    .btn.green {
      --color-light: #4CAF50;
      --color-dark: #388E3C;
    }
    .btn.red {
      --color-light: #f44336;
      --color-dark: #d32f2f;
    }
    .btn.blue {
      --color-light: #2196F3;
      --color-dark: #1976D2;
    }
    .btn.purple {
      --color-light: #9C27B0;
      --color-dark: #7B1FA2;
    }
    .btn.darkblue {
      --color-light: #3F51B5;
      --color-dark: #303F9F;
    }
    .btn:hover {
      transform: translateY(-2px); /* Slight lift effect */
      box-shadow: 0 6px 12px rgba(0,0,0,0.15); /* More pronounced shadow on hover */
      opacity: 1; /* Ensure full opacity */
    }
    .field {
      margin-bottom: 20px; /* Increased margin-bottom */
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px; /* Space between label and input */
    }
    @media (min-width: 640px) {
      .field {
        flex-direction: row;
        align-items: center;
        gap: 16px; /* Larger gap for desktop */
      }
    }
    .field label {
      flex: 0 0 140px; /* Wider label column */
      color: #4a5568;
      font-weight: 600; /* Semi-bold */
      font-size: 0.95rem;
    }
    .field input[type="text"],
    .field input[type="date"],
    .field input[type="time"],
    .field input[type="password"],
    .field select,
    .field textarea {
      flex: 1;
      padding: 10px 14px; /* Larger padding */
      border: 1px solid #cbd5e0; /* Softer border color */
      border-radius: 8px; /* More rounded inputs */
      box-sizing: border-box;
      width: 100%;
      font-size: 1rem;
      color: #2d3748;
      background-color: #f7fafc; /* Light background for inputs */
      transition: all 0.2s ease-in-out;
    }
    .field input[type="text"]:focus,
    .field input[type="date"]:focus,
    .field input[type="time"]:focus,
    .field input[type="password"]:focus,
    .field select:focus,
    .field textarea:focus {
      outline: none;
      border-color: #6366f1; /* Accent color on focus */
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* Ring effect on focus */
      background-color: #ffffff;
    }
    .field img {
      margin-left: 0;
      margin-top: 12px; /* Adjusted spacing */
      width: 90px; /* Consistent image size */
      height: 90px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #6366f1; /* Accent border for images */
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    @media (min-width: 640px) {
      .field img {
        margin-left: 20px; /* Larger margin-left for row layout */
        margin-top: 0;
      }
    }
    textarea {
      resize: vertical;
      min-height: 80px; /* Minimum height for textareas */
    }
    .checklist {
      padding: 20px;
      border: 1px solid #d1d8e0;
      border-radius: 12px;
      background-color: #f0f4f8; /* Slightly darker background for checklist */
      margin-top: 24px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Inner shadow */
    }
    .checklist h4 {
      color: #333;
      margin-top: 0;
      margin-bottom: 16px;
      text-align: center;
      font-size: 1.35rem; /* Larger checklist title */
    }
    .checklist label {
      display: flex;
      align-items: center;
      gap: 10px; /* More space for checkbox and text */
      margin-bottom: 10px;
      font-size: 0.9rem;
      color: #4a5568;
    }
    .checklist input[type="radio"] {
        transform: scale(1.2); /* Slightly larger radio buttons */
        cursor: pointer;
    }
    .admin-panel {
      display: none;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid #e2e8f0;
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.6); /* Darker overlay */
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(4px); /* Blurred background */
    }
    .modal-content {
        background-color: #ffffff;
        padding: 30px; /* Increased padding */
        border: 1px solid #b2c1d3;
        border-radius: 16px; /* More rounded */
        width: 90%;
        max-width: 450px; /* Slightly larger max width */
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2); /* Stronger shadow */
        animation: fadeIn 0.3s ease-out; /* Fade-in animation */
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .modal-warning-background {
        background-color: #ffebee; /* Lighter, softer red */
        border-color: #ef9a9a; /* Softer red border */
    }
    .modal-warning-background h3,
    .modal-warning-background p {
        color: #c62828; /* Stronger red text */
    }

    .modal-content h3 {
        font-size: 1.6rem; /* Larger modal title */
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 12px;
        border-bottom: none; /* No underline for modal titles */
    }
    .modal-content p {
        font-size: 1.05rem;
        color: #555;
        margin-bottom: 24px; /* More space */
        line-height: 1.5;
    }
    .modal-buttons button {
        margin: 0 10px;
        min-width: 100px; /* Ensure buttons have a minimum width */
    }

    /* Specific styles for Availability section tables */
    .availability-table, .consult-table, .data-table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 8px; /* Rounded table corners */
        overflow: hidden; /* Ensures rounded corners apply to content */
        margin-top: 16px;
    }
    .availability-table th, .availability-table td,
    .consult-table th, .consult-table td,
    .data-table th, .data-table td {
        padding: 12px 8px; /* Increased padding */
        font-size: 0.9rem; /* Slightly larger font */
        text-align: left;
        border: 1px solid #e2e8f0; /* Soft border for cells */
    }
    .availability-table thead, .consult-table thead, .data-table thead {
        background-color: #e2e8f0; /* Lighter header background */
        color: #4a5568;
        font-weight: 700; /* Bold headers */
        text-transform: uppercase;
        font-size: 0.8rem;
    }
    .availability-table tbody tr:nth-child(even),
    .consult-table tbody tr:nth-child(even),
    .data-table tbody tr:nth-child(even) {
        background-color: #f7fafc; /* Subtle zebra striping */
    }
    .availability-table tbody tr:hover,
    .consult-table tbody tr:hover,
    .data-table tbody tr:hover {
        background-color: #ebf4ff; /* Light hover effect */
    }
    
    /* Responsive table for smaller screens - enhanced */
    @media (max-width: 640px) {
        .availability-table, .consult-table, .data-table {
            border: none; /* Remove outer border */
        }
        .availability-table thead, .consult-table thead, .data-table thead {
            display: none;
        }
        .availability-table tr, .consult-table tr, .data-table tr {
            margin-bottom: 16px; /* More space between stacked rows */
            border: 1px solid #e2e8f0;
            border-radius: 12px; /* Rounded individual row cards */
            padding: 16px; /* More padding inside row cards */
            background-color: #ffffff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); /* Shadow for row cards */
            display: block;
            width: 100%;
        }
        .availability-table td, .consult-table td, .data-table td {
            border-bottom: 1px dotted #e2e8f0; /* Softer dotted divider */
            text-align: right;
            padding-left: 50%;
            position: relative;
            display: block;
            white-space: normal; /* Allow text to wrap in cells */
            overflow: visible; /* Ensure content is not cut off */
            text-overflow: clip; /* Remove ellipsis for wrapping text */
        }
        .availability-table td:last-child, .consult-table td:last-child, .data-table td:last-child {
            border-bottom: 0;
        }
    }
    
    /* Status Styling - Refined Colors */
    /* Removed .status-available to remove green background for available frotas */
    .status-maintenance-strong {
        background-color: #D32F2F; /* Stronger Red for Maintenance */
        color: #FFFFFF;
        font-weight: 600;
    }
    .status-revision-strong {
        background-color: #3F51B5; /* Deep Blue for Revision */
        color: #FFFFFF;
        font-weight: 600;
    }
    .status-active {
        background-color: #BBDEFB; /* Lighter Blue for Active */
        color: #1A237E; /* Darker text for contrast */
        font-weight: 600;
    }
    /* Specific styling for table cells with status */
    .status-cell {
        padding: 6px 12px;
        border-radius: 6px;
        display: inline-block; /* Make it look like a badge */
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .status-ok { background-color: #e8f5e9; color: #388e3c; }
    .status-inconsistente { background-color: #ffebee; color: #d32f2f; }
  </style>
</head>
<body>
<div class="card" id="mainPanel">
  <!-- New header div for title and admin button -->
  <div class="flex justify-between items-center mb-6">
    <h2 id="panelTitle">Status de Atividade</h2>
    <button class="btn purple" id="btnAdministrador" onclick="mostrar('administrador')">Administrador</button>
  </div>
  
  <div class="flex flex-wrap justify-center mb-8 gap-3"> <!-- Increased gap -->
    <button class="btn yellow" id="btnDisponibilidade" onclick="mostrar('disponibilidade')">Disponibilidade</button>
    <button class="btn green" id="btnInicioAtividade" onclick="mostrar('inicio')">In?cio de Atividade</button>
    <button class="btn red" id="btnEncerramentoAtividade" onclick="mostrar('fim')">Encerramento de Atividade</button>
    <button class="btn blue" id="btnCadastro" style="display:none;" onclick="mostrar('cadastro')">Cadastro</button>
    <button class="btn blue" id="btnRelatorio" style="display:none;" onclick="mostrar('relatorio')">Relat?rio</button>
    <button class="btn darkblue" id="btnDados" style="display:none;" onclick="mostrar('dados')">Dados</button>
  </div>
  
  <div id="inicio" style="display:none; margin-top:20px;">
    <h3>In?cio de Atividade</h3>
    <form id="formInicio">
      <div class="flex justify-end mb-4">
        <button class="btn red" type="button" onclick="limparFormulario('formInicio')">Limpar Formul?rio</button>
      </div>
      <div class="field">
        <label for="crachaInicio">Crach?</label>
        <input type="text" name="crachaInicio" id="crachaInicio" oninput="this.value = this.value.toUpperCase(); buscarOperador(this.value,'nomeInicio','fotoInicio'); toggleChecklistVisibility();" required>
        <label for="nomeInicio">Operador</label>
        <input type="text" id="nomeInicio" readonly>
        <img id="fotoInicio" src="https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR" alt="Foto Operador">
      </div>
      
      <div class="field">
        <label for="dataInicial">Data Inicial</label>
        <input type="date" name="dataInicial" id="dataInicial" required onclick="confirmarDataHora('dataInicial','horaInicial')" onchange="toggleChecklistVisibility()">
      </div>
      <div class="field">
        <label for="horaInicial">Hora Inicial</label>
        <input type="time" id="horaInicial" name="horaInicial" required>
      </div>
      <div class="field">
        <label for="frotaInicio">Frota</label>
        <input type="text" name="frotaInicio" id="frotaInicio" oninput="this.value = this.value.toUpperCase(); mostrarModeloFrota(this.value,'equipamentoInicio','fotoEquipInicio'); toggleChecklistVisibility();" required>
        <img id="fotoEquipInicio" src="https://placehold.co/100x100/A0AEC0/000000?text=FROTA" alt="Foto Frota">
      </div>
      <div class="field">
        <label for="equipamentoInicio">Equipamento</label>
        <input type="text" id="equipamentoInicio" readonly>
      </div>
      <!-- Novo campo Hor?metro Inicial -->
      <div class="field">
        <label for="horimetroInicial">Hor?metro Inicial</label>
        <input type="text" name="horimetroInicial" id="horimetroInicial" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" required>
      </div>
      <div class="field">
        <label for="setorInicio">Setor</label>
        <select id="setorInicio"></select>
      </div>
      <div class="field">
        <label for="atividadeInicio">Atividade</label>
        <select id="atividadeInicio" onchange="toggleRelatoProblema()"></select>
      </div>
      <div class="field" id="relatoProblemaField" style="display:none;">
        <label for="relatoProblema">Relato do Problema</label>
        <textarea name="relatoProblema" id="relatoProblema" rows="3" placeholder="Descreva o problema da manuten??o"></textarea>
      </div>

    <script>
  const implementos = ['Arado', 'Grade', 'Semeadora', 'Pulverizador'];
  const select = document.getElementById('implementoInicio');

  implementos.forEach(imp => {
    const option = document.createElement('option');
    option.value = imp.toLowerCase();
    option.textContent = imp;
    select.appendChild(option);
  });
</script>
      
      <!-- REFORMULATED CHECKLIST -->
      <div class="checklist" id="safetyChecklist">
        <h4 class="font-bold uppercase text-center mb-4">Checklist de Seguran?a</h4>
        <div class="grid grid-cols-12 gap-2 items-center text-center font-bold text-gray-700 text-sm mb-2">
            <div class="col-span-1">OK</div>
            <div class="col-span-6 text-left">ITENS A CONFERIR</div>
            <div class="col-span-2">N?O CONFORME</div>
            <div class="col-span-3 text-left">RELATAR</div>
        </div>
        <!-- Item: ?leo do Motor -->
        <div class="grid grid-cols-12 gap-2 items-center mb-3">
            <div class="col-span-1 flex justify-center">
                <input type="radio" name="status_OleoMotor" value="OK" checked required>
            </div>
            <div class="col-span-6 text-left text-sm">?leo do Motor</div>
            <div class="col-span-2 flex justify-center">
                <input type="radio" name="status_OleoMotor" value="N?O CONFORME" data-target-textarea="relato_OleoMotor" onchange="toggleNonConformityReport(this)">
            </div>
            <div class="col-span-3">
                <textarea name="relato_OleoMotor" id="relato_OleoMotor" rows="1" placeholder="Relatar n?o conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea>
            </div>
        </div>
        <!-- Item: ?leo Hidr?ulico -->
        <div class="grid grid-cols-12 gap-2 items-center mb-3">
            <div class="col-span-1 flex justify-center">
                <input type="radio" name="status_OleoHidraulico" value="OK" checked required>
            </div>
            <div class="col-span-6 text-left text-sm">?leo Hidr?ulico</div>
            <div class="col-span-2 flex justify-center">
                <input type="radio" name="status_OleoHidraulico" value="N?O CONFORME" data-target-textarea="relato_OleoHidraulico" onchange="toggleNonConformityReport(this)">
            </div>
            <div class="col-span-3">
                <textarea name="relato_OleoHidraulico" id="relato_OleoHidraulico" rows="1" placeholder="Relatar n?o conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea>
            </div>
        </div>
        <!-- Item: ?leo da Transmiss?o -->
        <div class="grid grid-cols-12 gap-2 items-center mb-3">
            <div class="col-span-1 flex justify-center">
                <input type="radio" name="status_OleoTransmissao" value="OK" checked required>
            </div>
            <div class="col-span-6 text-left text-sm">?leo da Transmiss?o</div>
            <div class="col-span-2 flex justify-center">
                <input type="radio" name="status_OleoTransmissao" value="N?O CONFORME" data-target-textarea="relato_OleoTransmissao" onchange="toggleNonConformityReport(this)">
            </div>
            <div class="col-span-3">
                <textarea name="relato_OleoTransmissao" id="relato_OleoTransmissao" rows="1" placeholder="Relatar n?o conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea>
            </div>
        </div>
        <!-- Item: Extintor -->
        <div class="grid grid-cols-12 gap-2 items-center mb-3">
            <div class="col-span-1 flex justify-center">
                <input type="radio" name="status_Extintor" value="OK" checked required>
            </div>
            <div class="col-span-6 text-left text-sm">Extintor</div>
            <div class="col-span-2 flex justify-center">
                <input type="radio" name="status_Extintor" value="N?O CONFORME" data-target-textarea="relato_Extintor" onchange="toggleNonConformityReport(this)">
            </div>
            <div class="col-span-3">
                <textarea name="relato_Extintor" id="relato_Extintor" rows="1" placeholder="Relatar n?o conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea>
            </div>
        </div>
        <!-- Item: Pneus -->
        <div class="grid grid-cols-12 gap-2 items-center mb-3">
            <div class="col-span-1 flex justify-center">
                <input type="radio" name="status_Pneus" value="OK" checked required>
            </div>
            <div class="col-span-6 text-left text-sm">Pneus</div>
            <div class="col-span-2 flex justify-center">
                <input type="radio" name="status_Pneus" value="N?O CONFORME" data-target-textarea="relato_Pneus" onchange="toggleNonConformityReport(this)">
            </div>
            <div class="col-span-3">
                <textarea name="relato_Pneus" id="relato_Pneus" rows="1" placeholder="Relatar n?o conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea>
            </div>
        </div>
        <!-- Item: Parte El?trica -->
        <div class="grid grid-cols-12 gap-2 items-center mb-3">
            <div class="col-span-1 flex justify-center">
                <input type="radio" name="status_ParteEletrica" value="OK" checked required>
            </div>
            <div class="col-span-6 text-left text-sm">Parte El?trica</div>
            <div class="col-span-2 flex justify-center">
                <input type="radio" name="status_ParteEletrica" value="N?O CONFORME" data-target-textarea="relato_ParteEletrica" onchange="toggleNonConformityReport(this)">
            </div>
            <div class="col-span-3">
                <textarea name="relato_ParteEletrica" id="relato_ParteEletrica" rows="1" placeholder="Relatar n?o conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea>
            </div>
        </div>
      </div>
      <!-- END REFORMULATED CHECKLIST -->

      <button class="btn blue mt-6" type="button" onclick="enviarInicio(event)">Salvar In?cio</button>
    </form>
  </div>
  
  <div id="disponibilidade" style="display:none; margin-top:20px;">
    <h3>Disponibilidade</h3>
    <div id="disponibilidadeContent">
        <p class="text-gray-600">Nenhuma frota cadastrada ou atividade em andamento para exibir.</p>
    </div>
    <!-- Lista de frotas em manuten??o -->
    <div id="frotasEmManutencaoList" class="mt-8 p-6 border border-red-300 rounded-lg bg-red-50 shadow-md" style="display: none;">
      <h4 class="text-xl font-bold mb-4 text-red-700">Frotas em Manuten??o</h4>
      <ul id="manutencaoItems" class="list-disc pl-5 text-red-600 text-base leading-relaxed">
        </ul>
    </div>
  </div>
  
  <div id="fim" style="display:none; margin-top:20px;">
    <h3>Fim de Atividade</h3>
    <form id="formFim">
      <div class="flex justify-end mb-4">
        <button class="btn red" type="button" onclick="limparFormulario('formFim')">Limpar Formul?rio</button>
      </div>
      <div class="field">
        <label for="crachaFim">Crach?</label>
        <input type="text" name="crachaFim" id="crachaFim" oninput="this.value = this.value.toUpperCase(); handleCrachaFimChange();" required>
        <label for="nomeFim">Operador</label>
        <input type="text" id="nomeFim" readonly>
        <img id="fotoFim" src="https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR" alt="Foto Operador">
      </div>
      
      <div class="field">
        <label for="dataFinal">Data Final</label>
        <input type="date" name="dataFinal" id="dataFinal" required onclick="confirmarDataHora('dataFinal','horaFinal')">
      </div>
      <div class="field">
        <label for="horaFinal">Hora Final</label>
        <input type="time" id="horaFinal" name="horaFinal" required>
      </div>

      <div class="field">
        <label for="frotaFim">Frota</label>
        <input type="text" name="frotaFim" id="frotaFim" oninput="this.value = this.value.toUpperCase(); mostrarModeloFrota(this.value,'equipamentoFim','fotoEquipFim')" required>
        <img id="fotoEquipFim" src="https://placehold.co/100x100/A0AEC0/000000?text=FROTA" alt="Foto Frota">
      </div>
      <!-- New Frota Selection Container -->
      <div class="field" id="frotaSelectionContainer" style="display:none;">
          <label for="selectFrotaAtiva">Selecione a Frota:</label>
          <div id="multipleFrotaWarning" class="text-red-700 font-semibold mb-2" style="display:none;"></div>
          <select id="selectFrotaAtiva" onchange="selecionarFrotaAtiva(this.value)"></select>
      </div>
      <!-- End New Frota Selection Container -->

      <div class="field">
        <label for="equipamentoFim">Equipamento</label>
        <input type="text" id="equipamentoFim" readonly>
      </div>
      <div class="field">
        <label for="horimetroFim">Hor?metro Final</label>
        <input type="text" name="horimetroFim" id="horimetroFim" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" required>
      </div>
      <div class="field">
        <label for="observacoesFim">Observa??es</label>
        <textarea name="observacoesFim" id="observacoesFim" rows="3"></textarea>
      </div>
      <button class="btn green mt-6" type="button" onclick="enviarFim(event)">Finalizar</button>
    </form>
  </div>
  
  <!-- Main Cadastro section, accessible based on login level -->
  <div id="cadastro" class="admin-panel">
    <h3>Cadastro</h3> 
    <div class="flex flex-wrap justify-center mb-6 gap-3">
      <button class="btn blue" onclick="mostrarCadastroOperador()">Operador</button>
      <button class="btn blue" onclick="mostrarCadastroFrota()">Frota</button>
      <button class="btn blue" onclick="mostrarCadastroSetor()">Setor</button>
      <button class="btn blue" onclick="mostrarCadastroAtividade()">Atividade</button>
      <button class="btn blue" onclick="mostrarCadastroImplemento()">Implemento</button>
    </div>
  
    <div id="cadastroOperador" style="display:none; margin-top:10px;">
      <h4>Cadastro de Operador</h4>
      <div class="field"><label for="crachaOperador">Crach?</label><input type="text" id="crachaOperador" oninput="this.value = this.value.toUpperCase()"></div>
      <div class="field"><label for="nomeOperador">Operador</label><input type="text" id="nomeOperador" oninput="this.value = this.value.toUpperCase()"></div>
      <div class="field"><label for="fotoOperador">Foto</label><input type="file" id="fotoOperador" accept="image/*" capture></div>
      <div class="flex justify-start gap-4 mt-6">
        <button class="btn blue" onclick="salvarOperador()">Salvar</button>
        <button class="btn blue" onclick="consultarOperador()">Consultar</button>
      </div>
    </div>
  
    <div id="cadastroFrota" style="display:none; margin-top:10px;">
      <h4>Cadastro de Frota</h4>
      <div class="field"><label for="codigoFrota">Frota</label><input type="text" id="codigoFrota" oninput="this.value = this.value.toUpperCase()"></div>
      <div class="field"><label for="modeloFrota">Modelo</label><input type="text" id="modeloFrota" oninput="this.value = this.value.toUpperCase()"></div>
      <div class="field"><label for="fotoFrota">Foto</label><input type="file" id="fotoFrota" accept="image/*" capture></div>
      <div class="flex justify-start gap-4 mt-6">
        <button class="btn blue" onclick="salvarFrota()">Salvar</button>
        <button class="btn blue" onclick="consultarFrota()">Consultar</button>
      </div>
    </div>
  
    <div id="cadastroSetor" style="display:none; margin-top:10px;">
      <h4>Cadastro de Setor</h4>
      <div class="field"><label for="nomeSetor">Setor</label><input type="text" id="nomeSetor" oninput="this.value = this.value.toUpperCase()"></div>
      <div class="flex justify-start gap-4 mt-6">
        <button class="btn blue" onclick="salvarSetor()">Salvar</button>
        <button class="btn blue" onclick="consultarSetor()">Consultar</button>
      </div>
    </div>
  
    <div id="cadastroAtividade" style="display:none; margin-top:10px;">
      <h4>Cadastro de Atividade</h4>
      <div class="field"><label for="nomeAtividade">Atividade</label><input type="text" id="nomeAtividade" oninput="this.value = this.value.toUpperCase()"></div>
      <div class="flex justify-start gap-4 mt-6">
        <button class="btn blue" onclick="salvarAtividade()">Salvar</button>
        <button class="btn blue" onclick="consultarAtividade()">Consultar</button>
      </div>
    </div>
  
    <div id="cadastroImplemento" style="display:none; margin-top:10px;">
      <h4>Cadastro de Implemento</h4>
      <div class="field"><label for="nomeImplemento">Implemento</label><input type="text" id="nomeImplemento" oninput="this.value = this.value.toUpperCase()"></div>
      <div class="field"><label for="siglaImplemento">Sigla</label><input type="text" id="siglaImplemento" required oninput="this.value = this.value.toUpperCase()"></div>
      <div class="flex justify-start gap-4 mt-6">
        <button class="btn blue" onclick="salvarImplemento()">Salvar</button>
        <button class="btn blue" onclick="consultarImplemento()">Consultar</button>
      </div>
    </div>
  </div>

  <!-- New Admin login and dashboard section -->
  <div id="administrador" class="admin-panel">
    <h3>Painel Administrativo</h3>
    <div id="adminLogin" style="display:block;">
      <h4>Login de Administrador</h4>
      <div class="field">
        <label for="adminUsername">Usu?rio</label>
        <input type="text" id="adminUsername" required>
      </div>
      <div class="field">
        <label for="adminPassword">Senha</label>
        <input type="password" id="adminPassword" required>
      </div>
      <button class="btn purple mt-6" onclick="handleLogin()">Entrar</button>
      <p class="text-sm text-gray-600 mt-4">Use 'admin'/'admin123' para Administrador ou 'analista'/'user123' para Analista.</p>
    </div>

    <div id="adminDashboard" style="display:none; margin-top:20px;">
      <h4>Bem-vindo, <span id="loggedInUserRoleDisplay"></span>!</h4>
      <p class="mb-4 text-gray-700">Voc? est? logado com acesso <span id="loggedInUserLevelDisplay" class="font-bold"></span>.</p>

      <!-- User Management Section -->
      <div id="userManagement" class="mt-8 p-6 border border-blue-300 rounded-lg bg-blue-50 shadow-md" style="display: none;">
        <h4 class="text-xl font-bold mb-4 text-blue-800">Gerenciamento de Usu?rios</h4>
        <div class="field">
          <label for="newUsername">Usu?rio</label>
          <input type="text" id="newUsername" placeholder="Novo usu?rio" required>
        </div>
        <div class="field">
          <label for="newPassword">Senha</label>
          <input type="password" id="newPassword" placeholder="Nova senha" required>
        </div>
        <div class="field">
          <label for="newUserLevel">N?vel</label>
          <select id="newUserLevel" required>
            <option value="">Selecione o N?vel</option>
            <option value="operacao">Opera??o</option>
            <option value="analista">Analista</option>
            <option value="administrador">Administrador</option>
          </select>
        </div>
        <button class="btn blue mt-6" onclick="salvarUsuario()">Salvar Usu?rio</button>

        <h5 class="font-bold mt-8 mb-4 text-gray-700">Usu?rios Cadastrados:</h5>
        <div id="userListContainer" class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg bg-white shadow-inner">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usu?rio</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N?vel</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A??es</th>
              </tr>
            </thead>
            <tbody id="userList" class="bg-white divide-y divide-gray-200">
              <!-- User list will be populated here by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
      <button class="btn red mt-6" onclick="logout()">Sair</button>
    </div>
  </div>

  <!-- New section for Relat?rio -->
  <div id="relatorio" style="display:none; margin-top:20px;">
    <h3>Relat?rios Dispon?veis</h3>
    <ul class="list-disc pl-5 text-gray-700 text-base leading-relaxed">
      <li class="mb-4">
        <h4 class="font-semibold text-gray-800">Relat?rio de Horas por Frota</h4>
        <p class="mb-2">Gera um relat?rio detalhado do total de horas de opera??o por cada frota, permitindo filtrar por per?odo.</p>
        <button class="btn green mt-2" onclick="mostrar('relatorioHorasFrota')">Gerar Relat?rio</button>
      </li>
      <li class="mb-4">
        <h4 class="font-semibold text-gray-800">Relat?rio de Atividades por Operador</h4>
        <p class="mb-2">Exibe o tempo gasto em cada tipo de atividade por operador, ?til para an?lise de produtividade.</p>
        <button class="btn green mt-2">Gerar Relat?rio</button>
      </li>
      <li class="mb-4">
        <h4 class="font-semibold text-gray-800">Relat?rio de Manuten??es</h4>
        <p class="mb-2">Lista todas as ocorr?ncias de manuten??o, com relatos e tempo de parada, para acompanhamento de reparos.</p>
        <button class="btn green mt-2">Gerar Relat?rio</button>
      </li>
      <li class="mb-4">
        <h4 class="font-semibold text-gray-800">Disponibilidade da Frota</h4>
        <p class="mb-2">Mostra a porcentagem de tempo que cada frota esteve dispon?vel versus em atividade ou manuten??o.</p>
        <button class="btn green mt-2">Gerar Relat?rio</button>
      </li>
      <li class="mb-4">
        <h4 class="font-semibold text-gray-800">Hor?metros por Frota</h4>
        <p class="mb-2">Apresenta o registro dos hor?metros inicial e final para cada frota em um per?odo selecionado.</p>
        <button class="btn green mt-2">Gerar Relat?rio</button>
      </li>
      <!-- New Checklist Report -->
      <li class="mb-4">
        <h4 class="font-semibold text-gray-800">Relat?rio de Checklist de Seguran?a</h4>
        <p class="mb-2">Apresenta o status dos itens do checklist de seguran?a e os relatos de n?o conformidade para cada atividade.</p>
        <button class="btn green mt-2" onclick="mostrar('relatorioChecklist')">Gerar Relat?rio</button>
      </li>
      <!-- New Relat?rio por Setor -->
      <li class="mb-4">
        <h4 class="font-semibold text-gray-800">Relat?rio por Setor</h4>
        <p class="mb-2">Analisa a utiliza??o das frotas por setor, incluindo quantidade, tempo total e hor?metro.</p>
        <button class="btn blue mt-2" onclick="mostrar('relatorioSetor')">Gerar Relat?rio</button>
      </li>
      <!-- New Relat?rio por Atividade -->
      <li class="mb-4">
        <h4 class="font-semibold text-gray-800">Relat?rio por Atividade</h4>
        <p class="mb-2">Oferece uma vis?o detalhada das atividades realizadas, com foco em tempo e hor?metro por tipo de atividade.</p>
        <button class="btn blue mt-2" onclick="mostrar('relatorioAtividade')">Gerar Relat?rio</button>
      </li>
      <!-- New Relat?rio de Edi??es -->
      <li class="mb-4">
        <h4 class="font-semibold text-gray-800">Relat?rio de Edi??es Realizadas</h4>
        <p class="mb-2">Lista todas as modifica??es feitas nos registros de atividade.</p>
        <button class="btn purple mt-2" onclick="mostrar('relatorioEdicoes')">Gerar Relat?rio</button>
      </li>
    </ul>
    <!-- You can add more interactive elements here later, like date pickers and download buttons -->
  </div>

  <!-- Relat?rio de Horas por Frota Section -->
  <div id="relatorioHorasFrota" style="display:none; margin-top:20px;">
    <h3>Relat?rio de Horas por Frota</h3>
    <div class="flex flex-wrap gap-4 mb-6">
      <div class="field flex-grow">
        <label for="filterFrotaRelatorioHoras">Frota</label>
        <input type="text" id="filterFrotaRelatorioHoras" placeholder="Filtrar por Frota" oninput="this.value = this.value.toUpperCase(); popularTabelaHorasFrota()">
      </div>
      <div class="field flex-grow">
        <label for="filterDataInicioRelatorioHoras">Data In?cio</label>
        <input type="date" id="filterDataInicioRelatorioHoras" onchange="popularTabelaHorasFrota()">
      </div>
      <div class="field flex-grow">
        <label for="filterDataFimRelatorioHoras">Data Fim</label>
        <input type="date" id="filterDataFimRelatorioHoras" onchange="popularTabelaHorasFrota()">
      </div>
      <div class="flex justify-start gap-4 mt-4 w-full">
        <button class="btn blue" onclick="popularTabelaHorasFrota()">Atualizar Relat?rio</button>
        <button class="btn red" onclick="limparFiltrosRelatorioHorasFrota()">Limpar Filtros</button>
      </div>
    </div>
    <div id="horasFrotaTableContainer" class="mt-4 max-h-96 overflow-y-auto border border-gray-200 rounded-lg shadow-inner">
        <table class="min-w-full divide-y divide-gray-200 data-table">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Frota</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total de Horas (h)</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hor?metro Total</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N? Atividades</th>
                </tr>
            </thead>
            <tbody id="horasFrotaTableBody" class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
    </div>
  </div>


  <!-- New section for all data records -->
  <div id="dados" style="display:none; margin-top:20px;">
    <h3>Dados de Atividades Registradas</h3>
    <div class="flex flex-wrap gap-4 mb-6">
      <div class="field flex-grow">
        <label for="filterFrotaDados">Frota</label>
        <input type="text" id="filterFrotaDados" placeholder="Filtrar por Frota" oninput="this.value = this.value.toUpperCase(); popularTabelaRegistros()">
      </div>
      <div class="field flex-grow">
        <label for="filterOperadorDados">Operador</label>
        <input type="text" id="filterOperadorDados" placeholder="Filtrar por Operador" oninput="this.value = this.value.toUpperCase(); popularTabelaRegistros()">
      </div>
      <div class="field flex-grow">
        <label for="filterSetorDados">Setor</label>
        <input type="text" id="filterSetorDados" placeholder="Filtrar por Setor" oninput="this.value = this.value.toUpperCase(); popularTabelaRegistros()">
      </div>
      <div class="field flex-grow">
        <label for="filterAtividadeDados">Atividade</label>
        <input type="text" id="filterAtividadeDados" placeholder="Filtrar por Atividade" oninput="this.value = this.value.toUpperCase(); popularTabelaRegistros()">
      </div>
      <div class="field flex-grow">
        <label for="filterImplementoDados">Implemento</label>
        <input type="text" id="filterImplementoDados" placeholder="Filtrar por Implemento" oninput="this.value = this.value.toUpperCase(); popularTabelaRegistros()">
      </div>
      <div class="flex justify-start gap-4 mt-4 w-full">
        <button class="btn blue" onclick="popularTabelaRegistros()">Atualizar Dados</button>
        <button class="btn red" onclick="limparFiltrosDados()">Limpar Filtros</button>
      </div>
    </div>
    <div id="registrosDataTableContainer" class="mt-4 max-h-96 overflow-y-auto border border-gray-200 rounded-lg shadow-inner">
        <table class="min-w-full divide-y divide-gray-200 data-table">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Frota</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Operador</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Atividade</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">In?cio</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">H. Inicial</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fim</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">H. Final</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dura??o (h)</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A??es</th> <!-- New column -->
                </tr>
            </thead>
            <tbody id="registrosTableBody" class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
    </div>
  </div>

  <!-- New section for detailed checklist report -->
  <div id="relatorioChecklist" style="display:none; margin-top:20px;">
    <h3>Relat?rio de Checklist de Seguran?a</h3>
    <div class="flex flex-wrap gap-4 mb-6">
      <div class="field flex-grow">
        <label for="filterFrotaChecklist">Frota</label>
        <input type="text" id="filterFrotaChecklist" placeholder="Filtrar por Frota" oninput="this.value = this.value.toUpperCase(); popularTabelaChecklist()">
      </div>
      <div class="field flex-grow">
        <label for="filterOperadorChecklist">Operador</label>
        <input type="text" id="filterOperadorChecklist" placeholder="Filtrar por Operador" oninput="this.value = this.value.toUpperCase(); popularTabelaChecklist()">
      </div>
      <div class="field flex-grow">
        <label for="filterDataChecklist">Data</label>
        <input type="date" id="filterDataChecklist" onchange="popularTabelaChecklist()">
      </div>
      <div class="flex justify-start gap-4 mt-4 w-full">
        <button class="btn blue" onclick="popularTabelaChecklist()">Atualizar Relat?rio</button>
        <button class="btn red" onclick="limparFiltrosChecklist()">Limpar Filtros</button>
      </div>
    </div>
    <div id="checklistTableContainer" class="mt-4 max-h-96 overflow-y-auto border border-gray-200 rounded-lg shadow-inner">
        <table class="min-w-full divide-y divide-gray-200 data-table">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Atividade</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Frota</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Operador</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data In?cio</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Checklist</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Relato</th>
                </tr>
            </thead>
            <tbody id="checklistTableBody" class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
    </div>
  </div>

  <!-- Relat?rio por Setor Section -->
  <div id="relatorioSetor" style="display:none; margin-top:20px;">
    <h3>Relat?rio por Setor</h3>
    <div class="flex flex-wrap gap-4 mb-6">
      <div class="field flex-grow">
        <label for="filterSetorRelatorioSetor">Setor</label>
        <input type="text" id="filterSetorRelatorioSetor" placeholder="Filtrar por Setor" oninput="this.value = this.value.toUpperCase(); popularTabelaRelatorioSetor()">
      </div>
      <div class="field flex-grow">
        <label for="filterDataInicioRelatorioSetor">Data In?cio</label>
        <input type="date" id="filterDataInicioRelatorioSetor" onchange="popularTabelaRelatorioSetor()">
      </div>
      <div class="field flex-grow">
        <label for="filterDataFimRelatorioSetor">Data Fim</label>
        <input type="date" id="filterDataFimRelatorioSetor" onchange="popularTabelaRelatorioSetor()">
      </div>
      <div class="flex justify-start gap-4 mt-4 w-full">
        <button class="btn blue" onclick="popularTabelaRelatorioSetor()">Atualizar Relat?rio</button>
        <button class="btn red" onclick="limparFiltrosRelatorioSetor()">Limpar Filtros</button>
      </div>
    </div>
    <div id="relatorioSetorTableContainer" class="mt-4 max-h-96 overflow-y-auto border border-gray-200 rounded-lg shadow-inner">
        <table class="min-w-full divide-y divide-gray-200 data-table">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Setor</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total de Frotas</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tempo Total (h)</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hor?metro Total</th>
                </tr>
            </thead>
            <tbody id="relatorioSetorTableBody" class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
    </div>
  </div>

  <!-- Relat?rio por Atividade Section -->
  <div id="relatorioAtividade" style="display:none; margin-top:20px;">
    <h3>Relat?rio por Atividade</h3>
    <div class="flex flex-wrap gap-4 mb-6">
      <div class="field flex-grow">
        <label for="filterAtividadeRelatorioAtividade">Atividade</label>
        <input type="text" id="filterAtividadeRelatorioAtividade" placeholder="Filtrar por Atividade" oninput="this.value = this.value.toUpperCase(); popularTabelaRelatorioAtividade()">
      </div>
      <div class="field flex-grow">
        <label for="filterDataInicioRelatorioAtividade">Data In?cio</label>
        <input type="date" id="filterDataInicioRelatorioAtividade" onchange="popularTabelaRelatorioAtividade()">
      </div>
      <div class="field flex-grow">
        <label for="filterDataFimRelatorioAtividade">Data Fim</label>
        <input type="date" id="filterDataFimRelatorioAtividade" onchange="popularTabelaRelatorioAtividade()">
      </div>
      <div class="flex justify-start gap-4 mt-4 w-full">
        <button class="btn blue" onclick="popularTabelaRelatorioAtividade()">Atualizar Relat?rio</button>
        <button class="btn red" onclick="limparFiltrosRelatorioAtividade()">Limpar Filtros</button>
      </div>
    </div>
    <div id="relatorioAtividadeTableContainer" class="mt-4 max-h-96 overflow-y-auto border border-gray-200 rounded-lg shadow-inner">
        <table class="min-w-full divide-y divide-gray-200 data-table">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Atividade</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total de Frotas</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tempo Total (h)</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hor?metro Total</th>
                </tr>
            </thead>
            <tbody id="relatorioAtividadeTableBody" class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
    </div>
  </div>

  <!-- Relat?rio de Edi??es Section -->
  <div id="relatorioEdicoes" style="display:none; margin-top:20px;">
    <h3>Relat?rio de Edi??es Realizadas</h3>
    <div class="flex flex-wrap gap-4 mb-6">
      <div class="field flex-grow">
        <label for="filterRecordIdEdicao">ID Registro</label>
        <input type="text" id="filterRecordIdEdicao" placeholder="Filtrar por ID" oninput="this.value = this.value.toUpperCase(); popularTabelaEdicoes()">
      </div>
      <div class="field flex-grow">
        <label for="filterEditorUser">Usu?rio Editor</label>
        <input type="text" id="filterEditorUser" placeholder="Filtrar por Usu?rio" oninput="this.value = this.value.toUpperCase(); popularTabelaEdicoes()">
      </div>
      <div class="field flex-grow">
        <label for="filterDateEdicao">Data Edi??o</label>
        <input type="date" id="filterDateEdicao" onchange="popularTabelaEdicoes()">
      </div>
      <div class="flex justify-start gap-4 mt-4 w-full">
        <button class="btn blue" onclick="popularTabelaEdicoes()">Atualizar Relat?rio</button>
        <button class="btn red" onclick="limparFiltrosEdicoes()">Limpar Filtros</button>
      </div>
    </div>
    <div id="edicoesTableContainer" class="mt-4 max-h-96 overflow-y-auto border border-gray-200 rounded-lg shadow-inner">
        <table class="min-w-full divide-y divide-gray-200 data-table">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Registro</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usu?rio Editor</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Edi??o</th>
                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Campos Editados</th>
                </tr>
            </thead>
            <tbody id="edicoesTableBody" class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
    </div>
  </div>


  <!-- New sections for detailed consultations -->
  <div id="consultaOperador" style="display:none; margin-top:20px;">
    <h3>Consultar Operadores</h3>
    <div class="field">
      <label for="searchOperador">Buscar</label>
      <input type="text" id="searchOperador" placeholder="Crach? ou Nome" oninput="this.value = this.value.toUpperCase()">
      <button class="btn blue mt-4" onclick="popularTabelaOperadores()">Buscar</button>
    </div>
    <div id="operadoresTableContainer" class="mt-4 max-h-96 overflow-y-auto border border-gray-200 rounded-lg shadow-inner">
        <table class="min-w-full divide-y divide-gray-200 consult-table">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Crach?</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Foto</th>
                </tr>
            </thead>
            <tbody id="operadoresTableBody" class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
    </div>
  </div>

  <div id="consultaFrota" style="display:none; margin-top:20px;">
    <h3>Consultar Frotas</h3>
    <div class="field">
      <label for="searchFrota">Buscar</label>
      <input type="text" id="searchFrota" placeholder="C?digo ou Modelo" oninput="this.value = this.value.toUpperCase()">
      <button class="btn blue mt-4" onclick="popularTabelaFrotas()">Buscar</button>
    </div>
    <div id="frotasTableContainer" class="mt-4 max-h-96 overflow-y-auto border border-gray-200 rounded-lg shadow-inner">
        <table class="min-w-full divide-y divide-gray-200 consult-table">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C?digo</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modelo</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Foto</th>
                </tr>
            </thead>
            <tbody id="frotasTableBody" class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
    </div>
  </div>

  <div id="consultaSetor" style="display:none; margin-top:20px;">
    <h3>Consultar Setores</h3>
    <div class="field">
      <label for="searchSetor">Buscar</label>
      <input type="text" id="searchSetor" placeholder="Nome do Setor" oninput="this.value = this.value.toUpperCase()">
      <button class="btn blue mt-4" onclick="popularTabelaSetores()">Buscar</button>
    </div>
    <div id="setoresTableContainer" class="mt-4 max-h-96 overflow-y-auto border border-gray-200 rounded-lg shadow-inner">
        <table class="min-w-full divide-y divide-gray-200 consult-table">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome do Setor</th>
                </tr>
            </thead>
            <tbody id="setoresTableBody" class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
    </div>
  </div>

  <div id="consultaAtividade" style="display:none; margin-top:20px;">
    <h3>Consultar Atividades</h3>
    <div class="field">
      <label for="searchAtividade">Buscar</label>
      <input type="text" id="searchAtividade" placeholder="Nome da Atividade" oninput="this.value = this.value.toUpperCase()">
      <button class="btn blue mt-4" onclick="popularTabelaAtividades()">Buscar</button>
    </div>
    <div id="atividadesTableContainer" class="mt-4 max-h-96 overflow-y-auto border border-gray-200 rounded-lg shadow-inner">
        <table class="min-w-full divide-y divide-gray-200 consult-table">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome da Atividade</th>
                </tr>
            </thead>
            <tbody id="atividadesTableBody" class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
    </div>
  </div>

  <div id="consultaImplemento" style="display:none; margin-top:20px;">
    <h3>Consultar Implementos</h3>
    <div class="field">
      <label for="searchImplemento">Buscar</label>
      <input type="text" id="searchImplemento" placeholder="Nome ou Sigla" oninput="this.value = this.value.toUpperCase()">
      <button class="btn blue mt-4" onclick="popularTabelaImplementos()">Buscar</button>
    </div>
    <div id="implementosTableContainer" class="mt-4 max-h-96 overflow-y-auto border border-gray-200 rounded-lg shadow-inner">
        <table class="min-w-full divide-y divide-gray-200 consult-table">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome do Implemento</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sigla</th>
                </tr>
            </thead>
            <tbody id="implementosTableBody" class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
    </div>
  </div>


</div>

<div id="customModal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle"></h3>
    <p id="modalMessage"></p>
    <div class="modal-buttons">
      <button id="modalConfirmBtn" class="btn blue" style="display:none;">Sim</button>
      <button id="modalCancelBtn" class="btn red" style="display:none;">N?o</button>
      <button id="modalOKBtn" class="btn blue" style="display:none;">OK</button>
    </div>
  </div>
</div>

<!-- Edit Record Modal -->
<div id="editRecordModal" class="modal">
  <div class="modal-content">
    <h3 class="text-xl font-bold mb-4">Editar Registro de Atividade</h3>
    
    <!-- Record Type Selection -->
    <div class="flex justify-center gap-4 mb-6">
        <label class="inline-flex items-center">
            <input type="radio" name="editType" value="fim" checked class="form-radio" onchange="toggleEditMode('fim')">
            <span class="ml-2 text-gray-700 font-medium">Editar Dados de Fim</span>
        </label>
        <label class="inline-flex items-center">
            <input type="radio" name="editType" value="inicio" class="form-radio" onchange="toggleEditMode('inicio')">
            <span class="ml-2 text-gray-700 font-medium">Editar Dados de In?cio</span>
        </label>
    </div>

    <form id="formEditRecord">
      <input type="hidden" id="editRecordId">
      
      <!-- Fields for Editing END Record Data -->
      <div id="editFimFields">
        <h4 class="text-left font-semibold text-gray-700 mb-3 border-b pb-2">Dados de Encerramento</h4>
        <div class="field">
          <label for="editDataFinal">Data Final</label>
          <input type="date" id="editDataFinal" required>
        </div>
        <div class="field">
          <label for="editHoraFinal">Hora Final</label>
          <input type="time" id="editHoraFinal" required>
        </div>
        <div class="field">
          <label for="editHorimetroFinal">Hor?metro Final</label>
          <input type="text" id="editHorimetroFinal" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" required>
        </div>
        <div class="field">
          <label for="editObservacoesFim">Observa??es</label>
          <textarea id="editObservacoesFim" rows="3"></textarea>
        </div>
      </div>

      <!-- Fields for Editing START Record Data (Hidden by default, requires password) -->
      <div id="editInicioFields" style="display:none;">
        <h4 class="text-left font-semibold text-gray-700 mb-3 border-b pb-2 mt-6">Dados de In?cio</h4>
        <div class="field">
            <label for="editCrachaInicio">Crach? Operador</label>
            <input type="text" id="editCrachaInicio" oninput="this.value = this.value.toUpperCase(); buscarOperador(this.value, 'editNomeOperador', 'editFotoOperador');">
            <label for="editNomeOperador">Nome Operador</label>
            <input type="text" id="editNomeOperador" readonly>
            <img id="editFotoOperador" src="https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR" alt="Foto Operador">
        </div>
        <div class="field">
            <label for="editFrotaInicio">Frota</label>
            <input type="text" id="editFrotaInicio" oninput="this.value = this.value.toUpperCase(); mostrarModeloFrota(this.value, 'editEquipamentoInicio', 'editFotoEquipamento');">
            <label for="editEquipamentoInicio">Equipamento</label>
            <input type="text" id="editEquipamentoInicio" readonly>
            <img id="editFotoEquipamento" src="https://placehold.co/100x100/A0AEC0/000000?text=FROTA" alt="Foto Frota">
        </div>
        <!-- Password section for sensitive edits, placed after operator/frota -->
        <div id="editPasswordSection" class="mt-6 p-4 border border-yellow-300 bg-yellow-50 rounded-lg shadow-inner" style="display:none;">
            <h4 class="text-md font-semibold text-yellow-800 mb-2">Desbloquear Edi??o de Dados de In?cio</h4>
            <div class="field">
                <label for="editAdminPassword">Senha Admin</label>
                <input type="password" id="editAdminPassword" placeholder="Digite a senha de administrador">
            </div>
            <button type="button" class="btn purple mt-2" onclick="handleUnlockEdit()">DESBLOQUEAR</button>
        </div>
        <div class="field">
            <label for="editDataInicial">Data Inicial</label>
            <input type="date" id="editDataInicial">
        </div>
        <div class="field">
            <label for="editHoraInicial">Hora Inicial</label>
            <input type="time" id="editHoraInicial">
        </div>
        <div class="field">
            <label for="editHorimetroInicial">Hor?metro Inicial</label>
            <input type="text" id="editHorimetroInicial" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');">
        </div>
        <div class="field">
            <label for="editSetorInicio">Setor</label>
            <select id="editSetorInicio"></select>
        </div>
        <div class="field">
            <label for="editAtividadeInicio">Atividade</label>
            <select id="editAtividadeInicio"></select>
        </div>
        <div class="field">
            <label for="editImplementoInicio">Implemento</label>
            <select id="editImplementoInicio"></select>
        </div>
        <div class="field" id="editRelatoProblemaField" style="display:none;">
            <label for="editRelatoProblema">Relato Problema</label>
            <textarea id="editRelatoProblema" rows="3"></textarea>
        </div>
      </div>

      <div class="modal-buttons mt-6">
        <button class="btn blue" type="button" onclick="salvarEdicaoRegistro()">Salvar Edi??o</button>
        <button class="btn red" type="button" onclick="cancelarEdicaoRegistro()">Cancelar</button>
      </div>
    </form>
  </div>
</div>
  
<script>
  // Global objects to store data (in-memory, not persistent)
  const operadores = {};
  const frotas = {};
  const setores = {};
  const atividades = {};
  const implementos = {}; 
  // Global map to store the current active activity for each frota
  // Key: frotaCode, Value: activity object
  const frotasAtivas = {}; 
  // Global array to store all completed activity records
  const registrosAtividades = [];
  // Global map to store the last known valid horimeter for each frota
  const lastKnownHorimeters = {};
  // Global object to store simplified records of completed activities for checklist logic
  // Key: "CRACA_FROTA_YYYY-MM-DD", Value: true
  const completedActivitiesSummary = {};
  // Global array to store edit history
  const edicoesRealizadas = [];


  // In-memory user roles for demonstration
  // IMPORTANT: In a real application, user data and passwords should be stored securely on a backend server, not in client-side JavaScript. This is for demonstration purposes only.
  const appUsers = {
    'admin': { password: 'admin123', role: 'administrador' },
    'analista': { password: 'user123', role: 'analista' } // Renamed from 'user' to 'analista'
  };
  let currentUserRole = null; // Stores the role of the currently logged-in user

  let tempData = ''; // Stores the ID of the date input field for confirmation
  let tempHora = ''; // Stores the ID of the time input field for confirmation

  // Reference to the custom modal elements
  const customModal = document.getElementById('customModal');
  const modalContent = customModal.querySelector('.modal-content'); // Get the content div
  const modalTitle = document.getElementById('modalTitle');
  const modalMessage = document.getElementById('modalMessage');
  const modalConfirmBtn = document.getElementById('modalConfirmBtn');
  const modalCancelBtn = document.getElementById('modalCancelBtn');
  const modalOKBtn = document.getElementById('modalOKBtn');

  // References for edit modal
  const editRecordModal = document.getElementById('editRecordModal');
  let currentEditingRecord = null; // Stores the record object being edited
  let isInitialEditUnlocked = false; // Flag to track if initial fields are editable

  /**
   * Generates a simple unique ID.
   * @returns {string} A unique ID string.
   */
  function generateUniqueId() {
      return Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
  }

  /**
   * Displays a custom alert message to the user.
   * @param {string} message - The message to display.
   * @param {boolean} isWarning - If true, applies warning style for critical alerts.
   */
  function showAlert(message, isWarning = false) {
      modalTitle.textContent = isWarning ? 'ATEN??O!' : 'ATEN??O'; // Simplified title for consistency
      modalMessage.textContent = message;
      modalConfirmBtn.style.display = 'none';
      modalCancelBtn.style.display = 'none';
      modalOKBtn.style.display = 'inline-block';
      customModal.style.display = 'flex';

      // Apply/remove warning background
      if (isWarning) {
          modalContent.classList.add('modal-warning-background');
      } else {
          modalContent.classList.remove('modal-warning-background');
      }

      modalOKBtn.onclick = () => {
          customModal.style.display = 'none';
          modalContent.classList.remove('modal-warning-background'); // Ensure removal on close
      };
  }

  /**
   * Displays a custom confirmation dialog to the user.
   * @param {string} message - The confirmation message.
   * @param {boolean} isWarning - If true, applies warning style for critical alerts.
   * @returns {Promise<boolean>} A promise that resolves to true if confirmed, false otherwise.
   */
  function showConfirm(message, isWarning = false) {
      return new Promise((resolve) => {
          modalTitle.textContent = isWarning ? 'CONFIRMA??O!' : 'CONFIRMA??O'; // Simplified title for consistency
          modalMessage.textContent = message;
          modalConfirmBtn.style.display = 'inline-block';
          modalCancelBtn.style.display = 'inline-block';
          modalOKBtn.style.display = 'none';
          customModal.style.display = 'flex';

          // Apply/remove warning background
          if (isWarning) {
              modalContent.classList.add('modal-warning-background');
          } else {
              modalContent.classList.remove('modal-warning-background');
          }

          modalConfirmBtn.onclick = () => {
              customModal.style.display = 'none';
              modalContent.classList.remove('modal-warning-background'); // Ensure removal on close
              resolve(true);
          };
          modalCancelBtn.onclick = () => {
              customModal.style.display = 'none';
              modalContent.classList.remove('modal-warning-background'); // Ensure removal on close
              resolve(false);
          };
      });
  }

  /**
   * Handles user login based on provided credentials.
   */
  function handleLogin() {
    const username = document.getElementById('adminUsername').value;
    const password = document.getElementById('adminPassword').value;

    const user = appUsers[username]; 

    if (user && user.password === password) {
      currentUserRole = user.role;
      showAlert(`LOGIN BEM-SUCEDIDO! N?VEL DE ACESSO: ${user.role.toUpperCase()}!`);
      document.getElementById('adminLogin').style.display = 'none';
      document.getElementById('adminDashboard').style.display = 'block';
      document.getElementById('loggedInUserRoleDisplay').textContent = username.toUpperCase(); 
      document.getElementById('loggedInUserLevelDisplay').textContent = user.role.toUpperCase(); 
      
      // Show user management if admin
      if (currentUserRole === 'administrador') {
          document.getElementById('userManagement').style.display = 'block';
          popularListaUsuarios(); // Populate the list of users
      } else {
          document.getElementById('userManagement').style.display = 'none';
      }

      // After successful login, refresh the button visibility based on the new role
      mostrar('disponibilidade'); // Go to a default view that refreshes buttons
    } else {
      showAlert('USU?RIO OU SENHA INV?LIDOS.');
      currentUserRole = null;
    }
    updateButtonVisibility(); // Always call this after login attempt
  }

  /**
   * Handles user logout.
   */
  function logout() {
    currentUserRole = null;
    showAlert('VOC? FOI DESCONECTADO.');
    // Hide dashboard and show login form again
    document.getElementById('adminDashboard').style.display = 'none';
    document.getElementById('adminLogin').style.display = 'block';
    document.getElementById('adminUsername').value = '';
    document.getElementById('adminPassword').value = '';
    document.getElementById('userManagement').style.display = 'none'; // Hide user management on logout
    // Redirect to a default public section, e.g., Disponibilidade
    mostrar('disponibilidade');
    updateButtonVisibility(); // Update button visibility after logout
  }

  /**
   * Updates the visibility of navigation buttons based on the current user role.
   */
  function updateButtonVisibility() {
      // All buttons in the navigation bar, excluding the moved Admin button
      const navButtons = [
          'btnDisponibilidade', 'btnInicioAtividade', 'btnEncerramentoAtividade',
          'btnCadastro', 'btnRelatorio', 'btnDados'
      ];

      // Hide all nav buttons by default
      navButtons.forEach(btnId => {
          document.getElementById(btnId).style.display = 'none';
      });

      // Show the Admin button regardless of login state (for login/logout)
      document.getElementById('btnAdministrador').style.display = 'inline-block';

      if (currentUserRole === null) { // Before login, default "Opera??o" view
          document.getElementById('btnDisponibilidade').style.display = 'inline-block';
          document.getElementById('btnInicioAtividade').style.display = 'inline-block';
          document.getElementById('btnEncerramentoAtividade').style.display = 'inline-block';
      } else if (currentUserRole === 'operacao') { // Opera??o profile (after explicit login as 'operacao' if that were allowed)
          document.getElementById('btnDisponibilidade').style.display = 'inline-block';
          document.getElementById('btnInicioAtividade').style.display = 'inline-block';
          document.getElementById('btnEncerramentoAtividade').style.display = 'inline-block';
      } else if (currentUserRole === 'analista') { // Analista profile
          document.getElementById('btnDisponibilidade').style.display = 'inline-block';
          document.getElementById('btnInicioAtividade').style.display = 'inline-block';
          document.getElementById('btnEncerramentoAtividade').style.display = 'inline-block';
          document.getElementById('btnCadastro').style.display = 'inline-block';
          document.getElementById('btnDados').style.display = 'inline-block';
          document.getElementById('btnRelatorio').style.display = 'inline-block'; // Analista can see reports
      } else if (currentUserRole === 'administrador') { // Administrador profile
          navButtons.forEach(btnId => {
              document.getElementById(btnId).style.display = 'inline-block';
          });
      }
  }


  /**
   * Checks if the current user has the required access level for a given section.
   * This function now always returns true, removing the login requirement.
   * @returns {boolean} Always true.
   */
  function checkAccess() {
    return true; // Login is no longer mandatory for section access, handled by UI visibility
  }

  /**
   * Busca os dados do operador pelo crach? e preenche os campos de nome e foto.
   * Para o formul?rio de in?cio, tamb?m gerencia a visibilidade do checklist.
   * Para o formul?rio de fim, tamb?m aciona a busca por frotas ativas.
   * @param {string} cracha - O crach? do operador.
   * @param {string} nomeFieldId - O ID do campo de input para o nome do operador.
   * @param {string} fotoFieldId - O ID da tag <img> para a foto do operador.
   */
  function buscarOperador(cracha, nomeFieldId, fotoFieldId) {
    const operador = operadores[cracha];
    if (operador) {
      document.getElementById(nomeFieldId).value = operador.nome;
      document.getElementById(fotoFieldId).src = operador.foto;
    } else {
      document.getElementById(nomeFieldId).value = 'OPERADOR N?O ENCONTRADO';
      document.getElementById(fotoFieldId).src = 'https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR';
    }
  }

  /**
   * Mostra o modelo e a foto da frota com base no c?digo da frota.
   * @param {string} frotaCode - O c?digo da frota.
   * @param {string} equipamentoFieldId - O ID do campo de input para o nome do equipamento.
   * @param {string} fotoEquipFieldId - O ID da tag <img> para a foto do equipamento.
   */
  function mostrarModeloFrota(frotaCode, equipamentoFieldId, fotoEquipFieldId) {
    const frota = frotas[frotaCode];
    if (frota) {
      document.getElementById(equipamentoFieldId).value = frota.modelo;
      document.getElementById(fotoEquipFieldId).src = frota.foto;
    } else {
      document.getElementById(equipamentoFieldId).value = 'EQUIPAMENTO N?O ENCONTRADO';
      document.getElementById(fotoEquipFieldId).src = 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
    }
  }

  /**
   * Controls which main section of the application is displayed.
   * Updates the panel background color and title based on the active section.
   * @param {string} section - The ID of the section to display ('inicio', 'disponibilidade', 'fim', 'cadastro', 'administrador', 'relatorio', 'dados', 'relatorioChecklist', 'consultaOperador', 'consultaFrota', 'consultaSetor', 'consultaAtividade', 'consultaImplemento', 'relatorioSetor', 'relatorioAtividade', 'relatorioEdicoes', 'relatorioHorasFrota').
   */
  function mostrar(section) {
    // Hide all main sections
    ['inicio', 'disponibilidade', 'fim', 'cadastro', 'administrador', 'relatorio', 'dados', 'relatorioChecklist', 'consultaOperador', 'consultaFrota', 'consultaSetor', 'consultaAtividade', 'consultaImplemento', 'relatorioSetor', 'relatorioAtividade', 'relatorioEdicoes', 'relatorioHorasFrota'].forEach(id => {
      document.getElementById(id).style.display = 'none';
    });

    // Display the requested section
    document.getElementById(section).style.display = 'block';

    // Get the main panel element
    const panel = document.getElementById('mainPanel');

    // Set panel background color based on the active section
    panel.style.backgroundColor = section === 'inicio'
      ? '#e6ffe6' // Light green for start activity
      : section === 'disponibilidade'
        ? '#fff3cd' // Light yellow for availability
        : section === 'fim'
          ? '#ffe6e6' // Light red for end activity
          : section === 'cadastro'
            ? '#e6f0ff' // Light blue for Cadastro (was Admin)
            : section === 'relatorio'
              ? '#e0ffe0' // Light green for relatorio
              : section === 'dados'
                ? '#f0f8ff' // AliceBlue for Data section
                : section === 'relatorioChecklist'
                  ? '#e0f8f8' // Light cyan for checklist report
                : section.startsWith('consulta')
                  ? '#e6f0ff' // Light blue for consultation sections
                  : section.startsWith('relatorio')
                    ? '#e0ffe0' // Light green for reports
                  : '#f2f2f2'; // Default for admin login/dashboard, or other cases

    // Update the panel title
    document.getElementById('panelTitle').textContent =
      section === 'inicio'
        ? 'IN?CIO DE ATIVIDADE'
        : section === 'disponibilidade'
          ? 'DISPONIBILIDADE'
          : section === 'fim'
            ? 'ENCERRAMENTO DE ATIVIDADE'
            : section === 'cadastro'
              ? 'CADASTRO'
              : section === 'administrador'
                ? 'PAINEL ADMINISTRATIVO' // Title for Admin login/dashboard
                : section === 'relatorio'
                  ? 'RELAT?RIOS'
                  : section === 'dados'
                    ? 'DADOS DE ATIVIDADES'
                    : section === 'relatorioChecklist'
                      ? 'RELAT?RIO DE CHECKLIST DE SEGURAN?A'
                    : section === 'consultaOperador'
                      ? 'CONSULTAR OPERADORES'
                      : section === 'consultaFrota'
                        ? 'CONSULTAR FROTAS'
                        : section === 'consultaSetor'
                          ? 'CONSULTAR SETORES'
                          : section === 'consultaAtividade'
                            ? 'CONSULTAR ATIVIDADES'
                            : section === 'consultaImplemento'
                              ? 'CONSULTAR IMPLEMENTOS'
                              : section === 'relatorioSetor'
                                ? 'RELAT?RIO POR SETOR'
                                : section === 'relatorioAtividade'
                                  ? 'RELAT?RIO POR ATIVIDADE'
                                  : section === 'relatorioEdicoes'
                                    ? 'RELAT?RIO DE EDI??ES REALIZADAS'
                                    : section === 'relatorioHorasFrota'
                                        ? 'RELAT?RIO DE HORAS POR FROTA'
                                        : 'STATUS DE ATIVIDADE';

    // Populate dropdowns if in 'inicio' section
    if (section === 'inicio') {
      populateDropdown('setor', section);
      populateDropdown('atividade', section);
      populateDropdown('implemento', section);
      toggleChecklistVisibility(); // Ensure checklist is correctly shown/hidden on section change
    } else if (section === 'disponibilidade') {
      // Populate the availability section when it's displayed
      popularDisponibilidade();
    } else if (section === 'dados') {
      popularTabelaRegistros(); // Populate the data table
    } else if (section === 'relatorioChecklist') {
      popularTabelaChecklist(); // Populate the checklist report table
    } else if (section === 'relatorioSetor') {
      popularTabelaRelatorioSetor(); // Populate the sector report table
    } else if (section === 'relatorioAtividade') {
      popularTabelaRelatorioAtividade(); // Populate the activity report table
    } else if (section === 'relatorioEdicoes') {
      popularTabelaEdicoes(); // Populate the edits report table
    } else if (section === 'relatorioHorasFrota') {
        popularTabelaHorasFrota(); // Populate the new hours by frota report
    }
    updateButtonVisibility(); // Always update button visibility when changing sections
  }

  /**
   * Populates a dropdown (select element) with data from a global object.
   * @param {string} type - The type of dropdown to populate ('setor', 'atividade', 'implemento').
   * @param {string} section - The current section ('inicio') to determine the correct dropdown ID, or if for edit modal.
   * @param {string} targetSelectId - Optional. The specific ID of the select element to populate if not following standard 'type + section' naming.
   */
  function populateDropdown(type, section, targetSelectId = null) {
    // Determine which global object to use based on the type
    const obj = type === 'setor'
      ? setores
      : type === 'atividade'
        ? atividades
        : implementos;

    const selectId = targetSelectId || (section + type.charAt(0).toUpperCase() + type.slice(1));
    const select = document.getElementById(selectId);

    if (!select) return; // Exit if the target select element doesn't exist

    select.innerHTML = ''; // Clear existing options

    // Add a default "Selecione" option
    const defaultOpt = document.createElement('option');
    defaultOpt.value = '';
    defaultOpt.textContent = 'SELECIONE';
    defaultOpt.disabled = true;
    defaultOpt.selected = true;
    select.append(defaultOpt);

    // Add options from the global object
    Object.keys(obj).forEach(key => {
        const opt = document.createElement('option');
        opt.value = key; // Use the key (which is the name for setor/atividade, or the internal key for implementos)
        // For implementos, display both name and acronym
        opt.textContent = type === 'implemento' ? `${obj[key].nome} (${obj[key].sigla})` : obj[key]; 
        select.append(opt);
    });
  }

  // --- Admin Helpers (Cadastro Sub-panels) ---

  /** Hides all cadastro sub-panels. */
  function hideAllCadastroSubPanels() { 
    ['cadastroOperador', 'cadastroFrota', 'cadastroSetor', 'cadastroAtividade', 'cadastroImplemento']
      .forEach(id => document.getElementById(id).style.display = 'none');
  }

  /** Displays the Operator registration panel. */
  function mostrarCadastroOperador() {
    hideAllCadastroSubPanels();
    document.getElementById('cadastroOperador').style.display = 'block';
  }

  /** Saves operator data to the `operadores` object. */
  function salvarOperador() {
    const c = document.getElementById('crachaOperador').value.trim();
    const n = document.getElementById('nomeOperador').value.trim();
    const f = document.getElementById('fotoOperador').files[0];

    if (!c || !n) {
      showAlert('CRACH? E NOME DO OPERADOR S?O OBRIGAT?RIOS.');
      return;
    }

    // Check for duplicate Crach?
    if (operadores[c]) {
        showAlert('ERRO: CRACH? J? CADASTRADO!');
        return;
    }

    if (f) {
      const r = new FileReader();
      r.onload = () => {
        operadores[c] = { nome: n, foto: r.result };
        clearOperador();
        showAlert('OPERADOR SALVO COM SUCESSO!');
      };
      r.readAsDataURL(f); // Read the image file as a Data URL
    } else {
      operadores[c] = { nome: n, foto: 'https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR' }; // Placeholder if no photo
      clearOperador();
      showAlert('OPERADOR SALVO SEM FOTO.');
    }
  }

  /** Clears the operator registration form fields. */
  function clearOperador() {
    ['crachaOperador', 'nomeOperador', 'fotoOperador'].forEach(id => document.getElementById(id).value = '');
  }

  /** Consults operator data by code and updates display fields. Now redirects to the consultation table. */
  function consultarOperador() {
    mostrar('consultaOperador'); // Navigate to the consultation screen
    const cracha = document.getElementById('crachaOperador').value.trim();
    document.getElementById('searchOperador').value = cracha; // Pre-fill search field
    popularTabelaOperadores(); // Populate/filter the table
  }

  /** Displays the Fleet registration panel. */
  function mostrarCadastroFrota() {
    hideAllCadastroSubPanels();
    document.getElementById('cadastroFrota').style.display = 'block';
  }

  /** Saves fleet data to the `frotas` object. */
  function salvarFrota() {
    const c = document.getElementById('codigoFrota').value.trim();
    const m = document.getElementById('modeloFrota').value.trim();
    const f = document.getElementById('fotoFrota').files[0];

    if (!c || !m) {
      showAlert('FROTA E MODELO S?O OBRIGAT?RIOS.');
      return;
    }

    // Check for duplicate Frota Code
    if (frotas[c]) {
        showAlert('ERRO: C?DIGO DA FROTA J? CADASTRADO!');
        return;
    }

    if (f) {
      const r = new FileReader();
      r.onload = () => {
        frotas[c] = { modelo: m, foto: r.result };
        clearFrota();
        showAlert('FROTA SALVA COM SUCESSO!');
      };
      r.readAsDataURL(f); // Read the image file as a Data URL
    } else {
      frotas[c] = { modelo: m, foto: 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA' }; // Placeholder if no photo
      clearFrota();
      showAlert('FROTA SALVA SEM FOTO.');
    }
    popularDisponibilidade(); // Update availability section immediately after saving a fleet
  }

  /** Clears the fleet registration form fields. */
  function clearFrota() {
    ['codigoFrota', 'modeloFrota', 'fotoFrota'].forEach(id => document.getElementById(id).value = '');
  }

  /** Consults fleet data by code and updates display fields. Now redirects to the consultation table. */
  function consultarFrota() {
    mostrar('consultaFrota'); // Navigate to the consultation screen
    const codigo = document.getElementById('codigoFrota').value.trim();
    document.getElementById('searchFrota').value = codigo; // Pre-fill search field
    popularTabelaFrotas(); // Populate/filter the table
  }

  /** Displays the Sector registration panel. */
  function mostrarCadastroSetor() {
    hideAllCadastroSubPanels();
    document.getElementById('cadastroSetor').style.display = 'block';
  }

  /** Saves sector data to the `setores` object. */
  function salvarSetor() {
    const n = document.getElementById('nomeSetor').value.trim();
    if (!n) {
      showAlert('NOME DO SETOR ? OBRIGAT?RIO.');
      return;
    }

    // Check for duplicate Sector Name
    if (setores[n]) {
        showAlert('ERRO: SETOR J? CADASTRADO!');
        return;
    }

    setores[n] = n; // Store the name as both key and value for simplicity
    document.getElementById('nomeSetor').value = '';
    showAlert('SETOR SALVO COM SUCESSO!');
  }

  /** Consults sector data by name. Now redirects to the consultation table. */
  function consultarSetor() {
    mostrar('consultaSetor'); // Navigate to the consultation screen
    const nome = document.getElementById('nomeSetor').value.trim();
    document.getElementById('searchSetor').value = nome; // Pre-fill search field
    popularTabelaSetores(); // Populate/filter the table
  }

  /** Displays the Activity registration panel. */
  function mostrarCadastroAtividade() {
    hideAllCadastroSubPanels();
    document.getElementById('cadastroAtividade').style.display = 'block';
  }

  /** Saves activity data to the `atividades` object. */
  function salvarAtividade() {
    const n = document.getElementById('nomeAtividade').value.trim();
    if (!n) {
      showAlert('NOME DA ATIVIDADE ? OBRIGAT?RIO.');
      return;
    }

    // Check for duplicate Activity Name
    if (atividades[n]) {
        showAlert('ERRO: ATIVIDADE J? CADASTRADA!');
        return;
    }

    atividades[n] = n; // Store the name as both key and value
    document.getElementById('nomeAtividade').value = '';
    showAlert('ATIVIDADE SALVA COM SUCESSO!');
  }

  /** Consults activity data by name. Now redirects to the consultation table. */
  function consultarAtividade() {
    mostrar('consultaAtividade'); // Navigate to the consultation screen
    const nome = document.getElementById('nomeAtividade').value.trim();
    document.getElementById('searchAtividade').value = nome; // Pre-fill search field
    popularTabelaAtividades(); // Populate/filter the table
  }

  /** Displays the Implement registration panel. */
  function mostrarCadastroImplemento() {
    hideAllCadastroSubPanels();
    document.getElementById('cadastroImplemento').style.display = 'block';
  }

  /** Saves implement data to the `implementos` object. */
  function salvarImplemento() {
    const n = document.getElementById('nomeImplemento').value.trim();
    const s = document.getElementById('siglaImplemento').value.trim(); // Get the new 'Sigla' value
    if (!n || !s) { // Both name and acronym are now required
      showAlert('NOME E SIGLA DO IMPLEMENTO S?O OBRIGAT?RIOS.');
      return;
    }

    // Check for duplicate Implemento Name or Sigla
    if (implementos[n]) {
        showAlert('ERRO: IMPLEMENTO COM ESTE NOME J? CADASTRADO!');
        return;
    }
    const siglaExists = Object.values(implementos).some(impl => impl.sigla === s);
    if (siglaExists) {
        showAlert('ERRO: SIGLA J? CADASTRADA PARA OUTRO IMPLEMENTO!');
        return;
    }

    implementos[n] = { nome: n, sigla: s }; // Store as an object
    clearImplemento(); // Clear the form fields
    showAlert('IMPLEMENTO SALVO COM SUCESSO!');
  }

  /** Clears the implement registration form fields. */
  function clearImplemento() {
    document.getElementById('nomeImplemento').value = '';
    document.getElementById('siglaImplemento').value = ''; // Clear the new 'Sigla' field
  }

  /** Consults implement data by name or sigla. Now redirects to the consultation table. */
  function consultarImplemento() {
    mostrar('consultaImplemento'); // Navigate to the consultation screen
    const nome = document.getElementById('nomeImplemento').value.trim();
    const sigla = document.getElementById('siglaImplemento').value.trim();
    document.getElementById('searchImplemento').value = nome || sigla; // Pre-fill search field
    popularTabelaImplementos(); // Populate/filter the table
  }


  // --- New Consultation Table Population Functions ---

  /** Populates the Operators table with (optionally filtered) data. */
  function popularTabelaOperadores() {
    const tableBody = document.getElementById('operadoresTableBody');
    tableBody.innerHTML = '';
    const searchTerm = document.getElementById('searchOperador').value.toLowerCase();

    let foundCount = 0;
    for (const cracha in operadores) {
      const op = operadores[cracha];
      const matchCracha = cracha.toLowerCase().includes(searchTerm);
      const matchNome = op.nome.toLowerCase().includes(searchTerm);

      if (!searchTerm || matchCracha || matchNome) {
        const row = tableBody.insertRow();
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" data-label="Crach?">${cracha}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" data-label="Nome">${op.nome}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" data-label="Foto"><img src="${op.foto}" alt="Foto" class="h-10 w-10 rounded-full object-cover inline-block"></td>
        `;
        foundCount++;
      }
    }
    if (foundCount === 0) {
      tableBody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-sm text-gray-500">NENHUM OPERADOR ENCONTRADO.</td></tr>`;
    }
  }

  /** Populates the Fleets table with (optionally filtered) data. */
  function popularTabelaFrotas() {
    const tableBody = document.getElementById('frotasTableBody');
    tableBody.innerHTML = '';
    const searchTerm = document.getElementById('searchFrota').value.toLowerCase();

    let foundCount = 0;
    for (const codigo in frotas) {
      const fr = frotas[codigo];
      const matchCodigo = codigo.toLowerCase().includes(searchTerm);
      const matchModelo = fr.modelo.toLowerCase().includes(searchTerm);

      if (!searchTerm || matchCodigo || matchModelo) {
        const row = tableBody.insertRow();
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" data-label="C?digo">${codigo}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" data-label="Modelo">${fr.modelo}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" data-label="Foto"><img src="${fr.foto}" alt="Foto" class="h-10 w-10 rounded-full object-cover inline-block"></td>
        `;
        foundCount++;
      }
    }
    if (foundCount === 0) {
      tableBody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-sm text-gray-500">NENHUMA FROTA ENCONTRADA.</td></tr>`;
    }
  }

  /** Populates the Sectors table with (optionally filtered) data. */
  function popularTabelaSetores() {
    const tableBody = document.getElementById('setoresTableBody');
    tableBody.innerHTML = '';
    const searchTerm = document.getElementById('searchSetor').value.toLowerCase();

    let foundCount = 0;
    for (const nome in setores) {
      const matchNome = nome.toLowerCase().includes(searchTerm);

      if (!searchTerm || matchNome) {
        const row = tableBody.insertRow();
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" data-label="Nome do Setor">${nome}</td>
        `;
        foundCount++;
      }
    }
    if (foundCount === 0) {
      tableBody.innerHTML = `<tr><td colspan="1" class="px-6 py-4 text-center text-sm text-gray-500">NENHUM SETOR ENCONTRADO.</td></tr>`;
    }
  }

  /** Populates the Activities table with (optionally filtered) data. */
  function popularTabelaAtividades() {
    const tableBody = document.getElementById('atividadesTableBody');
    tableBody.innerHTML = '';
    const searchTerm = document.getElementById('searchAtividade').value.toLowerCase();

    let foundCount = 0;
    for (const nome in atividades) {
      const matchNome = nome.toLowerCase().includes(searchTerm);

      if (!searchTerm || matchNome) {
        const row = tableBody.insertRow();
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" data-label="Nome da Atividade">${nome}</td>
        `;
        foundCount++;
      }
    }
    if (foundCount === 0) {
      tableBody.innerHTML = `<tr><td colspan="1" class="px-6 py-4 text-center text-sm text-gray-500">NENHUMA ATIVIDADE ENCONTRADA.</td></tr>`;
    }
  }

  /** Populates the Implements table with (optionally filtered) data. */
  function popularTabelaImplementos() {
    const tableBody = document.getElementById('implementosTableBody');
    tableBody.innerHTML = '';
    const searchTerm = document.getElementById('searchImplemento').value.toLowerCase();

    let foundCount = 0;
    for (const nome in implementos) {
      const impl = implementos[nome];
      const matchNome = nome.toLowerCase().includes(searchTerm);
      const matchSigla = impl.sigla.toLowerCase().includes(searchTerm);

      if (!searchTerm || matchNome || matchSigla) {
        const row = tableBody.insertRow(); // Corrected: insertRow() on tbody
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" data-label="Nome do Implemento">${impl.nome}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" data-label="Sigla">${impl.sigla}</td>
        `;
        foundCount++;
      }
    }
    if (foundCount === 0) {
      tableBody.innerHTML = `<tr><td colspan="2" class="px-6 py-4 text-center text-sm text-gray-500">NENHUM IMPLEMENTO ENCONTRADO.</td></tr>`;
    }
  }

  /** Populates the main data table with all activity records, filtered by search terms. */
  function popularTabelaRegistros() {
      const tableBody = document.getElementById('registrosTableBody');
      tableBody.innerHTML = '';
      const filterFrota = document.getElementById('filterFrotaDados').value.toLowerCase();
      const filterOperador = document.getElementById('filterOperadorDados').value.toLowerCase();
      const filterSetor = document.getElementById('filterSetorDados').value.toLowerCase();
      const filterAtividade = document.getElementById('filterAtividadeDados').value.toLowerCase();
      const filterImplemento = document.getElementById('filterImplementoDados').value.toLowerCase();

      let foundCount = 0;
      registrosAtividades.forEach(record => {
          const matchFrota = record.frotaInicio.toLowerCase().includes(filterFrota); 
          const matchOperador = record.nomeOperadorDisplay.toLowerCase().includes(filterOperador);
          const matchSetor = record.setor.toLowerCase().includes(filterSetor);
          const matchAtividade = record.atividade.toLowerCase().includes(filterAtividade);
          const matchImplemento = (implementos[record.implemento]?.nome || '').toLowerCase().includes(filterImplemento) ||
                                (implementos[record.implemento]?.sigla || '').toLowerCase().includes(filterImplemento);

          if (matchFrota && matchOperador && matchSetor && matchAtividade && matchImplemento) {
              const row = tableBody.insertRow();
              row.className = 'hover:bg-gray-50';
              
              const duracao = calcularDiferencaHoras(record.dataInicial, record.horaInicial, record.dataFinal, record.horaFinal);
              const horimetroTotal = record.horimetroTotalCalculado;

              let statusText = record.horimetroInconsistente ? 'INCONSISTENTE' : 'OK';
              let statusClass = record.horimetroInconsistente ? 'status-inconsistente' : 'status-ok';

              // If it's a "ENCERRAMENTO SEM IN?CIO" record, always mark as INCONSISTENTE
              if (record.atividade === 'ENCERRAMENTO SEM IN?CIO') {
                  statusText = 'INCONSISTENTE';
                  statusClass = 'status-inconsistente';
              }


              row.innerHTML = `
                  <td class="px-2 py-2 whitespace-nowrap text-sm font-medium text-gray-900" data-label="ID">${record.id.substring(0, 8)}...</td>
                  <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="Frota">${record.frotaInicio}</td>
                  <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="Operador">${record.nomeOperadorDisplay}</td>
                  <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="Atividade">${record.atividade}</td>
                  <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="In?cio">${record.dataInicial} ${record.horaInicial}</td>
                  <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="H. Inicial">${record.horimetroInicial}</td>
                  <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="Fim">${record.dataFinal || 'N/A'} ${record.horaFinal || 'N/A'}</td>
                  <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="H. Final">${record.horimetroFinal || 'N/A'}</td>
                  <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="Dura??o (h)">${record.dataFinal ? duracao.toFixed(2) : 'Em Andamento'}</td>
                  <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="Status"><span class="status-cell ${statusClass}">${statusText}</span></td>
                  <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="A??es">
                      <button class="btn blue text-sm py-1 px-3" onclick="editarRegistro('${record.id}')">EDITAR</button>
                  </td>
              `;
              foundCount++;
          }
      });

      if (foundCount === 0) {
          tableBody.innerHTML = `<tr><td colspan="11" class="px-6 py-4 text-center text-sm text-gray-500">NENHUM REGISTRO ENCONTRADO COM OS FILTROS APLICADOS.</td></tr>`;
      }
  }

  /** Clears all filters in the "Dados" section and repopulates the table. */
  function limparFiltrosDados() {
      document.getElementById('filterFrotaDados').value = '';
      document.getElementById('filterOperadorDados').value = '';
      document.getElementById('filterSetorDados').value = '';
      document.getElementById('filterAtividadeDados').value = '';
      document.getElementById('filterImplementoDados').value = '';
      popularTabelaRegistros();
  }


  // --- Date/Time Functions ---

  /**
   * Confirms with the user if they want to pre-fill date and time with current values.
   * @param {string} dateFieldId - The ID of the date input field.
   * @param {string} timeFieldId - The ID of the time input field.
   */
  async function confirmarDataHora(dateFieldId, timeFieldId) {
    tempData = dateFieldId;
    tempHora = timeFieldId;
    const ok = await showConfirm('DESEJA PREENCHER DATA E HORA DO MOMENTO?');
    if (ok) {
      preencherDataHora();
    }
  }

  /** Fills the specified date and time input fields with the current local date and time. */
  function preencherDataHora() {
    const now = new Date();
    // Format date asYYYY-MM-DD
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    document.getElementById(tempData).value = `${year}-${month}-${day}`;
    
    // Format time as HH:MM
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    document.getElementById(tempHora).value = `${hours}:${minutes}`;

    // After pre-filling, check checklist visibility
    if (tempData === 'dataInicial') {
        toggleChecklistVisibility();
    }
  }

  /**
   * Calculates the difference in hours between two date-time strings.
   * @param {string} dataInicio - Start date (YYYY-MM-DD).
   * @param {string} horaInicio - Start time (HH:MM).
   * @param {string} dataFim - End date (YYYY-MM-DD).
   * @param {string} horaFim - End time (HH:MM).
   * @returns {number} Duration in hours.
   */
  function calcularDiferencaHoras(dataInicio, horaInicio, dataFim, horaFim) {
      // If either start or end date/time is 'N/A', return 0 or handle as error
      if (dataInicio === 'N/A' || horaInicio === 'N/A' || dataFim === 'N/A' || horaFim === 'N/A') {
          return 0; // Or NaN, or throw an error, depending on desired behavior
      }
      const inicio = new Date(`${dataInicio}T${horaInicio}:00`);
      const fim = new Date(`${dataFim}T${horaFim}:00`);
      const diffMs = fim - inicio; // Difference in milliseconds
      return diffMs / (1000 * 60 * 60); // Convert to hours
  }

  /**
   * Toggles the visibility of the 'Relato do Problema' field based on the selected activity.
   */
  function toggleRelatoProblema() {
    const atividadeSelect = document.getElementById('atividadeInicio');
    const relatoProblemaField = document.getElementById('relatoProblemaField');
    const relatoProblemaTextarea = document.getElementById('relatoProblema');

    if (atividadeSelect.value.toUpperCase().includes('MANUTEN??O')) {
      relatoProblemaField.style.display = 'flex'; // Use flex to maintain field styling
      relatoProblemaTextarea.setAttribute('required', 'required'); // Make it required
    } else {
      relatoProblemaField.style.display = 'none';
      relatoProblemaTextarea.removeAttribute('required'); // Remove required attribute
      relatoProblemaTextarea.value = ''; // Clear content when hidden
    }
  }

  /**
   * Toggles the visibility of the non-conformity report textarea.
   * @param {HTMLInputElement} radioElement - The radio button that triggered the change.
   */
  function toggleNonConformityReport(radioElement) {
    const textareaId = radioElement.getAttribute('data-target-textarea');
    const reportTextarea = document.getElementById(textareaId);

    if (radioElement.value === 'N?O CONFORME' && radioElement.checked) {
        reportTextarea.classList.remove('hidden');
        reportTextarea.setAttribute('required', 'required');
    } else {
        reportTextarea.classList.add('hidden');
        reportTextarea.removeAttribute('required');
        reportTextarea.value = ''; // Clear content when hidden
    }
  }

  /**
   * Checks if an operator has already completed an activity with the same fleet on the same day.
   * If so, the checklist should not appear.
   * Toggles the visibility and required attributes of the safety checklist.
   */
  function toggleChecklistVisibility() {
    const cracha = document.getElementById('crachaInicio').value.trim();
    const frota = document.getElementById('frotaInicio').value.trim();
    const data = document.getElementById('dataInicial').value; //YYYY-MM-DD format

    const safetyChecklist = document.getElementById('safetyChecklist');
    const checklistRadioGroups = ['status_OleoMotor', 'status_OleoHidraulico', 'status_OleoTransmissao', 'status_Extintor', 'status_Pneus', 'status_ParteEletrica'];
    const checklistTextareas = safetyChecklist.querySelectorAll('textarea');

    // Determine if an activity for this operator, frota, and date already exists in completed activities
    const activityAlreadyDone = registrosAtividades.some(record => 
        record.crachaInicio === cracha && 
        record.frotaInicio === frota && 
        record.dataInicial === data &&
        record.dataInicial !== 'N/A' // Only consider 'real' starts
    );

    if (cracha && frota && data && activityAlreadyDone) {
        safetyChecklist.style.display = 'none';
        // Remove required from all radios and clear/hide all textareas
        checklistRadioGroups.forEach(groupName => {
            const radios = document.querySelectorAll(`input[name="${groupName}"]`);
            radios.forEach(radio => radio.removeAttribute('required'));
        });
        checklistTextareas.forEach(textarea => {
            textarea.removeAttribute('required');
            textarea.classList.add('hidden');
            textarea.value = '';
        });
    } else {
        // If not all fields are filled, or no previous activity found, show the checklist
        safetyChecklist.style.display = 'block';
        checklistRadioGroups.forEach(groupName => {
            const radiosOK = document.querySelector(`input[name="${groupName}"][value="OK"]`);
            if (radiosOK) {
                radiosOK.setAttribute('required', 'required');
                radiosOK.checked = true; // Default to OK
            }
            const radiosNonConforme = document.querySelector(`input[name="${groupName}"][value="N?O CONFORME"]`);
            if (radiosNonConforme) {
                radiosNonConforme.setAttribute('required', 'required');
            }
        });
        checklistTextareas.forEach(textarea => {
            textarea.classList.add('hidden');
            textarea.removeAttribute('required');
            textarea.value = '';
        });
    }
  }


  /**
   * Populates the "Disponibilidade" section with all registered fleets,
   * grouping them by model and indicating their current status (active or available).
   */
  function popularDisponibilidade() {
    const disponibilidadeContentDiv = document.getElementById('disponibilidadeContent');
    disponibilidadeContentDiv.innerHTML = ''; // Clear content, will add default message if no frotas

    const manutencaoListDiv = document.getElementById('frotasEmManutencaoList'); 
    const manutencaoItemsUl = document.getElementById('manutencaoItems');

    if (Object.keys(frotas).length === 0) {
        disponibilidadeContentDiv.innerHTML = '<p class="text-gray-600">N?O H? FROTAS CADASTRADAS.</p>';
        if (manutencaoListDiv) {
            manutencaoListDiv.style.display = 'none';
        }
        return;
    }

    // Group all frotas by model
    const frotasPorModelo = {};
    for (const frotaCode in frotas) {
        const frotaDetails = frotas[frotaCode];
        if (frotaDetails.modelo) {
            if (!frotasPorModelo[frotaDetails.modelo]) {
                frotasPorModelo[frotaDetails.modelo] = [];
            }
            frotasPorModelo[frotaDetails.modelo].push({ code: frotaCode, details: frotaDetails });
        }
    }

    if (Object.keys(frotasPorModelo).length === 0) {
        disponibilidadeContentDiv.innerHTML = '<p class="text-gray-600">NENHUMA FROTA COM MODELO V?LIDO CADASTRADO.</p>';
        if (manutencaoListDiv) {
            manutencaoListDiv.style.display = 'none';
        }
        return;
    }

    const frotasEmManutencao = []; // Array to store frotas in maintenance for the summary list
    // No need to clear disponibilidadeContentDiv again here, as it was done at the beginning

    for (const modelo in frotasPorModelo) {
        const modelBlock = document.createElement('div');
        modelBlock.className = 'mt-6 p-4 border rounded-lg bg-gray-100 shadow-sm'; 
        
        const modelTitle = document.createElement('h4');
        modelTitle.className = 'text-lg font-semibold mb-3 text-gray-800';
        modelTitle.textContent = `MODELO: ${modelo.toUpperCase()}`;
        modelBlock.appendChild(modelTitle);

        const table = document.createElement('table');
        table.className = 'min-w-full bg-white border-collapse border border-gray-200 rounded-lg availability-table'; 
        table.innerHTML = `
            <thead>
                <tr class="bg-gray-200 text-gray-700 uppercase text-xs leading-normal">
                    <th class="py-3 px-3 text-left border-r">FROTA</th>
                    <th class="py-3 px-3 text-left border-r">OPERADOR</th>
                    <th class="py-3 px-3 text-left border-r">SETOR</th>
                    <th class="py-3 px-3 text-left">ATIVIDADE</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        `;
        const tbody = table.querySelector('tbody');

        // Sort frotas within each model group by frotaCode for consistent display
        frotasPorModelo[modelo].sort((a, b) => a.code.localeCompare(b.code)).forEach(frotaEntry => {
            const frotaCode = frotaEntry.code;
            const currentActivity = frotasAtivas[frotaCode]; // Check the active frotas map
            
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-200 last:border-b-0';

            let rowClass = '';
            let operadorText = 'DISPON?VEL';
            let setorText = 'DISPON?VEL';
            let atividadeText = 'DISPON?VEL';
            let frotaDisplay = frotaCode; // Default frota display
            let relatoManutencao = '';

            if (currentActivity) {
                const implementoDetail = implementos[currentActivity.implemento];
                const implementoSigla = implementoDetail ? implementoDetail.sigla : ''; // Get sigla, can be empty
                
                // Format frota display with implement sigla if available, similar to image (e.g., "90.420-H60 G")
                frotaDisplay = `${frotaCode}${implementoSigla ? ' ' + implementoSigla : ''}`;

                operadorText = currentActivity.nomeOperadorDisplay || 'N/A';
                setorText = currentActivity.setor || 'N/A';
                atividadeText = currentActivity.atividade || 'N/A';
                relatoManutencao = currentActivity.relatoProblema || '';
                
                if (atividadeText.toUpperCase().includes('MANUTEN??O')) {
                    rowClass = 'status-maintenance-strong';
                    frotasEmManutencao.push({ frota: frotaCode, relato: relatoManutencao });
                } else if (atividadeText.toUpperCase().includes('REVIS?O')) {
                    rowClass = 'status-revision-strong';
                } else {
                    rowClass = 'status-active';
                }
            }
            // Removed: else { rowClass = 'status-available'; } to remove green color for AVAILABLE frotas.
            
            // Apply row class
            if (rowClass) {
                row.classList.add(rowClass);
            }

            // Set cell text color based on rowClass.
            if (rowClass === 'status-maintenance-strong' || rowClass === 'status-revision-strong' /* Removed || rowClass === 'status-available' */) {
                row.classList.add('text-white');
            } else {
                row.classList.add('text-gray-800'); // Default text color for .status-active and AVAILABLE (no rowClass applied)
            }

            // Create and append cells
            const frotaCell = document.createElement('td');
            frotaCell.className = 'py-2 px-3 text-sm font-bold';
            frotaCell.setAttribute('data-label', 'Frota');
            frotaCell.textContent = frotaDisplay;
            row.appendChild(frotaCell);

            const operadorCell = document.createElement('td');
            operadorCell.className = 'py-2 px-3 text-sm';
            operadorCell.setAttribute('data-label', 'Operador');
            operadorCell.textContent = operadorText;
            row.appendChild(operadorCell);

            const setorCell = document.createElement('td');
            setorCell.className = 'py-2 px-3 text-sm';
            setorCell.setAttribute('data-label', 'Setor');
            setorCell.textContent = setorText;
            row.appendChild(setorCell);

            const atividadeCell = document.createElement('td');
            atividadeCell.className = 'py-2 px-3 text-sm';
            atividadeCell.setAttribute('data-label', 'Atividade');
            atividadeCell.textContent = atividadeText;
            row.appendChild(atividadeCell);

            tbody.appendChild(row);
        });
        modelBlock.appendChild(table);
        disponibilidadeContentDiv.appendChild(modelBlock); 
    }

    // Populate the "Frotas em Manuten??o" list at the end
    if (manutencaoListDiv && manutencaoItemsUl) { 
        manutencaoItemsUl.innerHTML = ''; 

        if (frotasEmManutencao.length > 0) {
            manutencaoListDiv.style.display = 'block';
            frotasEmManutencao.forEach(item => {
                const listItem = document.createElement('li');
                listItem.textContent = `FROTA: ${item.frota} - RELATO: ${item.relato || 'N/A'}`;
                manutencaoItemsUl.appendChild(listItem);
            });
        } else {
            manutencaoListDiv.style.display = 'none'; 
        }
    }
  }


  // --- Form Submission Functions ---

  /**
   * Handles the submission of the "Start Activity" form.
   * @param {Event} e - The form submission event.
   */
  async function enviarInicio(e) {
    e.preventDefault(); 

    const form = document.getElementById('formInicio');
    if (!form.checkValidity()) {
        // Form's default validation will show messages for empty required fields.
        showAlert('POR FAVOR, PREENCHA TODOS OS CAMPOS OBRIGAT?RIOS.');
        form.reportValidity(); 
        return;
    }

    const data = new FormData(form);
    const formDataObject = Object.fromEntries(data.entries());

    // Validation: Check if Crach? and Frota exist in registered data
    if (!operadores[formDataObject.crachaInicio]) {
        showAlert(`ERRO: CRACH? ${formDataObject.crachaInicio} N?O CADASTRADO. POR FAVOR, CADASTRE O OPERADOR OU VERIFIQUE O CRACH?.`, true);
        return;
    }
    if (!frotas[formDataObject.frotaInicio]) {
        showAlert(`ERRO: FROTA ${formDataObject.frotaInicio} N?O CADASTRADA. POR FAVOR, CADASTRE A FROTA OU VERIFIQUE O C?DIGO.`, true);
        return;
    }

    // Add selected dropdown values
    formDataObject.setor = document.getElementById('setorInicio').value;
    formDataObject.atividade = document.getElementById('atividadeInicio').value;
    formDataObject.implemento = document.getElementById('implementoInicio').value;
    // Capture relatoProblema if it exists and is visible
    if (document.getElementById('relatoProblemaField').style.display === 'flex') {
        formDataObject.relatoProblema = document.getElementById('relatoProblema').value.trim();
    } else {
        formDataObject.relatoProblema = ''; 
    }

    // Process checklist data
    const checklistItems = [
        { name: '?leo do Motor', statusName: 'status_OleoMotor', relatoName: 'relato_OleoMotor' },
        { name: '?leo Hidr?ulico', statusName: 'status_OleoHidraulico', relatoName: 'relato_OleoHidraulico' },
        { name: '?leo da Transmiss?o', statusName: 'status_OleoTransmissao', relatoName: 'relato_OleoTransmissao' },
        { name: 'Extintor', statusName: 'status_Extintor', relatoName: 'relato_Extintor' },
        { name: 'Pneus', statusName: 'status_Pneus', relatoName: 'relato_Pneus' },
        { name: 'Parte El?trica', statusName: 'status_ParteEletrica', relatoName: 'relato_ParteEletrica' }
    ];
    formDataObject.checklist = [];

    // Only validate checklist if it's visible
    if (document.getElementById('safetyChecklist').style.display !== 'none') {
        for (const item of checklistItems) {
            const status = formDataObject[item.statusName];
            let relato = '';
            if (status === 'N?O CONFORME') {
                relato = formDataObject[item.relatoName].trim();
                if (!relato) {
                    showAlert(`POR FAVOR, RELATE A N?O CONFORMIDADE PARA "${item.name}".`, true);
                    return; // Stop submission
                }
            }
            formDataObject.checklist.push({
                item: item.name,
                status: status,
                relato: relato
            });
        }
    } else {
        // If checklist is hidden, just record a default/skipped status
        for (const item of checklistItems) {
            formDataObject.checklist.push({
                item: item.name,
                status: 'N/A - Checklist Omitido',
                relato: ''
            });
        }
    }


    // Check if frota is available
    const frotaCode = formDataObject.frotaInicio;
    if (frotasAtivas[frotaCode]) {
        showAlert(`A FROTA ${frotaCode} J? EST? EM ATIVIDADE E N?O EST? DISPON?VEL PARA UM NOVO IN?CIO.`, true);
        return;
    }

    // Horimeter validation for start activity
    const horimetroInicial = parseFloat(formDataObject.horimetroInicial);
    
    let horimetroInconsistente = false;
    let correcaoConfirmada = false;

    if (lastKnownHorimeters[frotaCode] !== undefined && horimetroInicial < lastKnownHorimeters[frotaCode]) {
        horimetroInconsistente = true;
        const confirmed = await showConfirm(
            `O HOR?METRO INICIAL (${horimetroInicial}) ? MENOR QUE O ?LTIMO HOR?METRO REGISTRADO (${lastKnownHorimeters[frotaCode]}) PARA A FROTA ${frotaCode}. TEM CERTEZA QUE ESTE HOR?METRO EST? CORRETO?`,
            true // isWarning
        );
        if (!confirmed) {
            showAlert('LAN?AMENTO CANCELADO. POR FAVOR, VERIFIQUE O HOR?METRO INICIAL.', true);
            return; // Stop submission
        }
        correcaoConfirmada = true;
    }


    // Capture the displayed name and equipment, and also the photo URLs for displaying later
    formDataObject.nomeOperadorDisplay = document.getElementById('nomeInicio').value;
    formDataObject.fotoOperadorDisplay = document.getElementById('fotoInicio').src;
    formDataObject.equipamentoDisplay = document.getElementById('equipamentoInicio').value;
    formDataObject.fotoEquipamentoDisplay = document.getElementById('fotoEquipInicio').src;

    // Store the activity data in the global map for active frotas
    // Add flags for horimeter inconsistency and confirmation
    frotasAtivas[formDataObject.frotaInicio] = {
        ...formDataObject,
        id: generateUniqueId(), // Assign unique ID for this activity cycle
        horimetroInconsistente: horimetroInconsistente,
        correcaoConfirmada: correcaoConfirmada
    };

    console.log('Dados de In?cio de Atividade:', frotasAtivas[formDataObject.frotaInicio]);
    showAlert('IN?CIO DE ATIVIDADE REGISTRADO COM SUCESSO!');
    limparFormulario('formInicio'); // Use the new clear form function
    popularDisponibilidade(); 
  }

  /**
   * Handles the submission of the "End Activity" form.
   * @param {Event} e - The form submission event.
   */
  async function enviarFim(e) {
    e.preventDefault(); 

    const form = document.getElementById('formFim');
    if (!form.checkValidity()) {
        showAlert('POR FAVOR, PREENCHA TODOS OS CAMPOS OBRIGAT?RIOS.');
        form.reportValidity(); 
        return;
    }

    const data = new FormData(form);
    const formDataObject = Object.fromEntries(data.entries());
    
    const frotaFimCode = document.getElementById('frotaFim').value; 
    const crachaFim = formDataObject.crachaFim;

    // Validation: Check if Crach? and Frota exist in registered data
    if (!operadores[crachaFim]) {
        showAlert(`ERRO: CRACH? ${crachaFim} N?O CADASTRADO. POR FAVOR, CADASTRE O OPERADOR OU VERIFIQUE O CRACH?.`, true);
        return;
    }
    if (!frotas[frotaFimCode]) {
        showAlert(`ERRO: FROTA ${frotaFimCode} N?O CADASTRADA. POR FAVOR, CADASTRE A FROTA OU VERIFIQUE O C?DIGO.`, true);
        return;
    }

    let currentActivity = frotasAtivas[frotaFimCode]; // Retrieve the in-progress activity
    let horimetroInconsistente = false; // Initialize for final record
    let correcaoConfirmada = false; // Initialize for final record

    if (!currentActivity) {
        // New logic: Ask to proceed if no start activity
        const confirmedProceed = await showConfirm(
            `N?O H? ATIVIDADE DE IN?CIO REGISTRADA PARA A FROTA ${frotaFimCode}. DESEJA ENCERRAR MESMO ASSIM?`,
            true // isWarning
        );
        if (!confirmedProceed) {
            showAlert('LAN?AMENTO CANCELADO.');
            return; // Stop submission
        }
        // If confirmed to proceed without a start activity, create a dummy activity
        currentActivity = {
            id: generateUniqueId(),
            crachaInicio: crachaFim, 
            nomeOperadorDisplay: document.getElementById('nomeFim').value, 
            fotoOperadorDisplay: document.getElementById('fotoFim').src, 
            dataInicial: 'N/A', 
            horaInicial: 'N/A', 
            frotaInicio: frotaFimCode,
            equipamentoDisplay: document.getElementById('equipamentoFim').value,
            fotoEquipamentoDisplay: document.getElementById('fotoEquipFim').src,
            horimetroInicial: 0, 
            setor: 'N/A', 
            atividade: 'ENCERRAMENTO SEM IN?CIO', 
            implemento: 'N/A', 
            relatoProblema: 'Atividade encerrada sem registro de in?cio pr?vio.',
            checklist: [{ item: 'N/A - Sem Checklist', status: 'N/A', relato: '' }] 
        };
        horimetroInconsistente = true; // Mark as inconsistent if no start record
    } else {
        // Existing logic: Validate if the current operator matches the one who started the activity
        if (currentActivity.crachaInicio !== crachaFim) {
            showAlert(`ERRO: A FROTA ${frotaFimCode} EST? ATUALMENTE EM ATIVIDADE COM O OPERADOR ${currentActivity.crachaInicio}. VOC? N?O PODE ENCERRAR ESTA ATIVIDADE.`, true);
            return;
        }
        // Inherit consistency flags from start record if it exists
        horimetroInconsistente = currentActivity.horimetroInconsistente || false;
        correcaoConfirmada = currentActivity.correcaoConfirmada || false;
    }

    // Date/Time validation for dataFinal vs dataInicial for actual started activities
    if (currentActivity.dataInicial !== 'N/A') { 
        const startDateTime = new Date(`${currentActivity.dataInicial}T${currentActivity.horaInicial}:00`);
        const endDateTime = new Date(`${formDataObject.dataFinal}T${formDataObject.horaFinal}:00`);

        if (endDateTime < startDateTime) {
            const confirmedDateTimeCorrection = await showConfirm(
                `A DATA E HORA FINAL (${formDataObject.dataFinal} ${formDataObject.horaFinal}) ? ANTERIOR ? DATA E HORA INICIAL (${currentActivity.dataInicial} ${currentActivity.horaInicial}). DESEJA CONTINUAR COM ESTA INFORMA??O E MARCAR COMO INCONSISTENTE?`,
                true 
            );
            if (!confirmedDateTimeCorrection) {
                showAlert('LAN?AMENTO CANCELADO. POR FAVOR, CORRIJA A DATA E HORA FINAL.', true);
                document.getElementById('dataFinal').value = ''; 
                document.getElementById('horaFinal').value = ''; 
                return; 
            }
            horimetroInconsistente = true; // Mark as inconsistent due to date/time
        }
    }

    // Horimeter validation for end activity
    const horimetroFinal = parseFloat(formDataObject.horimetroFim);
    const horimetroInicialAtividade = parseFloat(currentActivity.horimetroInicial);
    
    if (horimetroFinal < horimetroInicialAtividade && currentActivity.dataInicial !== 'N/A') { 
        const confirmedHorimeterCorrection = await showConfirm(
            `O HOR?METRO FINAL (${horimetroFinal}) ? MENOR QUE O HOR?METRO INICIAL (${horimetroInicialAtividade}) DESTA ATIVIDADE PARA A FROTA ${frotaFimCode}. TEM CERTEZA QUE ESTE HOR?METRO EST? CORRETO?`,
            true 
        );
        if (!confirmedHorimeterCorrection) {
            showAlert('LAN?AMENTO CANCELADO. POR FAVOR, VERIFIQUE O HOR?METRO FINAL.', true);
            return; 
        }
        horimetroInconsistente = true; // Mark as inconsistent due to horimeter
    }


    // Complete the activity record
    const completedRecord = {
        ...currentActivity, 
        dataFinal: formDataObject.dataFinal,
        horaFinal: formDataObject.horaFinal,
        horimetroFinal: formDataObject.horimetroFim,
        observacoesFim: formDataObject.observacoesFim,
        horimetroInconsistente: horimetroInconsistente, 
        correcaoConfirmada: correcaoConfirmada 
    };

    // Calculate duration and total horimeter (only if it was a real activity start)
    if (completedRecord.dataInicial !== 'N/A') {
        completedRecord.duracaoHoras = calcularDiferencaHoras(
            completedRecord.dataInicial, completedRecord.horaInicial,
            completedRecord.dataFinal, completedRecord.horaFinal
        );
        completedRecord.horimetroTotalCalculado = parseFloat(completedRecord.horimetroFinal) - parseFloat(completedRecord.horimetroInicial);
    } else {
        completedRecord.duracaoHoras = 0; 
        completedRecord.horimetroTotalCalculado = 0; 
    }

    // Store the completed activity record
    registrosAtividades.push(completedRecord);

    // Update the last known horimeter for this frota (even if it was a "no start" end)
    lastKnownHorimeters[frotaFimCode] = horimetroFinal;

    // Mark this activity as completed for the checklist logic
    if (completedRecord.dataInicial !== 'N/A' && completedRecord.crachaInicio !== 'N/A' && completedRecord.dataFinal !== 'N/A') { 
        const key = `${completedRecord.crachaInicio}_${completedRecord.frotaInicio}_${completedRecord.dataFinal}`;
        completedActivitiesSummary[key] = true;
    }
    
    // Remove the activity from the active frotas map ONLY if it was a real started activity
    if (frotasAtivas[frotaFimCode]) {
        delete frotasAtivas[frotaFimCode];
    }

    console.log('Dados de Fim de Atividade:', completedRecord);
    showAlert('FIM DE ATIVIDADE REGISTRADO COM SUCESSO!');
    limparFormulario('formFim'); 
    popularDisponibilidade(); 
    popularTabelaRegistros(); 
  }

  /**
   * New function: Clears the specified form and its associated display fields.
   * @param {string} formId - The ID of the form to clear ('formInicio' or 'formFim').
   */
  function limparFormulario(formId) {
      const form = document.getElementById(formId);
      form.reset();
      if (formId === 'formInicio') {
          document.getElementById('nomeInicio').value = '';
          document.getElementById('fotoInicio').src = 'https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR';
          document.getElementById('equipamentoInicio').value = '';
          document.getElementById('fotoEquipInicio').src = 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
          populateDropdown('setor', 'inicio'); // Repopulate dropdowns to reset to default 'Selecione'
          populateDropdown('atividade', 'inicio');
          populateDropdown('implemento', 'inicio');
          toggleRelatoProblema(); // Hide the problem field if it was visible
          
          // Reset checklist to default (OK, no reports visible)
          const safetyChecklist = document.getElementById('safetyChecklist');
          const checklistRadioGroups = ['status_OleoMotor', 'status_OleoHidraulico', 'status_OleoTransmissao', 'status_Extintor', 'status_Pneus', 'status_ParteEletrica'];
          const checklistTextareas = safetyChecklist.querySelectorAll('textarea');

          checklistRadioGroups.forEach(groupName => {
              const radiosOK = document.querySelector(`input[name="${groupName}"][value="OK"]`);
              if (radiosOK) {
                  radiosOK.checked = true; // Set all OK radios to checked
              }
          });
          checklistTextareas.forEach(textarea => {
              textarea.classList.add('hidden'); // Hide all textareas
              textarea.removeAttribute('required'); // Remove required
              textarea.value = ''; // Clear value
          });
          toggleChecklistVisibility(); // Ensure correct visibility based on empty fields
      } else if (formId === 'formFim') {
          document.getElementById('nomeFim').value = '';
          document.getElementById('fotoFim').src = 'https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR';
          document.getElementById('equipamentoFim').value = '';
          document.getElementById('fotoEquipFim').src = 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
          // Also clear and hide the frota selection container for the end activity form
          document.getElementById('frotaSelectionContainer').style.display = 'none';
          document.getElementById('selectFrotaAtiva').innerHTML = '';
          document.getElementById('multipleFrotaWarning').style.display = 'none'; // Also hide warning
          document.getElementById('multipleFrotaWarning').textContent = ''; // Clear warning text
          document.getElementById('frotaFim').removeAttribute('readonly'); // Make frotaFim editable again
      }
      showAlert('FORMUL?RIO LIMPO.');
  }


  // New functions for User Management
  /**
   * Saves a new user or updates an existing one in the appUsers object.
   * This data is in-memory and will be lost on page refresh.
   */
  function salvarUsuario() {
    const newUsername = document.getElementById('newUsername').value.trim();
    const newPassword = document.getElementById('newPassword').value.trim();
    const newUserLevel = document.getElementById('newUserLevel').value;

    if (!newUsername || !newPassword || !newUserLevel) {
      showAlert('TODOS OS CAMPOS PARA O NOVO USU?RIO S?O OBRIGAT?RIOS.');
      return;
    }

    if (appUsers[newUsername]) {
      showAlert('USU?RIO J? EXISTE. ESCOLHA OUTRO NOME DE USU?RIO OU REMOVA O EXISTENTE.');
      return;
    }

    appUsers[newUsername] = { password: newPassword, role: newUserLevel };
    showAlert('USU?RIO SALVO COM SUCESSO!');
    document.getElementById('newUsername').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('newUserLevel').value = ''; // Reset dropdown
    popularListaUsuarios(); // Refresh the displayed list of users
  }

  /**
   * Populates the table with the list of registered users.
   */
  function popularListaUsuarios() {
    const userListBody = document.getElementById('userList');
    userListBody.innerHTML = ''; // Clear existing list

    for (const username in appUsers) {
      const user = appUsers[username];
      const row = document.createElement('tr');
      row.className = 'hover:bg-gray-100';
      
      let actionButton = `<button class="btn red text-white px-3 py-1 rounded-md" onclick="removerUsuario('${username}')">REMOVER</button>`;
      // Prevent removing the main 'admin' user
      if (username === 'admin') {
        actionButton = '<span class="text-gray-400">N?O REMOV?VEL</span>';
      }

      row.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${username.toUpperCase()}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.role === 'administrador' ? 'ADMINISTRADOR' : user.role.toUpperCase()}</td>
        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
          ${actionButton}
        </td>
      `;
      userListBody.appendChild(row);
    }
  }

  /**
   * Removes a user from the appUsers object after confirmation.
   * @param {string} usernameToRemove - The username of the user to be removed.
   */
  function removerUsuario(usernameToRemove) {
    showConfirm(`TEM CERTEZA QUE DESEJA REMOVER O USU?RIO ${usernameToRemove.toUpperCase()}?`).then(confirmed => {
      if (confirmed) {
        if (usernameToRemove === 'admin') {
          showAlert('N?O ? POSS?VEL REMOVER O USU?RIO "ADMIN" PRINCIPAL.');
          return;
        }
        if (appUsers[usernameToRemove]) {
          delete appUsers[usernameToRemove];
          showAlert(`USU?RIO ${usernameToRemove.toUpperCase()} REMOVIDO COM SUCESSO.`);
          popularListaUsuarios(); // Refresh list after removal
        } else {
          showAlert('USU?RIO N?O ENCONTRADO.');
        }
      }
    });
  }

  /**
   * Populates the checklist report table with filtered data.
   */
  function popularTabelaChecklist() {
    const tableBody = document.getElementById('checklistTableBody');
    tableBody.innerHTML = '';
    const filterFrota = document.getElementById('filterFrotaChecklist').value.toLowerCase();
    const filterOperador = document.getElementById('filterOperadorChecklist').value.toLowerCase();
    const filterData = document.getElementById('filterDataChecklist').value; //YYYY-MM-DD

    let foundCount = 0;
    registrosAtividades.forEach(record => {
      // Filter by frota, operator, and date
      const matchFrota = record.frotaInicio.toLowerCase().includes(filterFrota);
      const matchOperador = record.nomeOperadorDisplay.toLowerCase().includes(filterOperador);
      const matchData = !filterData || record.dataInicial === filterData;

      if (matchFrota && matchOperador && matchData && record.checklist && record.checklist.length > 0) {
        record.checklist.forEach(item => {
          const row = tableBody.insertRow();
          row.className = 'hover:bg-gray-50';
          row.innerHTML = `
            <td class="px-2 py-2 whitespace-nowrap text-sm font-medium text-gray-900" data-label="ID Atividade">${record.id.substring(0, 8)}...</td>
            <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="Frota">${record.frotaInicio}</td>
            <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="Operador">${record.nomeOperadorDisplay}</td>
            <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="Data In?cio">${record.dataInicial}</td>
            <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="Item Checklist">${item.item}</td>
            <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="Status">${item.status}</td>
            <td class="px-2 py-2 whitespace-normal text-sm text-gray-500 max-w-xs" data-label="Relato">${item.relato || 'N/A'}</td>
          `;
          foundCount++;
        });
      }
    });

    if (foundCount === 0) {
      tableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">NENHUM REGISTRO DE CHECKLIST ENCONTRADO COM OS FILTROS APLICADOS.</td></tr>`;
    }
  }

  /**
   * Clears all filters in the "Relat?rio de Checklist de Seguran?a" section and repopulates the table.
   */
  function limparFiltrosChecklist() {
      document.getElementById('filterFrotaChecklist').value = '';
      document.getElementById('filterOperadorChecklist').value = '';
      document.getElementById('filterDataChecklist').value = '';
      popularTabelaChecklist();
  }

  /**
   * Handles the change event for the Crach? input in the "Fim de Atividade" form.
   * This function populates the Operator details and then checks for active frotas.
   */
  function handleCrachaFimChange() {
    const crachaFim = document.getElementById('crachaFim').value.trim();
    buscarOperador(crachaFim, 'nomeFim', 'fotoFim'); // Populate operator details

    const frotaFimInput = document.getElementById('frotaFim');
    const equipamentoFimInput = document.getElementById('equipamentoFim');
    const fotoEquipFimImg = document.getElementById('fotoEquipFim');
    const frotaSelectionContainer = document.getElementById('frotaSelectionContainer');
    const selectFrotaAtiva = document.getElementById('selectFrotaAtiva');
    const multipleFrotaWarning = document.getElementById('multipleFrotaWarning'); // New element

    // Reset frota fields and selection container
    frotaFimInput.value = '';
    equipamentoFimInput.value = '';
    fotoEquipFimImg.src = 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
    frotaSelectionContainer.style.display = 'none';
    selectFrotaAtiva.innerHTML = ''; // Clear previous options
    multipleFrotaWarning.style.display = 'none'; // Hide warning
    multipleFrotaWarning.textContent = ''; // Clear warning text
    frotaFimInput.removeAttribute('readonly'); // Make frota input editable by default

    if (crachaFim) {
        const activeFrotasForOperator = [];
        for (const frotaCode in frotasAtivas) {
            const activity = frotasAtivas[frotaCode];
            if (activity.crachaInicio === crachaFim) {
                activeFrotasForOperator.push(activity);
            }
        }

        if (activeFrotasForOperator.length === 0) {
            // Do not show alert here, let enviarFim handle it
        } else if (activeFrotasForOperator.length === 1) {
            // One active frota, pre-fill
            const singleActiveFrota = activeFrotasForOperator[0];
            frotaFimInput.value = singleActiveFrota.frotaInicio;
            mostrarModeloFrota(singleActiveFrota.frotaInicio, 'equipamentoFim', 'fotoEquipFim');
            frotaFimInput.setAttribute('readonly', 'readonly'); // Make it read-only
        } else {
            // Multiple active frotas, show dropdown and warning
            frotaSelectionContainer.style.display = 'flex'; // Use flex to maintain styling
            multipleFrotaWarning.style.display = 'block'; // Show warning
            multipleFrotaWarning.textContent = 'M?LTIPLAS FROTAS EM ATIVIDADE ENCONTRADAS PARA ESTE OPERADOR. SELECIONE A FROTA PARA ENCERRAR A ATIVIDADE:';
            frotaFimInput.setAttribute('readonly', 'readonly'); // Make frotaFim read-only if selection is via dropdown

            // Add a default "Selecione" option
            const defaultOpt = document.createElement('option');
            defaultOpt.value = '';
            defaultOpt.textContent = 'SELECIONE A FROTA';
            defaultOpt.disabled = true;
            defaultOpt.selected = true;
            selectFrotaAtiva.appendChild(defaultOpt);

            activeFrotasForOperator.forEach(activity => {
                const option = document.createElement('option');
                option.value = activity.frotaInicio;
                option.textContent = `${activity.frotaInicio} (${activity.atividade} - In?cio: ${activity.dataInicial} ${activity.horaInicial})`;
                selectFrotaAtiva.appendChild(option);
            });
        }
    }
  }

  /**
   * Handles the selection of an active frota from the dropdown in the "Fim de Atividade" form.
   * @param {string} selectedFrotaCode - The code of the selected frota.
   */
  function selecionarFrotaAtiva(selectedFrotaCode) {
      const frotaFimInput = document.getElementById('frotaFim');
      if (selectedFrotaCode) {
          frotaFimInput.value = selectedFrotaCode;
          mostrarModeloFrota(selectedFrotaCode, 'equipamentoFim', 'fotoEquipFim');
      } else {
          frotaFimInput.value = '';
          document.getElementById('equipamentoFim').value = '';
          document.getElementById('fotoEquipFim').src = 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
      }
  }

  /**
   * Populates the "Relat?rio por Setor" table.
   */
  function popularTabelaRelatorioSetor() {
    const tableBody = document.getElementById('relatorioSetorTableBody');
    tableBody.innerHTML = '';
    const filterSetor = document.getElementById('filterSetorRelatorioSetor').value.toLowerCase();
    const filterDataInicio = document.getElementById('filterDataInicioRelatorioSetor').value;
    const filterDataFim = document.getElementById('filterDataFimRelatorioSetor').value;

    const setorSummary = new Map(); // Key: setor, Value: { totalFleets: Set, totalTime: number, totalHorimeter: number }

    registrosAtividades.forEach(record => {
      if (record.setor && record.dataFinal !== 'N/A' && record.duracaoHoras !== undefined && record.horimetroTotalCalculado !== undefined) {
        const recordDate = new Date(record.dataInicial);
        const startDate = filterDataInicio ? new Date(filterDataInicio) : null;
        const endDate = filterDataFim ? new Date(filterDataFim) : null;

        const matchSetor = !filterSetor || record.setor.toLowerCase().includes(filterSetor);
        const matchDate = (!startDate || recordDate >= startDate) && (!endDate || recordDate <= endDate);

        if (matchSetor && matchDate) {
          if (!setorSummary.has(record.setor)) {
            setorSummary.set(record.setor, {
              totalFleets: new Set(),
              totalTime: 0,
              totalHorimeter: 0
            });
          }
          const summary = setorSummary.get(record.setor);
          summary.totalFleets.add(record.frotaInicio); // Add unique frota
          summary.totalTime += record.duracaoHoras;
          summary.totalHorimeter += record.horimetroTotalCalculado;
        }
      }
    });

    if (setorSummary.size === 0) {
      tableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">NENHUM DADO ENCONTRADO PARA ESTES FILTROS.</td></tr>`;
      return;
    }

    // Sort by sector name for consistent display
    const sortedSetores = Array.from(setorSummary.keys()).sort();

    sortedSetores.forEach(setorName => {
      const summary = setorSummary.get(setorName);
      const row = tableBody.insertRow();
      row.className = 'hover:bg-gray-50';
      row.innerHTML = `
        <td class="px-2 py-2 whitespace-nowrap text-sm font-medium text-gray-900" data-label="Setor">${setorName}</td>
        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="Total de Frotas">${summary.totalFleets.size}</td>
        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="Tempo Total (h)">${summary.totalTime.toFixed(2)}</td>
        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="Hor?metro Total">${summary.totalHorimeter.toFixed(2)}</td>
      `;
    });
  }

  /** Clears filters for "Relat?rio por Setor" and repopulates the table. */
  function limparFiltrosRelatorioSetor() {
    document.getElementById('filterSetorRelatorioSetor').value = '';
    document.getElementById('filterDataInicioRelatorioSetor').value = '';
    document.getElementById('filterDataFimRelatorioSetor').value = '';
    popularTabelaRelatorioSetor();
  }


  /**
   * Populates the "Relat?rio por Atividade" table.
   */
  function popularTabelaRelatorioAtividade() {
    const tableBody = document.getElementById('relatorioAtividadeTableBody');
    tableBody.innerHTML = '';
    const filterAtividade = document.getElementById('filterAtividadeRelatorioAtividade').value.toLowerCase();
    const filterDataInicio = document.getElementById('filterDataInicioRelatorioAtividade').value;
    const filterDataFim = document.getElementById('filterDataFimRelatorioAtividade').value;

    const atividadeSummary = new Map(); // Key: atividade, Value: { totalFleets: Set, totalTime: number, totalHorimeter: number }

    registrosAtividades.forEach(record => {
      if (record.atividade && record.dataFinal !== 'N/A' && record.duracaoHoras !== undefined && record.horimetroTotalCalculado !== undefined) {
        const recordDate = new Date(record.dataInicial);
        const startDate = filterDataInicio ? new Date(filterDataInicio) : null;
        const endDate = filterDataFim ? new Date(filterDataFim) : null;

        const matchAtividade = !filterAtividade || record.atividade.toLowerCase().includes(filterAtividade);
        const matchDate = (!startDate || recordDate >= startDate) && (!endDate || recordDate <= endDate);

        if (matchAtividade && matchDate) {
          if (!atividadeSummary.has(record.atividade)) {
            atividadeSummary.set(record.atividade, {
              totalFleets: new Set(),
              totalTime: 0,
              totalHorimeter: 0
            });
          }
          const summary = atividadeSummary.get(record.atividade);
          summary.totalFleets.add(record.frotaInicio); // Add unique frota
          summary.totalTime += record.duracaoHoras;
          summary.totalHorimeter += record.horimetroTotalCalculado;
        }
      }
    });

    if (atividadeSummary.size === 0) {
      tableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">NENHUM DADO ENCONTRADO PARA ESTES FILTROS.</td></tr>`;
      return;
    }

    // Sort by activity name for consistent display
    const sortedAtividades = Array.from(atividadeSummary.keys()).sort();

    sortedAtividades.forEach(atividadeName => {
      const summary = atividadeSummary.get(atividadeName);
      const row = tableBody.insertRow();
      row.className = 'hover:bg-gray-50';
      row.innerHTML = `
        <td class="px-2 py-2 whitespace-nowrap text-sm font-medium text-gray-900" data-label="Atividade">${atividadeName}</td>
        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="Total de Frotas">${summary.totalFleets.size}</td>
        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="Tempo Total (h)">${summary.totalTime.toFixed(2)}</td>
        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="Hor?metro Total">${summary.totalHorimeter.toFixed(2)}</td>
      `;
    });
  }

  /** Clears filters for "Relat?rio por Atividade" and repopulates the table. */
  function limparFiltrosRelatorioAtividade() {
    document.getElementById('filterAtividadeRelatorioAtividade').value = '';
    document.getElementById('filterDataInicioRelatorioAtividade').value = '';
    document.getElementById('filterDataFimRelatorioAtividade').value = '';
    popularTabelaRelatorioAtividade();
  }

  /**
   * Opens the edit modal and populates it with the selected record's data.
   * @param {string} recordId - The ID of the record to edit.
   */
  function editarRegistro(recordId) {
    currentEditingRecord = registrosAtividades.find(record => record.id === recordId);
    if (!currentEditingRecord) {
      showAlert('REGISTRO N?O ENCONTRADO PARA EDI??O.');
      return;
    }

    // Populate all fields initially
    document.getElementById('editRecordId').value = currentEditingRecord.id;
    
    // Populate End Fields
    document.getElementById('editDataFinal').value = currentEditingRecord.dataFinal || '';
    document.getElementById('editHoraFinal').value = currentEditingRecord.horaFinal || '';
    document.getElementById('editHorimetroFinal').value = currentEditingRecord.horimetroFinal || '';
    document.getElementById('editObservacoesFim').value = currentEditingRecord.observacoesFim || '';

    // Populate Start Fields (initially read-only or editable based on record type)
    document.getElementById('editCrachaInicio').value = currentEditingRecord.crachaInicio || 'N/A';
    document.getElementById('editNomeOperador').value = currentEditingRecord.nomeOperadorDisplay || 'N/A';
    document.getElementById('editFotoOperador').src = currentEditingRecord.fotoOperadorDisplay || 'https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR';
    document.getElementById('editFrotaInicio').value = currentEditingRecord.frotaInicio || 'N/A';
    document.getElementById('editEquipamentoInicio').value = currentEditingRecord.equipamentoDisplay || 'N/A';
    document.getElementById('editFotoEquipamento').src = currentEditingRecord.fotoEquipamentoDisplay || 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
    document.getElementById('editDataInicial').value = currentEditingRecord.dataInicial || 'N/A';
    document.getElementById('editHoraInicial').value = currentEditingRecord.horaInicial || 'N/A';
    document.getElementById('editHorimetroInicial').value = currentEditingRecord.horimetroInicial || 'N/A';
    
    // Populate dropdowns for edit modal (initial values)
    populateDropdown('setor', 'edit', 'editSetorInicio');
    document.getElementById('editSetorInicio').value = currentEditingRecord.setor || '';
    populateDropdown('atividade', 'edit', 'editAtividadeInicio');
    document.getElementById('editAtividadeInicio').value = currentEditingRecord.atividade || '';
    populateDropdown('implemento', 'edit', 'editImplementoInicio');
    document.getElementById('editImplementoInicio').value = currentEditingRecord.implemento || '';

    // Handle relatoProblema visibility for edit modal
    const editRelatoProblemaField = document.getElementById('editRelatoProblemaField');
    const editRelatoProblemaTextarea = document.getElementById('editRelatoProblema');
    if (currentEditingRecord.atividade && currentEditingRecord.atividade.toUpperCase().includes('MANUTEN??O')) {
        editRelatoProblemaField.style.display = 'flex';
        editRelatoProblemaTextarea.value = currentEditingRecord.relatoProblema || '';
    } else {
        editRelatoProblemaField.style.display = 'none';
        editRelatoProblemaTextarea.value = '';
    }


    // Reset edit mode to 'fim' and set initial states
    document.querySelector('input[name="editType"][value="fim"]').checked = true;
    isInitialEditUnlocked = false; // Reset unlock status
    toggleEditMode('fim'); // Ensure correct initial field enable/disable

    editRecordModal.style.display = 'flex'; // Show the modal
  }

  /**
   * Toggles which fields are editable in the record edit modal based on the selected type
   * and whether it's an "ENCERRAMENTO SEM IN?CIO" record or if admin password is used.
   * @param {string} type - 'inicio' or 'fim'.
   */
  function toggleEditMode(type) {
    const editFimFields = document.getElementById('editFimFields');
    const editInicioFields = document.getElementById('editInicioFields');
    const editPasswordSection = document.getElementById('editPasswordSection');

    // Get all input/select/textarea elements in each section
    const fimInputs = editFimFields.querySelectorAll('input, select, textarea');
    const inicioInputs = editInicioFields.querySelectorAll('input, select, textarea');

    // Always clear the admin password input when toggling modes
    document.getElementById('editAdminPassword').value = ''; 

    if (type === 'fim') {
      editFimFields.style.display = 'block';
      editInicioFields.style.display = 'none';
      editPasswordSection.style.display = 'none'; // Hide password section when editing end fields

      // Enable end fields, disable start fields
      fimInputs.forEach(input => input.removeAttribute('readonly'));
      inicioInputs.forEach(input => input.setAttribute('readonly', 'readonly'));
    } else if (type === 'inicio') {
      editFimFields.style.display = 'none';
      editInicioFields.style.display = 'block';

      // Determine if 'inicio' fields should be immediately editable (if it's an "ENCERRAMENTO SEM IN?CIO" record)
      const isNoStartRecord = currentEditingRecord.dataInicial === 'N/A';

      if (isNoStartRecord) {
          editPasswordSection.style.display = 'none'; // No password needed
          inicioInputs.forEach(input => input.removeAttribute('readonly')); // Enable all
          // Also pre-populate dropdowns if they were 'N/A' and there are default options
          if (document.getElementById('editSetorInicio').value === 'N/A') populateDropdown('setor', 'edit', 'editSetorInicio');
          if (document.getElementById('editAtividadeInicio').value === 'N/A') populateDropdown('atividade', 'edit', 'editAtividadeInicio');
          if (document.getElementById('editImplementoInicio').value === 'N/A') populateDropdown('implemento', 'edit', 'editImplementoInicio');

      } else {
          // If it's a regular record, password is required to enable fields
          editPasswordSection.style.display = 'block';
          inicioInputs.forEach(input => input.setAttribute('readonly', 'readonly')); // Disable until unlocked
          isInitialEditUnlocked = false; // Ensure it's locked again on toggle
      }
    }
  }

  /**
   * Handles the unlock action for editing initial record data.
   */
  function handleUnlockEdit() {
      const adminPasswordInput = document.getElementById('editAdminPassword');
      const password = adminPasswordInput.value;

      // In a real application, this would involve a secure backend authentication.
      // For this demo, we're using a hardcoded admin password.
      if (appUsers['admin'] && appUsers['admin'].password === password) {
          isInitialEditUnlocked = true;
          showAlert('DADOS DE IN?CIO DESBLOQUEADOS PARA EDI??O.');
          document.getElementById('editPasswordSection').style.display = 'none';
          // Enable all input elements within the 'editInicioFields' div
          const inicioInputs = document.getElementById('editInicioFields').querySelectorAll('input, select, textarea');
          inicioInputs.forEach(input => input.removeAttribute('readonly'));
          
          // Ensure dropdowns are populated if they need to be
          populateDropdown('setor', 'edit', 'editSetorInicio');
          populateDropdown('atividade', 'edit', 'editAtividadeInicio');
          populateDropdown('implemento', 'edit', 'editImplementoInicio');
          
          // Restore selected values if they were previously set
          if (currentEditingRecord.setor) document.getElementById('editSetorInicio').value = currentEditingRecord.setor;
          if (currentEditingRecord.atividade) document.getElementById('editAtividadeInicio').value = currentEditingRecord.atividade;
          if (currentEditingRecord.implemento) document.getElementById('editImplementoInicio').value = currentEditingRecord.implemento;

          // Restore focus to a relevant field or just let them navigate
          document.getElementById('editCrachaInicio').focus();
      } else {
          showAlert('SENHA DE ADMINISTRADOR INV?LIDA OU N?VEL DE ACESSO INSUFICIENTE.', true);
          adminPasswordInput.value = ''; // Clear password on failure
      }
  }


  /**
   * Saves the edited record data from the modal.
   */
  async function salvarEdicaoRegistro() {
    if (!currentEditingRecord) {
      showAlert('NENHUM REGISTRO SELECIONADO PARA SALVAR.');
      return;
    }

    const oldValues = { ...currentEditingRecord }; // Clone for comparison
    const selectedEditType = document.querySelector('input[name="editType"]:checked').value;
    const editedFields = {};

    if (selectedEditType === 'fim') {
        // Editing end data
        const newDataFinal = document.getElementById('editDataFinal').value;
        const newHoraFinal = document.getElementById('editHoraFinal').value;
        const newHorimetroFinal = parseFloat(document.getElementById('editHorimetroFinal').value);
        const newObservacoesFim = document.getElementById('editObservacoesFim').value.trim();

        // Basic validation
        if (!newDataFinal || !newHoraFinal || isNaN(newHorimetroFinal)) {
            showAlert('POR FAVOR, PREENCHA TODOS OS CAMPOS OBRIGAT?RIOS DO FORMUL?RIO DE EDI??O DE FIM.', true);
            return;
        }

        let isEditedInconsistent = false;

        // Validate new dataFinal/horaFinal against original dataInicial/horaInicial
        if (currentEditingRecord.dataInicial !== 'N/A') {
            const originalStartDateTime = new Date(`${oldValues.dataInicial}T${oldValues.horaInicial}:00`);
            const newEndDateTime = new Date(`${newDataFinal}T${newHoraFinal}:00`);
            
            if (newEndDateTime < originalStartDateTime) {
                const confirmedDateTimeCorrection = await showConfirm(
                    `A NOVA DATA E HORA FINAL (${newDataFinal} ${newHoraFinal}) ? ANTERIOR ? DATA E HORA INICIAL ORIGINAL (${oldValues.dataInicial} ${oldValues.horaInicial}). DESEJA SALVAR COM ESTA INCONSIST?NCIA?`,
                    true
                );
                if (!confirmedDateTimeCorrection) {
                    showAlert('EDI??O CANCELADA. POR FAVOR, CORRIJA A DATA E HORA FINAL.', true);
                    return;
                }
                isEditedInconsistent = true;
            }
        }

        // Validate new horimetroFinal against original horimetroInicial
        const originalHorimetroInicial = parseFloat(currentEditingRecord.horimetroInicial);
        if (newHorimetroFinal < originalHorimetroInicial && currentEditingRecord.dataInicial !== 'N/A') {
            const confirmedHorimeterCorrection = await showConfirm(
                `O NOVO HOR?METRO FINAL (${newHorimetroFinal}) ? MENOR QUE O HOR?METRO INICIAL ORIGINAL (${originalHorimetroInicial}). DESEJA SALVAR COM ESTA INCONSIST?NCIA?`,
                true
            );
            if (!confirmedHorimeterCorrection) {
                showAlert('EDI??O CANCELADA. POR FAVOR, VERIFIQUE O HOR?METRO FINAL.', true);
                return;
            }
            isEditedInconsistent = true;
        }

        // Apply updates and log changes
        if (oldValues.dataFinal !== newDataFinal) editedFields.dataFinal = { old: oldValues.dataFinal, new: newDataFinal };
        if (oldValues.horaFinal !== newHoraFinal) editedFields.horaFinal = { old: oldValues.horaFinal, new: newHoraFinal };
        if (parseFloat(oldValues.horimetroFinal) !== newHorimetroFinal) editedFields.horimetroFinal = { old: oldValues.horimetroFinal, new: newHorimetroFinal };
        if (oldValues.observacoesFim !== newObservacoesFim) editedFields.observacoesFim = { old: oldValues.observacoesFim, new: newObservacoesFim };

        currentEditingRecord.dataFinal = newDataFinal;
        currentEditingRecord.horaFinal = newHoraFinal;
        currentEditingRecord.horimetroFinal = newHorimetroFinal;
        currentEditingRecord.observacoesFim = newObservacoesFim;
        currentEditingRecord.horimetroInconsistente = isEditedInconsistent; // Update inconsistency flag

    } else if (selectedEditType === 'inicio') {
        // Editing start data
        // Check if it's a "No Start" record OR if admin password was used for regular record
        const isNoStartRecord = currentEditingRecord.dataInicial === 'N/A';
        if (!isNoStartRecord && !isInitialEditUnlocked) {
            showAlert('POR FAVOR, DESBLOQUEIE A EDI??O DE DADOS DE IN?CIO COM A SENHA DE ADMINISTRADOR.', true);
            return;
        }

        const newCrachaInicio = document.getElementById('editCrachaInicio').value.trim();
        const newFrotaInicio = document.getElementById('editFrotaInicio').value.trim();
        const newDataInicial = document.getElementById('editDataInicial').value;
        const newHoraInicial = document.getElementById('editHoraInicial').value;
        const newHorimetroInicial = parseFloat(document.getElementById('editHorimetroInicial').value);
        const newSetor = document.getElementById('editSetorInicio').value;
        const newAtividade = document.getElementById('editAtividadeInicio').value;
        const newImplemento = document.getElementById('editImplementoInicio').value;
        const newRelatoProblema = document.getElementById('editRelatoProblema').value.trim();

        // Basic validation for start fields
        if (!newCrachaInicio || !newFrotaInicio || !newDataInicial || !newHoraInicial || isNaN(newHorimetroInicial) || !newSetor || !newAtividade || !newImplemento) {
            showAlert('POR FAVOR, PREENCHA TODOS OS CAMPOS OBRIGAT?RIOS DO FORMUL?RIO DE EDI??O DE IN?CIO.', true);
            return;
        }
        
        // Specific validation for Crach? and Frota existence
        if (!operadores[newCrachaInicio]) {
            showAlert(`ERRO: CRACH? ${newCrachaInicio} N?O CADASTRADO. POR FAVOR, CADASTRE O OPERADOR OU VERIFIQUE O CRACH?.`, true);
            return;
        }
        if (!frotas[newFrotaInicio]) {
            showAlert(`ERRO: FROTA ${newFrotaInicio} N?O CADASTRADA. POR FAVOR, CADASTRE A FROTA OU VERIFIQUE O C?DIGO.`, true);
            return;
        }


        let isEditedInconsistent = false;
        // Re-validate horimeter consistency if initial horimeter is changed relative to final
        // For simplicity in this demo, we'll only check if new initial > old final.
        // A more complex system would re-evaluate against `lastKnownHorimeters` for *this* frota
        // and potentially mark all subsequent records as inconsistent if the initial horimeter changes drastically.
        if (currentEditingRecord.dataFinal !== 'N/A' && newHorimetroInicial > parseFloat(currentEditingRecord.horimetroFinal)) {
             const confirmedHorimeterCorrection = await showConfirm(
                `O NOVO HOR?METRO INICIAL (${newHorimetroInicial}) ? MAIOR QUE O HOR?METRO FINAL REGISTRADO (${currentEditingRecord.horimetroFinal}). DESEJA SALVAR COM ESTA INCONSIST?NCIA?`,
                true
            );
            if (!confirmedHorimeterCorrection) {
                showAlert('EDI??O CANCELADA. POR FAVOR, VERIFIQUE O HOR?METRO INICIAL.', true);
                return;
            }
            isEditedInconsistent = true;
        }

        // Apply updates and log changes
        if (oldValues.crachaInicio !== newCrachaInicio) editedFields.crachaInicio = { old: oldValues.crachaInicio, new: newCrachaInicio };
        if (oldValues.frotaInicio !== newFrotaInicio) editedFields.frotaInicio = { old: oldValues.frotaInicio, new: newFrotaInicio };
        if (oldValues.dataInicial !== newDataInicial) editedFields.dataInicial = { old: oldValues.dataInicial, new: newDataInicial };
        if (oldValues.horaInicial !== newHoraInicial) editedFields.horaInicial = { old: oldValues.horaInicial, new: newHoraInicial };
        if (parseFloat(oldValues.horimetroInicial) !== newHorimetroInicial) editedFields.horimetroInicial = { old: oldValues.horimetroInicial, new: newHorimetroInicial };
        if (oldValues.setor !== newSetor) editedFields.setor = { old: oldValues.setor, new: newSetor };
        if (oldValues.atividade !== newAtividade) editedFields.atividade = { old: oldValues.atividade, new: newAtividade };
        if (oldValues.implemento !== newImplemento) editedFields.implemento = { old: oldValues.implemento, new: newImplemento };
        if (oldValues.relatoProblema !== newRelatoProblema) editedFields.relatoProblema = { old: oldValues.relatoProblema, new: newRelatoProblema };


        currentEditingRecord.crachaInicio = newCrachaInicio;
        currentEditingRecord.frotaInicio = newFrotaInicio;
        currentEditingRecord.dataInicial = newDataInicial;
        currentEditingRecord.horaInicial = newHoraInicial;
        currentEditingRecord.horimetroInicial = newHorimetroInicial;
        currentEditingRecord.setor = newSetor;
        currentEditingRecord.atividade = newAtividade;
        currentEditingRecord.implemento = newImplemento;
        currentEditingRecord.relatoProblema = newRelatoProblema;

        // Update display names/photos if Crach? or Frota changed
        currentEditingRecord.nomeOperadorDisplay = operadores[newCrachaInicio] ? operadores[newCrachaInicio].nome : 'OPERADOR N?O ENCONTRADO';
        currentEditingRecord.fotoOperadorDisplay = operadores[newCrachaInicio] ? operadores[newCrachaInicio].foto : 'https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR';
        currentEditingRecord.equipamentoDisplay = frotas[newFrotaInicio] ? frotas[newFrotaInicio].modelo : 'EQUIPAMENTO N?O ENCONTRADO';
        currentEditingRecord.fotoEquipamentoDisplay = frotas[newFrotaInicio] ? frotas[newFrotaInicio].foto : 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';

        // Update the horimetroInconsistente flag based on this edit's validation
        currentEditingRecord.horimetroInconsistente = isEditedInconsistent;
    }


    // Recalculate duration and total horimeter for the record if possible
    if (currentEditingRecord.dataInicial !== 'N/A' && currentEditingRecord.dataFinal !== 'N/A') {
        currentEditingRecord.duracaoHoras = calcularDiferencaHoras(
            currentEditingRecord.dataInicial, currentEditingRecord.horaInicial,
            currentEditingRecord.dataFinal, currentEditingRecord.horaFinal
        );
        currentEditingRecord.horimetroTotalCalculado = parseFloat(currentEditingRecord.horimetroFinal) - parseFloat(currentEditingRecord.horimetroInicial);
    } else {
        currentEditingRecord.duracaoHoras = 0; // Or keep as N/A if one of the dates is N/A
        currentEditingRecord.horimetroTotalCalculado = 0;
    }

    // Update last known horimeter for this frota (important for future validations)
    lastKnownHorimeters[currentEditingRecord.frotaInicio] = parseFloat(currentEditingRecord.horimetroFinal);
    
    if (Object.keys(editedFields).length > 0) {
        edicoesRealizadas.push({
            recordId: currentEditingRecord.id,
            editorUser: currentUserRole || 'N?o Logado', // Log who edited (if logged in)
            timestamp: new Date().toLocaleString('pt-BR'),
            editedFields: editedFields
        });
    }

    showAlert('REGISTRO ATUALIZADO COM SUCESSO!');
    editRecordModal.style.display = 'none'; // Hide the modal
    currentEditingRecord = null; // Clear the editing record
    isInitialEditUnlocked = false; // Reset unlock status
    popularTabelaRegistros(); // Refresh the main data table
    popularDisponibilidade(); // Refresh availability in case frota status changed
  }

  /**
   * Cancels the edit operation and hides the modal.
   */
  function cancelarEdicaoRegistro() {
    editRecordModal.style.display = 'none';
    currentEditingRecord = null;
    isInitialEditUnlocked = false; // Reset unlock status
    showAlert('EDI??O CANCELADA.');
  }

  /**
   * Populates the "Relat?rio de Edi??es Realizadas" table.
   */
  function popularTabelaEdicoes() {
    const tableBody = document.getElementById('edicoesTableBody');
    tableBody.innerHTML = '';
    const filterRecordId = document.getElementById('filterRecordIdEdicao').value.toLowerCase();
    const filterEditorUser = document.getElementById('filterEditorUser').value.toLowerCase();
    const filterDate = document.getElementById('filterDateEdicao').value; //YYYY-MM-DD

    let foundCount = 0;
    edicoesRealizadas.forEach(edit => {
      const matchRecordId = !filterRecordId || edit.recordId.toLowerCase().includes(filterRecordId);
      const matchEditorUser = !filterEditorUser || (edit.editorUser || '').toLowerCase().includes(filterEditorUser);
      const matchDate = !filterDate || edit.timestamp.startsWith(filterDate.split('-').reverse().join('/')); // Compare formatted date

      if (matchRecordId && matchEditorUser && matchDate) {
        const row = tableBody.insertRow();
        row.className = 'hover:bg-gray-50';

        let fieldsDisplay = '';
        for (const field in edit.editedFields) {
          const oldVal = edit.editedFields[field].old;
          const newVal = edit.editedFields[field].new;
          fieldsDisplay += `<strong>${field}:</strong> ${oldVal} &rarr; ${newVal}<br>`;
        }

        row.innerHTML = `
          <td class="px-2 py-2 whitespace-nowrap text-sm font-medium text-gray-900" data-label="ID Registro">${edit.recordId.substring(0, 8)}...</td>
          <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="Usu?rio Editor">${edit.editorUser}</td>
          <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="Data Edi??o">${edit.timestamp}</td>
          <td class="px-2 py-2 text-sm text-gray-500" data-label="Campos Editados">${fieldsDisplay}</td>
        `;
        foundCount++;
      }
    });

    if (foundCount === 0) {
      tableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">NENHUMA EDI??O ENCONTRADA COM OS FILTROS APLICADOS.</td></tr>`;
    }
  }

  /**
   * Populates the "Relat?rio de Horas por Frota" table.
   */
  function popularTabelaHorasFrota() {
    const tableBody = document.getElementById('horasFrotaTableBody');
    tableBody.innerHTML = '';
    const filterFrota = document.getElementById('filterFrotaRelatorioHoras').value.toLowerCase();
    const filterDataInicio = document.getElementById('filterDataInicioRelatorioHoras').value;
    const filterDataFim = document.getElementById('filterDataFimRelatorioHoras').value;

    const frotaSummary = new Map(); // Key: frotaCode, Value: { totalHours: number, totalHorimeter: number, activityCount: number }

    registrosAtividades.forEach(record => {
      // Only process completed activities with valid duration and horimeter data
      if (record.dataInicial !== 'N/A' && record.dataFinal !== 'N/A' && record.duracaoHoras !== undefined && record.horimetroTotalCalculado !== undefined) {
        const recordDate = new Date(record.dataInicial);
        const startDate = filterDataInicio ? new Date(filterDataInicio) : null;
        const endDate = filterDataFim ? new Date(filterDataFim) : null;

        const matchFrota = !filterFrota || record.frotaInicio.toLowerCase().includes(filterFrota);
        const matchDate = (!startDate || recordDate >= startDate) && (!endDate || recordDate <= endDate);

        if (matchFrota && matchDate) {
          if (!frotaSummary.has(record.frotaInicio)) {
            frotaSummary.set(record.frotaInicio, {
              totalHours: 0,
              totalHorimeter: 0,
              activityCount: 0
            });
          }
          const summary = frotaSummary.get(record.frotaInicio);
          summary.totalHours += record.duracaoHoras;
          summary.totalHorimeter += record.horimetroTotalCalculado;
          summary.activityCount++;
        }
      }
    });

    if (frotaSummary.size === 0) {
      tableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">NENHUM DADO ENCONTRADO PARA ESTES FILTROS.</td></tr>`;
      return;
    }

    // Sort by frota code for consistent display
    const sortedFrotas = Array.from(frotaSummary.keys()).sort();

    sortedFrotas.forEach(frotaCode => {
      const summary = frotaSummary.get(frotaCode);
      const row = tableBody.insertRow();
      row.className = 'hover:bg-gray-50';
      row.innerHTML = `
        <td class="px-2 py-2 whitespace-nowrap text-sm font-medium text-gray-900" data-label="Frota">${frotaCode}</td>
        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="Total de Horas (h)">${summary.totalHours.toFixed(2)}</td>
        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="Hor?metro Total">${summary.totalHorimeter.toFixed(2)}</td>
        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500" data-label="N? Atividades">${summary.activityCount}</td>
      `;
    });
  }

  /** Clears filters for "Relat?rio de Horas por Frota" and repopulates the table. */
  function limparFiltrosRelatorioHorasFrota() {
    document.getElementById('filterFrotaRelatorioHoras').value = '';
    document.getElementById('filterDataInicioRelatorioHoras').value = '';
    document.getElementById('filterDataFimRelatorioHoras').value = '';
    popularTabelaHorasFrota();
  }


  // Initial display setup
  document.addEventListener('DOMContentLoaded', () => {
    // Set initial placeholder images
    document.getElementById('fotoInicio').src = 'https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR';
    document.getElementById('fotoEquipInicio').src = 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
    document.getElementById('fotoFim').src = 'https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR';
    document.getElementById('fotoEquipFim').src = 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';

    // Default to 'Disponibilidade' view on load
    mostrar('disponibilidade');
    // Ensure admin dashboard and user management are hidden by default
    document.getElementById('adminDashboard').style.display = 'none';
    document.getElementById('adminLogin').style.display = 'block'; // Ensure login form is visible
    document.getElementById('userManagement').style.display = 'none'; 

    updateButtonVisibility(); // Call initially to set correct button visibility
  });
</script>
</body>
</html>
