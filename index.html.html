<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestão de Frotas</title>
  <meta name="theme-color" content="#ffffff"/>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
      body {
        font-family: 'Inter', sans-serif;
        margin: 0;
        padding: 0;
      }
      .card {
        padding: 32px;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        width: 100%;
        max-width: 768px;
        background-color: #ffffff;
        border: 1px solid #e2e8f0;
        position: relative;
      }
      .app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }
      .header-actions {
         display: flex;
         align-items: center;
         gap: 16px;
      }
      .notification-bell {
        position: relative;
        cursor: pointer;
      }
      .notification-badge {
        position: absolute;
        top: -5px;
        right: -8px;
        background-color: #ef4444;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 10px;
        font-weight: bold;
        display: none; /* Hidden by default */
      }
      #notification-panel {
        display: none;
        position: fixed;
        top: 64px; /* abaixo do menu fixo */
        right: 16px;
        width: 300px;
        max-height: 400px;
        overflow-y: auto;
        background-color: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        z-index: 1010;
      }
      #notification-panel .notification-item {
        padding: 12px;
        border-bottom: 1px solid #f1f5f9;
        font-size: 14px;
      }
      #notification-panel .notification-item:last-child {
        border-bottom: none;
      }
      h2 {
        font-size: 2.25rem;
        font-weight: 800;
        color: #1a202c;
        margin-bottom: 0;
      }
      h3 {
        font-size: 1.75rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid #edf2f7;
      }
      h4 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 12px;
      }
      .btn {
        padding: 12px 28px;
        border: none;
        color: white;
        border-radius: 10px;
        cursor: pointer;
        margin: 6px 4px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        background-image: linear-gradient(145deg, var(--color-light), var(--color-dark));
      }
      .btn.yellow { --color-light: #ffeb3b; --color-dark: #fbc02d; color: #333; }
      .btn.green { --color-light: #4CAF50; --color-dark: #388E3C; }
      .btn.red { --color-light: #f44336; --color-dark: #d32f2f; }
      .btn.blue { --color-light: #2196F3; --color-dark: #1976D2; }
      .btn.purple { --color-light: #9C27B0; --color-dark: #7B1FA2; }
      .btn.darkblue { --color-light: #3F51B5; --color-dark: #303F9F; }
      .btn.teal { --color-light: #009688; --color-dark: #00796B; }
      .btn.orange { --color-light: #FF9800; --color-dark: #F57C00; }
      /* Adicionado para botões escuros */
      .btn.dark-primary { --color-light: #374151; --color-dark: #1F2937; } /* Cor mais escura para botões principais */
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        opacity: 1;
      }
      .field {
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      @media (min-width: 640px) {
        .field {
         flex-direction: row;
          align-items: center;
          gap: 16px;
        }
      }
      .field label {
        flex: 0 0 140px;
        color: #4a5568;
        font-weight: 600;
        font-size: 0.95rem;
      }
      .field input[type="text"],
      .field input[type="date"],
      .field input[type="password"],
      .field input[type="email"],
      .field select,
      .field textarea {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid #cbd5e0;
        border-radius: 8px;
        box-sizing: border-box;
        width: 100%;
        font-size: 1rem;
        color: #2d3748;
        background-color: #f7fafc;
        transition: all 0.2s ease-in-out;
      }
      .field input:focus, .field select:focus, .field textarea:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        background-color: #ffffff;
      }
      .field img {
        margin-left: 0;
        margin-top: 12px;
        width: 90px;
        height: 90px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #6366f1;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      }
      @media (min-width: 640px) {
        .field img {
          margin-left: 20px;
          margin-top: 0;
        }
      }
      textarea {
        resize: vertical;
        min-height: 80px;
      }
      .checklist {
        padding: 20px;
        border: 1px solid #d1d8e0;
        border-radius: 12px;
        background-color: #f0f4f8;
        margin-top: 24px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
      }
      .checklist h4 {
        color: #333;
        margin-top: 0;
        margin-bottom: 16px;
        text-align: center;
        font-size: 1.35rem;
      }
      .checklist label {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        font-size: 0.9rem;
        color: #4a5568;
      }
      .checklist input[type="radio"] {
        transform: scale(1.2);
        cursor: pointer;
      }
      .admin-panel {
        display: none;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid #e2e8f0;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.6);
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(4px);
      }
      .modal-content {
        background-color: #ffffff;
        padding: 30px;
        border: 1px solid #b2c1d3;
        border-radius: 16px;
        width: 90%;
        max-width: 650px; /* Increased width for lists */
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        animation: fadeIn 0.3s ease-out;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
      }
     .modal-warning-background {
       background-color: #ffebee;
        border-color: #ef9a9a;
      }
     .modal-warning-background h3,
     .modal-warning-background p {
        color: #c62828;
      }
      .modal-content h3 {
        font-size: 1.6rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 12px;
        border-bottom: none;
      }
      .modal-content p {
        font-size: 1.05rem;
        color: #555;
        margin-bottom: 24px;
        line-height: 1.5;
        white-space: pre-wrap; /* Allows line breaks in the message */
      }
      .modal-buttons button {
        margin: 0 10px;
        min-width: 100px;
      }
     .modal-list-content {
        max-height: 400px;
        overflow-y: auto;
        margin-top: 1rem;
      }
     .availability-table, .consult-table, .data-table {
        width: 100%;
       border-collapse: collapse;
        border-radius: 8px;
        overflow: hidden;
        margin-top: 16px;
      }
     .availability-table th, .availability-table td,
      .consult-table th, .consult-table td,
      .data-table th, .data-table td {
        padding: 12px 8px;
        font-size: 0.9rem;
        text-align: left;
        border: 1px solid #e2e8f0;
      }
     .availability-table thead, .consult-table thead, .data-table thead {
       background-color: #e2e8f0;
        color: #4a5568;
        font-weight: 700;
       text-transform: uppercase;
        font-size: 0.8rem;
      }
      .consult-table thead th {
        cursor: pointer;
      }
     .availability-table tbody tr:nth-child(even),
      .consult-table tbody tr:nth-child(even),
      .data-table tbody tr:nth-child(even) {
       background-color: #f7fafc;
      }
     .availability-table tbody tr:hover {
       background-color: #ebf4ff;
      }
      .availability-table tbody tr.editable:hover {
        cursor: pointer;
        background-color: #dbeafe;
      }
      .consult-table tbody tr:hover,
      .data-table tbody tr:hover {
       background-color: #ebf4ff;
      }
      @media (max-width: 640px) {
        .availability-table, .consult-table, .data-table { border: none; }
        .availability-table thead, .consult-table thead, .data-table thead { display: none; }
        .availability-table tr, .consult-table tr, .data-table tr {
           margin-bottom: 16px;
           border: 1px solid #e2e8f0;
           border-radius: 12px;
           padding: 16px;
           background-color: #ffffff;
           box-shadow: 0 4px 10px rgba(0,0,0,0.08);
           display: block;
           width: 100%;
        }
        .availability-table td, .consult-table td, .data-table td {
           border-bottom: 1px dotted #e2e8f0;
           text-align: right;
           padding-left: 50%;
           position: relative;
           display: block;
           white-space: normal;
           overflow: visible;
           text-overflow: clip;
        }
        .availability-table td:last-child, .consult-table td:last-child, .data-table td:last-child { border-bottom: 0; }
      }
     .status-maintenance-strong { background-color: #D32F2F; color: #FFFFFF; font-weight: 600; }
     .status-revision-strong { background-color: #3F51B5; color: #FFFFFF; font-weight: 600; }
      .status-active { background-color: #BBDEFB; color: #1A237E; font-weight: 600; }
      .status-cell {
        padding: 6px 12px;
        border-radius: 6px;
        display: inline-block;
        font-size: 0.8rem;
        font-weight: 700;
       text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .status-ok { background-color: #c8e6c9; color: #2e7d32; }
     .status-inconsistente { background-color: #ffebee; color: #d32f2f; }
     .search-icon {
        cursor: pointer;
        padding: 8px;
        margin-left: -40px;
        z-index: 10;
     }
     select[multiple] {
        height: 120px;
     }
     .association-container {
        display: flex;
        gap: 2rem;
        margin-top: 1rem;
     }
     .association-list {
        flex: 1;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        max-height: 300px;
        overflow-y: auto;
     }
     .association-list h5 {
        font-weight: bold;
        margin-bottom: 0.5rem;
     }
     .association-list label {
        display: block;
        margin-bottom: 0.5rem;
     }
</style>
<!-- ESTILOS DO LOGIN ATUALIZADOS -->
<style>
      body.login-bg {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        /* Fundo gradiente suave da nova tela de login */
        background: radial-gradient(ellipse at top, #f0f4f8 0%, #d9e2ec 60%, #c0cedc 100%);
      }
      .login-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        min-height: 70vh;
        justify-content: center;
        padding: 16px;
      }
      .login-logo {
        width: 200px; /* Aumentado */
        height: auto;
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15)); /* Sombra mais suave */
      }
      .login-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1f2937;
        margin-top: 8px;
        margin-bottom: 20px; /* Aumentado */
      }
      .login-card {
        width: 100%;
        max-width: 400px; /* Ajustado */
        padding: 32px 36px; /* Mais padding */
        border-radius: 16px; /* Mais arredondado */
        background: #fff;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1), 0 5px 10px rgba(0,0,0,0.04); /* Sombra mais suave */
        border: none; /* Sem borda */
      }
      .login-field {
          margin-bottom: 16px; /* Espaço entre os campos */
      }
      .login-field label {
        display: block;
        font-weight: 500; /* Ajustado */
        color: #4a5568; /* Ajustado */
        margin-bottom: 8px; /* Aumentado */
        font-size: 0.9rem; /* Ajustado */
      }
      .login-field input {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid #d1d5db; /* Borda cinza */
        border-radius: 8px; /* Menos arredondado */
        background-color: #ffffff; /* Fundo branco */
        font-size: 1rem;
        transition: all 0.2s ease-in-out;
      }
      .login-field input:focus {
          outline: none;
          border-color: #0b1f44; /* Cor do botão */
          box-shadow: 0 0 0 3px rgba(11, 31, 68, 0.2); /* Foco sutil */
      }
      .login-actions {
        display: flex;
        flex-direction: column; /* Checkbox e botão empilhados */
        align-items: center; /* Centraliza botão */
        margin-top: 16px; /* Ajustado */
      }
      .login-actions label {
          align-self: flex-start; /* Alinha checkbox à esquerda */
          margin-bottom: 16px; /* Espaço abaixo do checkbox */
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 0.9rem;
          color: #374151;
      }
      .login-actions .btn.dark-primary {
          width: 100%; /* Botão com largura total */
          padding: 12px;
          font-size: 1rem;
          margin: 0; /* Reseta margem do .btn */
      }
      .login-links {
        display: flex;
        justify-content: space-between;
        font-size: 0.875rem;
        margin-top: 20px; /* Aumentado */
      }
      .login-links a { color: #374151; text-decoration: none; }
      .login-links a:hover { text-decoration: underline; color: #0b1f44; }
</style>
  <style>
    :root { --navy: #0b1f44; }

    /* Fundo com imagem temática Axyn e fallback em gradiente */
    body { 
      background-color: #ffffff;
      background-image: none;
      background-size: auto;
      background-position: initial;
      background-attachment: initial;
      margin: 0;
      padding: 64px 0 0 0;
    }

    /* Cards planos, sem sombra e sem borda */
    .card { box-shadow: none !important; border: none !important; background-color: rgba(255,255,255,0.95); }

    /* Barra superior (header) azul marinho com texto branco */
    .app-header { background-color: var(--navy); color: #fff; padding: 12px 16px; border-radius: 10px; }
    .app-header .panel-title, .app-header .current-username { color: #fff; }
    .header-actions .notification-bell svg { color: #fff; }
    /* Ocultar ações nos headers internos pois agora estão no menu superior */
    .app-header .header-actions .notification-bell,
    .app-header .header-actions .current-username,
    .app-header .header-actions .btn[onclick="window.appLogout()"] { display: none !important; }

    /* Botão principal em azul marinho */
    .btn.dark-primary { --color-light: #0d2a66; --color-dark: #0b1f44; background-image: none; background-color: var(--navy); color: #fff; }
    .btn { background-image: none; background-color: var(--navy); color: #fff; }

    /* Menu superior da tela inicial (como links) */
    .top-menu { display: flex; justify-content: space-between; gap: 12px; align-items: center; padding: 10px 16px; background-color: #60A5FA; color: #fff; border-radius: 0; margin-bottom: 0; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; flex-wrap: wrap; }
    .top-menu .btn { background: none; box-shadow: none; border-radius: 8px; color: #fff; padding: 8px 12px; margin: 0; }
    .top-menu .btn:hover { background-color: rgba(255,255,255,0.15); transform: none; box-shadow: none; }
    .top-menu-left { display: flex; flex-direction: column; align-items: flex-start; }
    .top-menu-brand { font-weight: 800; font-size: 1.25rem; line-height: 1; color: #fff; margin-bottom: 6px; }

    /* Menus laterais verticais azuis com texto branco */
    .menu-vertical { display: flex; flex-direction: column; gap: 10px; align-items: stretch; max-width: 260px; }
    .menu-vertical .btn { background-color: var(--navy); color: #fff; box-shadow: none; border-radius: 8px; margin: 0; padding: 10px 14px; text-align: left; }
    .menu-vertical .btn:hover { opacity: 0.9; transform: none; box-shadow: none; }
    #manutencaoPanel .manutencao-layout { display: grid; grid-template-columns: 260px 1fr; gap: 16px; align-items: start; margin-top: 12px; }
    @media (max-width: 768px) { #manutencaoPanel .manutencao-layout { grid-template-columns: 1fr; } }
    /* Cores dos botões principais de Status de Atividade */
    #btnDisponibilidade { background-color: #DAA520; color: #fff; }
    #btnDisponibilidade:hover { filter: brightness(0.95); }
    #btnInicioAtividade { background-color: #10B981; color: #fff; }
    #btnInicioAtividade:hover { filter: brightness(0.95); }
    #btnEncerramentoAtividade { background-color: #3B82F6; color: #fff; }
    #btnEncerramentoAtividade:hover { filter: brightness(0.95); }

    /* Layout em duas colunas para painéis: menu esquerdo + conteúdo à direita */
    #statusDeAtividadePanel, #manutencaoPanel, #abastecimentoPanel, #pneusPanel { display: block; }
    #statusDeAtividadePanel .app-header, #manutencaoPanel .app-header, #abastecimentoPanel .app-header, #pneusPanel .app-header { }
    #statusDeAtividadePanel #mainNavButtons, #manutencaoPanel .menu-vertical, #abastecimentoPanel .menu-vertical, #pneusPanel .menu-vertical { position: relative; top: auto; align-self: auto; margin-bottom: 16px; }
    #statusDeAtividadePanel #inicio, #statusDeAtividadePanel #disponibilidade, #statusDeAtividadePanel #fim, #statusDeAtividadePanel #cadastro { grid-column: auto; }

    /* Cadastro com menu lateral também */
    #cadastro { display: grid; grid-template-columns: 260px 1fr; gap: 24px; }
    #cadastro h3 { grid-column: 1 / span 2; }
    #cadastro > .menu-vertical { grid-column: 1; position: sticky; top: 12px; align-self: start; }
    #cadastro > div[id] { grid-column: 2; }

    /* Títulos das seções centralizados e maiores */
    h3 { text-align: center; font-size: 2rem; }
  </style>
</head>
<body class="login-bg"> <!-- A classe 'login-bg' é aplicada inicialmente -->

<!-- Menu Superior Fixo (oculto no login) -->
<div class="top-menu mb-6" style="display:none;">
   <div class="top-menu-left">
      <div class="top-menu-brand">Axyn</div>
      <div class="top-menu-nav">
          <button id="btn-dashboard" class="btn" onclick="window.showApp('dashboardPanel')">Dashboard</button>
          <button id="btn-status" class="btn" onclick="window.showApp('statusDeAtividadePanel')">Status de Atividade</button>
          <button id="btn-manutencao" class="btn" onclick="window.showApp('manutencaoPanel')">Gestão de Manutenção</button>
          <button id="btn-abastecimento" class="btn" onclick="window.showApp('abastecimentoPanel')">Gestão de Abastecimento</button>
          <button id="btn-pneus" class="btn" onclick="window.showApp('pneusPanel')">Gestão de Pneus</button>
          <button id="btn-localizacao" class="btn" onclick="window.showApp('localizacaoPanel')">Localização</button>
          <button id="btn-cadastro" class="btn" onclick="window.showApp('statusDeAtividadePanel', 'cadastro')">Cadastro</button>
          <button id="btn-relatorio" class="btn" onclick="window.showApp('statusDeAtividadePanel', 'relatorio')">Relatório</button>
          <button id="btn-gerenciamento" class="btn" onclick="window.showApp('statusDeAtividadePanel', 'administrador')">Gerenciamento</button>
      </div>
   </div>
   <div class="top-menu-actions header-actions">
       <div class="flex items-center gap-3">
           <div class="notification-bell" onclick="toggleNotificationPanel()">
               <svg class="w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
               <span class="notification-badge"></span>
           </div>
           <svg class="w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 7.5a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 19.5a7.5 7.5 0 0115 0v.75a.75.75 0 01-.75.75h-13.5a.75.75 0 01-.75-.75v-.75z" /></svg>
           <span class="current-username text-xs text-white"></span>
       </div>
       <button class="btn dark-primary !p-2 !m-0" onclick="window.appLogout()">Sair</button>
   </div>
</div>

<!-- Painel de Login Principal (Visível no início) -->
<div id="loginPanel" class="login-container">
   <img id="logoLogin" alt="Logotipo da Empresa" class="login-logo">
   <h2 class="login-title">Portal de Acesso</h2>
   <div class="login-card">
       <div class="login-field">
           <label for="appUsername">Usuário</label>
           <input type="text" id="appUsername" required autocomplete="username" placeholder="Digite seu usuário">
       </div>
       <div class="login-field">
           <label for="appPassword">Senha</label>
           <input type="password" id="appPassword" required autocomplete="current-password" placeholder="Digite sua senha">
       </div>
       <div class="login-actions">
           <label><input type="checkbox" id="rememberMe"> Lembrar de mim</label>
           <button class="btn dark-primary" onclick="window.mainLogin()">Entrar</button>
       </div>
       <div class="login-links">
           <a href="#" onclick="return false;">Esqueceu a senha?</a>
           <a href="#" onclick="return false;">Criar conta</a>
       </div>
   </div>
</div>

<!-- Dashboard Panel -->
<div class="card" id="dashboardPanel" style="display:none;">
     <div class="app-header">
         <div class="flex items-center gap-4">
             <img alt="Logotipo da Empresa" class="h-14 logo-img">
             <h2 class="panel-title" style="margin-bottom: 0;"></h2>
         </div>
         <div class="header-actions">
             <button class="btn dark-primary back-button" onclick="window.showApp('gestaoDeFrotasPanel')">Voltar</button>
         </div>
     </div>
     <p class="text-gray-600 mb-8">Visão geral da operação da frota.</p>

     <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" id="dashboardFilters">
       <div class="field">
         <label for="dashboardStartDate">Período - Início</label>
         <input type="date" id="dashboardStartDate">
       </div>
       <div class="field">
         <label for="dashboardEndDate">Período - Fim</label>
         <input type="date" id="dashboardEndDate">
       </div>
       <div class="field">
         <label for="dashboardFrotaFilter">Filtrar por Frota(s)</label>
         <select id="dashboardFrotaFilter" multiple size="6"></select>
       </div>
       <div class="field">
         <label for="dashboardOperadorFilter">Filtrar por Operador(es)</label>
         <select id="dashboardOperadorFilter" multiple size="6"></select>
       </div>
     </div>
     <div class="flex gap-4 mb-6">
       <button class="btn dark-primary" onclick="window.loadDashboard()">Aplicar Filtros</button>
       <button class="btn dark-primary" onclick="document.getElementById('dashboardStartDate').value='';document.getElementById('dashboardEndDate').value='';Array.from(document.getElementById('dashboardFrotaFilter').options).forEach(o=>o.selected=false);Array.from(document.getElementById('dashboardOperadorFilter').options).forEach(o=>o.selected=false);window.loadDashboard();">Limpar Filtros</button>
     </div>

     <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
         <div>
             <h3 class="text-center">Utilização da Frota (Horas)</h3>
             <canvas id="utilizationChart"></canvas>
         </div>
         <div>
             <h3 class="text-center">Desempenho por Operador (Horas)</h3>
             <canvas id="operatorChart"></canvas>
         </div>
     </div>
</div>


<!-- Painel Principal de Gestão de Frotas (Menu Pós-Login) -->
<div class="card" id="gestaoDeFrotasPanel" style="display:none;">
   <div class="app-header">
         <div class="flex items-center gap-4">
             <img alt="Logotipo da Empresa" class="h-14 logo-img">
             <h2 class="panel-title" style="margin-bottom: 0;"></h2>
         </div>
         <div class="header-actions">
             <button class="btn dark-primary back-button" onclick="window.showApp('gestaoDeFrotasPanel')">Voltar</button>
         </div>
     </div>
     <!-- Conteúdo do menu principal (se houver) pode ir aqui -->
     <p class="text-gray-600 text-center text-lg mt-8">Selecione uma opção no menu superior para começar.</p>
</div>

<!-- Location Panel -->
<div class="card" id="localizacaoPanel" style="display:none;">
   <div class="app-header">
         <div class="flex items-center gap-4">
             <img alt="Logotipo da Empresa" class="h-14 logo-img">
             <h2 class="panel-title" style="margin-bottom: 0;"></h2>
         </div>
         <div class="header-actions">
             <!-- Notificações e usuário (removidos do header interno, ficam no menu superior) -->
             <button class="btn dark-primary back-button" onclick="window.showApp('gestaoDeFrotasPanel')">Voltar</button>
             <!-- Botão Sair (removido do header interno, fica no menu superior) -->
         </div>
     </div>
   <p class="text-gray-600 mb-8">Esta funcionalidade está em desenvolvimento e estará disponível em breve.</p>
</div>


<!-- Painel da Aplicação de Atividade de Empilhadeiras -->
<div class="card" id="statusDeAtividadePanel" style="display:none;">
     <div class="app-header">
         <div class="flex items-center gap-4">
             <img alt="Logotipo da Empresa" class="h-14 logo-img">
             <h2 id="panelTitle" class="panel-title" style="margin-bottom: 0;"></h2>
         </div>
         <div class="header-actions">
             <!-- Notificações e usuário (removidos do header interno, ficam no menu superior) -->
             <button class="btn dark-primary back-button" onclick="window.showApp('gestaoDeFrotasPanel')">Voltar</button>
             <!-- Botão Sair (removido do header interno, fica no menu superior) -->
         </div>
     </div>
   <div id="mainNavButtons" class="menu-vertical mb-8" style="display:flex; gap: 12px; align-items: center; flex-wrap: wrap;">
     <button class="btn" id="btnDisponibilidade" onclick="window.mostrar('disponibilidade')">Disponibilidade</button>
     <button class="btn" id="btnInicioAtividade" onclick="window.mostrar('inicio')">Início de Atividade</button>
     <button class="btn" id="btnEncerramentoAtividade" onclick="window.mostrar('fim')">Encerramento de Atividade</button>
   </div>

   <div id="inicio" style="display:none; margin-top:20px; padding: 20px; border-radius: 12px; background-color: rgba(46, 204, 113, 0.15); border: 2px solid #2ECC71;">
     <h3>Início de Atividade</h3>
     <form id="formInicio">
       <div class="flex justify-end mb-4">
         <button class="btn dark-primary" type="button" onclick="window.limparFormulario('formInicio')">Limpar Formulário</button>
       </div>
       <div class="field">
         <label for="crachaInicio">Crachá</label>
         <input type="text" name="crachaInicio" id="crachaInicio" oninput="this.value = this.value.toUpperCase(); window.buscarOperador(this.value,'nomeInicio','fotoInicio');" required>
         <div class="search-icon" onclick="window.showOperatorSearchModal('crachaInicio')">
           <svg class="w-6 h-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
         </div>
         <label for="nomeInicio">Operador</label>
         <input type="text" id="nomeInicio" readonly>
         <img id="fotoInicio" src="https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR" alt="Foto Operador">
       </div>
       <div class="field">
         <label for="dataInicial">Data Inicial</label>
         <input type="date" name="dataInicial" id="dataInicial" required onclick="window.confirmAndSetDateTime('dataInicial','horaInicial')">
       </div>
       <div class="field">
         <label for="horaInicial">Hora Inicial</label>
         <input type="text" id="horaInicial" name="horaInicial" required placeholder="HH:mm" oninput="this.value = this.value.replace(/\D/g, '').replace(/(\d{2})(\d)/, '$1:$2').slice(0, 5)">
       </div>
       <div class="field">
         <label for="frotaInicio">Frota</label>
         <input type="text" name="frotaInicio" id="frotaInicio" oninput="this.value = this.value.toUpperCase(); window.mostrarModeloFrota(this.value,'modeloInicio','fotoEquipInicio');" required>
         <img id="fotoEquipInicio" src="https://placehold.co/100x100/A0AEC0/000000?text=FROTA" alt="Foto Frota">
       </div>
       <div class="field">
         <label for="modeloInicio">Modelo</label>
         <input type="text" id="modeloInicio" readonly>
       </div>
       <div class="field">
         <label for="implementoInicio">Implemento</label>
         <select id="implementoInicio" required></select>
       </div>
       <div class="field">
         <label for="horimetroInicial">Horímetro Inicial</label>
         <input type="text" name="horimetroInicial" id="horimetroInicial" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" onblur="window.validateHorimetro('horimetroInicial', 'frotaInicio')" required>
       </div>
       <div class="field">
         <label for="setorInicio">Setor</label>
         <select id="setorInicio" required onchange="window.populateAtividadesPorSetor(this.value, 'atividadeInicio')"></select>
       </div>
       <div class="field">
         <label for="atividadeInicio">Atividade</label>
         <select id="atividadeInicio" onchange="window.toggleRelatoProblema()" required></select>
       </div>
       <div class="field" id="relatoProblemaField" style="display:none;">
         <label for="relatoProblema">Relato do Problema</label>
         <textarea name="relatoProblema" id="relatoProblema" rows="3" placeholder="Descreva o problema da manutenção"></textarea>
       </div>
       <div class="checklist" id="safetyChecklist">
         <h4 class="font-bold uppercase text-center mb-4">Checklist de Segurança</h4>
         <div class="grid grid-cols-12 gap-2 items-center text-center font-bold text-gray-700 text-sm mb-2">
             <div class="col-span-1">OK</div>
             <div class="col-span-6 text-left cursor-pointer" onclick="window.hideAllChecklistReports()">ITENS A CONFERIR</div>
             <div class="col-span-2">NÃO CONFORME</div>
             <div class="col-span-3 text-left">RELATAR</div>
         </div>
         <div class="grid grid-cols-12 gap-2 items-center mb-3">
             <div class="col-span-1 flex justify-center"><input type="radio" name="status_OleoMotor" value="OK" checked required></div>
             <div class="col-span-6 text-left text-sm">Óleo do Motor</div>
             <div class="col-span-2 flex justify-center"><input type="radio" name="status_OleoMotor" value="NÃO CONFORME" data-target-textarea="relato_OleoMotor" onchange="window.toggleNonConformityReport(this)"></div>
             <div class="col-span-3"><textarea name="relato_OleoMotor" id="relato_OleoMotor" rows="1" placeholder="Relatar não conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea></div>
         </div>
         <div class="grid grid-cols-12 gap-2 items-center mb-3">
             <div class="col-span-1 flex justify-center"><input type="radio" name="status_OleoHidraulico" value="OK" checked required></div>
             <div class="col-span-6 text-left text-sm">Óleo Hidráulico</div>
             <div class="col-span-2 flex justify-center"><input type="radio" name="status_OleoHidraulico" value="NÃO CONFORME" data-target-textarea="relato_OleoHidraulico" onchange="window.toggleNonConformityReport(this)"></div>
             <div class="col-span-3"><textarea name="relato_OleoHidraulico" id="relato_OleoHidraulico" rows="1" placeholder="Relatar não conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea></div>
         </div>
         <div class="grid grid-cols-12 gap-2 items-center mb-3">
             <div class="col-span-1 flex justify-center"><input type="radio" name="status_OleoTransmissao" value="OK" checked required></div>
             <div class="col-span-6 text-left text-sm">Óleo da Transmissão</div>
             <div class="col-span-2 flex justify-center"><input type="radio" name="status_OleoTransmissao" value="NÃO CONFORME" data-target-textarea="relato_OleoTransmissao" onchange="window.toggleNonConformityReport(this)"></div>
             <div class="col-span-3"><textarea name="relato_OleoTransmissao" id="relato_OleoTransmissao" rows="1" placeholder="Relatar não conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea></div>
         </div>
         <div class="grid grid-cols-12 gap-2 items-center mb-3">
             <div class="col-span-1 flex justify-center"><input type="radio" name="status_Extintor" value="OK" checked required></div>
             <div class="col-span-6 text-left text-sm">Extintor</div>
             <div class="col-span-2 flex justify-center"><input type="radio" name="status_Extintor" value="NÃO CONFORME" data-target-textarea="relato_Extintor" onchange="window.toggleNonConformityReport(this)"></div>
             <div class="col-span-3"><textarea name="relato_Extintor" id="relato_Extintor" rows="1" placeholder="Relatar não conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea></div>
         </div>
         <div class="grid grid-cols-12 gap-2 items-center mb-3">
             <div class="col-span-1 flex justify-center"><input type="radio" name="status_Pneus" value="OK" checked required></div>
             <div class="col-span-6 text-left text-sm">Pneus</div>
             <div class="col-span-2 flex justify-center"><input type="radio" name="status_Pneus" value="NÃO CONFORME" data-target-textarea="relato_Pneus" onchange="window.toggleNonConformityReport(this)"></div>
             <div class="col-span-3"><textarea name="relato_Pneus" id="relato_Pneus" rows="1" placeholder="Relatar não conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea></div>
         </div>
         <div class="grid grid-cols-12 gap-2 items-center mb-3">
             <div class="col-span-1 flex justify-center"><input type="radio" name="status_ParteEletrica" value="OK" checked required></div>
             <div class="col-span-6 text-left text-sm">Parte Elétrica</div>
             <div class="col-span-2 flex justify-center"><input type="radio" name="status_ParteEletrica" value="NÃO CONFORME" data-target-textarea="relato_ParteEletrica" onchange="window.toggleNonConformityReport(this)"></div>
             <div class="col-span-3"><textarea name="relato_ParteEletrica" id="relato_ParteEletrica" rows="1" placeholder="Relatar não conformidade" class="hidden text-xs px-1 py-0.5 w-full border rounded"></textarea></div>
         </div>
       </div>
       <button class="btn dark-primary mt-6" type="button" onclick="window.enviarInicio(event)">Salvar Início</button>
       <div class="field mt-4">
         <label for="observacoesInicio">Observações</label>
         <textarea id="observacoesInicio" name="observacoesInicio" rows="3" placeholder="Observações adicionais"></textarea>
       </div>
     </form>
   </div>

   <div id="disponibilidade" style="display:none; margin-top:20px; padding: 20px; border-radius: 12px; background-color: rgba(218, 165, 32, 0.15); border: 2px solid #DAA520;">
     <h3>Disponibilidade</h3>
     <div id="disponibilidadeContent"><p class="text-gray-600">Nenhuma frota cadastrada ou atividade em andamento para exibir.</p></div>
     <div id="frotasEmManutencaoList" class="mt-8 p-6 border border-red-300 rounded-lg bg-red-50 shadow-md" style="display: none;">
       <h4 class="text-xl font-bold mb-4 text-red-700">Frotas em Manutenção</h4>
       <ul id="manutencaoItems" class="list-disc pl-5 text-red-600 text-base leading-relaxed"></ul>
     </div>
   </div>

   <div id="fim" style="display:none; margin-top:20px; padding: 20px; border-radius: 12px; background-color: rgba(52, 152, 219, 0.15); border: 2px solid #3498DB;">
     <h3>Fim de Atividade</h3>
     <form id="formFim">
       <div class="flex justify-end mb-4"><button class="btn dark-primary" type="button" onclick="window.limparFormulario('formFim')">Limpar Formulário</button></div>
       <div class="field">
         <label for="crachaFim">Crachá</label>
         <input type="text" name="crachaFim" id="crachaFim" oninput="this.value = this.value.toUpperCase(); window.handleCrachaFimChange();" required>
         <div class="search-icon" onclick="window.showOperatorSearchModal('crachaFim')">
           <svg class="w-6 h-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
         </div>
         <label for="nomeFim">Operador</label>
         <input type="text" id="nomeFim" readonly>
         <img id="fotoFim" src="https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR" alt="Foto Operador">
       </div>
       <div class="field">
         <label for="dataFinal">Data Final</label>
         <input type="date" name="dataFinal" id="dataFinal" required onclick="window.confirmAndSetDateTime('dataFinal', 'horaFinal')">
       </div>
       <div class="field">
         <label for="horaFinal">Hora Final</label>
         <input type="text" id="horaFinal" name="horaFinal" required placeholder="HH:mm" oninput="this.value = this.value.replace(/\D/g, '').replace(/(\d{2})(\d)/, '$1:$2').slice(0, 5)">
       </div>
       <div class="field">
         <label for="frotaFim">Frota</label>
         <input type="text" name="frotaFim" id="frotaFim" oninput="this.value = this.value.toUpperCase(); window.mostrarModeloFrota(this.value,'equipamentoFim','fotoEquipFim')" required>
         <img id="fotoEquipFim" src="https://placehold.co/100x100/A0AEC0/000000?text=FROTA" alt="Foto Frota">
       </div>
       <div class="field" id="frotaSelectionContainer" style="display:none;">
           <label for="selectFrotaAtiva">Selecione a Frota:</label>
           <div id="multipleFrotaWarning" class="text-red-700 font-semibold mb-2" style="display:none;"></div>
           <select id="selectFrotaAtiva" onchange="window.selecionarFrotaAtiva(this.value)"></select>
       </div>
       <div class="field">
         <label for="equipamentoFim">Equipamento</label>
         <input type="text" id="equipamentoFim" readonly>
       </div>
       <div class="field">
         <label for="horimetroFim">Horímetro Final</label>
         <input type="text" name="horimetroFim" id="horimetroFim" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" onblur="window.validateHorimetro('horimetroFim', 'frotaFim')" required>
       </div>
       <div class="field">
         <label for="observacoesFim">Observações</label>
         <textarea name="observacoesFim" id="observacoesFim" rows="3"></textarea>
       </div>
       <button class="btn dark-primary mt-6" type="button" onclick="window.enviarFim(event)">Finalizar</button>
     </form>
   </div>

   <div id="cadastro" class="admin-panel">
     <h3>Cadastro</h3>
     <div class="menu-vertical">
       <button class="btn" onclick="window.mostrarCadastro('cadastroOperador')">Operador</button>
       <button class="btn" onclick="window.mostrarCadastro('cadastroFrota')">Frota</button>
       <button class="btn" onclick="window.mostrarCadastro('cadastroImplemento')">Implemento</button>
       <button class="btn" onclick="window.mostrarCadastro('cadastroSetor')">Setor</button>
       <button class="btn" onclick="window.mostrarCadastro('cadastroAtividade')">Atividade</button>
       <button class="btn" onclick="window.mostrarCadastro('associarAtividadeSetor')">Associar Atividade/Setor</button>
     </div>
     <div id="cadastroOperador" style="display:none; margin-top:10px;">
       <h4>Cadastro de Operador</h4>
       <form><div class="field"><label for="crachaOperador">Crachá</label><input type="text" id="crachaOperador" oninput="this.value = this.value.toUpperCase()"></div>
       <div class="field"><label for="nomeOperador">Operador</label><input type="text" id="nomeOperador" oninput="this.value = this.value.toUpperCase()"></div>
       <div class="field"><label for="fotoOperador">Foto</label><input type="file" id="fotoOperador" accept="image/*" capture></div>
       <div class="flex justify-start gap-4 mt-6"><button class="btn dark-primary" type="button" onclick="window.salvarOperador()">Salvar</button><button class="btn dark-primary" type="button" onclick="window.consultarOperador()">Consultar</button></div></form>
     </div>
     <div id="cadastroFrota" style="display:none; margin-top:10px;">
       <h4>Cadastro de Frota</h4>
       <form><div class="field"><label for="codigoFrota">Frota</label><input type="text" id="codigoFrota" oninput="this.value = this.value.toUpperCase()"></div>
       <div class="field"><label for="modeloFrota">Modelo</label><input type="text" id="modeloFrota" oninput="this.value = this.value.toUpperCase()"></div>
       <div class="field"><label for="fotoFrota">Foto</label><input type="file" id="fotoFrota" accept="image/*" capture></div>
       <div class="flex justify-start gap-4 mt-6"><button class="btn dark-primary" type="button" onclick="window.salvarFrota()">Salvar</button><button class="btn dark-primary" type="button" onclick="window.consultarFrota()">Consultar</button><button class="btn dark-primary" type="button" onclick="window.mostrarCadastro('cadastroCompletoFrota')">Cadastro Completo</button></div></form>
     </div>
     <div id="cadastroSetor" style="display:none; margin-top:10px;">
       <h4>Cadastro de Setor</h4>
       <div class="field"><label for="nomeSetor">Setor</label><input type="text" id="nomeSetor" oninput="this.value = this.value.toUpperCase()"></div>
       <div class="flex justify-start gap-4 mt-6"><button class="btn dark-primary" onclick="window.salvarSetor()">Salvar</button><button class="btn dark-primary" onclick="window.consultarSetor()">Consultar</button></div>
     </div>
     <div id="cadastroAtividade" style="display:none; margin-top:10px;">
       <h4>Cadastro de Atividade</h4>
       <div class="field"><label for="nomeAtividade">Atividade</label><input type="text" id="nomeAtividade" oninput="this.value = this.value.toUpperCase()"></div>
       <div class="flex justify-start gap-4 mt-6"><button class="btn dark-primary" type="button" onclick="window.salvarAtividade()">Salvar</button><button class="btn dark-primary" type="button" onclick="window.consultarAtividade()">Consultar</button></div></form>
     </div>
     <div id="cadastroCompletoFrota" style="display:none; margin-top:10px;">
       <h4>Cadastro Completo de Frota</h4>
       <div class="field"><label for="cadCompletoCodigoFrota">Frota</label><input type="text" id="cadCompletoCodigoFrota" placeholder="Informe a frota" oninput="this.value = this.value.toUpperCase()"></div>
       <div class="field"><label for="numeroEixos">Número de Eixos</label><input type="number" id="numeroEixos" min="1" max="10" value="2" onchange="window.renderEstruturaEixos()"></div>
       <div class="field"><label for="pneusPorEixo">Pneus por Eixo</label><input type="number" id="pneusPorEixo" min="2" max="12" value="4" onchange="window.renderEstruturaEixos()"></div>
       <div id="estruturaEixosContainer" class="mt-4"></div>
       <div class="flex justify-start gap-4 mt-6">
         <button class="btn dark-primary" type="button" onclick="window.salvarCadastroCompletoFrota()">Salvar Configuração</button>
       </div>
     </div>
     <div id="cadastroImplemento" style="display:none; margin-top:10px;">
       <h4>Cadastro de Implemento</h4>
       <div class="field"><label for="nomeImplemento">Implemento</label><input type="text" id="nomeImplemento" oninput="this.value = this.value.toUpperCase()"></div>
       <div class="field"><label for="siglaImplemento">Sigla</label><input type="text" id="siglaImplemento" required oninput="this.value = this.value.toUpperCase()"></div>
       <div class="field"><label for="modeloImplemento">Associar aos Modelos</label><select id="modeloImplemento" multiple></select></div>
       <div class="flex justify-start gap-4 mt-6"><button class="btn dark-primary" onclick="window.salvarImplemento()">Salvar</button><button class="btn dark-primary" type="button" onclick="window.consultarImplemento()">Consultar</button></div>
     </div>
     <div id="associarAtividadeSetor" style="display:none; margin-top:10px;">
         <h4>Associar Atividades a Setores</h4>
         <div class="field">
             <label for="selectSetorParaAssociar">Selecione um Setor</label>
             <select id="selectSetorParaAssociar" onchange="window.loadAtividadesParaSetor(this.value)"></select>
         </div>
         <div id="associacaoContainer" class="association-container" style="display:none;">
             <div id="atividadesDisponiveis" class="association-list">
                 <h5>Atividades Disponíveis</h5>
                 <div id="listaAtividadesDisponiveis"></div>
             </div>
             <div id="atividadesAssociadas" class="association-list">
                 <h5>Atividades Associadas</h5>
                 <div id="listaAtividadesAssociadas"></div>
             </div>
         </div>
         <button class="btn dark-primary mt-4" onclick="window.salvarAssociacaoAtividadeSetor()">Salvar Associação</button>
     </div>
   </div>

   <div id="administrador" class="admin-panel">
     <h3>Painel Administrativo</h3>
     <div id="adminDashboard" style="display:none; margin-top:20px;">
       <h4>Bem-vindo, <span id="loggedInUserEmailDisplay"></span>!</h4>
       <p class="mb-4 text-gray-700">Você está logado com acesso de <span id="loggedInUserLevelDisplay" class="font-bold"></span>.</p>
       <div id="userManagement" class="mt-8 p-6 border border-blue-300 rounded-lg bg-blue-50 shadow-md" style="display: none;">
         <h4 class="text-xl font-bold mb-4 text-blue-800">Gerenciamento de Usuários</h4>
         <div class="field"><label for="newUsername">Usuário</label><input type="text" id="newUsername" placeholder="nome.sobrenome" required></div>
         <div class="field"><label for="newUserPassword">Senha de Acesso</label><input type="password" id="newUserPassword" placeholder="Mínimo 6 caracteres" required></div>
         <div class="field">
             <label for="newUserLevel">Nível de Acesso</label>
             <select id="newUserLevel" required>
                 <option value="">Selecione o Nível</option>
                 <option value="operacao">Operação</option>
                 <option value="operacao_2">Operação II</option>
                 <option value="analista">Analista</option>
                 <option value="administrador">Administrador</option>
             </select>
         </div>
         <button class="btn dark-primary mt-6" onclick="window.salvarUsuario()">Criar Novo Usuário</button>
         <h5 class="font-bold mt-8 mb-4 text-gray-700">Usuários Cadastrados:</h5>
         <div id="userListContainer" class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg bg-white shadow-inner">
           <table class="min-w-full divide-y divide-gray-200">
             <thead class="bg-gray-50">
               <tr>
                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuário (Email)</th>
                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nível</th>
                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
               </tr>
             </thead>
             <tbody id="userList" class="bg-white divide-y divide-gray-200"></tbody>
           </table>
         </div>
       </div>
     </div>
   </div>

   <div id="relatorio" style="display:none; margin-top:20px;">
     <h3>Relatórios</h3>
     <div class="field">
         <label for="tipoRelatorio">Tipo de Relatório</label>
         <select id="tipoRelatorio">
             <option value="horasFrota">Horas por Frota</option>
             <option value="atividadesOperador">Atividades por Operador</option>
             <option value="manutencoes">Manutenções</option>
             <option value="disponibilidade">Tempo de Disponibilidade de Frotas</option>
             <option value="comparativoHoras">Horímetro vs. Apontamento</option>
             <option value="atividades">Relatório de Atividades</option>
             <option value="setor">Relatório por Setor</option>
             <option value="edicoes">Relatório de Apontamentos Inconsistentes</option>
             <option value="consumoFrota">Consumo por Frota</option>
             <option value="custosCombustivel">Custos de Combustível</option>
         </select>
     </div>
     <div class="field">
       <label for="relatorioDataInicio">Data de Início</label>
       <input type="date" id="relatorioDataInicio">
     </div>
     <div class="field">
       <label for="relatorioDataFim">Data de Fim</label>
       <input type="date" id="relatorioDataFim">
     </div>
     <button class="btn dark-primary mt-4" onclick="window.gerarRelatorio()">Gerar Relatório</button>
     <button class="btn dark-primary mt-4" onclick="window.mostrar('dados')">Dados</button>
     <div id="relatorioResultado" class="mt-6"></div>
   </div>

   <div id="dados" style="display:none; margin-top:20px;">
     <h3>Banco de Dados de Lançamentos</h3>
     <p class="text-gray-600 mb-4">Visualize e gerencie todos os lançamentos históricos.</p>
     <div id="dadosContent" class="mt-4"></div>
   </div>
</div>

<!-- Maintenance Panel -->
<div class="card" id="manutencaoPanel" style="display:none;">
   <div class="app-header">
         <div class="flex items-center gap-4">
             <img alt="Logotipo da Empresa" class="h-14 logo-img">
             <h2 class="panel-title" style="margin-bottom: 0;"></h2>
         </div>
         <div class="header-actions">
             <!-- Notificações e usuário (removidos do header interno, ficam no menu superior) -->
             <button class="btn dark-primary back-button" onclick="window.showApp('gestaoDeFrotasPanel')">Voltar</button>
             <!-- Botão Sair (removido do header interno, fica no menu superior) -->
         </div>
     </div>
   <div class="menu-vertical mb-6">
       <button class="btn" onclick="window.mostrarManutencaoSubpanel('formAbrirOS')">Abrir Ordem de Serviço</button>
       <button class="btn" onclick="window.mostrarManutencaoSubpanel('formPlanosManutencao')">Planos de Manutenção</button>
       <button class="btn" onclick="window.mostrarManutencaoSubpanel('consultarOS')">Consultar Ordens de Serviço</button>
       <button class="btn" onclick="window.mostrarManutencaoSubpanel('gestaoPecas')">Gestão de Peças</button>
       <button class="btn" onclick="window.mostrarManutencaoSubpanel('orcamentosAprovacoes')">Orçamentos e Aprovações</button>
       <button class="btn" onclick="window.mostrarManutencaoSubpanel('historicoManutencao')">Histórico de Manutenção</button>
   </div>

     <div id="formAbrirOS" style="display:none;">
         <h4>Abrir Ordem de Serviço</h4>
         <form id="osForm">
             <div class="field"><label for="osFrota">Frota</label><input type="text" id="osFrota" oninput="this.value = this.value.toUpperCase(); window.mostrarModeloFrota(this.value, 'osModelo')" required><input type="text" id="osModelo" readonly placeholder="Modelo"></div>
             <div class="field"><label for="osDataAbertura">Data Abertura</label><input type="text" id="osDataAbertura" readonly></div>
             <div class="field">
                 <label for="osCrachaSolicitante">Crachá Solicitante</label>
                 <input type="text" id="osCrachaSolicitante" oninput="this.value = this.value.toUpperCase(); window.buscarOperador(this.value, 'osNomeSolicitante')" required>
                 <div class="search-icon" onclick="window.showOperatorSearchModal('osCrachaSolicitante')">
                     <svg class="w-6 h-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
                 </div>
                 <input type="text" id="osNomeSolicitante" readonly placeholder="Nome do Solicitante">
             </div>
             <div class="field"><label for="osDescricao">Descrição do Problema</label><textarea id="osDescricao" rows="3" required></textarea></div>
             <div class="field"><label for="osTipo">Tipo</label><select id="osTipo"><option value="Corretiva">Corretiva</option><option value="Preventiva">Preventiva</option></select></div>
             <div class="field"><label for="osAgenteCausador">Agente Causador</label><input type="text" id="osAgenteCausador" oninput="this.value = this.value.toUpperCase()"></div>
             <div class="field"><label for="osHorimetro">Horímetro</label><input type="text" id="osHorimetro" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"></div>
             <button class="btn dark-primary mt-4" type="button" onclick="window.salvarOS()">Abrir OS</button>
         </form>
     </div>
     <div id="formPlanosManutencao" style="display:none;">
         <h4>Planos de Manutenção</h4>
         <form id="planosManutencaoForm">
             <div class="field"><label for="planoFrota">Frota</label><input type="text" id="planoFrota" oninput="this.value = this.value.toUpperCase(); window.mostrarModeloFrota(this.value, 'planoModelo')" required><input type="text" id="planoModelo" readonly placeholder="Modelo"></div>
             <div class="field"><label for="planoDescricao">Descrição</label><textarea id="planoDescricao" rows="2" required></textarea></div>
             <div class="field"><label for="tipoManutencao">Tipo</label><select id="tipoManutencao" required><option value="Horímetro">Baseado em Horímetro</option><option value="Tempo">Baseado em Tempo</option></select></div>
             <div class="field" id="horimetroIntervalField"><label for="horimetroInterval">Intervalo (Horímetro)</label><input type="text" id="horimetroInterval" oninput="this.value = this.value.replace(/[^0-9.]/g, '')"></div>
             <div class="field" id="tempoIntervalField" style="display:none;"><label for="tempoInterval">Intervalo (dias)</label><input type="text" id="tempoInterval" oninput="this.value = this.value.replace(/[^0-9]/g, '')"></div>
             <div class="field"><label for="ultimaManutencao">Última Manutenção</label><input type="date" id="ultimaManutencao"></div>
             <button class="btn dark-primary mt-4" type="button" onclick="window.salvarPlanoManutencao()">Salvar Plano</button>
         </form>
         <div id="planosManutencaoListContainer" class="mt-6">
             <h4>Planos Cadastrados</h4>
             <div id="planosManutencaoTable"></div>
         </div>
     </div>
     <div id="consultarOS" style="display:none;">
         <h4>Consultar Ordens de Serviço</h4>
         <div id="osListContainer">
             <p class="text-gray-600">Nenhuma Ordem de Serviço para exibir.</p>
         </div>
     </div>
     <div id="gestaoPecas" style="display:none;">
         <h4>Gestão de Peças</h4>
         <form id="pecaForm">
             <div class="field"><label for="nomePeca">Nome da Peça</label><input type="text" id="nomePeca" required></div>
             <div class="field"><label for="codPeca">Cód. Peça</label><input type="text" id="codPeca"></div>
             <div class="field"><label for="stockPeca">Stock</label><input type="number" id="stockPeca" required min="0"></div>
             <div class="field"><label for="minStockPeca">Stock Mínimo</label><input type="number" id="minStockPeca" min="0"></div>
             <div class="field"><label for="custoPeca">Custo Unitário (R$)</label><input type="text" id="custoPeca" oninput="this.value = this.value.replace(/[^0-9.]/g, '')"></div>
             <button class="btn dark-primary mt-4" type="button" onclick="window.salvarPeca()">Salvar Peça</button>
         </form>
         <div id="pecasListContainer" class="mt-6">
             <h4>Inventário de Peças</h4>
             <div id="pecasTable"></div>
         </div>
     </div>
     <div id="orcamentosAprovacoes" style="display:none;">
         <h4>Orçamentos e Aprovações</h4>
         <form id="orcamentoForm">
             <div class="field"><label for="orcamentoOsId">OS ID</label><input type="text" id="orcamentoOsId" oninput="this.value = this.value.replace(/[^0-9]/g, '')" required></div>
             <div class="field"><label for="orcamentoDescricao">Descrição Orçamento</label><textarea id="orcamentoDescricao" rows="2"></textarea></div>
             <div class="field"><label for="orcamentoValor">Valor Estimado (R$)</label><input type="text" id="orcamentoValor" oninput="this.value = this.value.replace(/[^0-9.]/g, '')" required></div>
             <button class="btn dark-primary mt-4" type="button" onclick="window.salvarOrcamento()">Submeter Orçamento</button>
         </form>
         <div id="orcamentosListContainer" class="mt-6">
             <h4>Orçamentos Pendentes</h4>
             <div id="orcamentosTable"></div>
         </div>
     </div>
     <div id="historicoManutencao" style="display:none;">
         <h4>Histórico de Manutenção</h4>
         <div class="field"><label for="historicoFrotaFilter">Filtrar por Frota</label><input type="text" id="historicoFrotaFilter" oninput="this.value = this.value.toUpperCase(); window.consultarHistoricoManutencao()"></div>
         <div id="historicoManutencaoListContainer" class="mt-4">
             <p class="text-gray-600">Nenhum histórico de manutenção para exibir.</p>
         </div>
     </div>
</div>


<!-- Fueling Panel -->
<div class="card" id="abastecimentoPanel" style="display:none;">
   <div class="app-header">
         <div class="flex items-center gap-4">
             <img alt="Logotipo da Empresa" class="h-14 logo-img">
             <h2 class="panel-title" style="margin-bottom: 0;"></h2>
         </div>
         <div class="header-actions">
             <!-- Notificações e usuário (removidos do header interno, ficam no menu superior) -->
             <button class="btn dark-primary back-button" onclick="window.showApp('gestaoDeFrotasPanel')">Voltar</button>
             <!-- Botão Sair (removido do header interno, fica no menu superior) -->
         </div>
     </div>
   <div class="menu-vertical mb-6">
       <button class="btn" onclick="window.mostrarAbastecimentoSubpanel('formAbastecimento')">Registrar Abastecimento</button>
       <button class="btn" onclick="window.mostrarAbastecimentoSubpanel('formCompraCombustivel')">Registrar Compra de Combustível</button>
   </div>
   <div id="formAbastecimento" style="display:none;">
         <h4>Registrar Abastecimento</h4>
         <form id="abastecimentoForm">
             <div class="field"><label for="abastecimentoFrota">Frota</label><input type="text" id="abastecimentoFrota" oninput="this.value = this.value.toUpperCase(); window.mostrarModeloFrota(this.value, 'abastecimentoModelo')" required><input type="text" id="abastecimentoModelo" readonly placeholder="Modelo"></div>
             <div class="field"><label for="abastecimentoDoc">Documento/NF</label><input type="text" id="abastecimentoDoc" required></div>
             <div class="field"><label for="abastecimentoEmpresa">Empresa</label><input type="text" id="abastecimentoEmpresa" required></div>
             <div class="field"><label for="abastecimentoHorimetro">Horímetro</label><input type="text" id="abastecimentoHorimetro" oninput="this.value = this.value.replace(/[^0-9.]/g, '')" required></div>
             <div class="field"><label for="abastecimentoData">Data</label><input type="date" id="abastecimentoData" required></div>
             <div class="field"><label for="abastecimentoHora">Hora</label><input type="text" id="abastecimentoHora" required placeholder="HH:mm" oninput="this.value = this.value.replace(/\D/g, '').replace(/(\d{2})(\d)/, '$1:$2').slice(0, 5)"></div>
             <div class="field"><label for="abastecimentoMotorista">Crachá Motorista</label><input type="text" id="abastecimentoMotorista" oninput="this.value = this.value.toUpperCase(); window.buscarOperador(this.value, 'nomeMotorista')" required><input type="text" id="nomeMotorista" readonly placeholder="Nome do Motorista"></div>
             <div class="field"><label for="abastecimentoFrentista">Crachá Frentista</label><input type="text" id="abastecimentoFrentista" oninput="this.value = this.value.toUpperCase(); window.buscarOperador(this.value, 'nomeFrentista')" required><input type="text" id="nomeFrentista" readonly placeholder="Nome do Frentista"></div>
             <div class="field"><label for="abastecimentoCodProduto">Cód. Produto</label><input type="text" id="abastecimentoCodProduto" oninput="this.value = this.value.toUpperCase(); window.buscarProduto(this.value, 'nomeProduto')" required><input type="text" id="nomeProduto" readonly placeholder="Nome do Produto"></div>
             <div class="field"><label for="abastecimentoLocal">Local</label><select id="abastecimentoLocal" onchange="window.toggleVolumeRestante(this.value)"><option value="interno">Dentro da Empresa</option><option value="externo">Fora da Empresa</option></select></div>
             <div class="field" id="volumeRestanteField"><label for="volumeRestante">Volume Restante</label><input type="text" id="volumeRestante" readonly></div>
             <button class="btn dark-primary mt-4" type="button" onclick="window.salvarAbastecimento()">Salvar</button>
         </form>
     </div>
     <div id="formCompraCombustivel" style="display:none;">
         <h4>Registrar Compra de Combustível</h4>
         <form id="compraCombustivelForm">
             <div class="field"><label for="compraCodProduto">Cód. Produto</label><input type="text" id="compraCodProduto" oninput="this.value = this.value.toUpperCase();" required></div>
             <div class="field"><label for="compraEmpresa">Empresa Comprado</label><input type="text" id="compraEmpresa" required></div>
             <div class="field"><label for="compraVolume">Volume (L)</label><input type="text" id="compraVolume" oninput="this.value = this.value.replace(/[^0-9.]/g, '')" required></div>
             <div class="field"><label for="compraValor">Valor (R$)</label><input type="text" id="compraValor" oninput="this.value = this.value.replace(/[^0-9.]/g, '')" required></div>
             <button class="btn dark-primary mt-4" type="button" onclick="window.salvarCompraCombustivel()">Salvar Compra</button>
         </form>
     </div>
</div>

<!-- Tires Panel -->
<div class="card" id="pneusPanel" style="display:none;">
   <div class="app-header">
         <div class="flex items-center gap-4">
             <img alt="Logotipo da Empresa" class="h-14 logo-img">
             <h2 class="panel-title" style="margin-bottom: 0;"></h2>
         </div>
         <div class="header-actions">
             <!-- Notificações e usuário (removidos do header interno, ficam no menu superior) -->
             <button class="btn dark-primary back-button" onclick="window.showApp('gestaoDeFrotasPanel')">Voltar</button>
             <!-- Botão Sair (removido do header interno, fica no menu superior) -->
         </div>
     </div>
   <div class="menu-vertical mb-6">
       <button class="btn" onclick="window.mostrarPneusSubpanel('formCadastroPneu')">Cadastrar Pneu</button>
       <button class="btn" onclick="window.mostrarPneusSubpanel('consultarPneus')">Consultar Pneus</button>
       <button class="btn" onclick="window.mostrarPneusSubpanel('alocarPneusPanel')">Alocar Pneu</button>
   </div>
   <div id="formCadastroPneu" style="display:none;">
         <h4>Cadastro de Pneu</h4>
         <form id="pneuForm">
             <div class="field"><label for="pneuId">ID do Pneu (DOT)</label><input type="text" id="pneuId" required></div>
             <div class="field"><label for="pneuMarca">Marca</label><input type="text" id="pneuMarca" required></div>
             <div class="field"><label for="pneuModelo">Modelo</label><input type="text" id="pneuModelo" required></div>
             <div class="field"><label for="pneuDataCompra">Data da Compra</label><input type="date" id="pneuDataCompra" required></div>
             <div class="field"><label for="pneuFrotaInstalado">Frota Instalado</label><input type="text" id="pneuFrotaInstalado" oninput="this.value = this.value.toUpperCase();"></div>
             <div class="field"><label for="pneuPosicao">Posição</label><input type="text" id="pneuPosicao" placeholder="Ex: Dianteiro Esquerdo"></div>
             <button class="btn dark-primary mt-4" type="button" onclick="window.salvarPneu()">Salvar Pneu</button>
         </form>
     </div>
     <div id="consultarPneus" style="display:none;">
         <h4>Pneus Cadastrados</h4>
         <div id="pneusListContainer"></div>
     </div>
     <div id="alocarPneusPanel" style="display:none;">
         <h4>Alocar Pneu</h4>
         <div class="field">
             <label for="alocacaoFrota">Selecione a Frota</label>
             <select id="alocacaoFrota" onchange="window.renderMapaPneus(this.value)"></select>
         </div>
         <div id="mapaPneusContainer" class="mt-4"></div>
     </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmationModal" class="modal">
   <div class="modal-content" id="modalContent">
       <h3 id="modalTitle">Confirmação</h3>
       <p id="modalMessage">Você tem certeza?</p>
       <div class="modal-buttons">
           <button id="modalConfirmBtn" class="btn dark-primary">Confirmar</button>
           <button id="modalCancelBtn" class="btn dark-primary">Cancelar</button>
       </div>
   </div>
</div>

<!-- List Display Modal -->
<div id="listModal" class="modal">
   <div class="modal-content">
       <h3 id="listModalTitle">Itens Cadastrados</h3>
       <div id="listModalContent" class="modal-list-content"></div>
       <div class="modal-buttons mt-4">
           <button id="listModalCloseBtn" class="btn dark-primary">Fechar</button>
       </div>
   </div>
</div>

<!-- Generic Edit Modal -->
<div id="editModal" class="modal">
   <div class="modal-content">
       <h3 id="editModalTitle">Editar Item</h3>
       <form id="editForm" class="text-left"></form>
       <div class="modal-buttons mt-6">
           <button id="editModalSaveBtn" class="btn dark-primary">Salvar</button>
           <button id="editModalCancelBtn" class="btn dark-primary">Cancelar</button>
       </div>
   </div>
</div>

<div id="notification-panel-container" class="relative">
     <div id="notification-panel"></div>
</div>

<script type="module">
    // --- FIREBASE SETUP ---
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        signInWithEmailAndPassword, 
        signOut,
        createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        getDoc, 
        setDoc, 
        addDoc, 
        updateDoc, 
        deleteDoc, 
        collection, 
        getDocs, 
        query, 
        where, 
        onSnapshot,
        writeBatch,
        orderBy,
        limit,
        runTransaction
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { 
        getStorage, 
        ref, 
        uploadBytes, 
        getDownloadURL,
        deleteObject
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBcGZ7GXAbYTPg2YZjtpuCMdmSv4ue7Q8Q",
      authDomain: "gestaodefrotasapp-4f48f.firebaseapp.com",
      projectId: "gestaodefrotasapp-4f48f",
      storageBucket: "gestaodefrotasapp-4f48f.appspot.com",
      messagingSenderId: "105185091527",
      appId: "1:105185091527:web:1cbb47dcf8f9e3c56c83e2"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
   
    console.log("Firebase initialized.");

    // --- GLOBAL STATE ---
    let currentUser = null;
    let currentUserRole = 'operacao'; // Default role
    let unsubscribeDisponibilidade = null; // To detach the real-time listener
    const DUMMY_DOMAIN = '@gestaodefrotas.app'; // Domain for creating emails from usernames
    let utilizationChartInstance = null;
    let operatorChartInstance = null;
    // --- NOTIFICATIONS STATE & FUNCTIONS ---
    let unsubscribeNotificationsHistorico = null;
    let unsubscribeNotificationsAtividades = null;
    let notifications = [];

    function updateNotificationBadge() {
        const count = notifications.length;
        document.querySelectorAll('.notification-badge').forEach(badge => {
            if (count > 0) {
                badge.textContent = String(count);
                badge.style.display = 'inline-block';
            } else {
                badge.textContent = '';
                badge.style.display = 'none';
            }
        });
    }

    function renderNotificationsPanel() {
        const panel = document.getElementById('notification-panel');
        if (!panel) return;
        if (notifications.length === 0) {
            panel.innerHTML = '<div class="notification-item">Nenhuma notificação no momento.</div>';
            return;
        }
        panel.innerHTML = notifications.slice(0, 50).map(n => `<div class="notification-item">${n.text}</div>`).join('');
    }

    window.toggleNotificationPanel = function() {
        const panel = document.getElementById('notification-panel');
        if (!panel) return;
        const isVisible = panel.style.display === 'block';
        panel.style.display = isVisible ? 'none' : 'block';
        if (!isVisible) {
            const topMenu = document.querySelector('.top-menu');
            if (topMenu) {
                const rect = topMenu.getBoundingClientRect();
                panel.style.position = 'fixed';
                panel.style.top = `${rect.bottom + 8}px`;
                panel.style.right = '16px';
            }
            renderNotificationsPanel();
        }
    };

    function initNotificationListeners() {
        // Reinicia estado
        cleanupNotificationListeners();
        notifications = [];
        updateNotificationBadge();

        // Inconsistências no histórico de atividades
        try {
            const qHist = query(collection(db, 'historicoAtividades'), where('inconsistente', '==', true));
            unsubscribeNotificationsHistorico = onSnapshot(qHist, (snapshot) => {
                const items = snapshot.docs.map(docSnap => {
                    const d = docSnap.data();
                    const cracha = d.cracha || (d.atividadeAberta && d.atividadeAberta.cracha) || 'CRA';
                    const frota = d.frota || (d.atividadeAberta && d.atividadeAberta.frota) || 'FROTA';
                    const dataFinal = d.dataFinal || (d.atividadeAberta && d.atividadeAberta.dataInicial) || '';
                    const horaFinal = d.horaFinal || (d.atividadeAberta && d.atividadeAberta.horaInicial) || '';
                    const whenStr = (dataFinal && horaFinal) ? `${dataFinal} ${horaFinal}` : '';
                    return { id: `hist-${docSnap.id}`, type: 'inconsistente', text: `Apontamento inconsistente: Crachá ${cracha} • Frota ${frota} • ${whenStr}` };
                });
                // Remove antigos e adiciona novos do tipo inconsistente
                notifications = notifications.filter(n => n.type !== 'inconsistente').concat(items);
                // Deduplicar
                const seen = new Set();
                notifications = notifications.filter(n => { if (seen.has(n.id)) return false; seen.add(n.id); return true; });
                updateNotificationBadge();
                const panel = document.getElementById('notification-panel');
                if (panel && panel.style.display === 'block') renderNotificationsPanel();
            }, (error) => {
                console.warn('Erro no listener de inconsistentes:', error);
            });
        } catch (e) { console.warn('Falha ao iniciar listener de historico:', e); }

        // Atividades em andamento
        try {
            const qAtiv = collection(db, 'atividadesEmAndamento');
            unsubscribeNotificationsAtividades = onSnapshot(qAtiv, (snapshot) => {
                const count = snapshot.docs.length;
                const item = { id: 'atividades-summary', type: 'andamento', text: count > 0 ? `Atividades em andamento: ${count}` : '' };
                notifications = notifications.filter(n => n.type !== 'andamento');
                if (item.text) notifications.unshift(item);
                updateNotificationBadge();
                const panel = document.getElementById('notification-panel');
                if (panel && panel.style.display === 'block') renderNotificationsPanel();
            }, (error) => { console.warn('Erro no listener de atividades em andamento:', error); });
        } catch (e) { console.warn('Falha ao iniciar listener de atividades:', e); }
    }

    function cleanupNotificationListeners() {
        if (unsubscribeNotificationsHistorico) { try { unsubscribeNotificationsHistorico(); } catch(e){} unsubscribeNotificationsHistorico = null; }
        if (unsubscribeNotificationsAtividades) { try { unsubscribeNotificationsAtividades(); } catch(e){} unsubscribeNotificationsAtividades = null; }
        notifications = [];
        updateNotificationBadge();
        const panel = document.getElementById('notification-panel');
        if (panel) panel.style.display = 'none';
    }

    // Carregar gráficos do Dashboard (Utilização por Frota e Atividades por Operador)
    window.loadDashboard = async function() {
        try {
            // Verifica Chart.js
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js não carregado');
                return;
            }

            const utilCanvas = document.getElementById('utilizationChart');
            const opCanvas = document.getElementById('operatorChart');
            if (!utilCanvas || !opCanvas) return;

            const ctxUtil = utilCanvas.getContext('2d');
            const ctxOp = opCanvas.getContext('2d');

            // Destroi instâncias anteriores para evitar vazamento de memória
            if (utilizationChartInstance) { utilizationChartInstance.destroy(); utilizationChartInstance = null; }
            if (operatorChartInstance) { operatorChartInstance.destroy(); operatorChartInstance = null; }

            // Coleta dados do histórico e aplica filtros do Dashboard (período, frota e operador)
            const inicioJanela = new Date();
            inicioJanela.setDate(inicioJanela.getDate() - 60);

            // Ler filtros da UI
            const startDateStr = (document.getElementById('dashboardStartDate')?.value || '').trim();
            const endDateStr = (document.getElementById('dashboardEndDate')?.value || '').trim();

            const startTS = startDateStr ? new Date(`${startDateStr}T00:00`).getTime() : null;
            const endTS = endDateStr ? new Date(`${endDateStr}T23:59:59`).getTime() : null;

            const frotaSelectEl = document.getElementById('dashboardFrotaFilter');
            const operadorSelectEl = document.getElementById('dashboardOperadorFilter');
            const frotaFilters = frotaSelectEl ? Array.from(frotaSelectEl.selectedOptions).map(o => o.value.toUpperCase()).filter(Boolean) : [];
            const operadorFilters = operadorSelectEl ? Array.from(operadorSelectEl.selectedOptions).map(o => o.value.toUpperCase()).filter(Boolean) : [];

            const historicoSnap = await getDocs(query(collection(db, 'historicoAtividades'), orderBy('dataFinal', 'desc'), limit(1000)));
            const frotaHoras = {};
            const operadorAtividades = {};

            historicoSnap.forEach(docSnap => {
                const d = docSnap.data();
                if (d.inconsistente) return; // Ignora registros inconsistentes

                const df = d.dataFinal || d.dataInicial;
                const hf = d.horaFinal || d.horaInicial;
                let fimTs = NaN;
                if (df && hf) {
                    fimTs = new Date(`${df}T${hf}`).getTime();
                }

                // Verificar janela temporal: usa período informado se presente; caso contrário, últimos 60 dias
                let dentroJanela = true;
                if (!isNaN(fimTs)) {
                    if (startTS !== null) dentroJanela = dentroJanela && (fimTs >= startTS);
                    if (endTS !== null) dentroJanela = dentroJanela && (fimTs <= endTS);
                    if (startTS === null && endTS === null) {
                        dentroJanela = fimTs >= inicioJanela.getTime();
                    }
                } else {
                    // Se não há data/hora, considera dentro apenas quando não há filtro de período explícito
                    dentroJanela = (startTS === null && endTS === null) ? true : false;
                }
                if (!dentroJanela) return;

                const frotaVal = (d.frota || d.equipamento || 'N/D').toString().toUpperCase();
                const operadorVal = (d.operador || d.cracha || 'N/D').toString().toUpperCase();

                // Aplicar filtros de Frota/Operador (aceita múltiplos valores separados por vírgula e também correspondência parcial)
                const frotaOk = frotaFilters.length === 0 ? true : frotaFilters.some(f => f && (frotaVal === f || frotaVal.includes(f)));
                const operadorOk = operadorFilters.length === 0 ? true : operadorFilters.some(o => o && (operadorVal === o || operadorVal.includes(o)));
                if (!frotaOk || !operadorOk) return;

                let horas = parseFloat(d.horasHorimetro);
                if (isNaN(horas)) {
                    const di = d.dataInicial, hi = d.horaInicial;
                    const df2 = d.dataFinal, hf2 = d.horaFinal;
                    if (di && hi && df2 && hf2) {
                        const ts1 = new Date(`${di}T${hi}`).getTime();
                        const ts2 = new Date(`${df2}T${hf2}`).getTime();
                        horas = (ts2 - ts1) / 3600000; // horas por diferença de tempo
                    } else {
                        horas = 0;
                    }
                }

                frotaHoras[frotaVal] = (frotaHoras[frotaVal] || 0) + Math.max(0, horas);
                operadorAtividades[operadorVal] = (operadorAtividades[operadorVal] || 0) + 1;
            });

            // Ordena e limita Top 10 para melhor legibilidade
            const frotaEntries = Object.entries(frotaHoras).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const operatorEntries = Object.entries(operadorAtividades).sort((a, b) => b[1] - a[1]).slice(0, 10);

            const utilLabels = frotaEntries.map(([f]) => f);
            const utilData = frotaEntries.map(([_, h]) => parseFloat(h.toFixed(2)));

            const opLabels = operatorEntries.map(([o]) => o);
            const opData = operatorEntries.map(([_, c]) => c);

            // Mensagem de informação no painel
            const dashPanel = document.getElementById('dashboardPanel');
            const infoId = 'dashboardInfo';
            let infoEl = dashPanel ? dashPanel.querySelector(`#${infoId}`) : null;
            if (!infoEl && dashPanel) {
                infoEl = document.createElement('p');
                infoEl.id = infoId;
                infoEl.className = 'text-gray-600 mt-2';
                dashPanel.appendChild(infoEl);
            }
            if (infoEl) {
                if (utilData.length === 0 && opData.length === 0) {
                    infoEl.textContent = 'Sem dados recentes para o dashboard.';
                } else {
                    infoEl.textContent = '';
                }
            }

            // Paleta de cores
            const palette = ['#1E88E5','#43A047','#FB8C00','#8E24AA','#E53935','#00ACC1','#7CB342','#FDD835','#3949AB','#6D4C41'];

            // Gráfico de Utilização por Frota
            utilizationChartInstance = new Chart(ctxUtil, {
                type: 'bar',
                data: {
                    labels: utilLabels,
                    datasets: [{
                        label: 'Horas',
                        data: utilData,
                        backgroundColor: utilLabels.map((_, i) => palette[i % palette.length])
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Utilização da Frota (últimos 60 dias)' }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { precision: 0 } }
                    }
                }
            });

            // Gráfico de Atividades por Operador
            operatorChartInstance = new Chart(ctxOp, {
                type: 'bar',
                data: {
                    labels: opLabels,
                    datasets: [{
                        label: 'Atividades',
                        data: opData,
                        backgroundColor: opLabels.map((_, i) => palette[(i + 3) % palette.length])
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Atividades por Operador (últimos 60 dias)' }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { precision: 0 } }
                    }
                }
            });

        } catch (err) {
            console.error('Erro ao carregar dashboard:', err);
            window.showModal('Erro', 'Não foi possível carregar os gráficos do dashboard.', null, true);
        }
    };


    // Logotipo da Empresa (ATUALIZADO)
    const logoUrl = "https://placehold.co/180x50/F0F4F8/1F2937?text=axyn&font=inter&weight=800";

    // --- AUTHENTICATION & ROLE MANAGEMENT ---
    async function fetchUserRole(uid) {
        try {
            const userDocRef = doc(db, "usuarios", uid);
            const userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists()) {
                return userDocSnap.data().level || 'operacao';
            }
            return 'operacao'; // Default if no role is defined
        } catch (error) {
            console.error("Error fetching user role:", error);
            return 'operacao'; // Default on error
        }
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        currentUserRole = await fetchUserRole(user.uid);
        console.log(`User ${user.email} signed in with role: ${currentUserRole}`);
       
        const username = user.email.replace(DUMMY_DOMAIN, '');
        document.querySelectorAll('.current-username').forEach(el => {
            el.textContent = username;
        });

        // Show the top menu when logged in
        const topMenu = document.querySelector('.top-menu');
        if (topMenu) topMenu.style.display = 'flex';
        // hide login when authenticated and remove login background
        const lpIn = document.getElementById('loginPanel');
        if (lpIn) lpIn.style.display = 'none';
        if (document.body) document.body.classList.remove('login-bg');

        document.querySelectorAll('.card').forEach(panel => panel.style.display = 'none');
        // MOSTRA O 'gestaoDeFrotasPanel' (MENU PRINCIPAL) APÓS LOGIN
        document.getElementById('gestaoDeFrotasPanel').style.display = 'block'; 
        
        if (typeof updateUIVisibilityBasedOnRole !== 'function') {
          window.updateUIVisibilityBasedOnRole = function() {
            // Fallback: show all panels/buttons accessible for default role
            // You can refine role-based visibility later.
            return;
          };
        }
        updateUIVisibilityBasedOnRole();
        window.populateSelects();
        initNotificationListeners();
      } else {
        currentUser = null;
        currentUserRole = 'operacao';
        console.log("User is signed out.");

        // Hide the top menu when logged out
        const topMenu = document.querySelector('.top-menu');
        if (topMenu) topMenu.style.display = 'none';

        document.querySelectorAll('.card').forEach(panel => {
            if (panel.id !== 'loginPanel') {
                panel.style.display = 'none';
            }
        });
        // MOSTRA 'loginPanel' QUANDO DESLOGADO
        document.getElementById('loginPanel').style.display = 'block'; 
        // Define fundo da tela de login
        if (document.body) document.body.classList.add('login-bg'); 
        // Clear the login fields on logout
        document.getElementById('appUsername').value = '';
        document.getElementById('appPassword').value = '';
        document.querySelectorAll('.current-username').forEach(el => {
            el.textContent = '';
        });
       
        if (unsubscribeDisponibilidade) {
            unsubscribeDisponibilidade();
            unsubscribeDisponibilidade = null;
        }
        cleanupNotificationListeners();
      }
    });

    window.mainLogin = async function() {
      let username = document.getElementById('appUsername').value;
      const password = document.getElementById('appPassword').value;

      if (!username || !password) {
          window.showModal('Erro de Login', 'Por favor, insira o usuário e a senha.', null, true);
          return;
      }

      // If the entered username is not an email, append the dummy domain
      if (!username.includes('@')) {
          username += DUMMY_DOMAIN;
      }

      try {
          await signInWithEmailAndPassword(auth, username, password);
          // onAuthStateChanged will handle the UI redirection
      } catch (error) {
          console.error("Login Error:", error);
          if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
              window.showModal('Erro de Login', 'Usuário ou senha inválidos.', null, true);
          } else {
              window.showModal('Erro de Login', `Ocorreu um erro: ${error.message}`, null, true);
          }
      }
    };

    window.appLogout = async function() {
        try {
            await signOut(auth);
            // onAuthStateChanged will handle the UI redirection
        } catch (error) {
            console.error("Logout Error:", error);
            window.showModal('Erro', 'Não foi possível sair. Tente novamente.', null, true);
        }
    };


    // --- NAVIGATION ---
    window.showApp = function(panelId, subPanelId = '') {
      document.querySelectorAll('.card').forEach(panel => panel.style.display = 'none');

      const targetPanel = document.getElementById(panelId);
      if (!targetPanel) return;
      targetPanel.style.display = 'block';

      // Controla visibilidade do menu/topo e do login conforme a seção
      const topMenu = document.querySelector('.top-menu');
      const lp = document.getElementById('loginPanel');
      if (panelId === 'loginPanel') {
          if (topMenu) topMenu.style.display = 'none';
          if (lp) lp.style.display = 'block';
          if (document.body) document.body.classList.add('login-bg');
      } else {
          if (topMenu) topMenu.style.display = 'flex';
          if (lp) lp.style.display = 'none';
          if (document.body) document.body.classList.remove('login-bg');
      }

      // Universal Header Logic
      const allHeaders = document.querySelectorAll('.app-header');
      allHeaders.forEach(header => {
          const backButton = header.querySelector('.back-button');
          if(backButton){
              if (panelId === 'gestaoDeFrotasPanel') {
                  backButton.style.display = 'none'; // Hide back button on main menu
              } else {
                  backButton.style.display = 'inline-block';
              }
          }
      });

      // Set title for the active panel
      const titleElement = targetPanel.querySelector('.panel-title');
      if (titleElement) {
          const titles = {
              dashboardPanel: 'Dashboard',
              gestaoDeFrotasPanel: 'Menu Principal',
              localizacaoPanel: 'Localização',
              statusDeAtividadePanel: 'Status de Atividade',
              manutencaoPanel: 'Gestão de Manutenção',
              abastecimentoPanel: 'Gestão de Abastecimento',
              pneusPanel: 'Gestão de Pneus'
          };
          titleElement.textContent = titles[panelId] || 'Gestão de Frotas';
      }

      // Ensure notification panel anchored to current header and hidden on navigation
      const notifPanel = document.getElementById('notification-panel');
      if (notifPanel) {
          notifPanel.style.display = 'none';
      }

      if (panelId === 'dashboardPanel') {
          if (typeof window.populateDashboardFilters === 'function') {
              window.populateDashboardFilters();
          }
          window.loadDashboard();
      }
     
      // Sub-panel logic
      if (panelId === 'statusDeAtividadePanel') {
          window.mostrar(subPanelId || 'disponibilidade'); 
      } else if (panelId === 'manutencaoPanel') {
          window.mostrarManutencaoSubpanel('formAbrirOS'); 
      } else if (panelId === 'abastecimentoPanel') {
          window.mostrarAbastecimentoSubpanel('formAbastecimento');
      } else if (panelId === 'pneusPanel') {
          window.mostrarPneusSubpanel('formCadastroPneu');
      }

      window.mostrarPneusSubpanel = function(subpanelId){
          const ids = ['formCadastroPneu','consultarPneus','alocarPneusPanel'];
          ids.forEach(id => {
             const el = document.getElementById(id);
             if(el) el.style.display = (id === subpanelId) ? 'block' : 'none';
          });
          if (subpanelId === 'consultarPneus') {
              window.listarPneus();
          } else if (subpanelId === 'alocarPneusPanel') {
              window.populateFrotasSelect('alocacaoFrota');
          }
      }
    }

    window.mostrar = function(idToShow) {
      const sections = ['inicio', 'disponibilidade', 'fim', 'cadastro', 'administrador', 'relatorio', 'dados'];
      const panelTitle = document.getElementById('panelTitle');
      const mainNavButtons = document.getElementById('mainNavButtons');

      // Hide all sections first
      sections.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.style.display = 'none';
      });
     
      // Show the target section
      const targetSection = document.getElementById(idToShow);
      if(targetSection) targetSection.style.display = 'block';

      // Control visibility of main navigation buttons
      if (['cadastro', 'administrador', 'relatorio', 'dados'].includes(idToShow)) {
          mainNavButtons.style.display = 'none';
      } else {
          mainNavButtons.style.display = 'flex';
      }

      switch(idToShow) {
          case 'disponibilidade': 
              panelTitle.textContent = 'Status de Atividade';
              window.updateDisponibilidade(); 
              break;
          case 'inicio': 
              panelTitle.textContent = 'Iniciar Atividade'; 
              window.populateSelects();
              window.populateCurrentDateTime('dataInicial', 'horaInicial'); 
              window.evaluateChecklistRequirement();
              const frotaField = document.getElementById('frotaInicio');
              const dataField = document.getElementById('dataInicial');
              if (frotaField) frotaField.addEventListener('change', window.evaluateChecklistRequirement);
              if (dataField) dataField.addEventListener('change', window.evaluateChecklistRequirement);
              break;
          case 'fim': 
              panelTitle.textContent = 'Encerrar Atividade';
              window.populateCurrentDateTime('dataFinal', 'horaFinal'); 
              break;
          case 'cadastro': 
              panelTitle.textContent = 'Gerenciar Cadastros';
              window.mostrarCadastro('cadastroOperador'); 
              break;
          case 'administrador': 
              panelTitle.textContent = 'Painel Administrativo';
              window.showAdminDashboard();
              break;
          case 'relatorio': 
              panelTitle.textContent = 'Relatórios';
              document.getElementById('relatorioResultado').innerHTML = ''; 
              break;
          case 'dados': 
              panelTitle.textContent = 'Gerenciar Dados'; 
              window.mostrarBancoDeDados(); 
              break;
      }
    }

    window.mostrarManutencaoSubpanel = function(subPanelId) {
        const subPanelsManutencao = ['formAbrirOS', 'formPlanosManutencao', 'consultarOS', 'gestaoPecas', 'orcamentosAprovacoes', 'historicoManutencao'];
        subPanelsManutencao.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        });

        const targetPanel = document.getElementById(subPanelId);
        if (targetPanel) {
            targetPanel.style.display = 'block';
        }

        if (subPanelId === 'formAbrirOS') {
            window.populateCurrentDateTime('osDataAbertura');
        } else if (subPanelId === 'consultarOS') {
            window.consultarOrdensServico();
        } else if (subPanelId === 'formPlanosManutencao') {
            window.consultarPlanosManutencao();
            const tipoManutencao = document.getElementById('tipoManutencao').value;
            document.getElementById('horimetroIntervalField').style.display = tipoManutencao === 'Horímetro' ? 'flex' : 'none';
            document.getElementById('tempoIntervalField').style.display = tipoManutencao === 'Tempo' ? 'flex' : 'none';
        } else if (subPanelId === 'gestaoPecas') {
            window.consultarPecas();
        } else if (subPanelId === 'orcamentosAprovacoes') {
            window.consultarOrcamentos();
        } else if (subPanelId === 'historicoManutencao') {
            window.consultarHistoricoManutencao();
        }
    }

    // Funções de Pneus
    window.salvarPneu = async function(){
      try{
        const id = document.getElementById('pneuId').value.trim().toUpperCase();
        const marca = document.getElementById('pneuMarca').value.trim().toUpperCase();
        const modelo = document.getElementById('pneuModelo').value.trim().toUpperCase();
        const dataCompra = document.getElementById('pneuDataCompra').value;
        const frotaInstalado = document.getElementById('pneuFrotaInstalado').value.trim().toUpperCase();
        const posicao = document.getElementById('pneuPosicao').value.trim().toUpperCase();
        if(!id || !marca || !modelo || !dataCompra){
          return window.showModal('Dados incompletos','Preencha ID, Marca, Modelo e Data da Compra.', null, true);
        }
        await setDoc(doc(db,'pneus', id), { id, marca, modelo, dataCompra, frotaInstalado, posicao }, { merge: true });
        window.showModal('Sucesso','Pneu salvo com sucesso.');
        document.getElementById('pneuForm').reset();
      }catch(err){
        console.error('Erro ao salvar pneu:', err);
        window.showModal('Erro','Falha ao salvar pneu.', null, true);
      }
    }

    window.listarPneus = async function(){
      try{
        const cont = document.getElementById('pneusListContainer');
        cont.innerHTML = '';
        const snap = await getDocs(collection(db,'pneus'));
        if(snap.empty){
          cont.innerHTML = '<p>Nenhum pneu cadastrado.</p>';
          return;
        }
        const table = document.createElement('table');
        table.className = 'w-full';
        table.innerHTML = '<thead><tr><th>ID</th><th>Marca</th><th>Modelo</th><th>Compra</th><th>Frota</th><th>Posição</th></tr></thead>';
        const tbody = document.createElement('tbody');
        snap.forEach(d=>{
          const p = d.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${p.id||''}</td><td>${p.marca||''}</td><td>${p.modelo||''}</td><td>${p.dataCompra||''}</td><td>${p.frotaInstalado||''}</td><td>${p.posicao||''}</td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        cont.appendChild(table);
      }catch(err){
        console.error('Erro ao listar pneus:', err);
        document.getElementById('pneusListContainer').innerHTML = '<p>Falha ao listar pneus.</p>';
      }
    }

    window.mostrarAbastecimentoSubpanel = function(subPanelId) {
        const subPanelsAbastecimento = ['formAbastecimento', 'formCompraCombustivel'];
        subPanelsAbastecimento.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        });

        const targetPanel = document.getElementById(subPanelId);
        if (targetPanel) {
            targetPanel.style.display = 'block';
        }

        if (subPanelId === 'formAbastecimento') {
            window.populateCurrentDateTime('abastecimentoData', 'abastecimentoHora');
            window.toggleVolumeRestante(document.getElementById('abastecimentoLocal').value);
        }
    }


    // --- GENERIC HELPER FUNCTIONS ---
    async function uploadFile(file, path) {
        if (!file) return null;
        const storageRef = ref(storage, path);
        await uploadBytes(storageRef, file);
        return await getDownloadURL(storageRef);
    }

    window.populateSelects = async function() {
        if (!currentUser) return;
        try {
            const collections = ['setores', 'atividades', 'implementos'];
            const [setores, atividades, implementos] = await Promise.all(
                collections.map(c => getDocs(collection(db, c)))
            );

            const formatOptions = (snapshot) => 
                snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const setorSelect = document.getElementById('setorInicio');
            const implementoSelect = document.getElementById('implementoInicio');

            [setorSelect, implementoSelect].forEach(s => s.innerHTML = '<option value="">Selecione...</option>');

            formatOptions(setores).forEach(item => setorSelect.innerHTML += `<option value="${item.nome}">${item.nome}</option>`);
            formatOptions(implementos).forEach(item => implementoSelect.innerHTML += `<option value="${item.nome}">${item.nome} (${item.sigla})</option>`);
            document.getElementById('atividadeInicio').innerHTML = '<option value="">Selecione um setor primeiro</option>';
        } catch (error) {
            console.error("Failed to populate selects:", error);
            window.showModal("Erro de Dados", "Não foi possível carregar as opções de cadastro.", null, true);
        }
    }
   
    // Popula selects múltiplos do Dashboard (Frotas e Operadores)
    window.populateDashboardFilters = async function() {
      if (!currentUser) return;
      try {
        const frotaSelect = document.getElementById('dashboardFrotaFilter');
        const operadorSelect = document.getElementById('dashboardOperadorFilter');
        if (!frotaSelect || !operadorSelect) return;

        // Limpa opções atuais
        frotaSelect.innerHTML = '';
        operadorSelect.innerHTML = '';

        // Helper para adicionar opção
        const addOption = (selectEl, value, text) => {
          const opt = document.createElement('option');
          opt.value = value;
          opt.textContent = text;
          selectEl.appendChild(opt);
        };

        // Carregar frotas
        const frotasSnapshot = await getDocs(collection(db, 'frotas'));
        const frotas = frotasSnapshot.docs
          .map(doc => doc.data())
          .map(f => (f.codigo || f.nome || '').toString().toUpperCase())
          .filter(v => v && v.trim().length > 0)
          .sort((a, b) => a.localeCompare(b));

        // Carregar operadores
        const operadoresSnapshot = await getDocs(collection(db, 'operadores'));
        const operadores = operadoresSnapshot.docs
          .map(doc => doc.data())
          .map(o => (o.nome || o.cracha || '').toString().toUpperCase())
          .filter(v => v && v.trim().length > 0)
          .sort((a, b) => a.localeCompare(b));

        if (frotas.length === 0) {
          addOption(frotaSelect, '', 'Nenhuma frota cadastrada');
        } else {
          frotas.forEach(f => addOption(frotaSelect, f, f));
        }

        if (operadores.length === 0) {
          addOption(operadorSelect, '', 'Nenhum operador cadastrado');
        } else {
          operadores.forEach(o => addOption(operadorSelect, o, o));
        }
      } catch (err) {
        console.error('Falha ao popular filtros do dashboard:', err);
      }
    }
   
    // --- Gestão de Pneus & Cadastro Completo de Frota ---
    window.populateFrotasSelect = async function(selectId){
      const el = document.getElementById(selectId);
      if (!el) return;
      const prevValue = el.value;
      el.disabled = true;
      el.innerHTML = '<option value="">Carregando...</option>';
      try {
        const snap = await getDocs(collection(db, 'frotas'));
        const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        const seen = new Set();
        const options = [];
        list.forEach(f => {
          const code = ((f.codigo ?? f.id) ?? '').toString().trim().toUpperCase();
          if (!code || seen.has(code)) return;
          seen.add(code);
          const label = `${code}${f.modelo ? ' - ' + f.modelo : ''}`;
          options.push({ code, label });
        });
        options.sort((a, b) => a.code.localeCompare(b.code));

        el.innerHTML = '<option value="">Selecione...</option>';
        if (options.length === 0) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'Nenhuma frota cadastrada';
          opt.disabled = true;
          el.appendChild(opt);
        } else {
          options.forEach(o => {
            const opt = document.createElement('option');
            opt.value = o.code;
            opt.textContent = o.label;
            el.appendChild(opt);
          });
          if (prevValue && seen.has(prevValue)) {
            el.value = prevValue;
          }
        }
      } catch (err) {
        console.error('Erro ao popular frotas:', err);
        el.innerHTML = '<option value="">Falha ao carregar frotas</option>';
      } finally {
        el.disabled = false;
        el.style.minWidth = '220px';
      }
    }

    window.renderEstruturaEixos = function(){
      const eixos = parseInt(document.getElementById('numeroEixos').value || '0', 10);
      const pneus = parseInt(document.getElementById('pneusPorEixo').value || '0', 10);
      const cont = document.getElementById('estruturaEixosContainer');
      cont.innerHTML = '';
      if (!eixos || !pneus) return;
      for(let i=1;i<=eixos;i++){
        const row = document.createElement('div');
        row.className = 'mt-2';
        row.innerHTML = `<strong>Eixo ${i}</strong>`;
        const slots = document.createElement('div');
        slots.className = 'flex gap-2 mt-1 flex-wrap';
        for(let j=1;j<=pneus;j++){
          const slot = document.createElement('div');
          slot.className = 'card p-2';
          slot.innerHTML = `
            <div class="field"><label>Posição ${j}</label><input type="text" value="${i}-${j}" disabled></div>
          `;
          slots.appendChild(slot);
        }
        cont.appendChild(row);
        cont.appendChild(slots);
      }
    }

    window.salvarCadastroCompletoFrota = async function(){
      try{
        const codigo = document.getElementById('cadCompletoCodigoFrota').value.trim().toUpperCase();
        const eixos = parseInt(document.getElementById('numeroEixos').value || '0', 10);
        const pneus = parseInt(document.getElementById('pneusPorEixo').value || '0', 10);
        if(!codigo || !eixos || !pneus){
          return window.showModal('Dados incompletos','Informe frota, número de eixos e pneus por eixo.', null, true);
        }
        const estrutura = [];
        for(let i=1;i<=eixos;i++){
          estrutura.push({eixo:i, posicoes: Array.from({length:pneus}, (_,idx)=>({pos:idx+1}))});
        }
        await setDoc(doc(db,'frotas', codigo), { codigo }, { merge: true });
        await setDoc(doc(db,'frotas', codigo, 'config', 'pneus'), { eixos, pneusPorEixo: pneus, estrutura }, { merge: true });
        window.showModal('Sucesso','Configuração de pneus salva para a frota '+codigo);
      }catch(err){
        console.error('Erro ao salvar cadastro completo:', err);
        window.showModal('Erro','Falha ao salvar configuração.', null, true);
      }
    }

    window.renderMapaPneus = async function(codigoFrota){
      const cont = document.getElementById('mapaPneusContainer');
      cont.innerHTML='';
      if(!codigoFrota){ cont.innerHTML='<p>Selecione uma frota.</p>'; return; }
      try{
        const cfgSnap = await getDoc(doc(db,'frotas', codigoFrota, 'config', 'pneus'));
        if(!cfgSnap.exists()) { cont.innerHTML = '<p>Esta frota não possui configuração de eixos/pneus.</p>'; return; }
        const cfg = cfgSnap.data();
        const eixos = cfg.eixos;
        const pneus = cfg.pneusPorEixo;
        for(let i=1;i<=eixos;i++){
          const eixoCard = document.createElement('div');
          eixoCard.className = 'card mt-2';
          eixoCard.innerHTML = `<h5>Eixo ${i}</h5>`;
          const slots = document.createElement('div');
          slots.className = 'grid grid-cols-2 sm:grid-cols-3 gap-2';
          for(let j=1;j<=pneus;j++){
            const slot = document.createElement('div');
            slot.className = 'card p-2';
            const slotId = `${i}-${j}`;
            slot.innerHTML = `
              <div class="field"><label>Pneu</label><input type="text" id="pneu_${slotId}" placeholder="Código do Pneu"></div>
              <div class="field"><label>Horímetro Instalação</label><input type="number" id="instHor_${slotId}"></div>
              <div class="field"><label>Data Início</label><input type="date" id="instData_${slotId}"></div>
              <div class="field"><label>Horímetro Retirada</label><input type="number" id="retHor_${slotId}"></div>
              <div class="field"><label>Data Retirada</label><input type="date" id="retData_${slotId}"></div>
              <div class="flex gap-2 mt-2">
                <button class="btn dark-primary" type="button" onclick="window.salvarAlocacaoPneu('${codigoFrota}', ${i}, ${j})">Salvar</button>
                <button class="btn dark-primary" type="button" onclick="window.removerAlocacaoPneu('${codigoFrota}', ${i}, ${j})">Remover</button>
              </div>
            `;
            slots.appendChild(slot);
          }
          eixoCard.appendChild(slots);
          cont.appendChild(eixoCard);
        }
        await window.preencherAlocacoesExistentes(codigoFrota);
      }catch(err){
        console.error('Erro ao renderizar mapa de pneus:', err);
        cont.innerHTML = '<p>Falha ao carregar mapa.</p>';
      }
    }

    window.preencherAlocacoesExistentes = async function(codigoFrota){
      try{
        const alocSnap = await getDocs(collection(db,'frotas', codigoFrota, 'alocacoes'));
        alocSnap.forEach(docu => {
          const a = docu.data();
          const slotId = `${a.eixo}-${a.pos}`;
          const pneuEl = document.getElementById('pneu_'+slotId);
          if(pneuEl){
            pneuEl.value = a.pneu || '';
            document.getElementById('instHor_'+slotId).value = a.instHor||'';
            document.getElementById('instData_'+slotId).value = a.instData||'';
            document.getElementById('retHor_'+slotId).value = a.retHor||'';
            document.getElementById('retData_'+slotId).value = a.retData||'';
          }
        });
      }catch(err){
        console.error('Erro ao preencher alocações existentes:', err);
      }
    }

    window.salvarAlocacaoPneu = async function(codigoFrota, eixo, pos){
      try{
        const slotId = `${eixo}-${pos}`;
        const dados = {
          frota: codigoFrota,
          eixo,
          pos,
          pneu: document.getElementById('pneu_'+slotId).value.trim().toUpperCase(),
          instHor: parseFloat(document.getElementById('instHor_'+slotId).value || '0'),
          instData: document.getElementById('instData_'+slotId).value || '',
          retHor: parseFloat(document.getElementById('retHor_'+slotId).value || '0'),
          retData: document.getElementById('retData_'+slotId).value || ''
        };
        await setDoc(doc(db,'frotas', codigoFrota, 'alocacoes', slotId), dados, { merge: true });
        window.showModal('Sucesso', `Alocação salva (Eixo ${eixo}, Posição ${pos}).`);
      }catch(err){
        console.error('Erro ao salvar alocação:', err);
        window.showModal('Erro','Falha ao salvar alocação.', null, true);
      }
    }

    window.removerAlocacaoPneu = async function(codigoFrota, eixo, pos){
      try{
        const slotId = `${eixo}-${pos}`;
        await setDoc(doc(db,'frotas', codigoFrota, 'alocacoes', slotId), {
          frota: codigoFrota, eixo, pos, pneu: '', instHor: '', instData: '', retHor: '', retData: ''
        }, { merge: true });
        document.getElementById('pneu_'+slotId).value = '';
        document.getElementById('instHor_'+slotId).value = '';
        document.getElementById('instData_'+slotId).value = '';
        document.getElementById('retHor_'+slotId).value = '';
        document.getElementById('retData_'+slotId).value = '';
        window.showModal('Sucesso', `Alocação removida (Eixo ${eixo}, Posição ${pos}).`);
      }catch(err){
        console.error('Erro ao remover alocação:', err);
        window.showModal('Erro','Falha ao remover alocação.', null, true);
      }
    }

    window.limparFormulario = function(formId) {
      const form = document.getElementById(formId);
      if (!form) return;
      form.reset();
      if (formId === 'formInicio') {
          document.getElementById('nomeInicio').value = '';
          document.getElementById('modeloInicio').value = '';
          document.getElementById('fotoInicio').src = 'https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR';
          document.getElementById('fotoEquipInicio').src = 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
          document.getElementById('relatoProblemaField').style.display = 'none';
          window.hideAllChecklistReports();
      } else if (formId === 'formFim') {
          document.getElementById('nomeFim').value = '';
          document.getElementById('equipamentoFim').value = '';
          document.getElementById('fotoFim').src = 'https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR';
          document.getElementById('fotoEquipFim').src = 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
          document.getElementById('frotaSelectionContainer').style.display = 'none';
      } else if (formId === 'osForm') {
          document.getElementById('osModelo').value = '';
          document.getElementById('osNomeSolicitante').value = '';
      } else if (formId === 'abastecimentoForm') {
          document.getElementById('abastecimentoModelo').value = '';
          document.getElementById('nomeMotorista').value = '';
          document.getElementById('nomeFrentista').value = '';
          document.getElementById('nomeProduto').value = '';
      } else if (formId === 'planosManutencaoForm') {
          document.getElementById('planoModelo').value = '';
          document.getElementById('horimetroIntervalField').style.display = 'flex';
          document.getElementById('tempoIntervalField').style.display = 'none';
      } 
    }

    window.populateCurrentDateTime = function(dateInputId, timeInputId) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');

        const dateInput = document.getElementById(dateInputId);
        if (dateInput) {
            dateInput.value = `${year}-${month}-${day}`;
        }
        const timeInput = document.getElementById(timeInputId);
        if (timeInput) {
            timeInput.value = `${hours}:${minutes}`;
        }
    }

    window.confirmAndSetDateTime = function(dateInputId, timeInputId) {
        const dateInput = document.getElementById(dateInputId);
        const timeInput = document.getElementById(timeInputId);

        if (!dateInput.value && !timeInput.value) {
            window.showModal(
                'Preenchimento Automático',
                'Deseja preencher a data e a hora com o momento atual?',
                () => { // onConfirm callback
                    window.populateCurrentDateTime(dateInputId, timeInputId);
                }
            );
        }
    }

    window.validateDateTime = function(dateInputId, timeInputId) {
        const dateInput = document.getElementById(dateInputId);
        const timeInput = document.getElementById(timeInputId);
        const selectedDate = dateInput.value;
        const selectedTime = timeInput.value;

        if (!selectedDate || !selectedTime) {
            return true; // Caught by main validation
        }

        const selectedDateTime = new Date(`${selectedDate}T${selectedTime}`);
        const now = new Date();

        if (selectedDateTime.getTime() > now.getTime() + 120000) { // 2 min buffer
            window.showModal("Data/Hora Inválida", "A data e hora não podem ser futuras. Por favor, corrija.", null, true);
            return false;
        }
        return true;
    }

    // Validação de Horímetro com mínimo e limite por turno
    window.validateHorimetro = async function(fieldId, frotaFieldId) {
        try {
            const input = document.getElementById(fieldId);
            if (!input) return true;
            const frotaInput = document.getElementById(frotaFieldId);
            const valor = parseFloat(input.value);
            if (isNaN(valor)) return true; // Deixe a validação principal do formulário tratar campos vazios

            // Carrega configuração (se existir)
            let limitePorTurno = 16; // padrão em horas
            let minimo = 0; // padrão mínimo
            try {
                const cfgRef = doc(db, 'configuracoes', 'horimetro');
                const cfgSnap = await getDoc(cfgRef);
                if (cfgSnap.exists()) {
                    const cfg = cfgSnap.data();
                    if (typeof cfg.limitePorTurno === 'number') limitePorTurno = cfg.limitePorTurno;
                    if (typeof cfg.minimo === 'number') minimo = cfg.minimo;
                }
            } catch(e) { /* silencioso */ }

            if (valor < minimo) {
                window.showModal('Horímetro inválido', `O valor do horímetro deve ser maior ou igual a ${minimo.toFixed(2)}.`, null, true);
                input.value = '';
                input.focus();
                return false;
            }

            const isFim = fieldId === 'horimetroFim';
            if (isFim) {
                const inicialDataset = parseFloat(input.dataset.horimetroInicial);
                const horimetroInicialVal = isNaN(inicialDataset) ? null : inicialDataset;
                if (horimetroInicialVal !== null) {
                    const diff = valor - horimetroInicialVal;
                    if (diff <= 0) {
                        window.showModal('Horímetro inválido', 'O horímetro final deve ser maior que o inicial.', null, true);
                        input.value = '';
                        input.focus();
                        return false;
                    }
                    if (diff > limitePorTurno) {
                        const frota = frotaInput ? frotaInput.value : '';
                        window.showModal('Limite por turno excedido', `O incremento de horímetro (${diff.toFixed(2)}h) para a frota ${frota || ''} excede o limite por turno de ${limitePorTurno} horas.`, null, true);
                        input.value = '';
                        input.focus();
                        return false;
                    }
                }
            }

            return true;
        } catch (error) {
            console.warn('Falha na validação de horímetro:', error);
            return true; // Não bloquear em caso de erro inesperado
        }
    }

    // Avalia obrigatoriedade do checklist: exigido somente na primeira atividade do dia para a frota
    window.evaluateChecklistRequirement = async function() {
        try {
            const frota = document.getElementById('frotaInicio')?.value || '';
            const data = document.getElementById('dataInicial')?.value || '';
            if (!frota || !data) return; // aguardar preenchimento

            let existeHoje = false;
            try {
                // Atividades em andamento da mesma frota no dia
                const qAtiv = query(collection(db, 'atividadesEmAndamento'), where('frota', '==', frota));
                const snapAtiv = await getDocs(qAtiv);
                const hasRunningToday = snapAtiv.docs.some(d => {
                    const x = d.data();
                    return x.dataInicial === data; // comparação de string yyyy-MM-dd
                });
                // Histórico da mesma frota com data inicial/final no dia
                const qHist = query(collection(db, 'historicoAtividades'), where('frota', '==', frota), limit(50));
                const snapHist = await getDocs(qHist);
                const hasHistoryToday = snapHist.docs.some(d => {
                    const x = d.data();
                    return x.dataInicial === data || x.dataFinal === data;
                });
                existeHoje = hasRunningToday || hasHistoryToday;
            } catch(e) { console.warn('Erro ao avaliar checklist por dia:', e); }

            const radios = document.querySelectorAll('#safetyChecklist input[type="radio"]');
            radios.forEach(r => { r.required = !existeHoje; });

            const checklistTitle = document.querySelector('#safetyChecklist h4');
            if (checklistTitle) {
                const noteId = 'checklist-note';
                let note = document.getElementById(noteId);
                if (!note) {
                    note = document.createElement('div');
                    note.id = noteId;
                    note.className = 'text-xs text-gray-600 text-center mt-1';
                    checklistTitle.insertAdjacentElement('afterend', note);
                }
                note.textContent = (!existeHoje)
                    ? 'Checklist obrigatório (primeira atividade do dia para esta frota).'
                    : 'Checklist opcional (já há atividade registrada hoje para esta frota).';
            }
        } catch (error) {
            console.warn('Falha ao configurar obrigatoriedade do checklist:', error);
        }
    }

    // --- MODAL FUNCTIONS ---
    let modalConfirmCallback = null;
    window.showModal = function(title, message, onConfirm, isWarning = false) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').innerHTML = message.replace(/\n/g, '<br>'); // Support newlines
        document.getElementById('modalContent').classList.toggle('modal-warning-background', isWarning);
        modalConfirmCallback = onConfirm;
        document.getElementById('modalConfirmBtn').style.display = onConfirm ? 'inline-block' : 'none';
        document.getElementById('modalCancelBtn').textContent = onConfirm ? 'Cancelar' : 'Fechar';
        document.getElementById('confirmationModal').style.display = 'flex';
    }
    document.getElementById('modalConfirmBtn').onclick = () => { if (typeof modalConfirmCallback === 'function') modalConfirmCallback(); window.closeModal(); };
    document.getElementById('modalCancelBtn').onclick = () => window.closeModal();
    window.closeModal = function() { document.getElementById('confirmationModal').style.display = 'none'; modalConfirmCallback = null; }

    document.getElementById('listModalCloseBtn').onclick = () => { document.getElementById('listModal').style.display = 'none'; };
    document.getElementById('editModalCancelBtn').onclick = () => { document.getElementById('editModal').style.display = 'none'; };

    window.showListModal = async function(title, data, headers, storeName) {
        const modal = document.getElementById('listModal');
        const titleEl = document.getElementById('listModalTitle');
        const contentEl = document.getElementById('listModalContent');

        titleEl.textContent = title;
        contentEl.innerHTML = '';

        if (!data || data.length === 0) {
            contentEl.innerHTML = '<p class="text-gray-600">Nenhum item cadastrado.</p>';
            modal.style.display = 'flex';
            return;
        }

        const table = document.createElement('table');
        table.className = 'consult-table w-full';
       
        const thead = table.createTHead();
        const headerRow = thead.insertRow();
        for (const key in headers) {
            const th = document.createElement('th');
            th.textContent = headers[key];
            th.dataset.sortKey = key;
            th.onclick = (e) => sortTable(e.target);
            headerRow.appendChild(th);
        }
        const thActions = document.createElement('th');
        thActions.textContent = 'Ações';
        headerRow.appendChild(thActions);

        const tbody = table.createTBody();
        data.forEach(item => {
            const row = tbody.insertRow();
            for (const key in headers) {
                const cell = row.insertCell();
                if (key === 'foto' && item[key]) {
                    const img = document.createElement('img');
                    img.src = item[key];
                    img.alt = 'Foto';
                    img.className = 'w-12 h-12 object-cover rounded';
                    cell.appendChild(img);
                } else if (Array.isArray(item[key])) {
                     cell.textContent = item[key].join(', ') || '-';
                }
                else {
                    cell.textContent = item[key] || '-';
                }
            }
            const actionsCell = row.insertCell();
            actionsCell.className = 'flex gap-2';
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Alterar';
            editBtn.className = 'btn dark-primary text-xs p-1';
            editBtn.onclick = () => window.handleEdit(storeName, item.id);
           
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Excluir';
            deleteBtn.className = 'btn dark-primary text-xs p-1';
            deleteBtn.onclick = () => window.handleDelete(storeName, item.id, item.foto); // Pass photo URL for deletion
           
            actionsCell.appendChild(editBtn);
            actionsCell.appendChild(deleteBtn);
        });

        contentEl.appendChild(table);
        modal.style.display = 'flex';
    }

    // --- CADASTRO (REGISTRATION) FUNCTIONS ---
    async function populateModelosSelect(selectElementId, selectedValues = []) {
        const selectEl = document.getElementById(selectElementId);
        selectEl.innerHTML = ''; // Clear previous options
        try {
            const frotasSnapshot = await getDocs(collection(db, 'frotas'));
            const modelos = new Set(frotasSnapshot.docs.map(doc => doc.data().modelo));
            modelos.forEach(modelo => {
                const isSelected = selectedValues.includes(modelo) ? 'selected' : '';
                selectEl.innerHTML += `<option value="${modelo}" ${isSelected}>${modelo}</option>`;
            });
        } catch (error) {
            console.error("Error populating modelos select:", error);
        }
    }

    window.mostrarCadastro = function(subpanel) {
        ['cadastroOperador', 'cadastroFrota', 'cadastroSetor', 'cadastroAtividade', 'cadastroImplemento', 'associarAtividadeSetor', 'cadastroCompletoFrota'].forEach(p => {
            const el = document.getElementById(p);
            if(el) el.style.display = p === subpanel ? 'block' : 'none';
        });
        if (subpanel === 'cadastroImplemento') {
            populateModelosSelect('modeloImplemento');
        }
        if (subpanel === 'associarAtividadeSetor') {
             populateSetorParaAssociacao();
        }
        if (subpanel === 'cadastroCompletoFrota') {
            // Pré-preencher frota se houver no formulário de frota
            const codigo = document.getElementById('codigoFrota').value.trim().toUpperCase();
            document.getElementById('cadCompletoCodigoFrota').value = codigo;
            window.renderEstruturaEixos();
        }
    }

    window.salvarOperador = async function() {
        const cracha = document.getElementById('crachaOperador').value.trim();
        const nome = document.getElementById('nomeOperador').value.trim();
        const fotoFile = document.getElementById('fotoOperador').files[0];
        if (!cracha || !nome) { window.showModal('Campos Obrigatórios', 'Crachá e Nome são obrigatórios.', null, true); return; }

        try {
            const docRef = doc(db, "operadores", cracha);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                window.showModal('Erro de Cadastro', `O operador com o crachá '${cracha}' já existe.`, null, true);
            } else {
                const fotoUrl = await uploadFile(fotoFile, `operadores/${cracha}`);
                const data = { cracha, nome, foto: fotoUrl };
                await setDoc(docRef, data);
                window.showModal('Sucesso', "Operador salvo com sucesso!");
                document.getElementById('cadastroOperador').querySelector('form').reset();
            }
        } catch (error) {
            console.error('Error saving operator:', error);
            window.showModal('Erro de Banco de Dados', 'Não foi possível salvar o operador.', null, true);
        }
    }

    window.salvarFrota = async function() {
        const codigo = document.getElementById('codigoFrota').value.trim();
        const modelo = document.getElementById('modeloFrota').value.trim();
        const fotoFile = document.getElementById('fotoFrota').files[0];
        if (!codigo || !modelo) {
            window.showModal('Campos Obrigatórios', 'Os campos Frota e Modelo são obrigatórios.', null, true);
            return;
        }

        try {
            const docRef = doc(db, "frotas", codigo);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                window.showModal('Erro de Cadastro', `A frota com o código '${codigo}' já existe.`, null, true);
            } else {
                const fotoUrl = await uploadFile(fotoFile, `frotas/${codigo}`);
                const frotaData = { codigo, modelo, foto: fotoUrl };
                await setDoc(docRef, frotaData);
                window.showModal('Sucesso', "Frota salva com sucesso!");
                document.getElementById('cadastroFrota').querySelector('form').reset();
            }
        } catch (error) {
            console.error('Error saving frota:', error);
            window.showModal('Erro', 'Ocorreu um erro ao salvar a frota.', null, true);
        }
    }

    window.salvarSetor = async function() {
        const nome = document.getElementById('nomeSetor').value.trim();
        if (!nome) { window.showModal('Campo Obrigatório', 'O nome do setor é obrigatório.', null, true); return; }
        try {
            await setDoc(doc(db, "setores", nome), { nome });
            window.showModal('Sucesso', "Setor salvo com sucesso!");
            document.getElementById('nomeSetor').value = '';
            window.populateSelects();
        } catch (error) {
            console.error("Error saving setor:", error);
            window.showModal('Erro', `Ocorreu um erro ao salvar o setor: ${error.message}`, null, true);
        }
    }

    window.salvarAtividade = async function() {
        const nome = document.getElementById('nomeAtividade').value.trim();
        if (!nome) { window.showModal('Campo Obrigatório', 'O nome da atividade é obrigatório.', null, true); return; }
        try {
            await setDoc(doc(db, "atividades", nome), { nome });
            window.showModal('Sucesso', "Atividade salva com sucesso!");
            document.getElementById('nomeAtividade').value = '';
            window.populateSelects();
        } catch (error) {
            console.error("Error saving atividade:", error);
            window.showModal('Erro', `Ocorreu um erro ao salvar a atividade: ${error.message}`, null, true);
        }
    }

    window.salvarImplemento = async function() {
        const nome = document.getElementById('nomeImplemento').value.trim();
        const sigla = document.getElementById('siglaImplemento').value.trim();
        const modelosSelect = document.getElementById('modeloImplemento');
        const modelosAssociados = [...modelosSelect.options]
                                    .filter(option => option.selected)
                                    .map(option => option.value);

        if (!nome || !sigla) { window.showModal('Campos Obrigatórios', 'Nome e Sigla são obrigatórios.', null, true); return; }
        
        try {
            await setDoc(doc(db, "implementos", nome), { nome, sigla, modelosAssociados });
            window.showModal('Sucesso', "Implemento salvo com sucesso!");
            document.getElementById('nomeImplemento').value = '';
            document.getElementById('siglaImplemento').value = '';
            modelosSelect.selectedIndex = -1; // Deselect all
            window.populateSelects();
        } catch (error) {
            console.error("Error saving implemento:", error);
            window.showModal('Erro', `Ocorreu um erro ao salvar o implemento: ${error.message}`, null, true);
        }
    }


    // --- INÍCIO/FIM DE ATIVIDADE FUNCTIONS ---
    window.buscarOperador = async function(cracha, nomeFieldId, fotoFieldId) {
        const nomeInput = document.getElementById(nomeFieldId);
        const fotoImg = document.getElementById(fotoFieldId);
       
        if (!cracha) {
            nomeInput.value = '';
            if(fotoImg) fotoImg.src = 'https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR';
            return null;
        }
       
        try {
            const docRef = doc(db, "operadores", cracha);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const op = docSnap.data();
                nomeInput.value = op.nome;
                if(fotoImg) fotoImg.src = op.foto || 'https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR';
                return op;
            } else {
                nomeInput.value = 'Operador não encontrado';
                if(fotoImg) fotoImg.src = 'https://placehold.co/100x100/A0AEC0/000000?text=OPERADOR';
                return null;
            }
        } catch (e) {
            console.error("Erro ao buscar operador:", e);
            nomeInput.value = 'Erro na busca';
            if(fotoImg) fotoImg.src = 'https://placehold.co/100x100/A0AEC0/000000?text=ERRO';
            return null;
        }
    }

    async function checkAndSetImplemento(modelo) {
        const implementoSelect = document.getElementById('implementoInicio');
        try {
            const q = query(collection(db, "implementos"), where("modelosAssociados", "array-contains", modelo));
            const querySnapshot = await getDocs(q);
            const implementosCompativeis = querySnapshot.docs.map(d => d.data());

            if (implementosCompativeis.length === 1) {
                implementoSelect.value = implementosCompativeis[0].nome;
            }
        } catch (error) {
            console.error("Error auto-setting implemento:", error);
        }
    }

    window.mostrarModeloFrota = async function(codigo, modeloFieldId, fotoFieldId) {
        const modeloInput = document.getElementById(modeloFieldId);
        const fotoImg = document.getElementById(fotoFieldId);

        if (!codigo) {
            modeloInput.value = '';
            if (fotoImg) fotoImg.src = 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
            return null;
        }

        try {
            const docRef = doc(db, "frotas", codigo);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const frota = docSnap.data();
                modeloInput.value = frota.modelo;
                if (fotoImg) fotoImg.src = frota.foto || 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
                checkAndSetImplemento(frota.modelo); // Auto-set implement if possible

                // Prefill Horímetro Inicial ao selecionar frota no formulário de início
                if (modeloFieldId === 'modeloInicio') {
                    const horInput = document.getElementById('horimetroInicial');
                    if (horInput) {
                        try {
                            const qHist = query(collection(db, 'historicoAtividades'), where('frota', '==', codigo), limit(50));
                            const snapHist = await getDocs(qHist);
                            let best = null;
                            snapHist.docs.forEach(d => {
                                const x = d.data();
                                let ts = 0;
                                if (x.dataFinal && x.horaFinal) {
                                    ts = new Date(`${x.dataFinal}T${x.horaFinal}`).getTime();
                                } else if (x.dataInicial && x.horaInicial) {
                                    ts = new Date(`${x.dataInicial}T${x.horaInicial}`).getTime();
                                }
                                let hf = parseFloat(x.horimetroFinal);
                                if (isNaN(hf)) {
                                    const hi = parseFloat(x.horimetroInicial);
                                    const hh = parseFloat(x.horasHorimetro);
                                    if (!isNaN(hi) && !isNaN(hh)) hf = hi + hh;
                                }
                                if (!isNaN(hf)) {
                                    if (!best || ts > best.ts) best = { ts, hf };
                                }
                            });
                            if (best) {
                                horInput.value = best.hf.toFixed(2);
                                horInput.dataset.horimetroInicial = best.hf.toFixed(2);
                                // Dispara validação padrão do campo após preencher
                                horInput.dispatchEvent(new Event('blur'));
                            }
                        } catch (err) {
                            console.warn('Falha ao sugerir horímetro inicial:', err);
                        }
                    }
                }
                return frota;
            } else {
                modeloInput.value = 'Frota não encontrada';
                if (fotoImg) fotoImg.src = 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
                return null;
            }
        } catch (e) {
            console.error("Erro ao buscar frota:", e);
            modeloInput.value = 'Erro na busca';
            if (fotoImg) fotoImg.src = 'https://placehold.co/100x100/A0AEC0/000000?text=ERRO';
            return null;
        }
    }
   
    window.toggleRelatoProblema = function() {
        const atividade = document.getElementById('atividadeInicio').value;
        const relatoField = document.getElementById('relatoProblemaField');
        const relatoTextarea = document.getElementById('relatoProblema');
        const isMaintenance = atividade.toLowerCase().includes('manutenção');
        relatoField.style.display = isMaintenance ? 'flex' : 'none';
        relatoTextarea.required = isMaintenance;
    }
   
    window.toggleNonConformityReport = function(radio) {
        const textarea = document.getElementById(radio.dataset.targetTextarea);
        textarea.classList.toggle('hidden', radio.value !== 'NÃO CONFORME');
        textarea.required = radio.value === 'NÃO CONFORME';
        if(radio.value !== 'NÃO CONFORME') textarea.value = '';
    }
   
    window.hideAllChecklistReports = function() {
        document.querySelectorAll('#safetyChecklist textarea').forEach(textarea => {
            textarea.classList.add('hidden');
            textarea.required = false;
            textarea.value = '';
        });
        document.querySelectorAll('#safetyChecklist input[type="radio"][value="OK"]').forEach(radio => {
            radio.checked = true;
        });
    }

    window.enviarInicio = async function(event) {
        event.preventDefault();
       
        if (!window.validateDateTime('dataInicial', 'horaInicial')) return;

        const frotaCadastrada = await window.mostrarModeloFrota(document.getElementById('frotaInicio').value, 'modeloInicio', 'fotoEquipInicio');
        if (!frotaCadastrada) {
            window.showModal('Erro', 'Frota não cadastrada. Verifique o código da frota e tente novamente.', null, true);
            return;
        }

        // Main form validation logic... (omitted for brevity, assume it passes)

        // Checklist requirement: se algum radio está com required, validar seleção e relatos
        const radiosReq = document.querySelectorAll('#safetyChecklist input[type="radio"][required]');
        const requireChecklist = radiosReq.length > 0;
        if (requireChecklist) {
            const grupos = new Set(Array.from(radiosReq).map(r => r.name));
            for (const name of grupos) {
                const ok = document.querySelector(`#safetyChecklist input[name="${name}"][value="OK"]`);
                const nc = document.querySelector(`#safetyChecklist input[name="${name}"][value="NÃO CONFORME"]`);
                if (!ok.checked && !nc.checked) {
                    window.showModal('Checklist obrigatório', 'Selecione OK ou NÃO CONFORME para todos os itens do checklist.', null, true);
                    return;
                }
                if (nc.checked) {
                    const taId = nc.dataset.targetTextarea;
                    const ta = document.getElementById(taId);
                    if (ta && !ta.value.trim()) {
                        window.showModal('Checklist obrigatório', 'Informe o relato para cada item marcado como NÃO CONFORME.', null, true);
                        return;
                    }
                }
            }
        }

        const cracha = document.getElementById('crachaInicio').value;
        const frota = document.getElementById('frotaInicio').value;

        try {
            const q = query(collection(db, "atividadesEmAndamento"), where("frota", "==", frota));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                window.showModal('Erro', `A frota ${frota} já está em atividade.`, null, true);
                return;
            }

            // Coleta respostas do checklist
            function getChecklistItem(name, relatoId) {
                const value = (document.querySelector(`#safetyChecklist input[name="${name}"]:checked`) || {}).value || 'OK';
                const relato = document.getElementById(relatoId)?.value || '';
                return { status: value, relato };
            }
            const checklistData = {
                OleoMotor: getChecklistItem('status_OleoMotor','relato_OleoMotor'),
                OleoHidraulico: getChecklistItem('status_OleoHidraulico','relato_OleoHidraulico'),
                OleoTransmissao: getChecklistItem('status_OleoTransmissao','relato_OleoTransmissao'),
                Extintor: getChecklistItem('status_Extintor','relato_Extintor'),
                Pneus: getChecklistItem('status_Pneus','relato_Pneus'),
                ParteEletrica: getChecklistItem('status_ParteEletrica','relato_ParteEletrica')
                // Adicione outros itens do checklist aqui se eles forem adicionados ao HTML
            };

            const dados = {
                cracha,
                operador: document.getElementById('nomeInicio').value,
                dataInicial: document.getElementById('dataInicial').value,
                horaInicial: document.getElementById('horaInicial').value,
                frota,
                equipamento: document.getElementById('modeloInicio').value,
                horimetroInicial: parseFloat(document.getElementById('horimetroInicial').value),
                setor: document.getElementById('setorInicio').value,
                atividade: document.getElementById('atividadeInicio').value,
                implemento: document.getElementById('implementoInicio').value,
                relatoProblema: document.getElementById('relatoProblema').value,
                observacoes: document.getElementById('observacoesInicio').value,
                checklist: checklistData
            };

            await addDoc(collection(db, "atividadesEmAndamento"), dados);
            window.showModal('Sucesso', 'Atividade iniciada com sucesso!');
            window.limparFormulario('formInicio');
            window.mostrar('disponibilidade');
        } catch (error) {
            console.error("Error starting activity:", error);
            window.showModal('Erro', `Não foi possível iniciar a atividade: ${error.message}`, null, true);
        }
    }
   
    window.finalizarAtividade = async function(atividadeId, atividadeAberta) {
      const horimetroFinal = parseFloat(document.getElementById('horimetroFim').value);
      const horimetroInicial = parseFloat(atividadeAberta.horimetroInicial);
      const dataFinalVal = document.getElementById('dataFinal').value;
      const horaFinalVal = document.getElementById('horaFinal').value;
      const inicioTimestamp = new Date(`${atividadeAberta.dataInicial}T${atividadeAberta.horaInicial}`).getTime();
      const fimTimestamp = new Date(`${dataFinalVal}T${horaFinalVal}`).getTime();

      let isInconsistente = false;
      if (horimetroFinal < horimetroInicial || fimTimestamp < inicioTimestamp) {
          isInconsistente = true;
      }

      const batch = writeBatch(db);

      // Add to history
      const historicoRef = doc(collection(db, "historicoAtividades"));
      const dadosHistorico = {
          ...atividadeAberta,
          dataFinal: dataFinalVal,
          horaFinal: horaFinalVal,
          horimetroFinal: horimetroFinal,
          observacoes: document.getElementById('observacoesFim').value,
          horasHorimetro: (horimetroFinal - horimetroInicial).toFixed(2),
          inconsistente: isInconsistente
      };
      batch.set(historicoRef, dadosHistorico);

      // Delete from current activities
      const atividadeAbertaRef = doc(db, "atividadesEmAndamento", atividadeId);
      batch.delete(atividadeAbertaRef);

      try {
          await batch.commit();
          window.showModal("Sucesso", "Atividade finalizada com sucesso!");
          window.limparFormulario('formFim');
          window.mostrar('disponibilidade');
      } catch (error) {
          console.error("Error ending activity:", error);
          window.showModal('Erro', `Não foi possível finalizar a atividade: ${error.message}`, null, true);
      }
    }


    window.enviarFim = async function(event) {
        event.preventDefault();
        if (!window.validateDateTime('dataFinal', 'horaFinal')) return;

        const atividadeId = document.getElementById('horimetroFim').dataset.atividadeId;
        if (!atividadeId) {
            window.showModal("Erro", "Nenhuma atividade selecionada para finalizar. Verifique o crachá e a frota.", null, true);
            return;
        }

        const atividadeAbertaRef = doc(db, "atividadesEmAndamento", atividadeId);
       
        try {
            const atividadeAbertaSnap = await getDoc(atividadeAbertaRef);
            if (!atividadeAbertaSnap.exists()) {
                window.showModal("Erro", "Atividade em andamento não encontrada. Pode já ter sido finalizada.", null, true);
                return;
            }
            const atividadeAberta = atividadeAbertaSnap.data();
           
            // Directly call the finalization logic
            await finalizarAtividade(atividadeId, atividadeAberta);

        } catch (error) {
            console.error("Error preparing to end activity:", error);
            window.showModal('Erro', `Não foi possível finalizar a atividade: ${error.message}`, null, true);
        }
    }

    window.handleCrachaFimChange = async function() {
      const cracha = document.getElementById('crachaFim').value;
      const operador = await window.buscarOperador(cracha, 'nomeFim', 'fotoFim');

      const frotaFimInput = document.getElementById('frotaFim');
      const container = document.getElementById('frotaSelectionContainer');
      const select = document.getElementById('selectFrotaAtiva');
      
      frotaFimInput.value = '';
      document.getElementById('equipamentoFim').value = '';
      document.getElementById('fotoEquipFim').src = 'https://placehold.co/100x100/A0AEC0/000000?text=FROTA';
      container.style.display = 'none';
      select.innerHTML = '<option value="">Selecione a frota...</option>';

      if (!operador) return;

      try {
          const q = query(collection(db, "atividadesEmAndamento"), where("cracha", "==", cracha));
          const querySnapshot = await getDocs(q);
          const atividadesOperador = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
         
          if (atividadesOperador.length === 1) {
              window.selecionarFrotaAtiva(atividadesOperador[0].id);
              container.style.display = 'none';
          } else if (atividadesOperador.length > 1) {
              atividadesOperador.forEach(ativ => select.innerHTML += `<option value="${ativ.id}">${ativ.frota} - ${ativ.atividade}</option>`);
              container.style.display = 'flex';
          }
      } catch (error) {
          console.error("Error fetching active tasks for operator:", error);
      }
    }

    window.selecionarFrotaAtiva = async function(id) {
      try {
          const docRef = doc(db, "atividadesEmAndamento", id);
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
              const ativ = docSnap.data();
              document.getElementById('frotaFim').value = ativ.frota;
              window.mostrarModeloFrota(ativ.frota, 'equipamentoFim', 'fotoEquipFim');
              const horimetroInput = document.getElementById('horimetroFim');
              horimetroInput.dataset.atividadeId = id;
              horimetroInput.dataset.horimetroInicial = ativ.horimetroInicial;
          }
      } catch (error) {
          console.error("Error selecting active fleet:", error);
      }
    }

    // --- DISPONIBILIDADE (AVAILABILITY) VIEW ---
    window.updateDisponibilidade = function() {
        if (!currentUser) return;
        if (unsubscribeDisponibilidade) unsubscribeDisponibilidade(); // Detach previous listener

        const q = collection(db, "atividadesEmAndamento");
        unsubscribeDisponibilidade = onSnapshot(q, async (querySnapshot) => {
            const atividadesEmAndamento = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
           
            const frotasSnapshot = await getDocs(collection(db, "frotas"));
            const todasFrotas = frotasSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

            const contentDiv = document.getElementById('disponibilidadeContent');
            contentDiv.innerHTML = '';

            if (todasFrotas.length === 0) {
                contentDiv.innerHTML = '<p class="text-gray-600">Nenhuma frota cadastrada.</p>';
                return;
            }

            const frotasAgrupadas = todasFrotas.reduce((acc, frota) => {
                const modelo = frota.modelo || 'Sem Modelo';
                if (!acc[modelo]) acc[modelo] = [];
                acc[modelo].push(frota);
                return acc;
            }, {});

            const sortedModelos = Object.keys(frotasAgrupadas).sort();

            for (const modelo of sortedModelos) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'mb-8';
                const groupTitle = document.createElement('h4');
                groupTitle.className = 'text-lg font-bold text-gray-700 border-b pb-2 mb-4';
                groupTitle.textContent = `Modelo: ${modelo}`;
                groupDiv.appendChild(groupTitle);

                const table = document.createElement('table');
                table.className = 'availability-table';
                table.innerHTML = `<thead><tr><th>Frota</th><th>Status</th><th>Operador</th><th>Setor</th><th>Atividade</th><th>Início</th></tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');

                frotasAgrupadas[modelo].forEach(frota => {
                    const atividade = atividadesEmAndamento.find(a => a.frota === frota.codigo);
                   
                    let statusClass = 'status-ok';
                    let statusText = 'DISPONÍVEL';
                    let operadorText = '-';
                    let inicioText = '-';
                    let atividadeText = '-';
                    let setorText = '-';
                    let isEditable = false;

                    if (atividade) {
                        const atividadeNomeUpper = atividade.atividade.toUpperCase();
                        if (atividadeNomeUpper.includes('MANUTENÇÃO')) {
                            statusText = 'MANUTENÇÃO';
                            statusClass = 'status-maintenance-strong';
                        } else if (atividadeNomeUpper.includes('REVISÃO')) {
                            statusText = 'REVISÃO';
                            statusClass = 'status-revision-strong';
                        } else {
                            statusText = 'EM USO';
                            statusClass = 'status-active';
                        }
                        
                        operadorText = `${atividade.operador} (${atividade.cracha})`;
                        inicioText = `${new Date(atividade.dataInicial + 'T' + atividade.horaInicial).toLocaleDateString('pt-BR')} ${atividade.horaInicial}`;
                        atividadeText = atividade.atividade;
                        setorText = atividade.setor || '-';
                        isEditable = ['operacao_2', 'analista', 'administrador'].includes(currentUserRole);
                    }

                    const row = tbody.insertRow();
                    if(isEditable && atividade) {
                        row.classList.add('editable');
                        row.setAttribute('data-atividade-id', atividade.id);
                        row.onclick = () => window.handleDisponibilidadeClick(atividade.id);
                    }
                    row.innerHTML = `<td data-label="Frota">${frota.codigo}</td><td data-label="Status"><span class="status-cell ${statusClass}">${statusText}</span></td><td data-label="Operador">${operadorText}</td><td data-label="Setor">${setorText}</td><td data-label="Atividade">${atividadeText}</td><td data-label="Início">${inicioText}</td>`;
                });
                groupDiv.appendChild(table);
                contentDiv.appendChild(groupDiv);
            }
        }, (error) => {
            console.error("Error with real-time listener:", error);
            window.showModal("Erro de Conexão", "Não foi possível carregar os dados em tempo real.", null, true);
        });
    }
    
    window.handleDisponibilidadeClick = function(atividadeId) {
         if (!['operacao_2', 'analista', 'administrador'].includes(currentUserRole)) {
             return;
         }
         if (atividadeId) {
             window.showEditAtividadeModal(atividadeId);
         }
    }


    // --- ADMIN PANEL FUNCTIONS ---
    window.showAdminDashboard = function() {
        if (!currentUser) return;
       
        const adminDashboard = document.getElementById('adminDashboard');
        const userManagement = document.getElementById('userManagement');
       
        adminDashboard.style.display = 'block';
        document.getElementById('loggedInUserEmailDisplay').textContent = currentUser.email.replace(DUMMY_DOMAIN, '');
        document.getElementById('loggedInUserLevelDisplay').textContent = currentUserRole;

        if (currentUserRole === 'administrador') {
            userManagement.style.display = 'block';
            window.loadUserList();
        } else {
            userManagement.style.display = 'none';
            window.showModal("Acesso Negado", "Você não tem permissão para gerenciar usuários.", null, true);
        }
    }

    window.salvarUsuario = async function() {
        let username = document.getElementById('newUsername').value.trim();
        const password = document.getElementById('newUserPassword').value.trim();
        const level = document.getElementById('newUserLevel').value;
       
        if (!username || !password || !level) { 
            window.showModal("Campos Obrigatórios", "Usuário, Senha e Nível são obrigatórios.", null, true); 
            return; 
        }

        const email = username.includes('@') ? username : username + DUMMY_DOMAIN;

        window.showModal("Aviso de Segurança", "A criação de usuários no cliente não é recomendada para produção. Para este demo, vamos prosseguir. O administrador atual pode precisar fazer login novamente após esta ação.", async () => {
          try {
              const userCredential = await createUserWithEmailAndPassword(auth, email, password);
              const newUser = userCredential.user;

              await setDoc(doc(db, "usuarios", newUser.uid), { email: newUser.email, level: level, username: username });

              window.showModal('Sucesso', `Usuário ${username} criado com sucesso com o nível '${level}'.`);
              window.loadUserList();
              document.getElementById('newUsername').value = '';
              document.getElementById('newUserPassword').value = '';
              document.getElementById('newUserLevel').value = '';

          } catch (error) {
              console.error("Error creating user:", error);
              if (error.code === 'auth/email-already-in-use') {
                  window.showModal('Erro', `O usuário (email: ${email}) já está em uso.`, null, true);
              } else if (error.code === 'auth/weak-password') {
                  window.showModal('Erro', 'A senha é muito fraca. Use pelo menos 6 caracteres.', null, true);
              } else {
                  window.showModal('Erro', `Não foi possível criar o usuário: ${error.message}`, null, true);
              }
          }
        });
    }

    window.loadUserList = async function() {
        const userListBody = document.getElementById('userList');
        userListBody.innerHTML = '<tr><td colspan="3">Carregando...</td></tr>';
        try {
            const querySnapshot = await getDocs(collection(db, "usuarios"));
            const users = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
           
            userListBody.innerHTML = '';
            if (users.length === 0) {
                userListBody.innerHTML = '<tr><td colspan="3">Nenhum usuário com permissão definida.</td></tr>';
                return;
            }

            users.forEach(user => {
                const row = userListBody.insertRow();
                row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.username || user.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.level}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <a href="#" class="text-blue-600 hover:text-blue-900" onclick="window.handleEdit('usuarios', '${user.id}')">Editar</a>
                            <a href="#" class="text-red-600 hover:text-red-900 ml-4" onclick="window.deleteUser('${user.id}', '${user.username || user.email}')">Excluir</a>
                        </td>`;
            });
        } catch(error) {
            console.error("Error loading user list:", error);
            userListBody.innerHTML = '<tr><td colspan="3">Erro ao carregar usuários.</td></tr>';
        }
    }

    window.deleteUser = function(uid, username) {
        if (currentUser.uid === uid) {
            window.showModal("Ação Inválida", "Você não pode remover seu próprio acesso.", null, true);
            return;
        }
        window.showModal('Excluir Permissão', `Tem certeza que deseja remover as permissões para '${username}'? <br><small>Isso NÃO exclui o login do usuário, apenas remove seu nível de acesso do aplicativo.</small>`, async () => {
            try {
                await deleteDoc(doc(db, "usuarios", uid));
                window.showModal('Sucesso', `Permissões para ${username} removidas.`);
                window.loadUserList();
            } catch (error) {
                console.error("Error deleting user role:", error);
                window.showModal('Erro', `Não foi possível remover as permissões: ${error.message}`, null, true);
            }
        }, true);
    }


    // --- CONSULTA & EDIT FUNCTIONS ---
    window.consultarOperador = async function() {
        const snapshot = await getDocs(collection(db, 'operadores'));
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        window.showListModal('Operadores Cadastrados', data, { cracha: 'Crachá', nome: 'Nome', foto: 'Foto' }, 'operadores');
    }
    window.consultarFrota = async function() {
        const snapshot = await getDocs(collection(db, 'frotas'));
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        window.showListModal('Frotas Cadastradas', data, { codigo: 'Código', modelo: 'Modelo', foto: 'Foto' }, 'frotas');
    }
    window.consultarSetor = async function() {
        const snapshot = await getDocs(collection(db, 'setores'));
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        window.showListModal('Setores Cadastrados', data, { nome: 'Nome' }, 'setores');
    }
    window.consultarAtividade = async function() {
        const snapshot = await getDocs(collection(db, 'atividades'));
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        window.showListModal('Atividades Cadastradas', data, { nome: 'Nome' }, 'atividades');
    }
    window.consultarImplemento = async function() {
        const snapshot = await getDocs(collection(db, 'implementos'));
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        window.showListModal('Implementos Cadastrados', data, { nome: 'Nome', sigla: 'Sigla', modelosAssociados: 'Modelos Associados' }, 'implementos');
    }

    window.handleDelete = async function(storeName, docId, fotoUrl) {
        if (currentUserRole !== 'administrador') {
            window.showModal('Acesso Negado', 'Você não tem permissão para excluir itens.', null, true);
            return;
        }

        window.showModal('Confirmar Exclusão', `Tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.`, async () => {
          try {
              // Delete firestore document
              await deleteDoc(doc(db, storeName, docId));

              // If there's a photo, delete it from storage
              if (fotoUrl) {
                  try {
                      const fotoRef = ref(storage, fotoUrl);
                      await deleteObject(fotoRef);
                  } catch (storageError) {
                      console.warn("Could not delete photo from storage, it might have been already deleted:", storageError);
                  }
              }

              window.showModal('Sucesso', 'Item excluído com sucesso!');
              document.getElementById('listModal').style.display = 'none';
          } catch (error) {
              console.error(`Error deleting from ${storeName}:`, error);
              window.showModal('Erro', `Erro ao excluir item de ${storeName}.`, null, true);
          }
        }, true);
    }

    window.handleEdit = async function(storeName, docId) {
      if (currentUserRole !== 'administrador') {
          window.showModal('Acesso Negado', 'Você não tem permissão para editar itens.', null, true);
          return;
      }

      try {
          const docRef = doc(db, storeName, docId);
          const docSnap = await getDoc(docRef);
          if (!docSnap.exists()) {
              window.showModal('Erro', 'Item não encontrado.', null, true);
              return;
          }
          const item = { id: docSnap.id, ...docSnap.data() };
         
          const modal = document.getElementById('editModal');
          const titleEl = document.getElementById('editModalTitle');
          const formEl = document.getElementById('editForm');
         
          titleEl.textContent = `Editar Item (ID: ${item.id})`;
          formEl.innerHTML = ''; // Clear previous form

          const fields = Object.keys(item);
          for (const field of fields) {
              if (field === 'id' || field === 'foto') continue;

              const fieldDiv = document.createElement('div');
              fieldDiv.className = 'field';
             
              const label = document.createElement('label');
              label.textContent = field.charAt(0).toUpperCase() + field.slice(1);
              fieldDiv.appendChild(label);

              let input;
              if (field === 'modelosAssociados') {
                  input = document.createElement('select');
                  input.id = `edit_${field}`;
                  input.multiple = true;
                  await populateModelosSelect(input.id, item[field] || []);
              } else {
                  input = document.createElement('input');
                  input.id = `edit_${field}`;
                  input.value = item[field] || '';
                  if (field === 'cracha' || field === 'codigo' || field === 'nome' || field === 'pneuId') {
                      // Make primary keys readonly
                      if (['operadores', 'frotas', 'setores', 'atividades', 'implementos', 'pneus'].includes(storeName)) {
                          input.readOnly = true;
                          input.classList.add('bg-gray-200');
                      }
                  }
              }
              fieldDiv.appendChild(input);
              formEl.appendChild(fieldDiv);
          }

          // Handle photo update
          if ('foto' in item) {
              const fieldDiv = document.createElement('div');
              fieldDiv.className = 'field';
              const label = document.createElement('label');
              label.textContent = 'Alterar Foto';
              const inputFile = document.createElement('input');
              inputFile.type = 'file';
              inputFile.id = 'edit_foto';
              inputFile.accept = 'image/*';
              fieldDiv.appendChild(label);
              fieldDiv.appendChild(inputFile);
              formEl.appendChild(fieldDiv);
          }

          document.getElementById('editModalSaveBtn').onclick = async () => {
              const updatedData = {};
              let newFotoFile = null;

              for (const field of fields) {
                  if (field === 'id' || field === 'foto') continue;
                  const inputEl = document.getElementById(`edit_${field}`);
                  if (inputEl) {
                     if (inputEl.multiple) {
                         updatedData[field] = [...inputEl.options]
                                               .filter(option => option.selected)
                                               .map(option => option.value);
                     } else {
                         updatedData[field] = inputEl.value;
                     }
                  }
              }

              if (document.getElementById('edit_foto')) {
                  newFotoFile = document.getElementById('edit_foto').files[0];
              }

              try {
                  if (newFotoFile) {
                      if (item.foto) { // Delete old photo
                          try {
                             const oldFotoRef = ref(storage, item.foto);
                             await deleteObject(oldFotoRef);
                          } catch (e) {
                             console.warn("Old photo not found, could not delete:", e.message);
                          }
                      }
                      const newFotoUrl = await uploadFile(newFotoFile, `${storeName}/${item.id}`);
                      updatedData.foto = newFotoUrl;
                  }

                  await updateDoc(docRef, updatedData);
                  window.showModal('Sucesso', 'Item atualizado com sucesso!');
                  modal.style.display = 'none';
                  document.getElementById('listModal').style.display = 'none';

              } catch (error) {
                  console.error("Error updating item:", error);
                  window.showModal('Erro', `Não foi possível atualizar o item: ${error.message}`, null, true);
              }
          };

          modal.style.display = 'flex';

      } catch (error) {
          console.error(`Error fetching item for edit from ${storeName}:`, error);
          window.showModal('Erro', `Erro ao buscar item para edição de ${storeName}.`, null, true);
      }
}

window.showEditAtividadeModal = async function(atividadeId) {
    try {
        const docRef = doc(db, "atividadesEmAndamento", atividadeId);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) {
            window.showModal('Erro', 'Atividade não encontrada. Pode ter sido finalizada.', null, true);
            return;
        }
        const item = { id: docSnap.id, ...docSnap.data() };

        const modal = document.getElementById('editModal');
        const titleEl = document.getElementById('editModalTitle');
        const formEl = document.getElementById('editForm');
       
        titleEl.textContent = `Editar Atividade da Frota: ${item.frota}`;
        formEl.innerHTML = ''; // Clear previous form

        // Create fields for editing
        const fieldsToEdit = {
            cracha: 'Crachá',
            setor: 'Setor',
            atividade: 'Atividade',
            horimetroInicial: 'Horímetro Inicial'
        };

        for (const field in fieldsToEdit) {
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'field';
            const label = document.createElement('label');
            label.textContent = fieldsToEdit[field];
            fieldDiv.appendChild(label);
            const input = document.createElement('input');
            input.id = `edit_atividade_${field}`;
            input.value = item[field] || '';
            fieldDiv.appendChild(input);
            formEl.appendChild(fieldDiv);
        }

        document.getElementById('editModalSaveBtn').onclick = async () => {
            const updatedData = {};
            for (const field in fieldsToEdit) {
                updatedData[field] = document.getElementById(`edit_atividade_${field}`).value;
            }
            // Ensure horimetro is a number
            updatedData.horimetroInicial = parseFloat(updatedData.horimetroInicial) || 0;

            try {
                await updateDoc(docRef, updatedData);
                window.showModal('Sucesso', 'Atividade atualizada com sucesso!');
                modal.style.display = 'none';
            } catch (error) {
                console.error("Error updating activity:", error);
                window.showModal('Erro', `Não foi possível atualizar a atividade: ${error.message}`, null, true);
            }
        };

        modal.style.display = 'flex';

    } catch (error) {
        console.error("Error fetching activity for edit:", error);
        window.showModal('Erro', 'Não foi possível carregar os dados da atividade.', null, true);
    }
}


window.showOperatorSearchModal = async function(targetCrachaId) {
    const modal = document.getElementById('listModal');
    const titleEl = document.getElementById('listModalTitle');
    const contentEl = document.getElementById('listModalContent');

    const isFim = targetCrachaId === 'crachaFim';
    titleEl.textContent = isFim ? 'Selecionar Operador (com atividade em andamento)' : 'Selecionar Operador';
    contentEl.innerHTML = '<p>Carregando...</p>';
    modal.style.display = 'flex';

    try {
        let data = [];
        if (isFim) {
            // Listar apenas operadores que iniciaram atividades (em andamento)
            const snapshot = await getDocs(collection(db, 'atividadesEmAndamento'));
            const byCracha = new Map();
            snapshot.docs.forEach(docSnap => {
                const d = docSnap.data();
                const cracha = String(d.cracha ?? '').toUpperCase();
                const nome = String(d.operador ?? '').toUpperCase();
                if (cracha) {
                    if (!byCracha.has(cracha)) byCracha.set(cracha, { cracha, nome });
                }
            });
            data = Array.from(byCracha.values());
            if (!data || data.length === 0) {
                contentEl.innerHTML = '<p class="text-gray-600">Nenhuma atividade em andamento.</p>';
                return;
            }
        } else {
            // Listar todos os operadores (para Início, OS, etc.)
            const snapshot = await getDocs(collection(db, 'operadores'));
            data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (!data || data.length === 0) {
                contentEl.innerHTML = '<p class="text-gray-600">Nenhum operador cadastrado.</p>';
                return;
            }
        }

        contentEl.innerHTML = '';
        const table = document.createElement('table');
        table.className = 'consult-table w-full';
        table.innerHTML = `<thead><tr><th></th><th data-sort-key="cracha" onclick="sortTable(this)">Crachá</th><th data-sort-key="nome" onclick="sortTable(this)">Nome</th></tr></thead><tbody></tbody>`;
        const tbody = table.querySelector('tbody');

        data.forEach(item => {
            const cracha = String((item.cracha ?? '')).toUpperCase();
            const nome = String((item.nome ?? item.operador ?? '')).toUpperCase();
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><input type="checkbox" class="operator-select-checkbox" data-cracha="${cracha}"></td>
                <td data-label="Crachá">${cracha}</td>
                <td data-label="Nome">${nome}</td>
            `;
            row.querySelector('.operator-select-checkbox').onchange = (e) => {
                 if (e.target.checked) {
                    const crachaInput = document.getElementById(targetCrachaId);
                    crachaInput.value = cracha;
                    crachaInput.dispatchEvent(new Event('input', { bubbles: true }));
                    modal.style.display = 'none';
                 }
            };
        });
        contentEl.appendChild(table);

    } catch (error) {
        console.error("Error showing operator search modal:", error);
        contentEl.innerHTML = '<p class="text-red-500">Erro ao carregar operadores.</p>';
    }
}


   // --- Initialize App ---
   document.addEventListener('DOMContentLoaded', () => {
       document.querySelectorAll('.logo-img').forEach(img => img.src = logoUrl);
       document.getElementById('logoLogin').src = logoUrl;
      
       // PWA Service Worker Registration
       if ('serviceWorker' in navigator) {
         window.addEventListener('load', () => {
             navigator.serviceWorker.register('./sw.js').then(registration => {
                 console.log('ServiceWorker registration successful with scope: ', registration.scope);
             }, err => {
                 console.log('ServiceWorker registration failed: ', err);
             });
         });
       }

       // Ajuste dinâmico do espaçamento superior conforme altura do menu fixo
       const topMenuEl = document.querySelector('.top-menu');
       if (topMenuEl) {
         const adjustBodyPadding = () => {
           const h = topMenuEl.getBoundingClientRect().height;
           document.body.style.paddingTop = `${Math.ceil(h) + 8}px`;
         };
         adjustBodyPadding();
         window.addEventListener('resize', adjustBodyPadding);
       }
   });

   // Placeholder for functions that are not fully migrated yet
   window.gerarRelatorio = () => window.showModal('Em Desenvolvimento', 'A geração de relatórios está sendo atualizada para o novo banco de dados.', null, false);
   window.mostrarBancoDeDados = () => window.showModal('Em Desenvolvimento', 'A visualização de dados brutos está sendo atualizada para o novo banco de dados.', null, false);
   window.salvarPlanoManutencao = () => window.showModal('Em Desenvolvimento', 'A gestão de Planos de Manutenção está sendo atualizada.', null, false);
   window.consultarPlanosManutencao = () => window.showModal('Em Desenvolvimento', 'A gestão de Planos de Manutenção está sendo atualizada.', null, false);
   window.salvarPeca = () => window.showModal('Em Desenvolvimento', 'A gestão de Peças está sendo atualizada.', null, false);
   window.consultarPecas = () => window.showModal('Em Desenvolvimento', 'A gestão de Peças está sendo atualizada.', null, false);
   window.salvarOrcamento = () => window.showModal('Em Desenvolvimento', 'A gestão de Orçamentos está sendo atualizada.', null, false);
   window.consultarOrcamentos = () => window.showModal('Em Desenvolvimento', 'A gestão de Orçamentos está sendo atualizada.', null, false);
   window.consultarHistoricoManutencao = () => window.showModal('Em Desenvolvimento', 'A gestão de Histórico está sendo atualizada.', null, false);

   // Busca de produto por código e preenchimento do nome
   window.buscarProduto = async function(codigo, nomeFieldId) {
       const nomeInput = document.getElementById(nomeFieldId);
       if (!codigo) { if (nomeInput) nomeInput.value = ''; return null; }
       try {
           const produtoRef = doc(db, 'produtos', codigo);
           const produtoSnap = await getDoc(produtoRef);
           if (produtoSnap.exists()) {
               const produto = produtoSnap.data();
               if (nomeInput) nomeInput.value = produto.nome || produto.descricao || 'Produto cadastrado';
               return produto;
           } else {
               if (nomeInput) nomeInput.value = 'Produto não encontrado';
               return null;
           }
       } catch (error) {
           console.error('Erro ao buscar produto:', error);
           if (nomeInput) nomeInput.value = 'Erro na busca';
           return null;
       }
   }

   // Mostrar/ocultar e calcular Volume Restante (para abastecimento interno)
   window.toggleVolumeRestante = async function(local) {
       const field = document.getElementById('volumeRestanteField');
       const input = document.getElementById('volumeRestante');
       if (!field || !input) return;

       if (local === 'interno') {
           field.style.display = 'flex';
           try {
               const codigo = (document.getElementById('abastecimentoCodProduto')?.value || '').trim().toUpperCase();
               let totalComprado = 0;
               let totalConsumido = 0;

               const comprasSnap = await getDocs(collection(db, 'comprasCombustivel'));
               comprasSnap.forEach(docSnap => {
                   const data = docSnap.data();
                   if (!codigo || (data.codProduto || '').toUpperCase() === codigo) {
                       const vol = parseFloat(data.volume ?? data.compraVolume ?? 0) || 0;
                       totalComprado += vol;
                   }
               });

               const abastecimentosSnap = await getDocs(collection(db, 'abastecimentos'));
               abastecimentosSnap.forEach(docSnap => {
                   const data = docSnap.data();
                   if (!codigo || (data.codProduto || '').toUpperCase() === codigo) {
                       const vol = parseFloat(data.volume ?? 0) || 0; // Ainda não há campo de volume no formulário de abastecimento
                       totalConsumido += vol;
                   }
               });

               const restante = totalComprado - totalConsumido;
               input.value = isNaN(restante) ? '-' : `${restante.toFixed(2)} L`;
           } catch (err) {
               console.error('Erro ao calcular volume restante:', err);
               input.value = 'N/D';
           }
       } else {
           field.style.display = 'none';
           input.value = '';
       }
   }

   // Salvar Abastecimento
   window.salvarAbastecimento = async function() {
       const frota = document.getElementById('abastecimentoFrota').value.trim().toUpperCase();
       const documento = document.getElementById('abastecimentoDoc').value.trim();
       const empresa = document.getElementById('abastecimentoEmpresa').value.trim();
       const horimetro = parseFloat(document.getElementById('abastecimentoHorimetro').value);
       const data = document.getElementById('abastecimentoData').value;
       const hora = document.getElementById('abastecimentoHora').value;
       const motoristaCracha = document.getElementById('abastecimentoMotorista').value.trim().toUpperCase();
       const motoristaNome = document.getElementById('nomeMotorista').value.trim();
       const frentistaCracha = document.getElementById('abastecimentoFrentista').value.trim().toUpperCase();
       const frentistaNome = document.getElementById('nomeFrentista').value.trim();
       const codProduto = document.getElementById('abastecimentoCodProduto').value.trim().toUpperCase();
       const local = document.getElementById('abastecimentoLocal').value;

       if (!frota || !documento || !empresa || isNaN(horimetro) || !data || !hora || !motoristaCracha || !frentistaCracha || !codProduto) {
           window.showModal('Campos Obrigatórios', 'Preencha todos os campos do abastecimento.', null, true);
           return;
       }

       if (!window.validateDateTime('abastecimentoData', 'abastecimentoHora')) return;

       try {
           await addDoc(collection(db, 'abastecimentos'), {
               frota,
               documento,
               empresa,
               horimetro,
               data,
               hora,
               motoristaCracha,
               motoristaNome,
               frentistaCracha,
               frentistaNome,
               codProduto,
               local,
               interno: local === 'interno',
               createdAt: Date.now()
           });
           window.showModal('Sucesso', 'Abastecimento registrado com sucesso!');
           document.getElementById('abastecimentoForm').reset();
           document.getElementById('abastecimentoModelo').value = '';
           document.getElementById('nomeMotorista').value = '';
           document.getElementById('nomeFrentista').value = '';
           document.getElementById('nomeProduto').value = '';
           window.populateCurrentDateTime('abastecimentoData', 'abastecimentoHora');
           window.toggleVolumeRestante(local);
       } catch (error) {
           console.error('Erro ao salvar abastecimento:', error);
           window.showModal('Erro', 'Não foi possível salvar o abastecimento.', null, true);
       }
   }

   // Salvar Compra de Combustível
   window.salvarCompraCombustivel = async function() {
       const codProduto = document.getElementById('compraCodProduto').value.trim().toUpperCase();
       const empresa = document.getElementById('compraEmpresa').value.trim();
       const volume = parseFloat(document.getElementById('compraVolume').value);
       const valor = parseFloat(document.getElementById('compraValor').value);

       if (!codProduto || !empresa || isNaN(volume) || isNaN(valor)) {
           window.showModal('Campos Obrigatórios', 'Preencha todos os campos da compra de combustível.', null, true);
           return;
       }

       try {
           await addDoc(collection(db, 'comprasCombustivel'), {
               codProduto,
               empresa,
               volume,
               valor,
               createdAt: Date.now()
           });
           window.showModal('Sucesso', 'Compra registrada com sucesso!');
           document.getElementById('compraCombustivelForm').reset();
           window.toggleVolumeRestante(document.getElementById('abastecimentoLocal').value);
       } catch (error) {
           console.error('Erro ao salvar compra de combustível:', error);
           window.showModal('Erro', 'Não foi possível salvar a compra de combustível.', null, true);
       }
   }
  
</script>
</body>
</html>

